<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微服务网关 | 独角兕大王</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.ccac5a78.css" as="style"><link rel="preload" href="/assets/js/app.51f2f156.js" as="script"><link rel="preload" href="/assets/js/2.8911ec45.js" as="script"><link rel="preload" href="/assets/js/33.722f1ec5.js" as="script"><link rel="prefetch" href="/assets/js/10.6948c28b.js"><link rel="prefetch" href="/assets/js/100.276864ee.js"><link rel="prefetch" href="/assets/js/101.447ab1c7.js"><link rel="prefetch" href="/assets/js/102.f5b3c71d.js"><link rel="prefetch" href="/assets/js/103.16474d4b.js"><link rel="prefetch" href="/assets/js/104.ed58aef3.js"><link rel="prefetch" href="/assets/js/105.045203cd.js"><link rel="prefetch" href="/assets/js/106.be359e0b.js"><link rel="prefetch" href="/assets/js/107.7331bbca.js"><link rel="prefetch" href="/assets/js/108.76e1c800.js"><link rel="prefetch" href="/assets/js/109.e82166f3.js"><link rel="prefetch" href="/assets/js/11.d4ec37c8.js"><link rel="prefetch" href="/assets/js/110.4144755a.js"><link rel="prefetch" href="/assets/js/111.5864ab53.js"><link rel="prefetch" href="/assets/js/112.ca2aee84.js"><link rel="prefetch" href="/assets/js/113.641e7765.js"><link rel="prefetch" href="/assets/js/114.d69f8545.js"><link rel="prefetch" href="/assets/js/115.1b6a9f89.js"><link rel="prefetch" href="/assets/js/116.dde2c44e.js"><link rel="prefetch" href="/assets/js/117.4e79498c.js"><link rel="prefetch" href="/assets/js/12.7aac9c8d.js"><link rel="prefetch" href="/assets/js/13.abf127cd.js"><link rel="prefetch" href="/assets/js/14.aa4413a7.js"><link rel="prefetch" href="/assets/js/15.11a64e5b.js"><link rel="prefetch" href="/assets/js/16.f2d9a882.js"><link rel="prefetch" href="/assets/js/17.11c5bb7f.js"><link rel="prefetch" href="/assets/js/18.a522877b.js"><link rel="prefetch" href="/assets/js/19.6f31a972.js"><link rel="prefetch" href="/assets/js/20.b546c54e.js"><link rel="prefetch" href="/assets/js/21.6d055b7f.js"><link rel="prefetch" href="/assets/js/22.c48feceb.js"><link rel="prefetch" href="/assets/js/23.69941f78.js"><link rel="prefetch" href="/assets/js/24.6126dfc2.js"><link rel="prefetch" href="/assets/js/25.3475449c.js"><link rel="prefetch" href="/assets/js/26.96bb4643.js"><link rel="prefetch" href="/assets/js/27.da610e5d.js"><link rel="prefetch" href="/assets/js/28.b24ec15c.js"><link rel="prefetch" href="/assets/js/29.ec8af553.js"><link rel="prefetch" href="/assets/js/3.bec5f768.js"><link rel="prefetch" href="/assets/js/30.2e780db1.js"><link rel="prefetch" href="/assets/js/31.464c36ed.js"><link rel="prefetch" href="/assets/js/32.ad7d37c2.js"><link rel="prefetch" href="/assets/js/34.8448d0fd.js"><link rel="prefetch" href="/assets/js/35.e5168ac9.js"><link rel="prefetch" href="/assets/js/36.edc404f1.js"><link rel="prefetch" href="/assets/js/37.5807602e.js"><link rel="prefetch" href="/assets/js/38.a519c89a.js"><link rel="prefetch" href="/assets/js/39.89af1b9a.js"><link rel="prefetch" href="/assets/js/4.5ed19beb.js"><link rel="prefetch" href="/assets/js/40.6c653db9.js"><link rel="prefetch" href="/assets/js/41.bc3b8b69.js"><link rel="prefetch" href="/assets/js/42.a0a02d9b.js"><link rel="prefetch" href="/assets/js/43.62f344e3.js"><link rel="prefetch" href="/assets/js/44.a7fd9d68.js"><link rel="prefetch" href="/assets/js/45.729c1c39.js"><link rel="prefetch" href="/assets/js/46.5b924aea.js"><link rel="prefetch" href="/assets/js/47.f3990404.js"><link rel="prefetch" href="/assets/js/48.f591f360.js"><link rel="prefetch" href="/assets/js/49.f7f213ad.js"><link rel="prefetch" href="/assets/js/5.2c5d28b5.js"><link rel="prefetch" href="/assets/js/50.b9ca2762.js"><link rel="prefetch" href="/assets/js/51.93672ee6.js"><link rel="prefetch" href="/assets/js/52.fb21314a.js"><link rel="prefetch" href="/assets/js/53.65343ccc.js"><link rel="prefetch" href="/assets/js/54.8081227d.js"><link rel="prefetch" href="/assets/js/55.e207659e.js"><link rel="prefetch" href="/assets/js/56.bde381df.js"><link rel="prefetch" href="/assets/js/57.f8eceb45.js"><link rel="prefetch" href="/assets/js/58.bef70bfd.js"><link rel="prefetch" href="/assets/js/59.7ab7562d.js"><link rel="prefetch" href="/assets/js/6.fc65a1ac.js"><link rel="prefetch" href="/assets/js/60.f40ac3ca.js"><link rel="prefetch" href="/assets/js/61.d2b463ab.js"><link rel="prefetch" href="/assets/js/62.cfdf1bcf.js"><link rel="prefetch" href="/assets/js/63.1e45ce59.js"><link rel="prefetch" href="/assets/js/64.a98fe86e.js"><link rel="prefetch" href="/assets/js/65.0234d7c5.js"><link rel="prefetch" href="/assets/js/66.724906f0.js"><link rel="prefetch" href="/assets/js/67.7806fda6.js"><link rel="prefetch" href="/assets/js/68.9f227dae.js"><link rel="prefetch" href="/assets/js/69.fdbc56ac.js"><link rel="prefetch" href="/assets/js/7.284de54e.js"><link rel="prefetch" href="/assets/js/70.04a9cc03.js"><link rel="prefetch" href="/assets/js/71.a6fa1dd9.js"><link rel="prefetch" href="/assets/js/72.2f8e3aa0.js"><link rel="prefetch" href="/assets/js/73.9bbb0cb6.js"><link rel="prefetch" href="/assets/js/74.9f122255.js"><link rel="prefetch" href="/assets/js/75.75e1fbd8.js"><link rel="prefetch" href="/assets/js/76.60ff3c3e.js"><link rel="prefetch" href="/assets/js/77.39a253ae.js"><link rel="prefetch" href="/assets/js/78.0e49712f.js"><link rel="prefetch" href="/assets/js/79.5f9c24a0.js"><link rel="prefetch" href="/assets/js/8.5c21a4cc.js"><link rel="prefetch" href="/assets/js/80.f826f188.js"><link rel="prefetch" href="/assets/js/81.b8995ea7.js"><link rel="prefetch" href="/assets/js/82.e9bf63e0.js"><link rel="prefetch" href="/assets/js/83.e3a00749.js"><link rel="prefetch" href="/assets/js/84.b940927c.js"><link rel="prefetch" href="/assets/js/85.ad46a9b2.js"><link rel="prefetch" href="/assets/js/86.190e0071.js"><link rel="prefetch" href="/assets/js/87.5f9eb9ef.js"><link rel="prefetch" href="/assets/js/88.cfaf7469.js"><link rel="prefetch" href="/assets/js/89.e64cc32c.js"><link rel="prefetch" href="/assets/js/9.0723805d.js"><link rel="prefetch" href="/assets/js/90.805edabe.js"><link rel="prefetch" href="/assets/js/91.6a1ab3f7.js"><link rel="prefetch" href="/assets/js/92.04ecd01e.js"><link rel="prefetch" href="/assets/js/93.e615470a.js"><link rel="prefetch" href="/assets/js/94.0ad7c41c.js"><link rel="prefetch" href="/assets/js/95.0e5ce618.js"><link rel="prefetch" href="/assets/js/96.b59cf9f4.js"><link rel="prefetch" href="/assets/js/97.2a327746.js"><link rel="prefetch" href="/assets/js/98.9c01ec88.js"><link rel="prefetch" href="/assets/js/99.952046bd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ccac5a78.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://github.com/fluidicon.png" alt="独角兕大王" class="logo"> <span class="site-name can-hide">独角兕大王</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/python/" class="nav-link">
  Python
</a></div><div class="nav-item"><a href="/rust/" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/go/" class="nav-link router-link-active">
  Go
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/lua/" class="nav-link">
  Lua
</a></div><div class="nav-item"><a href="/C/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="https://github.com/wuyuz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/double-W/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cnblogs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/python/" class="nav-link">
  Python
</a></div><div class="nav-item"><a href="/rust/" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/go/" class="nav-link router-link-active">
  Go
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/lua/" class="nav-link">
  Lua
</a></div><div class="nav-item"><a href="/C/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="https://github.com/wuyuz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/double-W/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cnblogs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Go常用模块</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Go基础知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Go应用实例</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Go设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Go源码解析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Go微服务网关</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/go/project/Go微服务网关.html" class="active sidebar-link">微服务网关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/go/project/Go微服务网关.html#微服务网关" class="sidebar-link">微服务网关</a></li><li class="sidebar-sub-header"><a href="/go/project/Go微服务网关.html#网络代理" class="sidebar-link">网络代理</a></li><li class="sidebar-sub-header"><a href="/go/project/Go微服务网关.html#负载均衡策略" class="sidebar-link">负载均衡策略</a></li><li class="sidebar-sub-header"><a href="/go/project/Go微服务网关.html#中间件支持" class="sidebar-link">中间件支持</a></li><li class="sidebar-sub-header"><a href="/go/project/Go微服务网关.html#限流" class="sidebar-link">限流</a></li><li class="sidebar-sub-header"><a href="/go/project/Go微服务网关.html#熔断与降级" class="sidebar-link">熔断与降级</a></li><li class="sidebar-sub-header"><a href="/go/project/Go微服务网关.html#websocket" class="sidebar-link">WebSocket</a></li><li class="sidebar-sub-header"><a href="/go/project/Go微服务网关.html#http2" class="sidebar-link">http2</a></li><li class="sidebar-sub-header"><a href="/go/project/Go微服务网关.html#tcp代理" class="sidebar-link">Tcp代理</a></li><li class="sidebar-sub-header"><a href="/go/project/Go微服务网关.html#grpc透明代理" class="sidebar-link">gRPC透明代理</a></li><li class="sidebar-sub-header"><a href="/go/project/Go微服务网关.html#grpc实现反向代理" class="sidebar-link">gRPC实现反向代理</a></li><li class="sidebar-sub-header"><a href="/go/project/Go微服务网关.html#网关服务发现" class="sidebar-link">网关服务发现</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="微服务网关"><a href="#微服务网关" class="header-anchor">#</a> 微服务网关</h2> <p>Tcp为啥需要三次握手、四次挥手</p> <ul><li>三次握手主要目的是保证连接的双工（发送和接受可同时），可靠更多的是通过重传机制保证的</li></ul> <h4 id="三次握手"><a href="#三次握手" class="header-anchor">#</a> 三次握手</h4> <h4 id="四次挥手"><a href="#四次挥手" class="header-anchor">#</a> 四次挥手</h4> <p>1、为什么需要等待2MSL？</p> <ul><li>MSL： Maximum Segment Lifetime ,30s-60s</li> <li>保证Tcp连接的成功关闭，如果最后client的ACK包没有被服务端接收到，那么服务端将处于LAST-ACK阶段，需要客户端重传ACK，所以需要主动关闭方等待哈</li> <li>保证这次连接的重复数据段从网络中消息，也就是说如果马上又有一个连接从客户端的这个端口发起，等待2msl保证上次的重传或者连接能成功清除，不会混淆到下一个连接中</li></ul> <p>2、为撒会出现大量的close_wait?</p> <ul><li>首先close_wait一般出现在被动关闭方，因为服务端没有关闭连接</li> <li>并发请求太多</li> <li>被动关闭方没有及时释放端口资源导致，卡在close_wait,程序就结束了</li></ul> <h4 id="使用抓包工具分析"><a href="#使用抓包工具分析" class="header-anchor">#</a> 使用抓包工具分析</h4> <h4 id="tcp为啥需要流量控制"><a href="#tcp为啥需要流量控制" class="header-anchor">#</a> Tcp为啥需要流量控制</h4> <ul><li>由于通讯双方，网速不同，通讯方任一方发送过快都会导致对方消息处理不过来，所以需要把数据放到缓冲区中</li> <li>如果缓冲区满了，发送方还在发送，那接收方只能把数据包丢弃，因此需要控制发送速率</li> <li>我们缓冲区剩余大小称之为接受窗口，用变量win表示，如果win=0，则发送方停止发送</li></ul> <h4 id="tcp为撒需要拥塞控制"><a href="#tcp为撒需要拥塞控制" class="header-anchor">#</a> Tcp为撒需要拥塞控制</h4> <ul><li>流量控制与拥塞控制是两个概念，拥塞控制是调节网络负载</li> <li>接受方网络资源繁忙，因未及时响应ACK导致发送方重传大量数据，这样将会导致网络更加拥堵</li> <li>拥塞控制是动态调整win大小，不只是依赖缓冲区大小确定窗口大小</li></ul> <h4 id="为什么会出现粘-拆包"><a href="#为什么会出现粘-拆包" class="header-anchor">#</a> 为什么会出现粘/拆包</h4> <ul><li>应用程序写入的数据大于套接字缓冲区大小，这将会发生拆包</li> <li>应用程序写入数据小于套接字缓冲区的大小，网卡将应用多次写入数据发送到网络上，这将发生粘包</li> <li>进行mss（最大报文长度）大小的Tcp分段，当Tcp报文长度-Tcp头部长度&gt;mss的时候拆包</li></ul> <p>如何避免粘包/拆包，获取完成数据报文？</p> <ul><li>使用带消息头的协议，头部写入包长度，然后读取指定长度</li> <li>设置定长消息</li> <li>设置消息边界</li> <li>更复杂的协议：json、protobuf</li></ul> <p>代码实现：</p> <p>Unpack/pack.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> unpack

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;encoding/binary&quot;</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;io&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> Msg_hander <span class="token operator">=</span><span class="token string">&quot;12345678&quot;</span>

<span class="token comment">// 编码</span>
<span class="token keyword">func</span> <span class="token function">Encode</span><span class="token punctuation">(</span>bytesByffer io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> content <span class="token builtin">string</span><span class="token punctuation">)</span>  <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// msg_handle + content_len + content</span>
	<span class="token comment">// 8 + 4 + len</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> binary<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>bytesByffer<span class="token punctuation">,</span>binary<span class="token punctuation">.</span>BigEndian<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>Msg_hander<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>  <span class="token comment">// 使用二进制编码</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	clen <span class="token operator">:=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 转化为32位，4字节的长度</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> binary<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>bytesByffer<span class="token punctuation">,</span>binary<span class="token punctuation">.</span>BigEndian<span class="token punctuation">,</span>clen<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> binary<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>bytesByffer<span class="token punctuation">,</span>binary<span class="token punctuation">.</span>BigEndian<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 解码</span>
<span class="token keyword">func</span> <span class="token function">Decode</span><span class="token punctuation">(</span>bytesBuffer io<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span> <span class="token punctuation">(</span>bodyBuf <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	MagicBuf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span><span class="token function">len</span><span class="token punctuation">(</span>Msg_hander<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err  <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>bytesBuffer<span class="token punctuation">,</span>MagicBuf<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span> <span class="token punctuation">,</span>err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">string</span><span class="token punctuation">(</span>MagicBuf<span class="token punctuation">)</span> <span class="token operator">!=</span> Msg_hander <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span> <span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;msg_hander error&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	lengthBuf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>bytesBuffer<span class="token punctuation">,</span>lengthBuf<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span> <span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;length error&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	length <span class="token operator">:=</span> binary<span class="token punctuation">.</span>BigEndian<span class="token punctuation">.</span><span class="token function">Uint32</span><span class="token punctuation">(</span>lengthBuf<span class="token punctuation">)</span>
	bodyBuf <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>bytesBuffer<span class="token punctuation">,</span>bodyBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span> <span class="token punctuation">,</span>err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> bodyBuf<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>client.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1、 连接服务器</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0.0.0.0:9999&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;connect failed&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	unpack<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token string">&quot;hello, world 000 !!!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Server.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">process</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		buf<span class="token punctuation">,</span> err <span class="token operator">:=</span> unpack<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;read from connect failed , err: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		str <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;receive from client, data: %v\n&quot;</span><span class="token punctuation">,</span>str<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// 1、监听端口</span>
	listern<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0.0.0.0:9999&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;listen fail,err: %v\n&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 2、建立套接字连接</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> listern<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;accept fail,err : %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 3、协程处理监听服务</span>
		<span class="token keyword">go</span> <span class="token function">process</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="tcp拥塞控制"><a href="#tcp拥塞控制" class="header-anchor">#</a> Tcp拥塞控制</h4> <ul><li>慢开始和拥塞避免</li> <li>快速重传和快速恢复</li></ul> <h4 id="udp连接通信"><a href="#udp连接通信" class="header-anchor">#</a> Udp连接通信</h4> <p>Client.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 监听服务器</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span>  net<span class="token punctuation">.</span><span class="token function">DialUDP</span><span class="token punctuation">(</span><span class="token string">&quot;udp&quot;</span><span class="token punctuation">,</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>net<span class="token punctuation">.</span>UDPAddr<span class="token punctuation">{</span>
		IP<span class="token punctuation">:</span>   net<span class="token punctuation">.</span><span class="token function">IPv4</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Port<span class="token punctuation">:</span> <span class="token number">9909</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;listen failed&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span>err <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;hello server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;send data failed :%v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span><span class="token number">1024</span><span class="token punctuation">)</span>
		n<span class="token punctuation">,</span> remoteAddr<span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">ReadFromUDP</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;receive data failed %v&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;recevice data: %v, addr: %v  \n&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>remoteAddr<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Server.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 监听服务器</span>
	listen<span class="token punctuation">,</span> err <span class="token operator">:=</span>  net<span class="token punctuation">.</span><span class="token function">ListenUDP</span><span class="token punctuation">(</span><span class="token string">&quot;udp&quot;</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>net<span class="token punctuation">.</span>UDPAddr<span class="token punctuation">{</span>
		IP<span class="token punctuation">:</span>   net<span class="token punctuation">.</span><span class="token function">IPv4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Port<span class="token punctuation">:</span> <span class="token number">9909</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;listen failed&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> data <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
		n<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> err <span class="token operator">:=</span> listen<span class="token punctuation">.</span><span class="token function">ReadFromUDP</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;read failed from addr: %s&quot;</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;read failed from addr: %s ,data:%v, count:%v\n&quot;</span><span class="token punctuation">,</span>addr<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span>
			<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> listen<span class="token punctuation">.</span><span class="token function">WriteToUDP</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;received sucess&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;write failed : %v&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="tcp连接通信"><a href="#tcp连接通信" class="header-anchor">#</a> Tcp连接通信</h4> <p>server端</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;net&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">process</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 如果服务端不主动关闭，会怎么样？</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> buf <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
		n<span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;read from connect failed , err: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		str <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;receive from client, data: %v\n&quot;</span><span class="token punctuation">,</span>str<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// 1、监听端口</span>
	listern<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0.0.0.0:9999&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;listen fail,err: %v\n&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 2、建立套接字连接</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> listern<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;accept fail,err : %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 3、协程处理监听服务</span>
		<span class="token keyword">go</span> <span class="token function">process</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>client端</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1、 连接服务器</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0.0.0.0:9999&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 思考：如果不关闭回发生什么？如果客户端不主动关闭连接，该连接还是会保持着占用</span>

	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;connect failed&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 2、读取命令行输入</span>
	inputReader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		input<span class="token punctuation">,</span> err <span class="token operator">:=</span> inputReader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;read from console failed&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 4、读取Q停止</span>
		trimmedInput <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
		<span class="token keyword">if</span> trimmedInput <span class="token operator">==</span> <span class="token string">&quot;Q&quot;</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 5、回复消息</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> docke<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>trimmedInput<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;write failed, err : %s\v&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意：如果是服务端没有主动关闭连接的动作，那么将会使得client端处于“fin_wait&quot;阶段、服务端处于“close_wait&quot;阶段（服务端协程已经关闭）</p> <h4 id="http服务通信"><a href="#http服务通信" class="header-anchor">#</a> Http服务通信</h4> <p>server端</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	Addr <span class="token operator">=</span> <span class="token string">&quot;:1212&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">sayBye</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;bye bye&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 创建路由器</span>
	mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 设置路由规则</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/bye&quot;</span><span class="token punctuation">,</span>sayBye<span class="token punctuation">)</span>

	<span class="token comment">// 创建服务器</span>
	server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span> Addr<span class="token punctuation">,</span>
		WriteTimeout<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">,</span>
		Handler<span class="token punctuation">:</span> mux<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 监听端口并提供服务</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpServer at &quot;</span><span class="token punctuation">,</span> Addr<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>client端</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io/ioutil&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 创建连接池</span>
	transport <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">{</span>
		DialContext<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>net<span class="token punctuation">.</span>Dialer<span class="token punctuation">{</span>
			Timeout<span class="token punctuation">:</span>       <span class="token number">30</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>  <span class="token comment">// 连接超时</span>
			KeepAlive<span class="token punctuation">:</span>     <span class="token number">30</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>  <span class="token comment">// 长连接超时时间</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DialContext<span class="token punctuation">,</span>
		MaxIdleConns<span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">,</span>    <span class="token comment">// 最大空闲连接</span>
		IdleConnTimeout<span class="token punctuation">:</span><span class="token number">90</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>  <span class="token comment">//  空闲超时使劲啊</span>
		TLSHandshakeTimeout<span class="token punctuation">:</span><span class="token number">10</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>  <span class="token comment">//  tls握手超时时间</span>
		ExpectContinueTimeout<span class="token punctuation">:</span><span class="token number">1</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>  <span class="token comment">//  100-continue状态吗超时时间</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//  创建客户端</span>
	client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{</span>
		Timeout<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">,</span>
		Transport<span class="token punctuation">:</span>transport<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 请求数据</span>
	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:1212/bye&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span>  <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 不释放会独占内存</span>
	<span class="token comment">// 读取数据</span>
	bas<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span>  <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>bas<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="网络代理"><a href="#网络代理" class="header-anchor">#</a> 网络代理</h2> <ul><li>用户通过代理请求信息</li> <li>请求通过网络代理完成转发到达目标服务器</li> <li>目标服务器响应后通过网络代理回传给用户</li></ul> <p>网络转发： 客户端ip ——&gt; 经过路由转发 ——&gt; 目标服务器</p> <ul><li>也就是说网络转发是路由器对报文的转发操作，中间可能对数据包进行修改</li></ul> <p>网络代理： 客户端ip（携带代理服务器的ip）——&gt; 代理服务器 ——&gt; 分发服务到后台服务</p> <ul><li>用户不直接连接服务器，网络代理去连接，获取数据后返回给用户</li></ul> <h4 id="正向代理"><a href="#正向代理" class="header-anchor">#</a> 正向代理</h4> <ul><li><p>是一种客户端的代理技术，帮助客户端访问无法访问的服务资源，可以隐藏用户的真实IP，比如浏览器web代理，VPN等</p></li> <li><p>实现一个web浏览器代理：</p> <ul><li><p>代理接受客户端请求，复制原请求对象，并根据数据配置新请求各种参数</p></li> <li><p>把新请求发送到真实服务端，并接收到服务端返回</p></li> <li><p>代理服务器对响应做一些处理，然后返回给客户端</p> <div class="language- extra-class"><pre class="language-text"><code>用户请求——&gt;代理服务器监听——&gt;交给上游TCP连接——&gt;回调方法——&gt;拷贝请求数据——&gt;请求下游服务Transport RoundTrip——&gt;回写上游数据
</code></pre></div></li></ul></li> <li><p>代码实现：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Pxy <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pxy<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>rw http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Received request %s %s %s\n&quot;</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>Method<span class="token punctuation">,</span>req<span class="token punctuation">.</span>Host<span class="token punctuation">,</span>req<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">)</span>
	transport <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultTransport   <span class="token comment">// 数据连接池</span>
	<span class="token comment">// step1, 浅拷贝对象，然后就再新增属性数据，因为浅拷贝可以保存新增属性</span>
	outReq <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span>
	<span class="token operator">*</span>outReq <span class="token operator">=</span> <span class="token operator">*</span>req

	<span class="token keyword">if</span> clienIP<span class="token punctuation">,</span><span class="token boolean">_</span><span class="token punctuation">,</span>err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> prior<span class="token punctuation">,</span>ok <span class="token operator">:=</span> outReq<span class="token punctuation">.</span>Header<span class="token punctuation">[</span><span class="token string">&quot;X-Forwarded-For&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>ok <span class="token punctuation">{</span> <span class="token comment">// X-Forwarded-For 是一个代理Ip的链表</span>
			clienIP <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>prior<span class="token punctuation">,</span><span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span><span class="token operator">+</span>clienIP
		<span class="token punctuation">}</span>
		outReq<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;X-Forwarded-For&quot;</span><span class="token punctuation">,</span>clienIP<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// step2, 请求下游</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> transport<span class="token punctuation">.</span><span class="token function">RoundTrip</span><span class="token punctuation">(</span>outReq<span class="token punctuation">)</span> <span class="token comment">// 获取到下游的响应数据</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		rw<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadGateway<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// step3, 下游请求内容返回给上游</span>
	<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> res<span class="token punctuation">.</span>Header <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> value <span class="token punctuation">{</span>
			rw<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>v<span class="token punctuation">)</span>  <span class="token comment">// 头写入</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//rw.Header().Add(&quot;xxx&quot;,&quot;sss&quot;)  // 可以给每个请求进行修改</span>
	rw<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span>res<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>  <span class="token comment">// 数据写入</span>
	res<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Serve on :8080&quot;</span><span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>Pxy<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// Handle中的第二个参数必须实现ServeHTTP</span>
	http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;0.0.0.0:8080&quot;</span><span class="token punctuation">,</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>服务启动后，打开浏览器，设置网络代理，设置好web网页代理到127.0.0.1,端口为8080，然后去访问一个http网址，如：www.tianya.cn</p></li></ul> <h4 id="反向代理"><a href="#反向代理" class="header-anchor">#</a> 反向代理</h4> <ul><li><p>是一种服务端的代理技术，帮助服务器做负载均衡、缓存、提供安全校验等，可以隐藏服务器真实IP，比如LVS技术、nginx proxy_pass等，所以我们可以在这做：负载、安全校验等功能</p> <ul><li>代理接收客户端请求，更改请求结构体信息</li> <li>通过一定的负载均衡算法获取下游服务地址</li> <li>把请求发送到下游服务器，并获取返回内容</li> <li>对返回内容做一些处理，返回给客户端</li></ul> <p>简单的http代理服务实现：</p> <p>real_server/main.go: 真实后端服务</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;os/signal&quot;</span>
	<span class="token string">&quot;syscall&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> RealServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Addr <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">HelloHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//127.0.0.1:8008/abc?sdsdsa=11</span>
	<span class="token comment">//r.Addr=127.0.0.1:8008</span>
	<span class="token comment">//req.URL.Path=/abc</span>
	upath <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;http://%s%s\n&quot;</span><span class="token punctuation">,</span>r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span>req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
	realIp <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;RemoteAddr=%s,X-Forwarded-For=%v,X-Real-IP=%v\n&quot;</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">,</span>req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;X-Forwarded-For&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;X-Real-Ip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	header <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;headers=%v\n&quot;</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>Header<span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span>upath<span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span>realIp<span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span>header<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">ErrorHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	upath <span class="token operator">:=</span> <span class="token string">&quot;error handler&quot;</span>
	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">TimeoutHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	upath <span class="token operator">:=</span> <span class="token string">&quot;timeout handler&quot;</span>
	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpServer at: &quot;</span><span class="token punctuation">,</span>r<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
	mux  <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>r<span class="token punctuation">.</span>HelloHandler<span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/base/error&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ErrorHandler<span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/test_http_string/test_http_string/aaa&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>TimeoutHandler<span class="token punctuation">)</span>
	server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>         r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span>
		WriteTimeout<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>
		Handler<span class="token punctuation">:</span>      mux<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rs1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">}</span>
	rs1<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	rs2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">}</span>
	rs2<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
	signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Got signal:&quot;</span><span class="token punctuation">,</span> <span class="token operator">&lt;-</span>quit<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>reverse_proxy_base/main.go： 反向代理服务</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	proxy_addr <span class="token operator">=</span> <span class="token string">&quot;http://127.0.0.1:2003&quot;</span>
	port <span class="token operator">=</span> <span class="token string">&quot;2002&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">handler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span>r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// step1 解析代理地址，并更改请求体的协议和主体</span>
	proxy<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>proxy_addr<span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> proxy<span class="token punctuation">.</span>Scheme <span class="token comment">// 协议</span>
	r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Host <span class="token operator">=</span> proxy<span class="token punctuation">.</span>Host

	<span class="token comment">// step2 请求下游服务</span>
	transport <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultTransport
	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> transport<span class="token punctuation">.</span><span class="token function">RoundTrip</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// step3 把下游请求内容返回给上游</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> vv <span class="token operator">:=</span> <span class="token keyword">range</span> resp<span class="token punctuation">.</span>Header <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> vv <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>v<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteTo</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>  <span class="token comment">// 将拿到的下游响应写入</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>handler<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Start serving on port: &quot;</span><span class="token punctuation">,</span>port<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span>port<span class="token punctuation">,</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面实现了2002代理2003端口的服务</p></li></ul> <h4 id="http代理"><a href="#http代理" class="header-anchor">#</a> HTTP代理</h4> <p>之前的是实现了简单的网络代理，其实我们可以在此基础上实现更为复杂的其他功能：</p> <ul><li>错误回调、错误日志处理</li> <li>更改代理返回内容</li> <li>负载均衡</li> <li>url重写</li> <li>限流、熔断、降级</li> <li>数据统计、权限验证等</li></ul> <p>我们以后会使用ReverseProxy来实现如上功能:</p> <ul><li>4种负载轮询类型的实现和接口封装</li> <li>拓展中间件支持：限流、熔断、权限、统计等</li></ul> <h5 id="reverseproxy结构"><a href="#reverseproxy结构" class="header-anchor">#</a> ReverseProxy结构</h5> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> ReverseProxy <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// Director must be a function which modifies</span>
	<span class="token comment">// the request into a new request to be sent</span>
	<span class="token comment">// using Transport. Its response is then copied</span>
	<span class="token comment">// back to the original client unmodified.</span>
	<span class="token comment">// Director must not access the provided Request</span>
	<span class="token comment">// after returning.</span>
	Director <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span>  <span class="token comment">// 控制器，一个函数，可以对请求内容进行修改，如请求参数</span>

	<span class="token comment">// The transport used to perform proxy requests.</span>
	<span class="token comment">// If nil, http.DefaultTransport is used.</span>
	Transport http<span class="token punctuation">.</span>RoundTripper  <span class="token comment">// 连接池，默认是DefaultTransport</span>

	<span class="token comment">// FlushInterval specifies the flush interval</span>
	<span class="token comment">// to flush to the client while copying the</span>
	<span class="token comment">// response body.</span>
	<span class="token comment">// If zero, no periodic flushing is done.</span>
	<span class="token comment">// A negative value means to flush immediately</span>
	<span class="token comment">// after each write to the client.</span>
	<span class="token comment">// The FlushInterval is ignored when ReverseProxy</span>
	<span class="token comment">// recognizes a response as a streaming response;</span>
	<span class="token comment">// for such responses, writes are flushed to the client</span>
	<span class="token comment">// immediately.</span>
	FlushInterval time<span class="token punctuation">.</span>Duration  <span class="token comment">// 客户端的刷新问题</span>

	<span class="token comment">// ErrorLog specifies an optional logger for errors</span>
	<span class="token comment">// that occur when attempting to proxy the request.</span>
	<span class="token comment">// If nil, logging is done via the log package's standard logger.</span>
	ErrorLog <span class="token operator">*</span>log<span class="token punctuation">.</span>Logger  <span class="token comment">// 错误记录器</span>

	<span class="token comment">// BufferPool optionally specifies a buffer pool to</span>
	<span class="token comment">// get byte slices for use by io.CopyBuffer when</span>
	<span class="token comment">// copying HTTP response bodies.</span>
	BufferPool BufferPool  <span class="token comment">// 定义一个缓冲池，在复制http相应时使用，提高请求效率</span>

	<span class="token comment">// ModifyResponse is an optional function that modifies the</span>
	<span class="token comment">// Response from the backend. It is called if the backend</span>
	<span class="token comment">// returns a response at all, with any HTTP status code.</span>
	<span class="token comment">// If the backend is unreachable, the optional ErrorHandler is</span>
	<span class="token comment">// called without any call to ModifyResponse.</span>
	<span class="token comment">//</span>
	<span class="token comment">// If ModifyResponse returns an error, ErrorHandler is called</span>
	<span class="token comment">// with its error value. If ErrorHandler is nil, its default</span>
	<span class="token comment">// implementation is used.</span>
	ModifyResponse <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span>  <span class="token comment">// 修改response的函数，修改响应内容，如果有error会触发下面的ErrorHandler</span>

	<span class="token comment">// ErrorHandler is an optional function that handles errors</span>
	<span class="token comment">// reaching the backend or errors from ModifyResponse.</span>
	<span class="token comment">//</span>
	<span class="token comment">// If nil, the default is to log the provided error and return</span>
	<span class="token comment">// a 502 Status Bad Gateway response.</span>
	ErrorHandler <span class="token keyword">func</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>  <span class="token comment">// 错误处理回调函数，如果为nil，遇到错误返回502</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="重写url"><a href="#重写url" class="header-anchor">#</a> 重写URL</h5> <p>简单实用ReverseProxy来实现反向代理</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/http/httputil&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">var</span> add <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2002&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 需要代理的下游服务url</span>
	rs1 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2003/base&quot;</span>  <span class="token comment">// 实现了重写url的规则</span>
	<span class="token comment">//127.0.0.1:2002/xxx</span>
	<span class="token comment">//127.0.0.1:2003/base/xxx</span>
	url1<span class="token punctuation">,</span>err1 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs1<span class="token punctuation">)</span>  <span class="token comment">// 解析url</span>
	<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err1<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	proxy <span class="token operator">:=</span> httputil<span class="token punctuation">.</span><span class="token function">NewSingleHostReverseProxy</span><span class="token punctuation">(</span>url1<span class="token punctuation">)</span> <span class="token comment">// 传递个url进去后，实现了一个direct，然后注册到ReverseProxy并返回</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpServer at: &quot;</span><span class="token operator">+</span>add<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>add<span class="token punctuation">,</span>proxy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// proxy中实现了Handler接口中的ServeHTTP</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="更改内容"><a href="#更改内容" class="header-anchor">#</a> 更改内容</h5> <p>reverse_proxy_step/main.go：重写下游返回的响应体，2002代理2003的服务</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bytes&quot;</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io/ioutil&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/http/httputil&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
	<span class="token string">&quot;regexp&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> addr <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2002&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//127.0.0.1:2002/xxx</span>
	<span class="token comment">//127.0.0.1:2003/base/xxx</span>
	rs1 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2003/base&quot;</span>
	url1<span class="token punctuation">,</span> err1 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs1<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err1<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	proxy <span class="token operator">:=</span> <span class="token function">NewSingleHostReverseProxy</span><span class="token punctuation">(</span>url1<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewSingleHostReverseProxy</span><span class="token punctuation">(</span>target <span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">)</span> <span class="token operator">*</span>httputil<span class="token punctuation">.</span>ReverseProxy <span class="token punctuation">{</span>
	<span class="token comment">//http://127.0.0.1:2002/dir?name=123</span>
	<span class="token comment">//RayQuery: name=123</span>
	<span class="token comment">//Scheme: http</span>
	<span class="token comment">//Host: 127.0.0.1:2002</span>
	targetQuery <span class="token operator">:=</span> target<span class="token punctuation">.</span>RawQuery
	<span class="token comment">// 请求体参数修改</span>
	director <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//url_rewrite</span>
		<span class="token comment">//127.0.0.1:2002/dir/abc ==&gt; 127.0.0.1:2003/base/abc ??</span>
		<span class="token comment">//127.0.0.1:2002/dir/abc ==&gt; 127.0.0.1:2002/abc</span>
		<span class="token comment">//127.0.0.1:2002/abc ==&gt; 127.0.0.1:2003/base/abc</span>
		re<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token string">&quot;^/dir(.*)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">ReplaceAllString</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> <span class="token string">&quot;$1&quot;</span><span class="token punctuation">)</span>  <span class="token comment">// 正则掉所有dir后面的地址，放在新的path中</span>

		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> target<span class="token punctuation">.</span>Scheme
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Host <span class="token operator">=</span> target<span class="token punctuation">.</span>Host

		<span class="token comment">//target.Path : /base</span>
		<span class="token comment">//req.URL.Path : /dir</span>
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
		<span class="token keyword">if</span> targetQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">[</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 定义返回响应的函数</span>
	modifyFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>res <span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		<span class="token comment">// 错误码时返回</span>
		<span class="token keyword">if</span> res<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;error statusCode&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 正常情况下直接修改返回体</span>
		oldPayload<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>  <span class="token comment">// 拿到返回内容</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
		newPayLoad <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;hello &quot;</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>oldPayload<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 追加新内容</span>
		res<span class="token punctuation">.</span>Body <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>newPayLoad<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// NopCloser用一个无操作的Close方法包装r返回一个ReadCloser接口。因为res.Body是一个io.ReaderClose</span>
		res<span class="token punctuation">.</span>ContentLength <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>newPayLoad<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 修改响应长度</span>
		res<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprint</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>newPayLoad<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 如果modifyFunc有返回error，则触犯这个错误回调</span>
	errorHandler <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>res http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>httputil<span class="token punctuation">.</span>ReverseProxy<span class="token punctuation">{</span>Director<span class="token punctuation">:</span> director<span class="token punctuation">,</span> ModifyResponse<span class="token punctuation">:</span> modifyFunc<span class="token punctuation">,</span> ErrorHandler<span class="token punctuation">:</span> errorHandler<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token comment">// URL路径拼接</span>
	aslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	bslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">switch</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> aslash <span class="token operator">&amp;&amp;</span> bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token keyword">case</span> <span class="token operator">!</span>aslash <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> b
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>
</code></pre></div><h2 id="负载均衡策略"><a href="#负载均衡策略" class="header-anchor">#</a> 负载均衡策略</h2> <ul><li><p>随机负载</p> <p>随机挑选目标服务器IP</p></li> <li><p>轮询负载</p> <p>ABC三台服务器，ABCABC依次轮询</p></li> <li><p>加权负载</p> <p>给目标设置访问权重，按照权重轮询</p></li> <li><p>一致性hash负载</p> <p>请求固定URL访问指定IP</p></li></ul> <h4 id="随机负载"><a href="#随机负载" class="header-anchor">#</a> 随机负载</h4> <ul><li><p>random.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> RandomBalance <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	currIndex <span class="token builtin">int</span>
	rss <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	<span class="token comment">// 观察主体</span>
<span class="token punctuation">}</span>

<span class="token comment">// 添加元素</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RandomBalance<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>params <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;param len 1 at least&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	add <span class="token operator">:=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	r<span class="token punctuation">.</span>rss<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">,</span>add<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 轮询取得</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RandomBalance<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>
	<span class="token punctuation">}</span>
	r<span class="token punctuation">.</span>currIndex <span class="token operator">=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> r<span class="token punctuation">.</span>rss<span class="token punctuation">[</span>r<span class="token punctuation">.</span>currIndex<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RandomBalance<span class="token punctuation">)</span>  <span class="token function">Get</span><span class="token punctuation">(</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> r<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>random_test.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestRandomBalance</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rb <span class="token operator">:=</span> <span class="token operator">&amp;</span>RandomBalance<span class="token punctuation">{</span><span class="token punctuation">}</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">)</span> <span class="token comment">//0</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">)</span> <span class="token comment">//1</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2005&quot;</span><span class="token punctuation">)</span> <span class="token comment">//2</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2006&quot;</span><span class="token punctuation">)</span> <span class="token comment">//3</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2007&quot;</span><span class="token punctuation">)</span> <span class="token comment">//4</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h4 id="轮询负载"><a href="#轮询负载" class="header-anchor">#</a> 轮询负载</h4> <ul><li><p>round_robin.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> RoundRobinBalance <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	curIndex <span class="token builtin">int</span>
	rss      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	<span class="token comment">//观察主体</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RoundRobinBalance<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>params <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;param len 1 at least&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	r<span class="token punctuation">.</span>rss <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RoundRobinBalance<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>
	<span class="token punctuation">}</span>
	lens <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">)</span> <span class="token comment">//5</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>curIndex <span class="token operator">&gt;=</span> lens <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>curIndex <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	curAddr <span class="token operator">:=</span> r<span class="token punctuation">.</span>rss<span class="token punctuation">[</span>r<span class="token punctuation">.</span>curIndex<span class="token punctuation">]</span>
	r<span class="token punctuation">.</span>curIndex <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>curIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> lens
	<span class="token keyword">return</span> curAddr
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>Robin_test.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Test_main</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rb <span class="token operator">:=</span> <span class="token operator">&amp;</span>RoundRobinBalance<span class="token punctuation">{</span><span class="token punctuation">}</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">)</span> <span class="token comment">//0</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">)</span> <span class="token comment">//1</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2005&quot;</span><span class="token punctuation">)</span> <span class="token comment">//2</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2006&quot;</span><span class="token punctuation">)</span> <span class="token comment">//3</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2007&quot;</span><span class="token punctuation">)</span> <span class="token comment">//4</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h4 id="加权轮询负载"><a href="#加权轮询负载" class="header-anchor">#</a> 加权轮询负载</h4> <ul><li><p>有三个概念：</p> <div class="language- extra-class"><pre class="language-text"><code>1、weight: 初始化时对节点约定的加权
2、currentWeight： 节点临时权重，每轮都会变化
3、effectWeight：节点有效权重，默认与weight相同
4、totalWeight: 所有节点有效权重之和：sum(effectweight)

忽略了有效权重，算法：
1、currentWeight=currentWeight+effectWeight
2、选中最大的currentWeight
3、currentWeight=currentWeight-totalWeight
</code></pre></div><table><thead><tr><th>请求次数</th> <th>请求currentWeight</th> <th>选中节点</th> <th>请求后的currentWeight</th></tr></thead> <tbody><tr><td>1</td> <td>serverA=4，serverB=3,serverC=2</td> <td>serverA</td> <td>serverA=-1,serverB=3,serverC=2</td></tr> <tr><td>2</td> <td>serverA=-1,serverB=3,serverC=4</td> <td>serverB</td> <td>serverA=3,serverB=0,serverC=6</td></tr> <tr><td>3</td> <td>serverA=3,serverB=0,serverC=6</td> <td>serverC</td> <td>serverA=7,serverB=3,serverC=-1</td></tr></tbody></table></li></ul> <h4 id="一致性hash负载"><a href="#一致性hash负载" class="header-anchor">#</a> 一致性hash负载</h4> <ul><li><p>hash_robin.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> load_balance

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;hash/crc32&quot;</span>
	<span class="token string">&quot;sort&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Hash <span class="token keyword">func</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">uint32</span>

<span class="token keyword">type</span> UInt32Slice <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s UInt32Slice<span class="token punctuation">)</span> <span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s UInt32Slice<span class="token punctuation">)</span> <span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> s<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s UInt32Slice<span class="token punctuation">)</span> <span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConsistentHashBanlance <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mux      sync<span class="token punctuation">.</span>RWMutex
	hash     Hash
	replicas <span class="token builtin">int</span>               <span class="token comment">//复制因子</span>
	keys     UInt32Slice       <span class="token comment">//已排序的节点hash切片</span>
	hashMap  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint32</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">//节点哈希和Key的map,键是hash值，值是节点key</span>

	<span class="token comment">//观察主体</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewConsistentHashBanlance</span><span class="token punctuation">(</span>replicas <span class="token builtin">int</span><span class="token punctuation">,</span> fn Hash<span class="token punctuation">)</span> <span class="token operator">*</span>ConsistentHashBanlance <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> <span class="token operator">&amp;</span>ConsistentHashBanlance<span class="token punctuation">{</span>
		replicas<span class="token punctuation">:</span> replicas<span class="token punctuation">,</span>
		hash<span class="token punctuation">:</span>     fn<span class="token punctuation">,</span>
		hashMap<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint32</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> m<span class="token punctuation">.</span>hash <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">//最多32位,保证是一个2^32-1环</span>
		m<span class="token punctuation">.</span>hash <span class="token operator">=</span> crc32<span class="token punctuation">.</span>ChecksumIEEE
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> m
<span class="token punctuation">}</span>

<span class="token comment">// 验证是否为空</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConsistentHashBanlance<span class="token punctuation">)</span> <span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token comment">// Add 方法用来添加缓存节点，参数为节点key，比如使用IP</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConsistentHashBanlance<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>params <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;param len 1 at least&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	c<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 结合复制因子计算所有虚拟节点的hash值，并存入m.keys中，同时在m.hashMap中保存哈希值和key的映射</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> c<span class="token punctuation">.</span>replicas<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		hash <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>hashMap<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> addr
	<span class="token punctuation">}</span>
	<span class="token comment">// 对所有虚拟节点的哈希值进行排序，方便之后进行二分查找</span>
	sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// Get 方法根据给定的对象获取最靠近它的那个节点</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConsistentHashBanlance<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;node is empty&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	hash <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// 通过二分查找获取最优节点，第一个&quot;服务器hash&quot;值大于&quot;数据hash&quot;值的就是最优&quot;服务器节点&quot;</span>
	idx <span class="token operator">:=</span> sort<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> c<span class="token punctuation">.</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> hash <span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">// 如果查找结果 大于 服务器节点哈希数组的最大索引，表示此时该对象哈希值位于最后一个节点之后，那么放入第一个节点中</span>
	<span class="token keyword">if</span> idx <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		idx <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>hashMap<span class="token punctuation">[</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>hash_test.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestNewConsistentHashBanlance</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rb <span class="token operator">:=</span> <span class="token function">NewConsistentHashBanlance</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">)</span> <span class="token comment">//0</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">)</span> <span class="token comment">//1</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2005&quot;</span><span class="token punctuation">)</span> <span class="token comment">//2</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2006&quot;</span><span class="token punctuation">)</span> <span class="token comment">//3</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2007&quot;</span><span class="token punctuation">)</span> <span class="token comment">//4</span>

	<span class="token comment">//url hash</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2002/base/getinfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2002/base/error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2002/base/getinfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2002/base/changepwd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">//ip hash</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h4 id="负载工厂模式"><a href="#负载工厂模式" class="header-anchor">#</a> 负载工厂模式</h4> <ul><li><p>factory.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> load_balance

<span class="token keyword">type</span> LbType <span class="token builtin">int</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	LbRandom LbType <span class="token operator">=</span> <span class="token boolean">iota</span>
	LbRoundRobin
	LbWeightRoundRobin
	LbConsistentHash
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">LoadBanlanceFactory</span><span class="token punctuation">(</span>lbType LbType<span class="token punctuation">)</span> LoadBalance <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> lbType <span class="token punctuation">{</span>
	<span class="token keyword">case</span> LbRandom<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>RandomBalance<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">case</span> LbConsistentHash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">NewConsistentHashBanlance</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> LbRoundRobin<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>RoundRobinBalance<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">case</span> LbWeightRoundRobin<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>WeightRoundRobinBalance<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>RandomBalance<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>interface.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> load_balance

<span class="token keyword">type</span> LoadBalance <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">Get</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div></li> <li><p>factory_test.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> load_balance

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bytes&quot;</span>
	<span class="token string">&quot;io/ioutil&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/http/httputil&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	addr      <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2002&quot;</span>
	transport <span class="token operator">=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">{</span>
		DialContext<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>net<span class="token punctuation">.</span>Dialer<span class="token punctuation">{</span>
			Timeout<span class="token punctuation">:</span>   <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//连接超时</span>
			KeepAlive<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//长连接超时时间</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DialContext<span class="token punctuation">,</span>
		MaxIdleConns<span class="token punctuation">:</span>          <span class="token number">100</span><span class="token punctuation">,</span>              <span class="token comment">//最大空闲连接</span>
		IdleConnTimeout<span class="token punctuation">:</span>       <span class="token number">90</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//空闲超时时间</span>
		TLSHandshakeTimeout<span class="token punctuation">:</span>   <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//tls握手超时时间</span>
		ExpectContinueTimeout<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>  <span class="token comment">//100-continue状态码超时时间</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">NewMultipleHostsReverseProxy</span><span class="token punctuation">(</span>lb LoadBalance<span class="token punctuation">)</span> <span class="token operator">*</span>httputil<span class="token punctuation">.</span>ReverseProxy <span class="token punctuation">{</span>
	<span class="token comment">//请求协调者</span>
	director <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		nextAddr<span class="token punctuation">,</span> err <span class="token operator">:=</span> lb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 通过URL的变化来负载分配,也可以根据RemoteIP来</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;get next addr fail&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		target<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>nextAddr<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		targetQuery <span class="token operator">:=</span> target<span class="token punctuation">.</span>RawQuery
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> target<span class="token punctuation">.</span>Scheme
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Host <span class="token operator">=</span> target<span class="token punctuation">.</span>Host
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
		<span class="token keyword">if</span> targetQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">[</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user-agent&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//更改内容</span>
	modifyFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>resp <span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		<span class="token comment">//请求以下命令：curl 'http://127.0.0.1:2002/error'</span>
		<span class="token keyword">if</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
			<span class="token comment">//获取内容</span>
			oldPayload<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
			<span class="token comment">//追加内容</span>
			newPayload <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;StatusCode error:&quot;</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>oldPayload<span class="token punctuation">)</span><span class="token punctuation">)</span>
			resp<span class="token punctuation">.</span>Body <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>newPayload<span class="token punctuation">)</span><span class="token punctuation">)</span>
			resp<span class="token punctuation">.</span>ContentLength <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>newPayload<span class="token punctuation">)</span><span class="token punctuation">)</span>
			resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>newPayload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//错误回调 ：关闭real_server时测试，错误回调</span>
	<span class="token comment">//范围：transport.RoundTrip发生的错误、以及ModifyResponse发生的错误</span>
	errFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//todo 如果是权重的负载则调整临时权重</span>
		http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;ErrorHandler error:&quot;</span><span class="token operator">+</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>httputil<span class="token punctuation">.</span>ReverseProxy<span class="token punctuation">{</span>Director<span class="token punctuation">:</span> director<span class="token punctuation">,</span> Transport<span class="token punctuation">:</span> transport<span class="token punctuation">,</span> ModifyResponse<span class="token punctuation">:</span> modifyFunc<span class="token punctuation">,</span> ErrorHandler<span class="token punctuation">:</span> errFunc<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	aslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	bslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">switch</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> aslash <span class="token operator">&amp;&amp;</span> bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token keyword">case</span> <span class="token operator">!</span>aslash <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> b
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestFactory</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rb <span class="token operator">:=</span> <span class="token function">LoadBanlanceFactory</span><span class="token punctuation">(</span>LbConsistentHash<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2003/base&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2004/base&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;20&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	proxy <span class="token operator">:=</span> <span class="token function">NewMultipleHostsReverseProxy</span><span class="token punctuation">(</span>rb<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="中间件支持"><a href="#中间件支持" class="header-anchor">#</a> 中间件支持</h2> <h4 id="中间件的意义"><a href="#中间件的意义" class="header-anchor">#</a> 中间件的意义</h4> <ul><li>避免程序逻辑复杂</li> <li>提高复用，隔离业务，比如权限认证我们可以单独抽离出来，通过中间件隔离业务</li> <li>调用清晰，组合随意</li></ul> <p>可以把中间件的原理理解成“洋葱”，一层一层的进一层一层的出来。</p> <ul><li>中间件代码实现
<ul><li>中间件一般都封装在路由上，路由是URL请求分发的管理器</li> <li>中间件选型：
<ul><li>基于链表构建中间件（缺点，实现复杂，调用不方便）</li> <li>使用数组构建中间件，控制灵活方便，推荐使用</li></ul></li> <li>方法组装
<ul><li>构建中间件URL路由</li> <li>构建URL的中间件方法数组</li> <li>使用use方法整合路由和方法数组</li></ul></li></ul></li></ul> <h4 id="开发一个中间件"><a href="#开发一个中间件" class="header-anchor">#</a> 开发一个中间件</h4> <ul><li><p>middleware/slice_router.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> middleware

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;math&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">//目标定位是 tcp、http通用的中间件</span>
<span class="token comment">//知其然也知其所以然</span>

<span class="token keyword">const</span> abortIndex <span class="token builtin">int8</span> <span class="token operator">=</span> math<span class="token punctuation">.</span>MaxInt8 <span class="token operator">/</span> <span class="token number">2</span> <span class="token comment">//最多 63 个中间件</span>

<span class="token keyword">type</span> HandlerFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span>

<span class="token comment">// router 结构体</span>
<span class="token keyword">type</span> SliceRouter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	groups <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SliceGroup
<span class="token punctuation">}</span>

<span class="token comment">// group 结构体</span>
<span class="token keyword">type</span> SliceGroup <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">*</span>SliceRouter
	path     <span class="token builtin">string</span>
	handlers <span class="token punctuation">[</span><span class="token punctuation">]</span>HandlerFunc
<span class="token punctuation">}</span>

<span class="token comment">// router上下文</span>
<span class="token keyword">type</span> SliceRouterContext <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Rw  http<span class="token punctuation">.</span>ResponseWriter
	Req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request
	Ctx context<span class="token punctuation">.</span>Context
	<span class="token operator">*</span>SliceGroup
	index <span class="token builtin">int8</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newSliceRouterContext</span><span class="token punctuation">(</span>rw http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> r <span class="token operator">*</span>SliceRouter<span class="token punctuation">)</span> <span class="token operator">*</span>SliceRouterContext <span class="token punctuation">{</span>
	newSliceGroup <span class="token operator">:=</span> <span class="token operator">&amp;</span>SliceGroup<span class="token punctuation">{</span><span class="token punctuation">}</span>

	<span class="token comment">//最长url前缀匹配</span>
	matchUrlLen <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> group <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>groups <span class="token punctuation">{</span>
		<span class="token comment">//fmt.Println(&quot;req.RequestURI&quot;)</span>
		<span class="token comment">//fmt.Println(req.RequestURI)</span>
		<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>RequestURI<span class="token punctuation">,</span> group<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			pathLen <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>group<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
			<span class="token keyword">if</span> pathLen <span class="token operator">&gt;</span> matchUrlLen <span class="token punctuation">{</span>
				matchUrlLen <span class="token operator">=</span> pathLen
				<span class="token operator">*</span>newSliceGroup <span class="token operator">=</span> <span class="token operator">*</span>group <span class="token comment">//浅拷贝数组指针</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	c <span class="token operator">:=</span> <span class="token operator">&amp;</span>SliceRouterContext<span class="token punctuation">{</span>Rw<span class="token punctuation">:</span> rw<span class="token punctuation">,</span> Req<span class="token punctuation">:</span> req<span class="token punctuation">,</span> SliceGroup<span class="token punctuation">:</span> newSliceGroup<span class="token punctuation">,</span> Ctx<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>Ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> SliceRouterHandler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	coreFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler
	router   <span class="token operator">*</span>SliceRouter
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>SliceRouterHandler<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>rw http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token function">newSliceRouterContext</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span> req<span class="token punctuation">,</span> w<span class="token punctuation">.</span>router<span class="token punctuation">)</span>
	<span class="token keyword">if</span> w<span class="token punctuation">.</span>coreFunc <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>handlers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>handlers<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span><span class="token function">coreFunc</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewSliceRouterHandler</span><span class="token punctuation">(</span>coreFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> router <span class="token operator">*</span>SliceRouter<span class="token punctuation">)</span> <span class="token operator">*</span>SliceRouterHandler <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>SliceRouterHandler<span class="token punctuation">{</span>
		coreFunc<span class="token punctuation">:</span> coreFunc<span class="token punctuation">,</span>
		router<span class="token punctuation">:</span>   router<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 构造 router</span>
<span class="token keyword">func</span> <span class="token function">NewSliceRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>SliceRouter <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>SliceRouter<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建 Group</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>SliceRouter<span class="token punctuation">)</span> <span class="token function">Group</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>SliceGroup <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>SliceGroup<span class="token punctuation">{</span>
		SliceRouter<span class="token punctuation">:</span> g<span class="token punctuation">,</span>
		path<span class="token punctuation">:</span>        path<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 构造回调方法</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>SliceGroup<span class="token punctuation">)</span> <span class="token function">Use</span><span class="token punctuation">(</span>middlewares <span class="token operator">...</span>HandlerFunc<span class="token punctuation">)</span> <span class="token operator">*</span>SliceGroup <span class="token punctuation">{</span>
	g<span class="token punctuation">.</span>handlers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>handlers<span class="token punctuation">,</span> middlewares<span class="token operator">...</span><span class="token punctuation">)</span>
	existsFlag <span class="token operator">:=</span> <span class="token boolean">false</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> oldGroup <span class="token operator">:=</span> <span class="token keyword">range</span> g<span class="token punctuation">.</span>SliceRouter<span class="token punctuation">.</span>groups <span class="token punctuation">{</span>
		<span class="token keyword">if</span> oldGroup <span class="token operator">==</span> g <span class="token punctuation">{</span>
			existsFlag <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>existsFlag <span class="token punctuation">{</span>
		g<span class="token punctuation">.</span>SliceRouter<span class="token punctuation">.</span>groups <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>SliceRouter<span class="token punctuation">.</span>groups<span class="token punctuation">,</span> g<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> g
<span class="token punctuation">}</span>

<span class="token comment">// 从最先加入中间件开始回调</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>index<span class="token operator">++</span>
	<span class="token keyword">for</span> c<span class="token punctuation">.</span>index <span class="token operator">&lt;</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>handlers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//fmt.Println(&quot;c.index&quot;)</span>
		<span class="token comment">//fmt.Println(c.index)</span>
		c<span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>c<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>index<span class="token operator">++</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 跳出中间件方法</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span> <span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>index <span class="token operator">=</span> abortIndex
<span class="token punctuation">}</span>

<span class="token comment">// 是否跳过了回调</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span> <span class="token function">IsAborted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>index <span class="token operator">&gt;=</span> abortIndex
<span class="token punctuation">}</span>

<span class="token comment">// 重置回调</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>middleware/proxy.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> middleware

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bytes&quot;</span>
	<span class="token string">&quot;compress/gzip&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io/ioutil&quot;</span>
	<span class="token string">&quot;math/rand&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/http/httputil&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> transport <span class="token operator">=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">{</span>
	DialContext<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>net<span class="token punctuation">.</span>Dialer<span class="token punctuation">{</span>
		Timeout<span class="token punctuation">:</span>   <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//连接超时</span>
		KeepAlive<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//长连接超时时间</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DialContext<span class="token punctuation">,</span>
	MaxIdleConns<span class="token punctuation">:</span>          <span class="token number">100</span><span class="token punctuation">,</span>              <span class="token comment">//最大空闲连接</span>
	IdleConnTimeout<span class="token punctuation">:</span>       <span class="token number">90</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//空闲超时时间</span>
	TLSHandshakeTimeout<span class="token punctuation">:</span>   <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//tls握手超时时间</span>
	ExpectContinueTimeout<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>  <span class="token comment">//100-continue超时时间</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewMultipleHostsReverseProxy</span><span class="token punctuation">(</span>c <span class="token operator">*</span>SliceRouterContext<span class="token punctuation">,</span> targets <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">)</span> <span class="token operator">*</span>httputil<span class="token punctuation">.</span>ReverseProxy <span class="token punctuation">{</span>
	<span class="token comment">//请求协调者</span>
	director <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		targetIndex <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>targets<span class="token punctuation">)</span><span class="token punctuation">)</span>
		target <span class="token operator">:=</span> targets<span class="token punctuation">[</span>targetIndex<span class="token punctuation">]</span>
		targetQuery <span class="token operator">:=</span> target<span class="token punctuation">.</span>RawQuery

		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> target<span class="token punctuation">.</span>Scheme
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Host <span class="token operator">=</span> target<span class="token punctuation">.</span>Host
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
		<span class="token comment">//todo 当对域名(非内网)反向代理时需要设置此项, 当作后端反向代理时不需要</span>
		req<span class="token punctuation">.</span>Host <span class="token operator">=</span> target<span class="token punctuation">.</span>Host
		<span class="token keyword">if</span> targetQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">[</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user-agent&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//更改内容</span>
	modifyFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>resp <span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		<span class="token comment">//todo 部分章节功能补充2</span>
		<span class="token comment">//todo 兼容websocket</span>
		<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;Connection&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Upgrade&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">var</span> payload <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
		<span class="token keyword">var</span> readErr <span class="token builtin">error</span>

		<span class="token comment">//todo 部分章节功能补充3</span>
		<span class="token comment">//todo 兼容gzip压缩</span>
		<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Encoding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;gzip&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			gr<span class="token punctuation">,</span> err <span class="token operator">:=</span> gzip<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
			payload<span class="token punctuation">,</span> readErr <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>gr<span class="token punctuation">)</span>
			resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Del</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Encoding&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			payload<span class="token punctuation">,</span> readErr <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> readErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> readErr
		<span class="token punctuation">}</span>

		<span class="token comment">//异常请求时设置StatusCode</span>
		<span class="token keyword">if</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
			payload <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;StatusCode error:&quot;</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//todo 部分章节功能补充4</span>
		<span class="token comment">//todo 因为预读了数据所以内容重新回写</span>
		c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;status_code&quot;</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
		resp<span class="token punctuation">.</span>Body <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
		resp<span class="token punctuation">.</span>ContentLength <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
		resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//错误回调 ：关闭real_server时测试，错误回调</span>
	<span class="token comment">//范围：transport.RoundTrip发生的错误、以及ModifyResponse发生的错误</span>
	errFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//todo record error log</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>httputil<span class="token punctuation">.</span>ReverseProxy<span class="token punctuation">{</span>Director<span class="token punctuation">:</span> director<span class="token punctuation">,</span> Transport<span class="token punctuation">:</span> transport<span class="token punctuation">,</span> ModifyResponse<span class="token punctuation">:</span> modifyFunc<span class="token punctuation">,</span> ErrorHandler<span class="token punctuation">:</span> errFunc<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	aslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	bslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">switch</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> aslash <span class="token operator">&amp;&amp;</span> bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token keyword">case</span> <span class="token operator">!</span>aslash <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> b
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>middleware/rancelog.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> middleware

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;log&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TraceLogSliceMW</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;trace_in&quot;</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;trace_out&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>slice_test.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> addr <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2002&quot;</span>

<span class="token keyword">func</span> <span class="token function">TestSliceRouter</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	reverseProxy <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
		rs1 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2003/base&quot;</span>
		url1<span class="token punctuation">,</span> err1 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs1<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err1<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		rs2 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2004/base&quot;</span>
		url2<span class="token punctuation">,</span> err2 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs2<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err2 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err2<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		urls <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">{</span>url1<span class="token punctuation">,</span> url2<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">NewMultipleHostsReverseProxy</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>urls<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>

	<span class="token comment">//初始化方法数组路由器</span>
	sliceRouter <span class="token operator">:=</span> <span class="token function">NewSliceRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//中间件可充当业务逻辑代码</span>
	sliceRouter<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;/base&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token function">TraceLogSliceMW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>Rw<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;test func&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">//请求到反向代理</span>
	sliceRouter<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token function">TraceLogSliceMW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>SliceRouterContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;reverseProxy&quot;</span><span class="token punctuation">)</span>
		<span class="token function">reverseProxy</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Rw<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Req<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	routerHandler <span class="token operator">:=</span> <span class="token function">NewSliceRouterHandler</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> sliceRouter<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> routerHandler<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="限流"><a href="#限流" class="header-anchor">#</a> 限流</h2> <p>高并发系统的三大利器：缓存、降级、限流</p> <ul><li>缓存：提升系统访问速度和增大处理容量，为相应业务增加缓存</li> <li>降级：当服务器压力剧增时，根据业务策略降级，以及释放服务资源保证业务正常</li> <li>限流：通过对并发限速，以达到拒绝服务、排队或等待、降级处理</li></ul> <h4 id="限流的分类"><a href="#限流的分类" class="header-anchor">#</a> 限流的分类：</h4> <ul><li>漏桶限流：每次请求时计算桶流量，超过阀值则降级请求</li> <li>令牌桶限流：每次请求时从令牌桶取令牌，取不到则降级请求</li></ul> <p>我们通过采用漏桶限流的方式进行实现限流，使用time/rate限速器：</p> <div class="language- extra-class"><pre class="language-text"><code>1、rate.NewLimter(limit,burst) limit表示每秒产生token数，burst最多存多少token
2、Allow 判断当前是否可以取到token
3、Wait阻塞等待直到取到token
4、Reserve返回等待时间，再去取token

原理解析
1、计算上次请求和当前请求的时间差
2、计算时间差内生成的token数+旧token数
3、如果token为负数，计算等待时间
4、token为正，则请求后token-1
</code></pre></div><p>代码实现</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;golang.org/x/time/rate&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Test_RateLimiter</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	l <span class="token operator">:=</span> rate<span class="token punctuation">.</span><span class="token function">NewLimiter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token comment">// 每秒1个token，最多存放6个</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span><span class="token function">Burst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token comment">//阻塞等待直到，取到一个token</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;before Wait&quot;</span><span class="token punctuation">)</span>
		c<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;limiter wait err:&quot;</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;after Wait&quot;</span><span class="token punctuation">)</span>

		<span class="token comment">//返回需要等待多久才有新的token,这样就可以等待指定时间执行任务</span>
		r <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Reserve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;reserve Delay:&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token comment">//判断当前是否可以取到token</span>
		a <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Allow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Allow:&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="网关集成限流功能"><a href="#网关集成限流功能" class="header-anchor">#</a> 网关集成限流功能</h4> <p>实现一个可以注册到中间件的限流器，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">RateLimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>middleware<span class="token punctuation">.</span>SliceRouterContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	l <span class="token operator">:=</span> rate<span class="token punctuation">.</span><span class="token function">NewLimiter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>middleware<span class="token punctuation">.</span>SliceRouterContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>l<span class="token punctuation">.</span><span class="token function">Allow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			c<span class="token punctuation">.</span>Rw<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;rate limit:%v,%v&quot;</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span><span class="token function">Burst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			c<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>写一个测试来实现代理限流</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> addr <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2002&quot;</span>

<span class="token comment">// 限流方案</span>
<span class="token keyword">func</span> <span class="token function">TestRater</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	coreFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>middleware<span class="token punctuation">.</span>SliceRouterContext<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>  <span class="token comment">// 创建一个核心方法</span>
		rs1 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2003/base&quot;</span>
		url1<span class="token punctuation">,</span> err1 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs1<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err1<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		rs2 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2004/base&quot;</span>
		url2<span class="token punctuation">,</span> err2 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs2<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err2 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err2<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		urls <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">{</span>url1<span class="token punctuation">,</span> url2<span class="token punctuation">}</span>
		<span class="token keyword">return</span> middleware<span class="token punctuation">.</span><span class="token function">NewMultipleHostsReverseProxy</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> urls<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>

	sliceRouter <span class="token operator">:=</span> middleware<span class="token punctuation">.</span><span class="token function">NewSliceRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 创建一个我们自己封装的路由</span>
	sliceRouter<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token function">RateLimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	routerHandler <span class="token operator">:=</span> middleware<span class="token punctuation">.</span><span class="token function">NewSliceRouterHandler</span><span class="token punctuation">(</span>coreFunc<span class="token punctuation">,</span> sliceRouter<span class="token punctuation">)</span> <span class="token comment">// 传入的是核心方法handler，和一个路由</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> routerHandler<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="熔断与降级"><a href="#熔断与降级" class="header-anchor">#</a> 熔断与降级</h2> <ul><li>熔断：熔断器是当依赖的服务已经出现故障时，为了保证自身服务的正常运行不再访问依赖服务，防止雪崩效应（保险丝）</li> <li>降级：当服务器压力剧增时，根据业务策略降级，以此释放服务资源保证业务正常</li></ul> <h4 id="熔断器的三种状态"><a href="#熔断器的三种状态" class="header-anchor">#</a> 熔断器的三种状态</h4> <ul><li>关闭状态：服务正常，维护失败率统计，达到失败率阀值时，转为开启</li> <li>开启状态：服务异常，调用fallback函数，一段时间后，进入半开启状态</li> <li>半开启状态：尝试恢复服务，失败率高于阀值，进入开启状态，第一阀值，进入关闭状态（尝试走业务逻辑）</li></ul> <h4 id="hystrix-go"><a href="#hystrix-go" class="header-anchor">#</a> hystrix-go</h4> <p>Hystrix-go类库，是熔断、降级、限流集成的类库，同时提供了监控面板；hystri-go的基本使用：</p> <p>配套的Hystrix Dashboard用作展示服务状态，代码实现：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;github.com/afex/hystrix-go/hystrix&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Test_main</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	hystrixStreamHandler <span class="token operator">:=</span> hystrix<span class="token punctuation">.</span><span class="token function">NewStreamHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	hystrixStreamHandler<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:8074&quot;</span><span class="token punctuation">,</span> hystrixStreamHandler<span class="token punctuation">)</span>

	hystrix<span class="token punctuation">.</span><span class="token function">ConfigureCommand</span><span class="token punctuation">(</span><span class="token string">&quot;aaa&quot;</span><span class="token punctuation">,</span> hystrix<span class="token punctuation">.</span>CommandConfig<span class="token punctuation">{</span>
		Timeout<span class="token punctuation">:</span>                <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 单次请求 超时时间</span>
		MaxConcurrentRequests<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token comment">// 最大并发量</span>
		SleepWindow<span class="token punctuation">:</span>            <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token comment">// 熔断后多久去尝试服务是否可用</span>
		RequestVolumeThreshold<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token comment">// 验证熔断的 请求数量, 10秒内采样</span>
		ErrorPercentThreshold<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token comment">// 验证熔断的 错误百分比</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token comment">//异步调用使用 hystrix.Go</span>
		err <span class="token operator">:=</span> hystrix<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token string">&quot;aaa&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>  <span class="token comment">// hystrix.Do是同步调用</span>
			<span class="token comment">//test case 1 并发测试</span>
			<span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;service error&quot;</span><span class="token punctuation">)</span>  <span class="token comment">// 第一次发生报错，触发熔断，之后如果并发量太多也会触发</span>
			<span class="token punctuation">}</span>
			<span class="token comment">//test case 2 超时测试</span>
			<span class="token comment">//time.Sleep(2 * time.Second)</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;do services&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;hystrix err:&quot;</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;sleep 1 second&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="websocket"><a href="#websocket" class="header-anchor">#</a> WebSocket</h2> <p>注意：反向代理服务器在客户端和服务端中间时，需要注意必须满足第一代理的角色</p> <h4 id="websocket代理实战"><a href="#websocket代理实战" class="header-anchor">#</a> WebSocket代理实战</h4> <p>webSocket实际服务器/客户端</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;flag&quot;</span>
	<span class="token string">&quot;github.com/gorilla/websocket&quot;</span>
	<span class="token string">&quot;html/template&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> addr <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;addr&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;localhost:2003&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http service address&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> upgrader <span class="token operator">=</span> websocket<span class="token punctuation">.</span>Upgrader<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// use default options</span>

<span class="token keyword">func</span> <span class="token function">echo</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">,</span> err <span class="token operator">:=</span> upgrader<span class="token punctuation">.</span><span class="token function">Upgrade</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;upgrade:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		mt<span class="token punctuation">,</span> message<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ReadMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;read:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;recv: %s&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
		err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">WriteMessage</span><span class="token punctuation">(</span>mt<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;write:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">home</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	homeTemplate<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;ws://&quot;</span><span class="token operator">+</span>r<span class="token punctuation">.</span>Host<span class="token operator">+</span><span class="token string">&quot;/echo&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">SetFlags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/echo&quot;</span><span class="token punctuation">,</span> echo<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> home<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting websocket server at &quot;</span> <span class="token operator">+</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> homeTemplate <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">`
&lt;!DOCTYPE html&gt;
&lt;head&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;script&gt;  
window.addEventListener(&quot;load&quot;, function(evt) {
    var output = document.getElementById(&quot;output&quot;);
    var input = document.getElementById(&quot;input&quot;);
    var ws;
    var print = function(message) {
        var d = document.createElement(&quot;div&quot;);
        d.innerHTML = message;
        output.appendChild(d);
    };
    document.getElementById(&quot;open&quot;).onclick = function(evt) {
        if (ws) {
            return false;
        }
		var web_url=document.getElementById(&quot;web_url&quot;).value
        ws = new WebSocket(web_url);
        ws.onopen = function(evt) {
            print(&quot;OPEN&quot;);
        }
        ws.onclose = function(evt) {
            print(&quot;CLOSE&quot;);
            ws = null;
        }
        ws.onmessage = function(evt) {
            print(&quot;RESPONSE: &quot; + evt.data);
        }
        ws.onerror = function(evt) {
            print(&quot;ERROR: &quot; + evt.data);
        }
        return false;
    };
    document.getElementById(&quot;send&quot;).onclick = function(evt) {
        if (!ws) {
            return false;
        }
        print(&quot;SEND: &quot; + input.value);
        ws.send(input.value);
        return false;
    };
    document.getElementById(&quot;close&quot;).onclick = function(evt) {
        if (!ws) {
            return false;
        }
        ws.close();
        return false;
    };
});
&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;table&gt;
&lt;tr&gt;&lt;td valign=&quot;top&quot; width=&quot;50%&quot;&gt;
&lt;p&gt;Click &quot;Open&quot; to create a connection to the server, 
&quot;Send&quot; to send a message to the server and &quot;Close&quot; to close the connection. 
You can change the message and send multiple times.
&lt;p&gt;
&lt;form&gt;
&lt;button id=&quot;open&quot;&gt;Open&lt;/button&gt;
&lt;button id=&quot;close&quot;&gt;Close&lt;/button&gt;
&lt;p&gt;&lt;input id=&quot;web_url&quot; type=&quot;text&quot; value=&quot;{{.}}&quot;&gt;
&lt;p&gt;&lt;input id=&quot;input&quot; type=&quot;text&quot; value=&quot;Hello world!&quot;&gt;
&lt;button id=&quot;send&quot;&gt;Send&lt;/button&gt;
&lt;/form&gt;
&lt;/td&gt;&lt;td valign=&quot;top&quot; width=&quot;50%&quot;&gt;
&lt;div id=&quot;output&quot;&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/body&gt;
&lt;/html&gt;
`</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>深入理解WebSocket的upgrade.Upgrade步骤：</p> <p>1、获取Sec-Websocket-key</p> <p>2、sha1生成Sec-Websocket-Accept</p> <p>3、向客户端发送101status</p> <p>设置反向代理</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;learn-plus/proxy/load_balance&quot;</span>
	<span class="token string">&quot;learn-plus/proxy/middleware&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	addr <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2002&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rb <span class="token operator">:=</span> load_balance<span class="token punctuation">.</span><span class="token function">LoadBanlanceFactory</span><span class="token punctuation">(</span>load_balance<span class="token punctuation">.</span>LbWeightRoundRobin<span class="token punctuation">)</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2003&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;50&quot;</span><span class="token punctuation">)</span>
	proxy <span class="token operator">:=</span> load_balance<span class="token punctuation">.</span><span class="token function">NewLoadBalanceReverseProxy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>middleware<span class="token punctuation">.</span>SliceRouterContext<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> rb<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="http2"><a href="#http2" class="header-anchor">#</a> http2</h2> <h4 id="https和http2的关系"><a href="#https和http2的关系" class="header-anchor">#</a> https和http2的关系</h4> <ul><li>http2代表多路复用的传输协议</li> <li>https代表http服务器使用了加密传输</li> <li>一个启用https的服务器不一定使用http2</li> <li>但是使用http2的服务器必须启用http2</li></ul> <h4 id="http2的设计目标"><a href="#http2的设计目标" class="header-anchor">#</a> http2的设计目标</h4> <ul><li>大多数情况下的感知延迟要有实质上改进</li> <li>解决HTTP1.1中的“队首阻塞”问题</li> <li>并行操作无需与服务器建立多个连接</li></ul> <h4 id="http2基本概念"><a href="#http2基本概念" class="header-anchor">#</a> http2基本概念</h4> <ul><li>流：流是连接中的虚拟信道，可以承载双向消息</li> <li>消息：是指逻辑上HTTP消息，比如请求、响应等</li> <li>帧：HTTP2.0 通信的最小单位，每个帧包含帧首部，至少也会识别出当前帧所属的流，承载着特定的数据</li></ul> <h4 id="https-http2下游服务实现"><a href="#https-http2下游服务实现" class="header-anchor">#</a> https/http2下游服务实现</h4> <ul><li><p>实现下游服务</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main


<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;golang.org/x/net/http2&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;learn-plus/https/testcrt&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;os/signal&quot;</span>
	<span class="token string">&quot;syscall&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">/*
证书签名生成方式:
//CA私钥
openssl genrsa -out ca.key 2048
//CA数据证书
openssl req -x509 -new -nodes -key ca.key -subj &quot;/CN=example1.com&quot; -days 5000 -out ca.crt
//服务器私钥（默认由CA签发）
openssl genrsa -out server.key 2048
//服务器证书签名请求：Certificate Sign Request，简称csr（example1.com代表你的域名）
openssl req -new -key server.key -subj &quot;/CN=example1.com&quot; -out server.csr
//上面2个文件生成服务器证书（days代表有效期）
openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 5000
*/</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rs1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:3003&quot;</span><span class="token punctuation">}</span>
	rs1<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rs2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:3004&quot;</span><span class="token punctuation">}</span>
	rs2<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//监听关闭信号</span>
	quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
	signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>quit
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RealServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Addr <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
	mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>HelloHandler<span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/base/error&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ErrorHandler<span class="token punctuation">)</span>
	server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>         r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span>
		WriteTimeout<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>
		Handler<span class="token punctuation">:</span>      mux<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		http2<span class="token punctuation">.</span><span class="token function">ConfigureServer</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token operator">&amp;</span>http2<span class="token punctuation">.</span>Server<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// 设置http2的支持，以帧的形式输出</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">ListenAndServeTLS</span><span class="token punctuation">(</span>testcrt<span class="token punctuation">.</span><span class="token function">Path</span><span class="token punctuation">(</span><span class="token string">&quot;server.crt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> testcrt<span class="token punctuation">.</span><span class="token function">Path</span><span class="token punctuation">(</span><span class="token string">&quot;server.key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">HelloHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	upath <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;http://%s%s\n&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">ErrorHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	upath <span class="token operator">:=</span> <span class="token string">&quot;error handler&quot;</span>
	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>testcrt/testdata.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// basepath is the root directory of this package.</span>
<span class="token keyword">var</span> basepath <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> currentFile<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">Caller</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	basepath <span class="token operator">=</span> filepath<span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span>currentFile<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Path returns the absolute path the given relative file or directory path,</span>
<span class="token comment">// relative to the google.golang.org/grpc/testdata directory in the user's GOPATH.</span>
<span class="token comment">// If rel is already absolute, it is returned unmodified.</span>
<span class="token keyword">func</span> <span class="token function">Path</span><span class="token punctuation">(</span>rel <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> filepath<span class="token punctuation">.</span><span class="token function">IsAbs</span><span class="token punctuation">(</span>rel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> rel
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>basepath<span class="token punctuation">,</span> rel<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>分析</p> <div class="language- extra-class"><pre class="language-text"><code>1、ListenAndServer调整ListenAndServeTLS即可支持http2
2、http服务器设置http2.ConfigureServer支持http2
	2.1、设置h2对应的handler回调
	2.2、http.Server中设置了对h2的回调
	2.3、h2回调方法负责从帧数据中转换数据为http请求
</code></pre></div></li></ul> <h2 id="tcp代理"><a href="#tcp代理" class="header-anchor">#</a> Tcp代理</h2> <h4 id="什么是负载均衡"><a href="#什么是负载均衡" class="header-anchor">#</a> 什么是负载均衡</h4> <ul><li><p>负载均衡（Load Balance）建立在现有网络结构之上，它提供了一种廉价有效透明的方法扩展网络设备和服务器的带宽、增加吞吐量、加强网络数据处理能力、提高网络的灵活性和可用性。负载均衡有两方面的含义：首先，大量的并发访问或数据流量分担到多台节点设备上分别处理，减少用户等待响应的时间；其次，单个重负载的运算分担到多台节点设备上做并行处理，每个节点设备处理结束后，将结果汇总，返回给用户，系统处理能力得到大幅度提高。</p></li> <li><p>简单来说就是：其一是将大量的并发处理转发给后端多个节点处理，减少工作响应时间；其二是将单个繁重的工作转发给后端多个节点处理，处理完再返回给负载均衡中心，再返回给用户。目前负载均衡技术大多数是用于提高诸如在Web服务器、FTP服务器和其它关键任务服务器上的Internet服务器程序的可用性和可伸缩性。</p></li></ul> <h4 id="负载均衡分类"><a href="#负载均衡分类" class="header-anchor">#</a> 负载均衡分类</h4> <ul><li>二层负载均衡（mac）：根据OSI模型分的二层负载，一般是用虚拟mac地址方式，外部对虚拟MAC地址请求，负载均衡接收后分配后端实际的MAC地址响应.</li> <li>三层负载均衡（ip）：一般采用虚拟IP地址方式，外部对虚拟的ip地址请求，负载均衡接收后分配后端实际的IP地址响应. (即一个ip对一个ip的转发, 端口全放开)</li> <li>四层负载均衡（tcp）：在三次负载均衡的基础上，即从第四层&quot;传输层&quot;开始, 使用&quot;ip+port&quot;接收请求，再转发到对应的机器。</li> <li>七层负载均衡（http）：从第七层&quot;应用层&quot;开始, 根据虚拟的url或IP，主机名接收请求，再转向相应的处理服务器</li></ul> <div class="language- extra-class"><pre class="language-text"><code>我们运维中最常见的四层和七层负载均衡，这里重点说下这两种负载均衡。
1）四层的负载均衡就是基于IP+端口的负载均衡：在三层负载均衡的基础上，通过发布三层的IP地址（VIP），然后加四层的端口号，来决定哪些流量需要做负载均衡，对需要处理的流量进行NAT处理，转发至后台服务器，并记录下这个TCP或者UDP的流量是由哪台服务器处理的，后续这个连接的所有流量都同样转发到同一台服务器处理。
对应的负载均衡器称为四层交换机（L4 switch），主要分析IP层及TCP/UDP层，实现四层负载均衡。此种负载均衡器不理解应用协议（如HTTP/FTP/MySQL等等）。

实现四层负载均衡的软件有：
F5：硬件负载均衡器，功能很好，但是成本很高。
lvs：重量级的四层负载软件
nginx：轻量级的四层负载软件，带缓存功能，正则表达式较灵活
haproxy：模拟四层转发，较灵活

2）七层的负载均衡就是基于虚拟的URL或主机IP的负载均衡：在四层负载均衡的基础上（没有四层是绝对不可能有七层的），再考虑应用层的特征，比如同一个Web服务器的负载均衡，除了根据VIP加80端口辨别是否需要处理的流量，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡。举个例子，如果你的Web服务器分成两组，一组是中文语言的，一组是英文语言的，那么七层负载均衡就可以当用户来访问你的域名时，自动辨别用户语言，然后选择对应的语言服务器组进行负载均衡处理。

对应的负载均衡器称为七层交换机（L7 switch），除了支持四层负载均衡以外，还有分析应用层的信息，如HTTP协议URI或Cookie信息，实现七层负载均衡。此种负载均衡器能理解应用协议。
实现七层负载均衡的软件有：
haproxy：天生负载均衡技能，全面支持七层代理，会话保持，标记，路径转移；
nginx：只在http协议和mail协议上功能比较好，性能与haproxy差不多；
apache：功能较差
Mysql proxy：功能尚可。

总的来说，一般是lvs做4层负载；nginx做7层负载(也能做4层负载, 通过stream模块)；haproxy比较灵活，4层和7层负载均衡都能做
</code></pre></div><h4 id="四层负载和七层负载的区别"><a href="#四层负载和七层负载的区别" class="header-anchor">#</a> 四层负载和七层负载的区别</h4> <ul><li>实际是路由转发和反向代理的区别</li> <li>转发客户端与服务器只会有一次三次握手，而代理有两次</li> <li>NAT是作用于内核运行，代理是用户程序运行的</li> <li>代理的数据进入程序buffer中</li></ul> <h4 id="tcp代理原理"><a href="#tcp代理原理" class="header-anchor">#</a> Tcp代理原理</h4> <ul><li>本质上还是七层反向代理，只是代理的内容是tcp协议包
<ul><li>初始化tcp服务器</li> <li>创建上下游连接</li> <li>上下游连接数据交换</li></ul></li></ul> <h4 id="tcp代理实现"><a href="#tcp代理实现" class="header-anchor">#</a> Tcp代理实现</h4> <p>参考http.util.RecerseProxy实现，服务与代理逻辑分离：</p> <ul><li>构建tcp服务器</li> <li>构建tcp代理</li> <li>tcp服务器与tcp代理结合，实现基于负载均衡的代理</li></ul> <p>构建tcp服务器</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;learn-plus/proxy/tcp_proxy&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	addr <span class="token operator">=</span> <span class="token string">&quot;:7002&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> tcpHandler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>tcpHandler<span class="token punctuation">)</span> <span class="token function">ServeTCP</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> src net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	src<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;tcpHandler\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//tcp服务器测试</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting tcpserver at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
	tcpServ <span class="token operator">:=</span> tcp_proxy<span class="token punctuation">.</span>TcpServer<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>    addr<span class="token punctuation">,</span>
		Handler<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tcpHandler<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting tcp_server at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
	tcpServ<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//代理测试</span>
	<span class="token comment">//rb := load_balance.LoadBanlanceFactory(load_balance.LbWeightRoundRobin)</span>
	<span class="token comment">//rb.Add(&quot;127.0.0.1:6001&quot;, &quot;40&quot;)</span>
	<span class="token comment">//proxy := proxy.NewTcpLoadBalanceReverseProxy(&amp;tcp_middleware.TcpSliceRouterContext{}, rb)</span>
	<span class="token comment">//tcpServ := tcp_proxy.TcpServer{Addr: addr, Handler: proxy,}</span>
	<span class="token comment">//fmt.Println(&quot;Starting tcp_proxy at &quot; + addr)</span>
	<span class="token comment">//tcpServ.ListenAndServe()</span>

	<span class="token comment">//redis服务器测试</span>
	<span class="token comment">//rb := load_balance.LoadBanlanceFactory(load_balance.LbWeightRoundRobin)</span>
	<span class="token comment">//rb.Add(&quot;127.0.0.1:6379&quot;, &quot;40&quot;)</span>
	<span class="token comment">//proxy := proxy.NewTcpLoadBalanceReverseProxy(&amp;tcp_middleware.TcpSliceRouterContext{}, rb)</span>
	<span class="token comment">//tcpServ := tcp_proxy.TcpServer{Addr: addr, Handler: proxy,}</span>
	<span class="token comment">//fmt.Println(&quot;Starting tcp_proxy at &quot; + addr)</span>
	<span class="token comment">//tcpServ.ListenAndServe()</span>

	<span class="token comment">//http服务器测试:</span>
	<span class="token comment">//缺点对请求的管控不足,比如我们用来做baidu代理,因为无法更改请求host,所以很轻易把我们拒绝</span>
	<span class="token comment">//rb := load_balance.LoadBanlanceFactory(load_balance.LbWeightRoundRobin)</span>
	<span class="token comment">//rb.Add(&quot;127.0.0.1:2003&quot;, &quot;40&quot;)</span>
	<span class="token comment">////rb.Add(&quot;www.baidu.com:80&quot;, &quot;40&quot;)</span>
	<span class="token comment">//proxy := proxy.NewTcpLoadBalanceReverseProxy(&amp;tcp_tcp_middleware.TcpSliceRouterContext{}, rb)</span>
	<span class="token comment">//tcpServ := tcp_proxy.TcpServer{Addr: addr, Handler: proxy,}</span>
	<span class="token comment">//fmt.Println(&quot;tcp_proxy start at:&quot; + addr)</span>
	<span class="token comment">//tcpServ.ListenAndServe()</span>

	<span class="token comment">//websocket服务器测试:缺点对请求的管控不足</span>
	<span class="token comment">//rb := load_balance.LoadBanlanceFactory(load_balance.LbWeightRoundRobin)</span>
	<span class="token comment">//rb.Add(&quot;127.0.0.1:2003&quot;, &quot;40&quot;)</span>
	<span class="token comment">//proxy := proxy.NewTcpLoadBalanceReverseProxy(&amp;tcp_middleware.TcpSliceRouterContext{}, rb)</span>
	<span class="token comment">//tcpServ := tcp_proxy.TcpServer{Addr: addr, Handler: proxy,}</span>
	<span class="token comment">//fmt.Println(&quot;Starting tcp_proxy at &quot; + addr)</span>
	<span class="token comment">//tcpServ.ListenAndServe()</span>

	<span class="token comment">//http2服务器测试:缺点对请求的管控不足</span>
	<span class="token comment">//rb := load_balance.LoadBanlanceFactory(load_balance.LbWeightRoundRobin)</span>
	<span class="token comment">//rb.Add(&quot;127.0.0.1:3003&quot;, &quot;40&quot;)</span>
	<span class="token comment">//proxy := proxy.NewTcpLoadBalanceReverseProxy(&amp;tcp_middleware.TcpSliceRouterContext{}, rb)</span>
	<span class="token comment">//tcpServ := tcp_proxy.TcpServer{Addr: addr, Handler: proxy,}</span>
	<span class="token comment">//fmt.Println(&quot;Starting tcp_proxy at &quot; + addr)</span>
	<span class="token comment">//tcpServ.ListenAndServe()</span>

</code></pre></div><p>prox/tcp_server.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> tcp_proxy

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
	<span class="token string">&quot;sync/atomic&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	ErrServerClosed     <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;tcp: Server closed&quot;</span><span class="token punctuation">)</span>
	ErrAbortHandler     <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;tcp: abort TCPHandler&quot;</span><span class="token punctuation">)</span>
	ServerContextKey    <span class="token operator">=</span> <span class="token operator">&amp;</span>contextKey<span class="token punctuation">{</span><span class="token string">&quot;tcp-server&quot;</span><span class="token punctuation">}</span>
	LocalAddrContextKey <span class="token operator">=</span> <span class="token operator">&amp;</span>contextKey<span class="token punctuation">{</span><span class="token string">&quot;local-addr&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> onceCloseListener <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	net<span class="token punctuation">.</span>Listener
	once     sync<span class="token punctuation">.</span>Once
	closeErr <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>oc <span class="token operator">*</span>onceCloseListener<span class="token punctuation">)</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	oc<span class="token punctuation">.</span>once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>oc<span class="token punctuation">.</span><span class="token builtin">close</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> oc<span class="token punctuation">.</span>closeErr
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>oc <span class="token operator">*</span>onceCloseListener<span class="token punctuation">)</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	oc<span class="token punctuation">.</span>closeErr <span class="token operator">=</span> oc<span class="token punctuation">.</span>Listener<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> TCPHandler <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">ServeTCP</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> TcpServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Addr    <span class="token builtin">string</span>
	Handler TCPHandler
	err     <span class="token builtin">error</span>
	BaseCtx context<span class="token punctuation">.</span>Context

	WriteTimeout     time<span class="token punctuation">.</span>Duration
	ReadTimeout      time<span class="token punctuation">.</span>Duration
	KeepAliveTimeout time<span class="token punctuation">.</span>Duration

	mu         sync<span class="token punctuation">.</span>Mutex
	inShutdown <span class="token builtin">int32</span>
	doneChan   <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	l          <span class="token operator">*</span>onceCloseListener
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>TcpServer<span class="token punctuation">)</span> <span class="token function">shuttingDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">.</span>inShutdown<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>TcpServer<span class="token punctuation">)</span> <span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span><span class="token function">shuttingDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrServerClosed
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>doneChan <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		srv<span class="token punctuation">.</span>doneChan <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> srv<span class="token punctuation">.</span>Addr
	<span class="token keyword">if</span> addr <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;need addr&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	ln<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> srv<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>tcpKeepAliveListener<span class="token punctuation">{</span>
		ln<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token punctuation">.</span>TCPListener<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>TcpServer<span class="token punctuation">)</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	atomic<span class="token punctuation">.</span><span class="token function">StoreInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>srv<span class="token punctuation">.</span>inShutdown<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token function">close</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>doneChan<span class="token punctuation">)</span> <span class="token comment">//关闭channel</span>
	srv<span class="token punctuation">.</span>l<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment">//执行listener关闭</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>TcpServer<span class="token punctuation">)</span> <span class="token function">Serve</span><span class="token punctuation">(</span>l net<span class="token punctuation">.</span>Listener<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	srv<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token operator">&amp;</span>onceCloseListener<span class="token punctuation">{</span>Listener<span class="token punctuation">:</span> l<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> srv<span class="token punctuation">.</span>l<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//执行listener关闭</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>BaseCtx <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		srv<span class="token punctuation">.</span>BaseCtx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	baseCtx <span class="token operator">:=</span> srv<span class="token punctuation">.</span>BaseCtx
	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>baseCtx<span class="token punctuation">,</span> ServerContextKey<span class="token punctuation">,</span> srv<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		rw<span class="token punctuation">,</span> e <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>srv<span class="token punctuation">.</span><span class="token function">getDoneChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				<span class="token keyword">return</span> ErrServerClosed
			<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token punctuation">}</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;accept fail, err: %v\n&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		c <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">newConn</span><span class="token punctuation">(</span>rw<span class="token punctuation">)</span>
		<span class="token keyword">go</span> c<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>TcpServer<span class="token punctuation">)</span> <span class="token function">newConn</span><span class="token punctuation">(</span>rwc net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token operator">*</span>conn <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token operator">&amp;</span>conn<span class="token punctuation">{</span>
		server<span class="token punctuation">:</span> srv<span class="token punctuation">,</span>
		rwc<span class="token punctuation">:</span>    rwc<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 设置参数</span>
	<span class="token keyword">if</span> d <span class="token operator">:=</span> c<span class="token punctuation">.</span>server<span class="token punctuation">.</span>ReadTimeout<span class="token punctuation">;</span> d <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>rwc<span class="token punctuation">.</span><span class="token function">SetReadDeadline</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> d <span class="token operator">:=</span> c<span class="token punctuation">.</span>server<span class="token punctuation">.</span>WriteTimeout<span class="token punctuation">;</span> d <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>rwc<span class="token punctuation">.</span><span class="token function">SetWriteDeadline</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> d <span class="token operator">:=</span> c<span class="token punctuation">.</span>server<span class="token punctuation">.</span>KeepAliveTimeout<span class="token punctuation">;</span> d <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> tcpConn<span class="token punctuation">,</span> ok <span class="token operator">:=</span> c<span class="token punctuation">.</span>rwc<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token punctuation">.</span>TCPConn<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			tcpConn<span class="token punctuation">.</span><span class="token function">SetKeepAlive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
			tcpConn<span class="token punctuation">.</span><span class="token function">SetKeepAlivePeriod</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>TcpServer<span class="token punctuation">)</span> <span class="token function">getDoneChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> s<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> s<span class="token punctuation">.</span>doneChan <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		s<span class="token punctuation">.</span>doneChan <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> s<span class="token punctuation">.</span>doneChan
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr <span class="token builtin">string</span><span class="token punctuation">,</span> handler TCPHandler<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	server <span class="token operator">:=</span> <span class="token operator">&amp;</span>TcpServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> addr<span class="token punctuation">,</span> Handler<span class="token punctuation">:</span> handler<span class="token punctuation">,</span> doneChan<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span>
	<span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>proxy/conn.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> tcp_proxy

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;runtime&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> tcpKeepAliveListener <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">*</span>net<span class="token punctuation">.</span>TCPListener
<span class="token punctuation">}</span>

<span class="token comment">//todo 思考点：继承方法覆写方法时，只要使用非指针接口</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>ln tcpKeepAliveListener<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>net<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	tc<span class="token punctuation">,</span> err <span class="token operator">:=</span> ln<span class="token punctuation">.</span><span class="token function">AcceptTCP</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> tc<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> contextKey <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>contextKey<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token string">&quot;tcp_proxy context value &quot;</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>name
<span class="token punctuation">}</span>

<span class="token keyword">type</span> conn <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	server     <span class="token operator">*</span>TcpServer
	cancelCtx  context<span class="token punctuation">.</span>CancelFunc
	rwc        net<span class="token punctuation">.</span>Conn
	remoteAddr <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>rwc<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token function">serve</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> ErrAbortHandler <span class="token punctuation">{</span>
			<span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token number">64</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span>
			buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>
			buf <span class="token operator">=</span> buf<span class="token punctuation">[</span><span class="token punctuation">:</span>runtime<span class="token punctuation">.</span><span class="token function">Stack</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;tcp: panic serving %v: %v\n%s&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>remoteAddr<span class="token punctuation">,</span> err<span class="token punctuation">,</span> buf<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		c<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>remoteAddr <span class="token operator">=</span> c<span class="token punctuation">.</span>rwc<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> LocalAddrContextKey<span class="token punctuation">,</span> c<span class="token punctuation">.</span>rwc<span class="token punctuation">.</span><span class="token function">LocalAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>server<span class="token punctuation">.</span>Handler <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;handler empty&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>server<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">ServeTCP</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> c<span class="token punctuation">.</span>rwc<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="tcp反向代理实现"><a href="#tcp反向代理实现" class="header-anchor">#</a> Tcp反向代理实现</h4> <p>proxy_tcp.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;learn-plus/proxy/load_balance&quot;</span>
	<span class="token string">&quot;learn-plus/proxy/proxy&quot;</span>
	<span class="token string">&quot;learn-plus/proxy/tcp_middleware&quot;</span>
	<span class="token string">&quot;learn-plus/proxy/tcp_proxy&quot;</span>
	<span class="token string">&quot;net&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	addr <span class="token operator">=</span> <span class="token string">&quot;:2002&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> tcpHandler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>tcpHandler<span class="token punctuation">)</span> <span class="token function">ServeTCP</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> src net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	src<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;tcpHandler\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//tcp服务器测试</span>
	<span class="token comment">//log.Println(&quot;Starting tcpserver at &quot; + addr)</span>
	<span class="token comment">//tcpServ := tcp_proxy.TcpServer{</span>
	<span class="token comment">//	Addr:    addr,</span>
	<span class="token comment">//	Handler: &amp;tcpHandler{},</span>
	<span class="token comment">//}</span>
	<span class="token comment">//fmt.Println(&quot;Starting tcp_server at &quot; + addr)</span>
	<span class="token comment">//tcpServ.ListenAndServe()</span>

	<span class="token comment">//代理测试</span>
	rb <span class="token operator">:=</span> load_balance<span class="token punctuation">.</span><span class="token function">LoadBanlanceFactory</span><span class="token punctuation">(</span>load_balance<span class="token punctuation">.</span>LbWeightRoundRobin<span class="token punctuation">)</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:7002&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;40&quot;</span><span class="token punctuation">)</span>  <span class="token comment">// 代理上游服务</span>

	proxy <span class="token operator">:=</span> proxy<span class="token punctuation">.</span><span class="token function">NewTcpLoadBalanceReverseProxy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tcp_middleware<span class="token punctuation">.</span>TcpSliceRouterContext<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> rb<span class="token punctuation">)</span>
	tcpServ <span class="token operator">:=</span> tcp_proxy<span class="token punctuation">.</span>TcpServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> addr<span class="token punctuation">,</span> Handler<span class="token punctuation">:</span> proxy<span class="token punctuation">,</span><span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting tcp_proxy at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
	tcpServ<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//redis服务器测试</span>
	<span class="token comment">//rb := load_balance.LoadBanlanceFactory(load_balance.LbWeightRoundRobin)</span>
	<span class="token comment">//rb.Add(&quot;127.0.0.1:6379&quot;, &quot;40&quot;)</span>
	<span class="token comment">//proxy := proxy.NewTcpLoadBalanceReverseProxy(&amp;tcp_middleware.TcpSliceRouterContext{}, rb)</span>
	<span class="token comment">//tcpServ := tcp_proxy.TcpServer{Addr: addr, Handler: proxy,}</span>
	<span class="token comment">//fmt.Println(&quot;Starting tcp_proxy at &quot; + addr)</span>
	<span class="token comment">//tcpServ.ListenAndServe()</span>

	<span class="token comment">//http服务器测试:</span>
	<span class="token comment">//缺点对请求的管控不足,比如我们用来做baidu代理,因为无法更改请求host,所以很轻易把我们拒绝</span>
	<span class="token comment">//rb := load_balance.LoadBanlanceFactory(load_balance.LbWeightRoundRobin)</span>
	<span class="token comment">//rb.Add(&quot;127.0.0.1:2003&quot;, &quot;40&quot;)</span>
	<span class="token comment">////rb.Add(&quot;www.baidu.com:80&quot;, &quot;40&quot;)</span>
	<span class="token comment">//proxy := proxy.NewTcpLoadBalanceReverseProxy(&amp;tcp_tcp_middleware.TcpSliceRouterContext{}, rb)</span>
	<span class="token comment">//tcpServ := tcp_proxy.TcpServer{Addr: addr, Handler: proxy,}</span>
	<span class="token comment">//fmt.Println(&quot;tcp_proxy start at:&quot; + addr)</span>
	<span class="token comment">//tcpServ.ListenAndServe()</span>

	<span class="token comment">//websocket服务器测试:缺点对请求的管控不足</span>
	<span class="token comment">//rb := load_balance.LoadBanlanceFactory(load_balance.LbWeightRoundRobin)</span>
	<span class="token comment">//rb.Add(&quot;127.0.0.1:2003&quot;, &quot;40&quot;)</span>
	<span class="token comment">//proxy := proxy.NewTcpLoadBalanceReverseProxy(&amp;tcp_middleware.TcpSliceRouterContext{}, rb)</span>
	<span class="token comment">//tcpServ := tcp_proxy.TcpServer{Addr: addr, Handler: proxy,}</span>
	<span class="token comment">//fmt.Println(&quot;Starting tcp_proxy at &quot; + addr)</span>
	<span class="token comment">//tcpServ.ListenAndServe()</span>

	<span class="token comment">//http2服务器测试:缺点对请求的管控不足</span>
	<span class="token comment">//rb := load_balance.LoadBanlanceFactory(load_balance.LbWeightRoundRobin)</span>
	<span class="token comment">//rb.Add(&quot;127.0.0.1:3003&quot;, &quot;40&quot;)</span>
	<span class="token comment">//proxy := proxy.NewTcpLoadBalanceReverseProxy(&amp;tcp_middleware.TcpSliceRouterContext{}, rb)</span>
	<span class="token comment">//tcpServ := tcp_proxy.TcpServer{Addr: addr, Handler: proxy,}</span>
	<span class="token comment">//fmt.Println(&quot;Starting tcp_proxy at &quot; + addr)</span>
	<span class="token comment">//tcpServ.ListenAndServe()</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Proxy/tcp_reverse_proxy.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> proxy

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;learn-plus/proxy/load_balance&quot;</span>
	<span class="token string">&quot;learn-plus/proxy/tcp_middleware&quot;</span>

	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">NewTcpLoadBalanceReverseProxy</span><span class="token punctuation">(</span>c <span class="token operator">*</span>tcp_middleware<span class="token punctuation">.</span>TcpSliceRouterContext<span class="token punctuation">,</span> lb load_balance<span class="token punctuation">.</span>LoadBalance<span class="token punctuation">)</span> <span class="token operator">*</span>TcpReverseProxy <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>TcpReverseProxy <span class="token punctuation">{</span>
		nextAddr<span class="token punctuation">,</span> err <span class="token operator">:=</span> lb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;get next addr fail&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>TcpReverseProxy<span class="token punctuation">{</span>
			ctx<span class="token punctuation">:</span>             c<span class="token punctuation">.</span>Ctx<span class="token punctuation">,</span>
			Addr<span class="token punctuation">:</span>            nextAddr<span class="token punctuation">,</span>
			KeepAlivePeriod<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
			DialTimeout<span class="token punctuation">:</span>     time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//TCP反向代理</span>
<span class="token keyword">type</span> TcpReverseProxy <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ctx                  context<span class="token punctuation">.</span>Context <span class="token comment">//单次请求单独设置</span>
	Addr                 <span class="token builtin">string</span>
	KeepAlivePeriod      time<span class="token punctuation">.</span>Duration <span class="token comment">//设置</span>
	DialTimeout          time<span class="token punctuation">.</span>Duration <span class="token comment">//设置超时时间</span>
	DialContext          <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> network<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>net<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	OnDialError          <span class="token keyword">func</span><span class="token punctuation">(</span>src net<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> dstDialErr <span class="token builtin">error</span><span class="token punctuation">)</span>
	ProxyProtocolVersion <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>dp <span class="token operator">*</span>TcpReverseProxy<span class="token punctuation">)</span> <span class="token function">dialTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Duration <span class="token punctuation">{</span>
	<span class="token keyword">if</span> dp<span class="token punctuation">.</span>DialTimeout <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> dp<span class="token punctuation">.</span>DialTimeout
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second
<span class="token punctuation">}</span>

<span class="token keyword">var</span> defaultDialer <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span>Dialer<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>dp <span class="token operator">*</span>TcpReverseProxy<span class="token punctuation">)</span> <span class="token function">dialContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> network<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>net<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> dp<span class="token punctuation">.</span>DialContext <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> dp<span class="token punctuation">.</span>DialContext
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>net<span class="token punctuation">.</span>Dialer<span class="token punctuation">{</span>
		Timeout<span class="token punctuation">:</span>   dp<span class="token punctuation">.</span>DialTimeout<span class="token punctuation">,</span>     <span class="token comment">//连接超时</span>
		KeepAlive<span class="token punctuation">:</span> dp<span class="token punctuation">.</span>KeepAlivePeriod<span class="token punctuation">,</span> <span class="token comment">//设置连接的检测时长</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DialContext
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>dp <span class="token operator">*</span>TcpReverseProxy<span class="token punctuation">)</span> <span class="token function">keepAlivePeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Duration <span class="token punctuation">{</span>
	<span class="token keyword">if</span> dp<span class="token punctuation">.</span>KeepAlivePeriod <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> dp<span class="token punctuation">.</span>KeepAlivePeriod
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> time<span class="token punctuation">.</span>Minute
<span class="token punctuation">}</span>

<span class="token comment">//传入上游 conn，在这里完成下游连接与数据交换</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>dp <span class="token operator">*</span>TcpReverseProxy<span class="token punctuation">)</span> <span class="token function">ServeTCP</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> src net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//设置连接超时</span>
	<span class="token keyword">var</span> cancel context<span class="token punctuation">.</span>CancelFunc
	<span class="token keyword">if</span> dp<span class="token punctuation">.</span>DialTimeout <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		ctx<span class="token punctuation">,</span> cancel <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> dp<span class="token punctuation">.</span><span class="token function">dialTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	dst<span class="token punctuation">,</span> err <span class="token operator">:=</span> dp<span class="token punctuation">.</span><span class="token function">dialContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> dp<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> cancel <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		dp<span class="token punctuation">.</span><span class="token function">onDialError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">go</span> dst<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//记得退出下游连接</span>

	<span class="token comment">//设置dst的 keepAlive 参数,在数据请求之前</span>
	<span class="token keyword">if</span> ka <span class="token operator">:=</span> dp<span class="token punctuation">.</span><span class="token function">keepAlivePeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ka <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> c<span class="token punctuation">,</span> ok <span class="token operator">:=</span> dst<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token punctuation">.</span>TCPConn<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			c<span class="token punctuation">.</span><span class="token function">SetKeepAlive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
			c<span class="token punctuation">.</span><span class="token function">SetKeepAlivePeriod</span><span class="token punctuation">(</span>ka<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	errc <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> dp<span class="token punctuation">.</span><span class="token function">proxyCopy</span><span class="token punctuation">(</span>errc<span class="token punctuation">,</span> src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span>
	<span class="token keyword">go</span> dp<span class="token punctuation">.</span><span class="token function">proxyCopy</span><span class="token punctuation">(</span>errc<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> src<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>errc
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>dp <span class="token operator">*</span>TcpReverseProxy<span class="token punctuation">)</span> <span class="token function">onDialError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>src net<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> dstDialErr <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> dp<span class="token punctuation">.</span>OnDialError <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> dp<span class="token punctuation">.</span>OnDialError
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>src net<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> dstDialErr <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;tcpproxy: for incoming conn %v, error dialing %q: %v&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dp<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span> dstDialErr<span class="token punctuation">)</span>
		src<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>dp <span class="token operator">*</span>TcpReverseProxy<span class="token punctuation">)</span> <span class="token function">proxyCopy</span><span class="token punctuation">(</span>errc <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">error</span><span class="token punctuation">,</span> dst<span class="token punctuation">,</span> src net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> src<span class="token punctuation">)</span>
	errc <span class="token operator">&lt;-</span> err
<span class="token punctuation">}</span>
</code></pre></div><h4 id="thrift安装介绍"><a href="#thrift安装介绍" class="header-anchor">#</a> thrift安装介绍</h4> <p>安装：https://thrift.apache.org/docs/install/</p> <p>构建thrift测试sever和client</p> <ul><li>首先编写 <code>thrift_gen.thrift</code></li> <li>运行IDL生成命令 <code>thrift --gen go thrift_gen.thrift</code></li> <li>使用生成的IDL单独构建 server 与 client 即可</li></ul> <p>介绍：</p> <ul><li>Facebook的开源项目，后来进入apache孵化</li> <li>thrift也是支持跨语言的一个rpc框架，有自己的一套IDL</li> <li>thrift的网络协议建立在tcp的基础上</li></ul> <h2 id="grpc透明代理"><a href="#grpc透明代理" class="header-anchor">#</a> gRPC透明代理</h2> <p>介绍：gRPC是谷歌出品的一个高性能、开源和通用的RPC框架，是基于http/2标准设计，支持普通rpc也支持双向流式传递数据，相对于thrift连接可以多路复用，可传递header头数据</p> <p>(关于grpc方面的功能演示，统一使用非加密方式)，首先确保grpc安装，步骤如下：</p> <p>官网：https://github.com/grpc/grpc-go</p> <h4 id="安装步骤"><a href="#安装步骤" class="header-anchor">#</a> 安装步骤</h4> <h5 id="go-mod安装方式"><a href="#go-mod安装方式" class="header-anchor">#</a> go mod安装方式</h5> <ul><li>开启 go mod <code>export GO111MODULE=on</code></li> <li>开启代理 go mod <code>export GOPROXY=https://goproxy.io</code></li> <li>安装grpc <code>go get -u google.golang.org/grpc</code></li> <li>安装proto <code>go get -u github.com/golang/protobuf/proto</code></li> <li>安装protoc-gen-go <code>go get -u github.com/golang/protobuf/protoc-gen-go</code></li></ul> <h5 id="遇到命令不存在-command-not-found-protoc"><a href="#遇到命令不存在-command-not-found-protoc" class="header-anchor">#</a> 遇到命令不存在 command not found: protoc</h5> <div class="language- extra-class"><pre class="language-text"><code>缺少protobuf预先安装导致的问题。 protoc-gen-go相当于只是protobuf的一个语言支持。

安装protobuf参照资料
mac 下   brew install protobuf
windows 下 https://blog.csdn.net/qq_41185868/article/details/82882206
linux 下 https://blog.csdn.net/sszzyzzy/article/details/89946075
</code></pre></div><h5 id="遇到-i-o-timeout-errors"><a href="#遇到-i-o-timeout-errors" class="header-anchor">#</a> 遇到 I/O Timeout Errors</h5> <div class="language- extra-class"><pre class="language-text"><code>$ go get -u google.golang.org/grpc
package google.golang.org/grpc: unrecognized import path &quot;google.golang.org/grpc&quot; (https fetch: Get https://google.golang.org/grpc?go-get=1: dial tcp 216.239.37.1:443: i/o timeout)
</code></pre></div><ul><li>要么翻墙解决问题</li> <li>要么设置 <code>export GOPROXY=https://goproxy.io</code></li></ul> <h5 id="遇到-permission-denied"><a href="#遇到-permission-denied" class="header-anchor">#</a> 遇到 permission denied</h5> <div class="language- extra-class"><pre class="language-text"><code>go get -u google.golang.org/grpc
go get github.com/golang/protobuf/protoc-gen-go: open /usr/local/go/bin/protoc-gen-go: permission denied
</code></pre></div><ul><li>要么给目录增加读写权限 <code>chmod -R 777 /usr/local/go/</code></li> <li>要么设置重新设置一下GOROOT地址指向非系统目录 比如 mac 下面 vim ~/.bashrc</li></ul> <div class="language- extra-class"><pre class="language-text"><code>#export GOROOT=/usr/local/go
#export GOBIN=/usr/local/go/bin
#export LGOBIN=/usr/local/go/bin
export GOROOT=/Users/niuyufu/go_1.12
export GOBIN=/Users/niuyufu/go_1.12/bin
export LGOBIN=/Users/niuyufu/go_1.12/bin
</code></pre></div><h4 id="构建grpc测试server与client"><a href="#构建grpc测试server与client" class="header-anchor">#</a> 构建grpc测试server与client</h4> <ul><li>首先编写 <code>echo.proto</code></li> <li>运行IDL生成命令，（如：遇到命令不存在 command not found: protoc 请参照上文帮助）</li></ul> <div class="language- extra-class"><pre class="language-text"><code>protoc -I . --go_out=plugins=grpc:proto ./echo.proto
</code></pre></div><ul><li>使用生成的IDL单独构建 server 与 client 即可</li></ul> <h4 id="构建grpc-gateway-测试服务端让服务器支持http"><a href="#构建grpc-gateway-测试服务端让服务器支持http" class="header-anchor">#</a> 构建grpc-gateway 测试服务端让服务器支持http</h4> <h5 id="安装参考"><a href="#安装参考" class="header-anchor">#</a> 安装参考</h5> <div class="language- extra-class"><pre class="language-text"><code>https://github.com/grpc-ecosystem/grpc-gateway
</code></pre></div><ul><li>开启 go mod <code>export GO111MODULE=on</code></li> <li>开启代理 go mod <code>export GOPROXY=https://goproxy.io</code></li> <li>执行安装命令</li></ul> <div class="language- extra-class"><pre class="language-text"><code>go install github.com/grpc-ecosystem/grpc-gateway/protoc-gen-grpc-gateway
go install  github.com/grpc-ecosystem/grpc-gateway/protoc-gen-swagger
go install github.com/golang/protobuf/protoc-gen-go
</code></pre></div><h4 id="构建grpc-gateway-测试服务端"><a href="#构建grpc-gateway-测试服务端" class="header-anchor">#</a> 构建grpc-gateway 测试服务端</h4> <ul><li>编写 <code>echo-gateway.proto</code></li> <li>运行IDL生成命令</li></ul> <div class="language- extra-class"><pre class="language-text"><code>protoc -I/usr/local/include -I. -I$GOPATH/src -I$GOPATH/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis --go_out=plugins=grpc:proto echo-gateway.proto
</code></pre></div><ul><li>删除 proto/echo.pb.go 防止结构体冲突 <code>rm proto/echo.pb.go</code></li> <li>运行gateway生成命令</li></ul> <div class="language- extra-class"><pre class="language-text"><code>protoc -I/usr/local/include -I. -I$GOPATH/src \
  -I$GOPATH/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis --grpc-gateway_out=logtostderr=true:proto echo-gateway.proto
</code></pre></div><ul><li>使用生成的IDL单独构建 server</li> <li>使用浏览器测试 server</li></ul> <div class="language- extra-class"><pre class="language-text"><code>curl 'http://127.0.0.1:8081/v1/example/echo' -d '{&quot;message&quot;:&quot;11222222&quot;}'
</code></pre></div><h4 id="代码实现"><a href="#代码实现" class="header-anchor">#</a> 代码实现</h4> <ul><li><p>grpc/echo.proto</p> <div class="language-protobuf extra-class"><pre class="language-protobuf"><code><span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">&quot;proto3&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">package</span> echo<span class="token punctuation">;</span>

<span class="token keyword">option</span> go_package <span class="token operator">=</span> <span class="token string">&quot;.;proto&quot;</span><span class="token punctuation">;</span>  <span class="token comment">// 输出文件</span>

<span class="token comment">// EchoRequest is the request for echo.</span>
<span class="token keyword">message</span> <span class="token class-name">EchoRequest</span> <span class="token punctuation">{</span>
    <span class="token builtin">string</span> message <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// EchoResponse is the response for echo.</span>
<span class="token keyword">message</span> <span class="token class-name">EchoResponse</span> <span class="token punctuation">{</span>
    <span class="token builtin">string</span> message <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Echo is the echo service.</span>
<span class="token keyword">service</span> <span class="token class-name">Echo</span> <span class="token punctuation">{</span>
    <span class="token comment">// UnaryEcho is unary echo.</span>
    <span class="token keyword">rpc</span> <span class="token function">UnaryEcho</span><span class="token punctuation">(</span><span class="token class-name">EchoRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token class-name">EchoResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// ServerStreamingEcho is server side streaming.</span>
    <span class="token keyword">rpc</span> <span class="token function">ServerStreamingEcho</span><span class="token punctuation">(</span><span class="token class-name">EchoRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token keyword">stream</span> <span class="token class-name">EchoResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// ClientStreamingEcho is client side streaming.</span>
    <span class="token keyword">rpc</span> <span class="token function">ClientStreamingEcho</span><span class="token punctuation">(</span><span class="token keyword">stream</span> <span class="token class-name">EchoRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token class-name">EchoResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// BidirectionalStreamingEcho is bidi streaming.</span>
    <span class="token keyword">rpc</span> <span class="token function">BidirectionalStreamingEcho</span><span class="token punctuation">(</span><span class="token keyword">stream</span> <span class="token class-name">EchoRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token keyword">stream</span> <span class="token class-name">EchoResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在grpc文件目录下创建proto文件夹，执行：protoc -I . --go_out=plugins=grpc:proto ./echo.proto命令，会输出一个满足实现proto文件的go文件，我们的客户端和服务端都是根据这个桥梁来进行通信</p></li> <li><p>grpc/server/main.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;flag&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;google.golang.org/grpc&quot;</span>
	<span class="token string">&quot;google.golang.org/grpc/metadata&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	pb <span class="token string">&quot;learn-plus/grpc/proto&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> port <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token number">50055</span><span class="token punctuation">,</span> <span class="token string">&quot;the port to serve on&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	streamingCount  <span class="token operator">=</span> <span class="token number">10</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> server <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">ServerStreamingEcho</span><span class="token punctuation">(</span>in <span class="token operator">*</span>pb<span class="token punctuation">.</span>EchoRequest<span class="token punctuation">,</span> stream pb<span class="token punctuation">.</span>Echo_ServerStreamingEchoServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;--- ServerStreamingEcho ---\n&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;request received: %v\n&quot;</span><span class="token punctuation">,</span> in<span class="token punctuation">)</span>
	<span class="token comment">// Read requests and send responses.</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> streamingCount<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;echo message %v\n&quot;</span><span class="token punctuation">,</span> in<span class="token punctuation">.</span>Message<span class="token punctuation">)</span>
		err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>EchoResponse<span class="token punctuation">{</span>Message<span class="token punctuation">:</span> in<span class="token punctuation">.</span>Message<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">ClientStreamingEcho</span><span class="token punctuation">(</span>stream pb<span class="token punctuation">.</span>Echo_ClientStreamingEchoServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;--- ClientStreamingEcho ---\n&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// Read requests and send responses.</span>
	<span class="token keyword">var</span> message <span class="token builtin">string</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		in<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;echo last received message\n&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> stream<span class="token punctuation">.</span><span class="token function">SendAndClose</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>EchoResponse<span class="token punctuation">{</span>Message<span class="token punctuation">:</span> message<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		message <span class="token operator">=</span> in<span class="token punctuation">.</span>Message
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;request received: %v, building echo\n&quot;</span><span class="token punctuation">,</span> in<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">BidirectionalStreamingEcho</span><span class="token punctuation">(</span>stream pb<span class="token punctuation">.</span>Echo_BidirectionalStreamingEchoServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;--- BidirectionalStreamingEcho ---\n&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// Read requests and send responses.</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		in<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;request received %v, sending echo\n&quot;</span><span class="token punctuation">,</span> in<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>EchoResponse<span class="token punctuation">{</span>Message<span class="token punctuation">:</span> in<span class="token punctuation">.</span>Message<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">UnaryEcho</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> in <span class="token operator">*</span>pb<span class="token punctuation">.</span>EchoRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>EchoResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;--- UnaryEcho ---\n&quot;</span><span class="token punctuation">)</span>
	md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;miss metadata from context&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;md&quot;</span><span class="token punctuation">,</span>md<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;request received: %v, sending echo\n&quot;</span><span class="token punctuation">,</span> in<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>EchoResponse<span class="token punctuation">{</span>Message<span class="token punctuation">:</span> in<span class="token punctuation">.</span>Message<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	lis<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;:%d&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to listen: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;server listening at %v\n&quot;</span><span class="token punctuation">,</span> lis<span class="token punctuation">.</span><span class="token function">Addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	s <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	pb<span class="token punctuation">.</span><span class="token function">RegisterEchoServer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>server<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	s<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>grace/client/main.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;flag&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;google.golang.org/grpc&quot;</span>
	<span class="token string">&quot;google.golang.org/grpc/metadata&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	pb <span class="token string">&quot;learn-plus/grpc/proto&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> addr <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;addr&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;localhost:50055&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;the address to connect to&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	timestampFormat <span class="token operator">=</span> time<span class="token punctuation">.</span>StampNano <span class="token comment">// &quot;Jan _2 15:04:05.000&quot;</span>
	streamingCount  <span class="token operator">=</span> <span class="token number">10</span>
	AccessToken<span class="token operator">=</span><span class="token string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1ODk2OTExMTQsImlzcyI6ImFwcF9pZF9iIn0.qb2A_WsDP_-jfQBxJk6L57gTnAzZs-SPLMSS_UO6Gkc&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">unaryCallWithMetadata</span><span class="token punctuation">(</span>c pb<span class="token punctuation">.</span>EchoClient<span class="token punctuation">,</span> message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;--- unary ---\n&quot;</span><span class="token punctuation">)</span>

	<span class="token comment">// Create metadata and context.</span>
	md <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>timestampFormat<span class="token punctuation">)</span><span class="token punctuation">)</span>
	md<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bearer &quot;</span><span class="token operator">+</span>AccessToken<span class="token punctuation">)</span>

	ctx <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">NewOutgoingContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> md<span class="token punctuation">)</span>
	r<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">UnaryEcho</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>EchoRequest<span class="token punctuation">{</span>Message<span class="token punctuation">:</span> message<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to call UnaryEcho: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;response:%v\n&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">serverStreamingWithMetadata</span><span class="token punctuation">(</span>c pb<span class="token punctuation">.</span>EchoClient<span class="token punctuation">,</span> message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;--- server streaming ---\n&quot;</span><span class="token punctuation">)</span>

	md <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>timestampFormat<span class="token punctuation">)</span><span class="token punctuation">)</span>
	md<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bearer &quot;</span><span class="token operator">+</span>AccessToken<span class="token punctuation">)</span>
	ctx <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">NewOutgoingContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> md<span class="token punctuation">)</span>

	stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ServerStreamingEcho</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>EchoRequest<span class="token punctuation">{</span>Message<span class="token punctuation">:</span> message<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to call ServerStreamingEcho: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Read all the responses.</span>
	<span class="token keyword">var</span> rpcStatus <span class="token builtin">error</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;response:\n&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			rpcStatus <span class="token operator">=</span> err
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot; - %s\n&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Message<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> rpcStatus <span class="token operator">!=</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to finish server streaming: %v&quot;</span><span class="token punctuation">,</span> rpcStatus<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">clientStreamWithMetadata</span><span class="token punctuation">(</span>c pb<span class="token punctuation">.</span>EchoClient<span class="token punctuation">,</span> message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;--- client streaming ---\n&quot;</span><span class="token punctuation">)</span>
	md <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>timestampFormat<span class="token punctuation">)</span><span class="token punctuation">)</span>
	md<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bearer &quot;</span><span class="token operator">+</span>AccessToken<span class="token punctuation">)</span>
	ctx <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">NewOutgoingContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> md<span class="token punctuation">)</span>
	stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ClientStreamingEcho</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to call ClientStreamingEcho: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Send all requests to the server.</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> streamingCount<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>EchoRequest<span class="token punctuation">{</span>Message<span class="token punctuation">:</span> message<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to send streaming: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Read the response.</span>
	r<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">CloseAndRecv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to CloseAndRecv: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;response:%v\n&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">bidirectionalWithMetadata</span><span class="token punctuation">(</span>c pb<span class="token punctuation">.</span>EchoClient<span class="token punctuation">,</span> message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;--- bidirectional ---\n&quot;</span><span class="token punctuation">)</span>
	md <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>timestampFormat<span class="token punctuation">)</span><span class="token punctuation">)</span>
	md<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bearer &quot;</span><span class="token operator">+</span>AccessToken<span class="token punctuation">)</span>
	ctx <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">NewOutgoingContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> md<span class="token punctuation">)</span>
	stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">BidirectionalStreamingEcho</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to call BidirectionalStreamingEcho: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Send all requests to the server.</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> streamingCount<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>EchoRequest<span class="token punctuation">{</span>Message<span class="token punctuation">:</span> message<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to send streaming: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		stream<span class="token punctuation">.</span><span class="token function">CloseSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Read all the responses.</span>
	<span class="token keyword">var</span> rpcStatus <span class="token builtin">error</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;response:\n&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			rpcStatus <span class="token operator">=</span> err
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot; - %s\n&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Message<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> rpcStatus <span class="token operator">!=</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to finish server streaming: %v&quot;</span><span class="token punctuation">,</span> rpcStatus<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token string">&quot;this is examples/metadata&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	wg <span class="token operator">:=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token operator">*</span>addr<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithInsecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;did not connect: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

			c <span class="token operator">:=</span> pb<span class="token punctuation">.</span><span class="token function">NewEchoClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>

			<span class="token comment">//调用一元方法</span>
			<span class="token comment">//for i := 0; i &lt; 100; i++ {</span>
			<span class="token function">unaryCallWithMetadata</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">400</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
			<span class="token comment">//}</span>
			<span class="token comment">//</span>
			<span class="token comment">//服务端流式</span>
			<span class="token function">serverStreamingWithMetadata</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>

			<span class="token comment">//客户端流式</span>
			<span class="token function">clientStreamWithMetadata</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>

			<span class="token comment">//双向流式</span>
			<span class="token function">bidirectionalWithMetadata</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="grpc实现反向代理"><a href="#grpc实现反向代理" class="header-anchor">#</a> gRPC实现反向代理</h2> <p>设置gRPC反向代理和透明服务：https://github.com/e421083458/gateway_demo/tree/master/demo/proxy/grpc_reverse_proxy</p> <h2 id="网关服务发现"><a href="#网关服务发现" class="header-anchor">#</a> 网关服务发现</h2> <p>服务发现是指用注册中心来记录服务信息，以便其他服务快速查找已注册服务，服务发现分类：</p> <ul><li>客户端服务发现（服务发现模块）</li> <li>服务端服务发现（注册中心）</li></ul> <h4 id="zookeeper介绍"><a href="#zookeeper介绍" class="header-anchor">#</a> zookeeper介绍</h4> <p>是一个分布式数据库（程序协调服务），Hadoop子项目；是一个树状方式维护节点的数据增删改查；监听通知机制，通过监听可以获取相应的消息事件</p> <h4 id="zookeeper核心功能补充"><a href="#zookeeper核心功能补充" class="header-anchor">#</a> zookeeper核心功能补充</h4> <ul><li>持久节点：一直保存在服务器上</li> <li>临时节点：会话失效，节点自动清理</li> <li>顺序节点：节点创建，自动分配序列号</li></ul> <h4 id="zookeeper安装"><a href="#zookeeper安装" class="header-anchor">#</a> zookeeper安装</h4> <ul><li><p>参考官方文档安装：https://zookeeper.apache.org/doc/r3.6.0/zookeeperStarted.html#sc_Download</p></li> <li><p>解压文件</p> <div class="language- extra-class"><pre class="language-text"><code>&gt; tar -zxvf zookeeper-3.4.10.tar.gz //解压
&gt; cd zookeeper-3.4.10/conf //切换到配置目录下
&gt; mv zoo_sample.cfg zoo.cfg //更改默认配置文件名称
&gt; vi zoo.cfg //编辑配置文件，自定义dataDir
</code></pre></div></li> <li><p>修改配置文件：</p> <div class="language- extra-class"><pre class="language-text"><code>tickTime: zookeeper中使用的基本时间单位, 毫秒
dataDir: 内存数据快照的保存目录；如果没有自定义Log也使用该目录
clientPort: 监听Cli连接的端口号
</code></pre></div></li> <li><p>zookeepr使用增删改查</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token punctuation">[</span>zk<span class="token operator">:</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">]</span> ls <span class="token operator">/</span>
<span class="token punctuation">[</span>zookeeper<span class="token punctuation">]</span>
<span class="token punctuation">[</span>zk<span class="token operator">:</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">]</span> create <span class="token operator">/</span>zk_test my_data   <span class="token comment">// 增</span>
Created <span class="token operator">/</span>zk_test
<span class="token punctuation">[</span>zk<span class="token operator">:</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">4</span><span class="token punctuation">]</span> ls <span class="token operator">/</span>
<span class="token punctuation">[</span>zookeeper<span class="token punctuation">,</span> zk_test<span class="token punctuation">]</span>
<span class="token punctuation">[</span>zk<span class="token operator">:</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">5</span><span class="token punctuation">]</span> get <span class="token operator">/</span>zk_test   <span class="token comment">// 查</span>
my_data
<span class="token punctuation">[</span>zk<span class="token operator">:</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">6</span><span class="token punctuation">]</span> set <span class="token operator">/</span>zk_test junk <span class="token comment">// 该</span>
<span class="token punctuation">[</span>zk<span class="token operator">:</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">8</span><span class="token punctuation">]</span> delete <span class="token operator">/</span>zk_test  <span class="token comment">// 删</span>
</code></pre></div></li> <li><p>运行于关闭：</p> <div class="language- extra-class"><pre class="language-text"><code>&gt; cd zookeeper-3.4.10/bin //切换到 bin目录
&gt; ./zkServer.sh start //启动


&gt; ./zkServer.sh stop //停止后，如果CLi没有关闭，将报错
</code></pre></div></li></ul> <h4 id="go操作zookeeper"><a href="#go操作zookeeper" class="header-anchor">#</a> Go操作zookeeper</h4> <ul><li><p>代码实现</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;github.com/samuel/go-zookeeper/zk&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	host <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;127.0.0.1:2181&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	conn<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> zk<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//增</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token string">&quot;/test_tree2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;tree_content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token number">0</span><span class="token punctuation">,</span> zk<span class="token punctuation">.</span><span class="token function">WorldACL</span><span class="token punctuation">(</span>zk<span class="token punctuation">.</span>PermAll<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>  <span class="token comment">// acl是权限</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;create err&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//查</span>
	nodeValue<span class="token punctuation">,</span> dStat<span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;/test_tree2&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;get err&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;nodeValue&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>nodeValue<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">//改</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;/test_tree2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;new_content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		dStat<span class="token punctuation">.</span>Version<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;update err&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//删除</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> dStat<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;/test_tree2&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">&quot;/test_tree2&quot;</span><span class="token punctuation">,</span> dStat<span class="token punctuation">.</span>Version<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Delete err&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token comment">//return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//验证存在</span>
	hasNode<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span><span class="token string">&quot;/test_tree2&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Exists err&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token comment">//return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;node Exist&quot;</span><span class="token punctuation">,</span> hasNode<span class="token punctuation">)</span>

	<span class="token comment">//增加</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token string">&quot;/test_tree2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;tree_content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token number">0</span><span class="token punctuation">,</span> zk<span class="token punctuation">.</span><span class="token function">WorldACL</span><span class="token punctuation">(</span>zk<span class="token punctuation">.</span>PermAll<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;create err&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//设置子节点</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token string">&quot;/test_tree2/subnode&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;node_content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token number">0</span><span class="token punctuation">,</span> zk<span class="token punctuation">.</span><span class="token function">WorldACL</span><span class="token punctuation">(</span>zk<span class="token punctuation">.</span>PermAll<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;create err&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//获取子节点列表</span>
	childNodes<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Children</span><span class="token punctuation">(</span><span class="token string">&quot;/test_tree2&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Children err&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;childNodes&quot;</span><span class="token punctuation">,</span> childNodes<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h4 id="zookeeper监听子节点"><a href="#zookeeper监听子节点" class="header-anchor">#</a> zookeeper监听子节点</h4> <ul><li><p>监听部分，代码实现：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;github.com/e421083458/gateway_demo/proxy/zookeeper&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;os/signal&quot;</span>
	<span class="token string">&quot;syscall&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> addr <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2002&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//获取zk节点列表</span>
	zkManager <span class="token operator">:=</span> zookeeper<span class="token punctuation">.</span><span class="token function">NewZkManager</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;127.0.0.1:2181&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	zkManager<span class="token punctuation">.</span><span class="token function">GetConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> zkManager<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 第一次获取一下</span>
	zlist<span class="token punctuation">,</span> err <span class="token operator">:=</span> zkManager<span class="token punctuation">.</span><span class="token function">GetServerListByPath</span><span class="token punctuation">(</span><span class="token string">&quot;/real_server&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;server node:&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>zlist<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//动态监听节点变化  -- 配套register</span>
	<span class="token comment">//chanList, chanErr := zkManager.WatchServerListByPath(&quot;/real_server&quot;)</span>
	<span class="token comment">//go func() {</span>
	<span class="token comment">//	for {</span>
	<span class="token comment">//		select {</span>
	<span class="token comment">//		case changeErr := &lt;-chanErr:</span>
	<span class="token comment">//			fmt.Println(&quot;changeErr&quot;)</span>
	<span class="token comment">//			fmt.Println(changeErr)</span>
	<span class="token comment">//		case changedList := &lt;-chanList:</span>
	<span class="token comment">//			fmt.Println(&quot;watch node changed&quot;)</span>
	<span class="token comment">//			fmt.Println(changedList)</span>
	<span class="token comment">//		}</span>
	<span class="token comment">//	}</span>
	<span class="token comment">//}()</span>

	<span class="token comment">//获取节点内容 -- 配套write</span>
	zc<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> zkManager<span class="token punctuation">.</span><span class="token function">GetPathData</span><span class="token punctuation">(</span><span class="token string">&quot;/rs_server_conf&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;get node data:&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>zc<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">//动态监听节点内容</span>
	dataChan<span class="token punctuation">,</span> dataErrChan <span class="token operator">:=</span> zkManager<span class="token punctuation">.</span><span class="token function">WatchPathData</span><span class="token punctuation">(</span><span class="token string">&quot;/rs_server_conf&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> changeErr <span class="token operator">:=</span> <span class="token operator">&lt;-</span>dataErrChan<span class="token punctuation">:</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;changeErr&quot;</span><span class="token punctuation">)</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>changeErr<span class="token punctuation">)</span>
			<span class="token keyword">case</span> changedData <span class="token operator">:=</span> <span class="token operator">&lt;-</span>dataChan<span class="token punctuation">:</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;WatchGetData changed&quot;</span><span class="token punctuation">)</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>changedData<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//关闭信号监听</span>
	quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
	signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>quit
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>服务注册后，数据变化部分</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;github.com/e421083458/gateway_demo/proxy/zookeeper&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	zkManager <span class="token operator">:=</span> zookeeper<span class="token punctuation">.</span><span class="token function">NewZkManager</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;127.0.0.1:2181&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	zkManager<span class="token punctuation">.</span><span class="token function">GetConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> zkManager<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	i <span class="token operator">:=</span> <span class="token number">0</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		conf <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;{name:&quot;</span> <span class="token operator">+</span> fmt<span class="token punctuation">.</span><span class="token function">Sprint</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">)</span>
		zkManager<span class="token punctuation">.</span><span class="token function">SetPathData</span><span class="token punctuation">(</span><span class="token string">&quot;/rs_server_conf&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		i<span class="token operator">++</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h4 id="网关服务发现原理"><a href="#网关服务发现原理" class="header-anchor">#</a> 网关服务发现原理</h4> <ul><li><p>网关中的负载均衡监听zookeeper变化，服务启动时在zookeeper中创建临时节点</p></li> <li><p>下游机器启动时创建临时节点，节点名和内容为服务地址</p></li> <li><p>以观察者模式构建负载配置LoadBalanConf</p></li> <li><p>负载均衡配置LoadBalanceConf与负载均衡器整合</p></li></ul> <p>结合服务启动时，将服务注册到zookeeper中的代码，这样可以通过watch实现动态监听服务变化</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;github.com/e421083458/gateway_demo/proxy/zookeeper&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;os/signal&quot;</span>
	<span class="token string">&quot;syscall&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rs1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">}</span>
	rs1<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	rs2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">}</span>
	rs2<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>

	<span class="token comment">//监听关闭信号</span>
	quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
	signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>quit
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RealServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Addr <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
	mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>HelloHandler<span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/base/error&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ErrorHandler<span class="token punctuation">)</span>
	server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>         r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span>
		WriteTimeout<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>
		Handler<span class="token punctuation">:</span>      mux<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//注册zk节点</span>
		zkManager <span class="token operator">:=</span> zookeeper<span class="token punctuation">.</span><span class="token function">NewZkManager</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;127.0.0.1:2181&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		err <span class="token operator">:=</span> zkManager<span class="token punctuation">.</span><span class="token function">GetConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot; connect zk error: %s &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">defer</span> zkManager<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		err <span class="token operator">=</span> zkManager<span class="token punctuation">.</span><span class="token function">RegistServerPath</span><span class="token punctuation">(</span><span class="token string">&quot;/real_server&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot; regist node error: %s &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		zlist<span class="token punctuation">,</span> err <span class="token operator">:=</span> zkManager<span class="token punctuation">.</span><span class="token function">GetServerListByPath</span><span class="token punctuation">(</span><span class="token string">&quot;/real_server&quot;</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>zlist<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">HelloHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	upath <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;http://%s%s\n&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">ErrorHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	upath <span class="token operator">:=</span> <span class="token string">&quot;error handler&quot;</span>
	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面实现了怎么将服务启动时注册到zookeeper中，下面我们来实现怎么从zookeeper中拿到服务，来做负载均衡，采用观察者模式。</p> <p>实现思路：负载均衡策略使用观察者模式，通过监听zk的动态变化，来更新配置</p> <h4 id="客户端服务发现"><a href="#客户端服务发现" class="header-anchor">#</a> 客户端服务发现</h4> <ul><li>下游机器启动时无需进行任何操作</li> <li>以观察者模式构建负载均衡配置LoadBalanceConf</li> <li>负载均衡配置固定时间频率检测下游节点健康状况</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/go/go-mode/设计模式.html" class="prev">
        设计模式
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.51f2f156.js" defer></script><script src="/assets/js/2.8911ec45.js" defer></script><script src="/assets/js/33.722f1ec5.js" defer></script>
  </body>
</html>
