<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Actix Basics | 独角兕大王</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.ccac5a78.css" as="style"><link rel="preload" href="/assets/js/app.51f2f156.js" as="script"><link rel="preload" href="/assets/js/2.8911ec45.js" as="script"><link rel="preload" href="/assets/js/117.4e79498c.js" as="script"><link rel="prefetch" href="/assets/js/10.6948c28b.js"><link rel="prefetch" href="/assets/js/100.276864ee.js"><link rel="prefetch" href="/assets/js/101.447ab1c7.js"><link rel="prefetch" href="/assets/js/102.f5b3c71d.js"><link rel="prefetch" href="/assets/js/103.16474d4b.js"><link rel="prefetch" href="/assets/js/104.ed58aef3.js"><link rel="prefetch" href="/assets/js/105.045203cd.js"><link rel="prefetch" href="/assets/js/106.be359e0b.js"><link rel="prefetch" href="/assets/js/107.7331bbca.js"><link rel="prefetch" href="/assets/js/108.76e1c800.js"><link rel="prefetch" href="/assets/js/109.e82166f3.js"><link rel="prefetch" href="/assets/js/11.d4ec37c8.js"><link rel="prefetch" href="/assets/js/110.4144755a.js"><link rel="prefetch" href="/assets/js/111.5864ab53.js"><link rel="prefetch" href="/assets/js/112.ca2aee84.js"><link rel="prefetch" href="/assets/js/113.641e7765.js"><link rel="prefetch" href="/assets/js/114.d69f8545.js"><link rel="prefetch" href="/assets/js/115.1b6a9f89.js"><link rel="prefetch" href="/assets/js/116.dde2c44e.js"><link rel="prefetch" href="/assets/js/12.7aac9c8d.js"><link rel="prefetch" href="/assets/js/13.abf127cd.js"><link rel="prefetch" href="/assets/js/14.aa4413a7.js"><link rel="prefetch" href="/assets/js/15.11a64e5b.js"><link rel="prefetch" href="/assets/js/16.f2d9a882.js"><link rel="prefetch" href="/assets/js/17.11c5bb7f.js"><link rel="prefetch" href="/assets/js/18.a522877b.js"><link rel="prefetch" href="/assets/js/19.6f31a972.js"><link rel="prefetch" href="/assets/js/20.b546c54e.js"><link rel="prefetch" href="/assets/js/21.6d055b7f.js"><link rel="prefetch" href="/assets/js/22.c48feceb.js"><link rel="prefetch" href="/assets/js/23.69941f78.js"><link rel="prefetch" href="/assets/js/24.6126dfc2.js"><link rel="prefetch" href="/assets/js/25.3475449c.js"><link rel="prefetch" href="/assets/js/26.96bb4643.js"><link rel="prefetch" href="/assets/js/27.da610e5d.js"><link rel="prefetch" href="/assets/js/28.b24ec15c.js"><link rel="prefetch" href="/assets/js/29.ec8af553.js"><link rel="prefetch" href="/assets/js/3.bec5f768.js"><link rel="prefetch" href="/assets/js/30.2e780db1.js"><link rel="prefetch" href="/assets/js/31.464c36ed.js"><link rel="prefetch" href="/assets/js/32.ad7d37c2.js"><link rel="prefetch" href="/assets/js/33.722f1ec5.js"><link rel="prefetch" href="/assets/js/34.8448d0fd.js"><link rel="prefetch" href="/assets/js/35.e5168ac9.js"><link rel="prefetch" href="/assets/js/36.edc404f1.js"><link rel="prefetch" href="/assets/js/37.5807602e.js"><link rel="prefetch" href="/assets/js/38.a519c89a.js"><link rel="prefetch" href="/assets/js/39.89af1b9a.js"><link rel="prefetch" href="/assets/js/4.5ed19beb.js"><link rel="prefetch" href="/assets/js/40.6c653db9.js"><link rel="prefetch" href="/assets/js/41.bc3b8b69.js"><link rel="prefetch" href="/assets/js/42.a0a02d9b.js"><link rel="prefetch" href="/assets/js/43.62f344e3.js"><link rel="prefetch" href="/assets/js/44.a7fd9d68.js"><link rel="prefetch" href="/assets/js/45.729c1c39.js"><link rel="prefetch" href="/assets/js/46.5b924aea.js"><link rel="prefetch" href="/assets/js/47.f3990404.js"><link rel="prefetch" href="/assets/js/48.f591f360.js"><link rel="prefetch" href="/assets/js/49.f7f213ad.js"><link rel="prefetch" href="/assets/js/5.2c5d28b5.js"><link rel="prefetch" href="/assets/js/50.b9ca2762.js"><link rel="prefetch" href="/assets/js/51.93672ee6.js"><link rel="prefetch" href="/assets/js/52.fb21314a.js"><link rel="prefetch" href="/assets/js/53.65343ccc.js"><link rel="prefetch" href="/assets/js/54.8081227d.js"><link rel="prefetch" href="/assets/js/55.e207659e.js"><link rel="prefetch" href="/assets/js/56.bde381df.js"><link rel="prefetch" href="/assets/js/57.f8eceb45.js"><link rel="prefetch" href="/assets/js/58.bef70bfd.js"><link rel="prefetch" href="/assets/js/59.7ab7562d.js"><link rel="prefetch" href="/assets/js/6.fc65a1ac.js"><link rel="prefetch" href="/assets/js/60.f40ac3ca.js"><link rel="prefetch" href="/assets/js/61.d2b463ab.js"><link rel="prefetch" href="/assets/js/62.cfdf1bcf.js"><link rel="prefetch" href="/assets/js/63.1e45ce59.js"><link rel="prefetch" href="/assets/js/64.a98fe86e.js"><link rel="prefetch" href="/assets/js/65.0234d7c5.js"><link rel="prefetch" href="/assets/js/66.724906f0.js"><link rel="prefetch" href="/assets/js/67.7806fda6.js"><link rel="prefetch" href="/assets/js/68.9f227dae.js"><link rel="prefetch" href="/assets/js/69.fdbc56ac.js"><link rel="prefetch" href="/assets/js/7.284de54e.js"><link rel="prefetch" href="/assets/js/70.04a9cc03.js"><link rel="prefetch" href="/assets/js/71.a6fa1dd9.js"><link rel="prefetch" href="/assets/js/72.2f8e3aa0.js"><link rel="prefetch" href="/assets/js/73.9bbb0cb6.js"><link rel="prefetch" href="/assets/js/74.9f122255.js"><link rel="prefetch" href="/assets/js/75.75e1fbd8.js"><link rel="prefetch" href="/assets/js/76.60ff3c3e.js"><link rel="prefetch" href="/assets/js/77.39a253ae.js"><link rel="prefetch" href="/assets/js/78.0e49712f.js"><link rel="prefetch" href="/assets/js/79.5f9c24a0.js"><link rel="prefetch" href="/assets/js/8.5c21a4cc.js"><link rel="prefetch" href="/assets/js/80.f826f188.js"><link rel="prefetch" href="/assets/js/81.b8995ea7.js"><link rel="prefetch" href="/assets/js/82.e9bf63e0.js"><link rel="prefetch" href="/assets/js/83.e3a00749.js"><link rel="prefetch" href="/assets/js/84.b940927c.js"><link rel="prefetch" href="/assets/js/85.ad46a9b2.js"><link rel="prefetch" href="/assets/js/86.190e0071.js"><link rel="prefetch" href="/assets/js/87.5f9eb9ef.js"><link rel="prefetch" href="/assets/js/88.cfaf7469.js"><link rel="prefetch" href="/assets/js/89.e64cc32c.js"><link rel="prefetch" href="/assets/js/9.0723805d.js"><link rel="prefetch" href="/assets/js/90.805edabe.js"><link rel="prefetch" href="/assets/js/91.6a1ab3f7.js"><link rel="prefetch" href="/assets/js/92.04ecd01e.js"><link rel="prefetch" href="/assets/js/93.e615470a.js"><link rel="prefetch" href="/assets/js/94.0ad7c41c.js"><link rel="prefetch" href="/assets/js/95.0e5ce618.js"><link rel="prefetch" href="/assets/js/96.b59cf9f4.js"><link rel="prefetch" href="/assets/js/97.2a327746.js"><link rel="prefetch" href="/assets/js/98.9c01ec88.js"><link rel="prefetch" href="/assets/js/99.952046bd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ccac5a78.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://github.com/fluidicon.png" alt="独角兕大王" class="logo"> <span class="site-name can-hide">独角兕大王</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/python/" class="nav-link">
  Python
</a></div><div class="nav-item"><a href="/rust/" class="nav-link router-link-active">
  Rust
</a></div><div class="nav-item"><a href="/go/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/lua/" class="nav-link">
  Lua
</a></div><div class="nav-item"><a href="/C/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="https://github.com/wuyuz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/double-W/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cnblogs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/python/" class="nav-link">
  Python
</a></div><div class="nav-item"><a href="/rust/" class="nav-link router-link-active">
  Rust
</a></div><div class="nav-item"><a href="/go/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/lua/" class="nav-link">
  Lua
</a></div><div class="nav-item"><a href="/C/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="https://github.com/wuyuz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/double-W/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cnblogs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="actix-basics"><a href="#actix-basics" class="header-anchor">#</a> Actix Basics</h1> <p>Actix: 一个长期霸榜的web框架</p> <p><a href="https://www.techempower.com/benchmarks/#section=data-r17&amp;hw=ph&amp;test=composite" target="_blank" rel="noopener noreferrer">TechEmpower Web Framework Performance Comparison<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Actix Web lets you quickly and confidently develop web services in Rust and this guide get you going in no time.</p> <p>The documentation on this website focusses primarily on the Actix Web framework. For information about the actor framework called Actix, check out the <a href="https://actix.rs/book/actix" target="_blank" rel="noopener noreferrer">Actix book<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (or the lower level <a href="https://docs.rs/actix" target="_blank" rel="noopener noreferrer">actix API docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>). Otherwise, head on to the <a href="https://actix.rs/docs/getting-started" target="_blank" rel="noopener noreferrer">getting started guide<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. If you already know your ways around and you need specific information you might want to read the <a href="https://docs.rs/actix-web" target="_blank" rel="noopener noreferrer">actix-web API docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>特性：</p> <ul><li>异步/同步 actors</li> <li>Actor 在本地/线程上下文中通信</li> <li>使用 Futures 进行异步消息处理</li> <li>Actor 监控</li> <li>支持 HTTP1/HTTP2</li> <li>类型化消息 (No Any type)</li></ul> <p>官网：</p> <p><a href="https://actix.rs/docs/" target="_blank" rel="noopener noreferrer">Documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="actix-quickstart"><a href="#actix-quickstart" class="header-anchor">#</a> Actix Quickstart</h2> <p>Before you can start writing an actix application, you’ll need a version of Rust installed. We recommend you use rustup to install or configure such a version.</p> <h3 id="install-rust"><a href="#install-rust" class="header-anchor">#</a> <a href="https://actix.rs/book/actix/sec-0-quick-start.html#install-rust" target="_blank" rel="noopener noreferrer">Install Rust<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h3> <p>Before we begin, we need to install Rust using the <a href="https://rustup.rs/" target="_blank" rel="noopener noreferrer">rustup<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> installer:
<code>curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh</code>
If you already have rustup installed, run this command to ensure you have the latest version of Rust:
<code>rustup update</code>
The actix framework requires Rust version 1.40.0 and up.</p> <p>通过下面命令检测rust版本：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>rustc <span class="token operator">-</span><span class="token operator">-</span>version
</code></pre></div><h3 id="getting-started"><a href="#getting-started" class="header-anchor">#</a> Getting Started</h3> <p>Let’s create and run our first actix application. We’ll create a new Cargo project that depends on actix and then run the application.In previous section we already installed required rust version. Now let's create new cargo projects.</p> <p>首先我们需要创建一个二进制项目，通过下面命令</p> <div class="language-rust extra-class"><pre class="language-rust"><code>cargo new actor<span class="token operator">-</span>ping
cd actor<span class="token operator">-</span>ping
</code></pre></div><p>同时需要添加actix依赖，通过在Cargo.toml中添加：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">[</span>dependencies<span class="token punctuation">]</span>
actix <span class="token operator">=</span> <span class="token string">&quot;0.10.0&quot;</span>
actix<span class="token operator">-</span>rt <span class="token operator">=</span> <span class="token string">&quot;1.1&quot;</span> # <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token class-name">Runtime</span> <span class="token keyword">for</span> actix，actix的运行时，基于<span class="token class-name">Tokio</span><span class="token operator">-</span>based的单线程异步运行时
</code></pre></div><p><strong>Actor Model</strong></p> <div class="language- extra-class"><pre><code>    Actor模式是一种并发模型，与另一种模型共享内存完全相反，Actor模型share nothing。所有的线程(或进程)通过消息传递的方式进行合作，这些线程(或进程)称为Actor。共享内存更适合单机多核的并发编程，而且共享带来的问题很多，编程也困难。随着多核时代和分布式系统的到来，共享模型已经不太适合并发编程，因此几十年前就已经出现的Actor模型又重新受到了人们的重视。MapReduce就是一种典型的Actor模式，而在语言级对Actor支持的编程语言Erlang又重新火了起来，Scala也提供了Actor，但是并不是在语言层面支持，Java也有第三方的Actor包，Go语言channel机制也是一种类Actor模型。
</code></pre></div><p>参考：</p> <p><a href="https://ifeve.com/introducing-actors-akka-notes-part-1/" target="_blank" rel="noopener noreferrer">并发编程网 - ifeve.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://zhuanlan.zhihu.com/p/82037463" target="_blank" rel="noopener noreferrer">Actor并发模型<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>编辑<code>actor_ping/src/main.rs</code>，让我们创建一个<code>actor</code>，它将接受Ping消息并以处理的Ping数量进行响应。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token comment">/// Define `Ping` message</span>
<span class="token comment">//#[derive(Message)]    // 实现message的方式一，使用注解</span>
<span class="token comment">//#[rtype(result = &quot;usize&quot;)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Ping</span><span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义actor需要接收的消息，这里使员工ping就是为了让其接收消息，Message的主要目的是定义放回结果的类型</span>
<span class="token comment">// Ping消息定义了usize，它指示任何可以接受Ping消息的参与者都需要返回usize值。</span>
<span class="token keyword">impl</span> <span class="token class-name">Message</span> <span class="token keyword">for</span> <span class="token class-name">Ping</span> <span class="token punctuation">{</span>   <span class="token comment">// 实现message的方式二，使用trait</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>  <span class="token comment">// 定义消息的类型为usize</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Actor</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyActor</span> <span class="token punctuation">{</span>   <span class="token comment">// 创建一个actor</span>
    count<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Declare actor and its context</span>
<span class="token comment">//每个actor都有一个执行上下文，对于MyActor我们将使用Context &lt;A&gt;，下一部分将提供有关参与者上下文的更多信息。</span>
<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span>   <span class="token comment">// 此actor必须实现Actor trait</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>  <span class="token comment">// 指定关联类型是Context&lt;Self&gt;</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Handler for `Ping` message，必须实现 Handler&lt;Ping&gt; 的trait</span>
<span class="token keyword">impl</span> <span class="token class-name">Handler</span><span class="token operator">&lt;</span><span class="token class-name">Ping</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span> <span class="token comment">// 指定RHS类型参数为Ping，表示Ping结构体类型和MyActor有操作</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token class-name">Ping</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>count <span class="token operator">+=</span> msg<span class="token number">.0</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>count
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 现在我们可以启动actor并发送message给它，启动过程其实应该取决于actor的上下文实现，在我们的例子中，我们可以使用基于&lt;tokio/future的Context&lt;A&gt;</span>
		<span class="token comment">// start()和create()方法返回一个actor的地址</span>
    <span class="token keyword">let</span> addr <span class="token operator">=</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 我们可以使用Actor::start() 或 Actor::create()启动它，</span>
                                               <span class="token comment">// 第一个用于可以立即创建actor实例的情况，第二个用于创建actor之前访问上下文</span>

    <span class="token comment">// send message and get future for result，所有的actor的通过地址交流</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> addr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Ping</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span> <span class="token comment">// 您可以不等待响应就发送一条消息，也可以将特定的消息发送给actor。</span>

    <span class="token comment">// handle() returns tokio handle</span>
		<span class="token comment">// 在这里，我们使用actix-rt作为启动系统和驱动主要Future的方式，因此我们可以轻松地等待发送给Actor的消息</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;RESULT: {}&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// stop system and exit</span>
    <span class="token class-name">System</span><span class="token punctuation">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="actor"><a href="#actor" class="header-anchor">#</a> Actor</h2> <p>Actix is built on the Actor Model which allows applications to be written as a group of independently executing but cooperating &quot;Actors&quot; which communicate via messages. Actors are objects which encapsulate state and behavior and run within the Actor System provided by the actix library.</p> <p>Actix基于Actor模型构建，该模型允许将应用程序编写为一组通过消息进行通信的独立执行但相互协作的“ Actor”。Actor是封装状态和行为并在actix库提供的Actor系统中运行的对象。（Actor=状态+行为）</p> <h3 id="actor-lifecycle"><a href="#actor-lifecycle" class="header-anchor">#</a> Actor lifecycle</h3> <h3 id="started"><a href="#started" class="header-anchor">#</a> Started</h3> <p>一个Actor总是在处于<code>Started</code>状态下开始，在这个状态区间中表示Actor的<code>started()</code>方法被调用，Actor trait提供了此方法的默认实现，Actor上下文在此状态下可用，并且Actor可以启动更多Actor、注册异步流或进行任何其他所需的配置。</p> <h3 id="running"><a href="#running" class="header-anchor">#</a> Running</h3> <p>在Actor的<code>starts()</code>方法被调用之后，Actor转换为Running状态，并且Actor可以无限期保持运行状态。</p> <h3 id="stopping"><a href="#stopping" class="header-anchor">#</a> Stopping</h3> <p>在以下情况下，Actor的执行状态变为停止状态：</p> <ul><li><code>Context::stop</code> is called by the actor itself.  Actor本身调用停止</li> <li>all addresses to the actor get dropped. i.e. no other actor references it. 在没有其他Actor引用它的前提下丢弃所有的Actor</li> <li>no event objects are registered in the context.  在上下文中没有注册任何事件对象</li></ul> <p>Actor可以从stopping状态恢复到running状态，通过创建新地址或添加事件对象并通过<code>Running::Continue</code>返回，如果一个Actor由于调用<code>Context::stop()</code>而将状态更改为stopping，则上下文会立即停止处理的<code>message</code> 并调用<code>Actor::stopping()</code>。如果Actor没有恢复到running状态，则会丢弃所有未处理的消息。By default this method returns <code>Running::Stop</code> which confirms the stop operation.</p> <h3 id="stopped"><a href="#stopped" class="header-anchor">#</a> Stopped</h3> <p>If the actor does not modify the execution context during the stopping state, the actor state changes to Stopped. This state is considered final and at this point the actor is dropped.</p> <h3 id="message"><a href="#message" class="header-anchor">#</a> Message</h3> <p>Actor通过发送message与其他Actor交流，在Actix中，所有message都是可以被自定义的，一条message可以是所有实现了Message trait的rust类型。<code>Message::Result</code> 定义返回类型，让我们定义一个简单的Ping消息-接受此消息的Actor需要返回<code>Result &lt;bool，std::io::Error&gt;</code>。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">actix</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Ping</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Message</span> <span class="token keyword">for</span> <span class="token class-name">Ping</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="spawning-an-actor"><a href="#spawning-an-actor" class="header-anchor">#</a> Spawning an actor</h3> <p>如何创建一个Actor取决于依赖的上下文，通过Actor特性的<code>start</code>和<code>create</code>方法可以生成新的异步Actor，It provides several different ways of creating actors。</p> <h3 id="complete-example"><a href="#complete-example" class="header-anchor">#</a> Complete example</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token comment">/// Define message</span>
<span class="token attribute attr-name">#[derive(Message)]</span>
<span class="token attribute attr-name">#[rtype(result = <span class="token string">&quot;Result&lt;bool, std::io::Error&gt;&quot;</span>)]</span>  <span class="token comment">// 使用注解的宏属性定义Message的返回类型</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Ping</span><span class="token punctuation">;</span>

<span class="token comment">// Define actor</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyActor</span><span class="token punctuation">;</span>

<span class="token comment">// Provide Actor implementation for our actor</span>
<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span>   <span class="token comment">// 定义实现Actor trait的MyActor，首先需要Context，同时在started中会在此状态中执行</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">started</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Actor is alive&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">stopped</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Actor is stopped&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Define handler for `Ping` message</span>
<span class="token keyword">impl</span> <span class="token class-name">Handler</span><span class="token operator">&lt;</span><span class="token class-name">Ping</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>  <span class="token comment">// 定义返回类型的实现</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token class-name">Ping</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Ping received&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 处理send发送的消息</span>

        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Start MyActor in current thread</span>
    <span class="token keyword">let</span> addr <span class="token operator">=</span> <span class="token class-name">MyActor</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Send Ping message.</span>
    <span class="token comment">// send() message returns Future object, that resolves to message result</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> addr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Ping</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>  <span class="token comment">// 此方法是基于MyActor的所以会自动传入self和一个Ping类型，触发Handler trait</span>

    <span class="token keyword">match</span> result <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Got result: {}&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// Got result: true</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Got error: {}&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="responding-with-a-messageresponse"><a href="#responding-with-a-messageresponse" class="header-anchor">#</a> Responding with a MessageResponse</h3> <p>让我们看看上面示例中为<code>impl Handler</code>定义的<code>Result</code>类型，看看我们是如何返回<code>Result&lt;bool, std::io::Error&gt;</code>的，我们能够以这种类型响应Actor的传入消息，因为它具有针对该类型实现的MessageResponse trait，Here's the definition for that trait:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// 在Hanler tarit定义中的要求：type Result: MessageResponse&lt;Self, M&gt;; 这里的M对应于Result&lt;bool, std::io::Error&gt;</span>

<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">MessageResponse</span><span class="token operator">&lt;</span><span class="token class-name">A</span><span class="token punctuation">:</span> <span class="token class-name">Actor</span><span class="token punctuation">,</span> <span class="token class-name">M</span><span class="token punctuation">:</span> <span class="token class-name">Message</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">ResponseChannel</span><span class="token operator">&lt;</span><span class="token class-name">M</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">A</span><span class="token punctuation">::</span><span class="token class-name">Context</span><span class="token punctuation">,</span> tx<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>有时候响应没有传入实现了这类tarit的类型的message也是很有意义的，当遇到这类情况时，我们可以自己实现此类trait，这是一个示例，其中我们用GotPing响应Ping消息，然后用GotPong响应Pong消息。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>dev<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">MessageResponse</span><span class="token punctuation">,</span> <span class="token class-name">ResponseChannel</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Message)]</span>
<span class="token attribute attr-name">#[rtype(result = <span class="token string">&quot;Responses&quot;</span>)]</span>  <span class="token comment">// 定义响应类型</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">Messages</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ping</span><span class="token punctuation">,</span>
    <span class="token class-name">Pong</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">Responses</span> <span class="token punctuation">{</span>
    <span class="token class-name">GotPing</span><span class="token punctuation">,</span>
    <span class="token class-name">GotPong</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">M</span><span class="token operator">&gt;</span> <span class="token class-name">MessageResponse</span><span class="token operator">&lt;</span><span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">M</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">Responses</span>
    <span class="token keyword">where</span>
        <span class="token class-name">A</span><span class="token punctuation">:</span> <span class="token class-name">Actor</span><span class="token punctuation">,</span>
        <span class="token class-name">M</span><span class="token punctuation">:</span> <span class="token class-name">Message</span><span class="token operator">&lt;</span><span class="token class-name">Result</span><span class="token operator">=</span><span class="token class-name">Responses</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">ResponseChannel</span><span class="token operator">&lt;</span><span class="token class-name">M</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">A</span><span class="token punctuation">::</span><span class="token class-name">Context</span><span class="token punctuation">,</span> tx<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 这里的handle的ResponseChannel会接收实现的MyActor的handle的返回值</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token operator">=</span> tx <span class="token punctuation">{</span>
            tx<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 处理返回值</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Define actor</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyActor</span><span class="token punctuation">;</span>

<span class="token comment">// Provide Actor implementation for our actor</span>
<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">started</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Actor is alive&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">stopped</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Actor is stopped&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Define handler for `Messages` enum</span>
<span class="token keyword">impl</span> <span class="token class-name">Handler</span><span class="token operator">&lt;</span><span class="token class-name">Messages</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token class-name">Responses</span><span class="token punctuation">;</span>  <span class="token comment">// 这里我们使用的是我们自己定义的Responses类型，而不是Result（会调用默认的MessageResponse）</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token class-name">Messages</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> msg <span class="token punctuation">{</span>
            <span class="token class-name">Messages</span><span class="token punctuation">::</span><span class="token class-name">Ping</span> <span class="token operator">=&gt;</span> <span class="token class-name">Responses</span><span class="token punctuation">::</span><span class="token class-name">GotPing</span><span class="token punctuation">,</span>
            <span class="token class-name">Messages</span><span class="token punctuation">::</span><span class="token class-name">Pong</span> <span class="token operator">=&gt;</span> <span class="token class-name">Responses</span><span class="token punctuation">::</span><span class="token class-name">GotPong</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Start MyActor in current thread</span>
    <span class="token keyword">let</span> addr <span class="token operator">=</span> <span class="token class-name">MyActor</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Send Ping message.</span>
    <span class="token comment">// send() message returns Future object, that resolves to message result</span>
    <span class="token keyword">let</span> ping_future <span class="token operator">=</span> addr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Messages</span><span class="token punctuation">::</span><span class="token class-name">Ping</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>  <span class="token comment">// 先调用MyActor的handle -》 MessageResponse的handle</span>
    <span class="token keyword">let</span> pong_future <span class="token operator">=</span> addr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Messages</span><span class="token punctuation">::</span><span class="token class-name">Pong</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>

    <span class="token keyword">match</span> pong_future <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">match</span> res <span class="token punctuation">{</span>
            <span class="token class-name">Responses</span><span class="token punctuation">::</span><span class="token class-name">GotPing</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Ping received&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Responses</span><span class="token punctuation">::</span><span class="token class-name">GotPong</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Pong received&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Actor is probably dead: {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">match</span> ping_future <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">match</span> res <span class="token punctuation">{</span>
            <span class="token class-name">Responses</span><span class="token punctuation">::</span><span class="token class-name">GotPing</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Ping received&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Responses</span><span class="token punctuation">::</span><span class="token class-name">GotPong</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Pong received&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Actor is probably dead: {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="address"><a href="#address" class="header-anchor">#</a> Address</h2> <p>Actor仅通过交换消息进行通信，发送方可以选择等待响应，无法仅通过其address直接引用Actor。有几种获取演员地址的方法，Actor trait 提供了两种方法去开启Actor，同时返回一个开始状态阿德Actor的地址。</p> <p>这是<code>Actor::start()</code>方法用法的示例，在此示例中<code>MyActor</code>结构体的Actor是异步的，并且在与调用方相同的线程中启动。一个异步Actor可以从Context结构中获取其地址，上下文需要实现<code>AsyncContext</code>trait， <code>AsyncContext::address()</code>提供Actor的地址。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">MyActor</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">started</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> addr <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 返回值</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> addr <span class="token operator">=</span> <span class="token class-name">MyActor</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="message-2"><a href="#message-2" class="header-anchor">#</a> Message</h3> <p>为了能够处理特定的消息，Actor必须为此message提供<code>Handler &lt;M&gt;</code>实现，所有message都是静态键入的，消息可以异步方式处理。Actor可以生成其他Actor，也可以将 <code>futures or streams</code>到执行上下文中。Actor特质提供了几种方法，可以控制Actor的生命周期。</p> <p>要将消息发送给参与者，需要使用Addr对象，Addr提供了几种发送消息的方法：</p> <ul><li><code>Addr::do_send(M)</code> - this method ignores any errors in message sending. If the mailbox is full the message is still queued, bypassing the limit. If the actor's mailbox is closed, the message is silently dropped. This method does not return the result, so if the mailbox is closed and a failure occurs, you won't have an indication of this.（忽略发送中的错误，比如mailbox已满，message仍在排队，绕过所有限制，如果actor的mailbox已经关闭，则将message丢弃）</li> <li><code>Addr::try_send(M)</code> - this method tries to send the message immediately. If the mailbox is full or closed (actor is dead), this method returns a <code>[SendError](https://actix.rs/actix/actix/prelude/enum.SendError.html)</code>. （立即发送消息，如果mailbox已满或者关闭，返回一个sendErr）</li> <li><code>Addr::send(M)</code> - This message returns a future object that resolves to a result of a message handling process. If the returned <code>Future</code> object is dropped, the message is cancelled. （该方法返回一个future的对象，该对象解析为message的处理过程的结果，如果丢弃返回的future对象，则该消息也被取消）</li></ul> <h3 id="recipient"><a href="#recipient" class="header-anchor">#</a> Recipient</h3> <p>收件人是地址的专用版本，仅支持一种类型的消息，如果消息需要发送到其他类型的Actor，则可以使用它，可以使用<code>Addr::recipient()</code>从地址创建收件人对象。地址对象需要一个Actor类型，但是如果我们只想发送特定的消息给可以处理该消息的Actor，则可以使用收件人接口。</p> <p>例如，收件人可以用于订阅系统，在以下示例中，<code>OrderEvents</code> Actor向所有订阅者发送一个<code>OrderShipped</code>消息，订户可以是实现<code>Handler &lt;OrderShipped&gt;</code>特性的任何Actor。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Message)]</span>
<span class="token attribute attr-name">#[rtype(result = <span class="token string">&quot;()&quot;</span>)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">OrderShipped</span><span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 寄件货运单号</span>

<span class="token attribute attr-name">#[derive(Message)]</span>
<span class="token attribute attr-name">#[rtype(result = <span class="token string">&quot;()&quot;</span>)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Ship</span><span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 寄件编号</span>

<span class="token comment">/// Subscribe to order shipped event. 订阅订单发货事件。</span>
<span class="token attribute attr-name">#[derive(Message)]</span>
<span class="token attribute attr-name">#[rtype(result = <span class="token string">&quot;()&quot;</span>)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Subscribe</span><span class="token punctuation">(</span><span class="token keyword">pub</span> <span class="token class-name">Recipient</span><span class="token operator">&lt;</span><span class="token class-name">OrderShipped</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 这里的Subscribe是一些Actor的接收对象的地址，下面的Email、SMS的地址可以存放</span>

<span class="token comment">/// Actor that provides order shipped event subscriptions, 提供订单发货事件订阅的Actor</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">OrderEvents</span> <span class="token punctuation">{</span>
    subscribers<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Recipient</span><span class="token operator">&lt;</span><span class="token class-name">OrderShipped</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 记录订阅者的Actor的接收地址</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">OrderEvents</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">OrderEvents</span> <span class="token punctuation">{</span>
            subscribers<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">OrderEvents</span> <span class="token punctuation">{</span>
    <span class="token comment">// 订单事件的Actor</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">OrderEvents</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Send event to all subscribers</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">notify</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> order_id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 提供订单事件通知功能，给订单订阅的对象发送消息</span>
        <span class="token keyword">for</span> subscr <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>subscribers <span class="token punctuation">{</span>
            subscr<span class="token punctuation">.</span><span class="token function">do_send</span><span class="token punctuation">(</span><span class="token class-name">OrderShipped</span><span class="token punctuation">(</span>order_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Subscribe to shipment event 订阅货运事件</span>
<span class="token keyword">impl</span> <span class="token class-name">Handler</span><span class="token operator">&lt;</span><span class="token class-name">Subscribe</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">OrderEvents</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token class-name">Subscribe</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>subscribers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token number">.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订阅货运单号</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Subscribe to ship message 订阅寄件留言</span>
<span class="token keyword">impl</span> <span class="token class-name">Handler</span><span class="token operator">&lt;</span><span class="token class-name">Ship</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">OrderEvents</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token class-name">Ship</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Context</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>msg<span class="token number">.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将寄件给订单事件，此时订单事件会通知每个订阅者，do_send,从而触发一系列动作</span>
        <span class="token class-name">System</span><span class="token punctuation">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Email Subscriber</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">EmailSubscriber</span><span class="token punctuation">;</span>  <span class="token comment">//邮件订阅</span>

<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">EmailSubscriber</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 得到通知后，触发handle函数</span>
<span class="token keyword">impl</span> <span class="token class-name">Handler</span><span class="token operator">&lt;</span><span class="token class-name">OrderShipped</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">EmailSubscriber</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token class-name">OrderShipped</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Context</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Email sent for order {}&quot;</span><span class="token punctuation">,</span> msg<span class="token number">.0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">SmsSubscriber</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">SmsSubscriber</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Handler</span><span class="token operator">&lt;</span><span class="token class-name">OrderShipped</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">SmsSubscriber</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token class-name">OrderShipped</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Context</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;SMS sent for order {}&quot;</span><span class="token punctuation">,</span> msg<span class="token number">.0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> system <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;events&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> email_subscriber <span class="token operator">=</span> <span class="token class-name">Subscribe</span><span class="token punctuation">(</span><span class="token class-name">EmailSubscriber</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recipient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> sms_subscriber <span class="token operator">=</span> <span class="token class-name">Subscribe</span><span class="token punctuation">(</span><span class="token class-name">SmsSubscriber</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recipient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> order_event <span class="token operator">=</span> <span class="token class-name">OrderEvents</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order_event<span class="token punctuation">.</span><span class="token function">do_send</span><span class="token punctuation">(</span>email_subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 添加Actor订阅着接收地址到subscribe的vec![]中</span>
    order_event<span class="token punctuation">.</span><span class="token function">do_send</span><span class="token punctuation">(</span>sms_subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 触发impl Handler&lt;Subscribe&gt; for OrderEvents</span>
    order_event<span class="token punctuation">.</span><span class="token function">do_send</span><span class="token punctuation">(</span><span class="token class-name">Ship</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 产生订单后，通知到各个订阅者，同时执行各自的handle方法，触发：impl Handler&lt;Ship&gt; for OrderEvents</span>
    system<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="context"><a href="#context" class="header-anchor">#</a> Context</h2> <p>Actors都维护一个内部执行上下文或状态，这样，Actor可以确定自己的地址，更改邮箱限制或停止执行等操作了。</p> <h3 id="mailbox"><a href="#mailbox" class="header-anchor">#</a> Mailbox</h3> <p>所有消息都首先发送到Actor的mailbox中，然后Actor的执行上下文调用特定的message处理程序，通常来说mailbox是有限制的，这也限制了上下文的实现。对于Context类型，默认情况下容量设置为16条消息，可以使用<code>Context::set_mailbox_capacity()</code>增加容量，但请记住这不适用于绕过邮箱队列限制的<code>Addr::do_send(M)</code>或完全绕过邮箱的<code>AsyncContext::notify(M)</code>和<code>AsyncContext::notify_later(M，Duration)</code>。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyActor</span><span class="token punctuation">;</span>
<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">started</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">set_mailbox_capacity</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">System</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> addr <span class="token operator">=</span> <span class="token class-name">MyActor</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="getting-your-actors-address"><a href="#getting-your-actors-address" class="header-anchor">#</a> Getting your actors Address</h3> <p>Actor可以从上下文中查看自己的地址，也许您想重新排队一个事件以供以后使用，或者您想要转换消息类型，也许您想用您的地址回复邮件，如果您希望Actor发送消息给自己，请看看<code>AsyncContext::notify(M)</code>。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyActor</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">WhoAmI</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Message</span> <span class="token keyword">for</span> <span class="token class-name">WhoAmI</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token namespace">actix<span class="token punctuation">::</span></span><span class="token class-name">Addr</span><span class="token operator">&lt;</span><span class="token class-name">MyActor</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Handler</span><span class="token operator">&lt;</span><span class="token class-name">WhoAmI</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token namespace">actix<span class="token punctuation">::</span></span><span class="token class-name">Addr</span><span class="token operator">&lt;</span><span class="token class-name">MyActor</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token class-name">WhoAmI</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;scratch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> addr <span class="token operator">=</span> <span class="token class-name">MyActor</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> who_addr <span class="token operator">=</span> addr<span class="token punctuation">.</span><span class="token function">do_send</span><span class="token punctuation">(</span><span class="token class-name">WhoAmI</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="stopping-an-actor"><a href="#stopping-an-actor" class="header-anchor">#</a> Stopping an Actor</h3> <p>在Actor执行上下文中，您可以选择阻止Actor处理任何将来的boxmail message，这可能是对错误情况的响应，或者是程序关闭的一部分，为此您可以调用<code>Context::stop()</code>。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">MyActor</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Message)]</span>
<span class="token attribute attr-name">#[rtype(result = <span class="token string">&quot;usize&quot;</span>)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Ping</span><span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Handler</span><span class="token operator">&lt;</span><span class="token class-name">Ping</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token class-name">Ping</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>count <span class="token operator">+=</span> msg<span class="token number">.0</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>count <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down ping receiver.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>count
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// start new actor</span>
    <span class="token keyword">let</span> addr <span class="token operator">=</span> <span class="token class-name">MyActor</span> <span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// send message and get future for result</span>
    <span class="token keyword">let</span> addr_2 <span class="token operator">=</span> addr<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> addr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Ping</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>

    <span class="token keyword">match</span> res <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//16</span>
            <span class="token macro property">assert!</span><span class="token punctuation">(</span>addr_2<span class="token punctuation">.</span><span class="token function">try_send</span><span class="token punctuation">(</span><span class="token class-name">Ping</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="arbiter"><a href="#arbiter" class="header-anchor">#</a> Arbiter</h3> <p>仲裁器为Actor，functions and futures 提供异步执行上下文，当Actor包含定义其Actor特定执行状态的上下文时，仲裁器将托管Actor运行的环境，最后仲裁员执行许多功能，最值得注意的是，他们能够生成新的OS线程，运行事件循环，在该事件循环上异步生成任务，并充当异步任务的助手。</p> <h3 id="system-and-arbiter"><a href="#system-and-arbiter" class="header-anchor">#</a> System and Arbiter</h3> <p>在我们之前的所有代码示例中，函数<code>System::new</code>创建一个Arbiter，供您的Actor在其中运行，当您在Actor上调用<code>start()</code>时，它将在系统仲裁器的线程内运行，在许多情况下，这就是使用Actix进行程序所需的全部区域。</p> <h3 id="the-event-loop"><a href="#the-event-loop" class="header-anchor">#</a> The event loop</h3> <p>一个仲裁器通过一个事件池控制一个线程，当仲裁程序生成任务时（通过<code>Arbiter::spawn</code>, <code>Context&lt;Actor&gt;::run_later</code>或类似结构体），仲裁程序会将任务排队以在该任务队列上执行。当您考虑使用仲裁器时，您可以考虑“单线程事件循环”。</p> <p>一般而言，Actix确实支持并发，但是普通仲裁器（不是SyncArbiters）不支持并发。要以并发方式使用Actix，您可以使用<code>Arbiter::new</code>，<code>ArbiterBuilder</code>或<code>Arbiter::start</code>启动多个Arbiter。</p> <p>创建新的仲裁器时，这将为Actor创建一个新的执行上下文。可以使用新线程向其中添加新的Actor，但是Actor无法在仲裁器之间自由移动：它们与生成它们的仲裁器绑定在一起，但是位于不同仲裁器上的Actor仍可以使用常规的Addr / Recipient方法相互通信。传递消息的方法与Actor是在相同还是不同的仲裁程序上运行无关。</p> <h3 id="using-arbiter-for-resolving-async-events"><a href="#using-arbiter-for-resolving-async-events" class="header-anchor">#</a> Using Arbiter for resolving async events</h3> <p>如果您不是Rust Futures的专家，那么Arbiter可以是一种有用且简单的包装器，可以按顺序解决异步事件。考虑我们有两个Actor: A和B，并且我们只想在A的结果完成后才在B上运行事件，我们可以使用<code>Arbiter::spawn</code>来完成此任务。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">SumActor</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">SumActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Message)]</span>
<span class="token attribute attr-name">#[rtype(result = <span class="token string">&quot;usize&quot;</span>)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Value</span><span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Handler</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">SumActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        msg<span class="token number">.0</span> <span class="token operator">+</span> msg<span class="token number">.1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">DisplayActor</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">DisplayActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Message)]</span>
<span class="token attribute attr-name">#[rtype(result = <span class="token string">&quot;()&quot;</span>)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Display</span><span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Handler</span><span class="token operator">&lt;</span><span class="token class-name">Display</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">DisplayActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token class-name">Display</span><span class="token punctuation">,</span> _ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Got {:?}&quot;</span><span class="token punctuation">,</span> msg<span class="token number">.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> system <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;single-arbiter-example&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Define an execution flow using futures</span>
    <span class="token keyword">let</span> execution <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token comment">// `Actor::start` spawns the `Actor` on the *current* `Arbiter`, which</span>
        <span class="token comment">// in this case is the System arbiter</span>
        <span class="token keyword">let</span> sum_addr <span class="token operator">=</span> <span class="token class-name">SumActor</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> dis_addr <span class="token operator">=</span> <span class="token class-name">DisplayActor</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Start by sending a `Value(6, 7)` to our `SumActor`.</span>
        <span class="token comment">// `Addr::send` responds with a `Request`, which implements `Future`.</span>
        <span class="token comment">// When awaited, it will resolve to a `Result&lt;usize, MailboxError&gt;`.</span>
        <span class="token keyword">let</span> sum_result <span class="token operator">=</span> sum_addr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Value</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>

        <span class="token keyword">match</span> sum_result <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// `res` is now the `usize` returned from `SumActor` as a response to `Value(6, 7)`</span>
                <span class="token comment">// Once the future is complete, send the successful response (`usize`)</span>
                <span class="token comment">// to the `DisplayActor` wrapped in a `Display</span>
                dis_addr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Display</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token macro property">eprintln!</span><span class="token punctuation">(</span><span class="token string">&quot;Encountered mailbox error: {:?}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// Spawn the future onto the current Arbiter/event loop</span>
    <span class="token class-name">Arbiter</span><span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span>execution<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// We only want to do one computation in this example, so we</span>
    <span class="token comment">// shut down the `System` which will stop any Arbiters within</span>
    <span class="token comment">// it (including the System Arbiter), which will in turn stop</span>
    <span class="token comment">// any Actor Contexts running within those Arbiters, finally</span>
    <span class="token comment">// shutting down all Actors.</span>
    <span class="token class-name">System</span><span class="token punctuation">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    system<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="syncarbiter"><a href="#syncarbiter" class="header-anchor">#</a> SyncArbiter</h2> <p>当您正常运行Actor时，使用其事件循环在系统的Arbiter线程上运行多个Actor，但是对于受CPU约束的工作负载或高度并发的工作负载，您可能希望让Actor并行运行多个实例。这就是SyncArbiter提供的功能-能够在OS线程池上启动Actor的多个实例。</p> <p>请务必注意，SyncArbiter只能托管一种类型的Actor。这意味着您需要为要以这种方式运行的每种Actor类型创建一个SyncArbiter。</p> <h3 id="creating-a-sync-actor"><a href="#creating-a-sync-actor" class="header-anchor">#</a> Creating a Sync Actor</h3> <p>实施要在SyncArbiter上运行的Actor时，需要将Actor的Context从Context更改为SyncContext。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">MySyncActor</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">MySyncActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">SyncContext</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="starting-the-sync-arbiter"><a href="#starting-the-sync-arbiter" class="header-anchor">#</a> Starting the Sync Arbiter</h3> <p>现在我们已经定义了一个Sync Actor，我们可以在由SyncArbiter创建的线程池上运行它。我们只能在SyncArbiter创建时控制线程数-我们以后不能添加/删除线程。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">MySyncActor</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">MySyncActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">SyncContext</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> addr <span class="token operator">=</span> <span class="token class-name">SyncArbiter</span><span class="token punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">MySyncActor</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We can communicate with the addr the same way as we have with our previous Actors that we started. We can send messages, receive futures and results, and more.Sync Actors have no Mailbox limits, but you should still use <code>do_send</code>, <code>try_send</code> and <code>send</code> as normal to account for other possible errors or sync vs async behavior.</p> <p>斐波拉且数列</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Fibonacci</span><span class="token punctuation">(</span><span class="token keyword">pub</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Message</span> <span class="token keyword">for</span> <span class="token class-name">Fibonacci</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">u64</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">SyncActor</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">SyncActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">SyncContext</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Handler</span><span class="token operator">&lt;</span><span class="token class-name">Fibonacci</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">SyncActor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">u64</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token class-name">Fibonacci</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Context</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> msg<span class="token number">.0</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> msg<span class="token number">.0</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> last <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> curr <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> i <span class="token operator">&lt;</span> msg<span class="token number">.0</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">{</span>
                sum <span class="token operator">=</span> last <span class="token operator">+</span> curr<span class="token punctuation">;</span>
                last <span class="token operator">=</span> curr<span class="token punctuation">;</span>
                curr <span class="token operator">=</span> sum<span class="token punctuation">;</span>
                i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// start sync arbiter with 3 threads</span>
    <span class="token keyword">let</span> addr <span class="token operator">=</span> <span class="token class-name">SyncArbiter</span><span class="token punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">SyncActor</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// send 5 messages</span>
    <span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token number">3</span><span class="token punctuation">..</span><span class="token number">32</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> addr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Fibonacci</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.51f2f156.js" defer></script><script src="/assets/js/2.8911ec45.js" defer></script><script src="/assets/js/117.4e79498c.js" defer></script>
  </body>
</html>
