<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>缓存和信号 | 独角兕大王</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.ccac5a78.css" as="style"><link rel="preload" href="/assets/js/app.51f2f156.js" as="script"><link rel="preload" href="/assets/js/2.8911ec45.js" as="script"><link rel="preload" href="/assets/js/63.1e45ce59.js" as="script"><link rel="prefetch" href="/assets/js/10.6948c28b.js"><link rel="prefetch" href="/assets/js/100.276864ee.js"><link rel="prefetch" href="/assets/js/101.447ab1c7.js"><link rel="prefetch" href="/assets/js/102.f5b3c71d.js"><link rel="prefetch" href="/assets/js/103.16474d4b.js"><link rel="prefetch" href="/assets/js/104.ed58aef3.js"><link rel="prefetch" href="/assets/js/105.045203cd.js"><link rel="prefetch" href="/assets/js/106.be359e0b.js"><link rel="prefetch" href="/assets/js/107.7331bbca.js"><link rel="prefetch" href="/assets/js/108.76e1c800.js"><link rel="prefetch" href="/assets/js/109.e82166f3.js"><link rel="prefetch" href="/assets/js/11.d4ec37c8.js"><link rel="prefetch" href="/assets/js/110.4144755a.js"><link rel="prefetch" href="/assets/js/111.5864ab53.js"><link rel="prefetch" href="/assets/js/112.ca2aee84.js"><link rel="prefetch" href="/assets/js/113.641e7765.js"><link rel="prefetch" href="/assets/js/114.d69f8545.js"><link rel="prefetch" href="/assets/js/115.1b6a9f89.js"><link rel="prefetch" href="/assets/js/116.dde2c44e.js"><link rel="prefetch" href="/assets/js/117.4e79498c.js"><link rel="prefetch" href="/assets/js/12.7aac9c8d.js"><link rel="prefetch" href="/assets/js/13.abf127cd.js"><link rel="prefetch" href="/assets/js/14.aa4413a7.js"><link rel="prefetch" href="/assets/js/15.11a64e5b.js"><link rel="prefetch" href="/assets/js/16.f2d9a882.js"><link rel="prefetch" href="/assets/js/17.11c5bb7f.js"><link rel="prefetch" href="/assets/js/18.a522877b.js"><link rel="prefetch" href="/assets/js/19.6f31a972.js"><link rel="prefetch" href="/assets/js/20.b546c54e.js"><link rel="prefetch" href="/assets/js/21.6d055b7f.js"><link rel="prefetch" href="/assets/js/22.c48feceb.js"><link rel="prefetch" href="/assets/js/23.69941f78.js"><link rel="prefetch" href="/assets/js/24.6126dfc2.js"><link rel="prefetch" href="/assets/js/25.3475449c.js"><link rel="prefetch" href="/assets/js/26.96bb4643.js"><link rel="prefetch" href="/assets/js/27.da610e5d.js"><link rel="prefetch" href="/assets/js/28.b24ec15c.js"><link rel="prefetch" href="/assets/js/29.ec8af553.js"><link rel="prefetch" href="/assets/js/3.bec5f768.js"><link rel="prefetch" href="/assets/js/30.2e780db1.js"><link rel="prefetch" href="/assets/js/31.464c36ed.js"><link rel="prefetch" href="/assets/js/32.ad7d37c2.js"><link rel="prefetch" href="/assets/js/33.722f1ec5.js"><link rel="prefetch" href="/assets/js/34.8448d0fd.js"><link rel="prefetch" href="/assets/js/35.e5168ac9.js"><link rel="prefetch" href="/assets/js/36.edc404f1.js"><link rel="prefetch" href="/assets/js/37.5807602e.js"><link rel="prefetch" href="/assets/js/38.a519c89a.js"><link rel="prefetch" href="/assets/js/39.89af1b9a.js"><link rel="prefetch" href="/assets/js/4.5ed19beb.js"><link rel="prefetch" href="/assets/js/40.6c653db9.js"><link rel="prefetch" href="/assets/js/41.bc3b8b69.js"><link rel="prefetch" href="/assets/js/42.a0a02d9b.js"><link rel="prefetch" href="/assets/js/43.62f344e3.js"><link rel="prefetch" href="/assets/js/44.a7fd9d68.js"><link rel="prefetch" href="/assets/js/45.729c1c39.js"><link rel="prefetch" href="/assets/js/46.5b924aea.js"><link rel="prefetch" href="/assets/js/47.f3990404.js"><link rel="prefetch" href="/assets/js/48.f591f360.js"><link rel="prefetch" href="/assets/js/49.f7f213ad.js"><link rel="prefetch" href="/assets/js/5.2c5d28b5.js"><link rel="prefetch" href="/assets/js/50.b9ca2762.js"><link rel="prefetch" href="/assets/js/51.93672ee6.js"><link rel="prefetch" href="/assets/js/52.fb21314a.js"><link rel="prefetch" href="/assets/js/53.65343ccc.js"><link rel="prefetch" href="/assets/js/54.8081227d.js"><link rel="prefetch" href="/assets/js/55.e207659e.js"><link rel="prefetch" href="/assets/js/56.bde381df.js"><link rel="prefetch" href="/assets/js/57.f8eceb45.js"><link rel="prefetch" href="/assets/js/58.bef70bfd.js"><link rel="prefetch" href="/assets/js/59.7ab7562d.js"><link rel="prefetch" href="/assets/js/6.fc65a1ac.js"><link rel="prefetch" href="/assets/js/60.f40ac3ca.js"><link rel="prefetch" href="/assets/js/61.d2b463ab.js"><link rel="prefetch" href="/assets/js/62.cfdf1bcf.js"><link rel="prefetch" href="/assets/js/64.a98fe86e.js"><link rel="prefetch" href="/assets/js/65.0234d7c5.js"><link rel="prefetch" href="/assets/js/66.724906f0.js"><link rel="prefetch" href="/assets/js/67.7806fda6.js"><link rel="prefetch" href="/assets/js/68.9f227dae.js"><link rel="prefetch" href="/assets/js/69.fdbc56ac.js"><link rel="prefetch" href="/assets/js/7.284de54e.js"><link rel="prefetch" href="/assets/js/70.04a9cc03.js"><link rel="prefetch" href="/assets/js/71.a6fa1dd9.js"><link rel="prefetch" href="/assets/js/72.2f8e3aa0.js"><link rel="prefetch" href="/assets/js/73.9bbb0cb6.js"><link rel="prefetch" href="/assets/js/74.9f122255.js"><link rel="prefetch" href="/assets/js/75.75e1fbd8.js"><link rel="prefetch" href="/assets/js/76.60ff3c3e.js"><link rel="prefetch" href="/assets/js/77.39a253ae.js"><link rel="prefetch" href="/assets/js/78.0e49712f.js"><link rel="prefetch" href="/assets/js/79.5f9c24a0.js"><link rel="prefetch" href="/assets/js/8.5c21a4cc.js"><link rel="prefetch" href="/assets/js/80.f826f188.js"><link rel="prefetch" href="/assets/js/81.b8995ea7.js"><link rel="prefetch" href="/assets/js/82.e9bf63e0.js"><link rel="prefetch" href="/assets/js/83.e3a00749.js"><link rel="prefetch" href="/assets/js/84.b940927c.js"><link rel="prefetch" href="/assets/js/85.ad46a9b2.js"><link rel="prefetch" href="/assets/js/86.190e0071.js"><link rel="prefetch" href="/assets/js/87.5f9eb9ef.js"><link rel="prefetch" href="/assets/js/88.cfaf7469.js"><link rel="prefetch" href="/assets/js/89.e64cc32c.js"><link rel="prefetch" href="/assets/js/9.0723805d.js"><link rel="prefetch" href="/assets/js/90.805edabe.js"><link rel="prefetch" href="/assets/js/91.6a1ab3f7.js"><link rel="prefetch" href="/assets/js/92.04ecd01e.js"><link rel="prefetch" href="/assets/js/93.e615470a.js"><link rel="prefetch" href="/assets/js/94.0ad7c41c.js"><link rel="prefetch" href="/assets/js/95.0e5ce618.js"><link rel="prefetch" href="/assets/js/96.b59cf9f4.js"><link rel="prefetch" href="/assets/js/97.2a327746.js"><link rel="prefetch" href="/assets/js/98.9c01ec88.js"><link rel="prefetch" href="/assets/js/99.952046bd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ccac5a78.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://github.com/fluidicon.png" alt="独角兕大王" class="logo"> <span class="site-name can-hide">独角兕大王</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/python/" class="nav-link router-link-active">
  Python
</a></div><div class="nav-item"><a href="/rust/" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/go/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/lua/" class="nav-link">
  Lua
</a></div><div class="nav-item"><a href="/C/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="https://github.com/wuyuz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/double-W/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cnblogs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/python/" class="nav-link router-link-active">
  Python
</a></div><div class="nav-item"><a href="/rust/" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/go/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/lua/" class="nav-link">
  Lua
</a></div><div class="nav-item"><a href="/C/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="https://github.com/wuyuz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/double-W/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cnblogs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python常用模块</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Django框架</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/python/django/Web框架本质.html" class="sidebar-link">Web框架本质</a></li><li><a href="/python/django/resquest、模块层.html" class="sidebar-link">resquest、模块层</a></li><li><a href="/python/django/静态文件和ORM.html" class="sidebar-link">静态文件和ORM</a></li><li><a href="/python/django/标签、自定义标签.html" class="sidebar-link">模块层之标签、自定义标签</a></li><li><a href="/python/django/模版语法.html" class="sidebar-link">模版语法</a></li><li><a href="/python/django/模型层.html" class="sidebar-link">模型层</a></li><li><a href="/python/django/反向解析和视图函数.html" class="sidebar-link">反向解析和视图函数</a></li><li><a href="/python/django/单表操作.html" class="sidebar-link">单表操作</a></li><li><a href="/python/django/多表操作.html" class="sidebar-link">多表操作</a></li><li><a href="/python/django/中间件.html" class="sidebar-link">中间件</a></li><li><a href="/python/django/模型进阶.html" class="sidebar-link">模型进阶</a></li><li><a href="/python/django/缓存和信号.html" class="active sidebar-link">缓存和信号</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/django/缓存和信号.html#缓存和信号" class="sidebar-link">缓存和信号</a></li><li class="sidebar-sub-header"><a href="/python/django/缓存和信号.html#缓存" class="sidebar-link">缓存</a></li><li class="sidebar-sub-header"><a href="/python/django/缓存和信号.html#信号" class="sidebar-link">信号</a></li><li class="sidebar-sub-header"><a href="/python/django/缓存和信号.html#orm性能相关" class="sidebar-link">ORM性能相关</a></li></ul></li><li><a href="/python/django/form组件.html" class="sidebar-link">form组件</a></li><li><a href="/python/django/csrf和Ajax.html" class="sidebar-link">csrf和Ajax</a></li><li><a href="/python/django/APIView使用和源码分析.html" class="sidebar-link">APIView使用和源码分析</a></li><li><a href="/python/django/REST framework之版本和解析器.html" class="sidebar-link">REST framework之版本和解析器</a></li><li><a href="/python/django/REST framework之分页和视图组件.html" class="sidebar-link">REST framework之分页和视图组件</a></li><li><a href="/python/django/REST framework之路由和渲染器.html" class="sidebar-link">REST framework之路由和渲染器</a></li><li><a href="/python/django/REST framework之序列化器.html" class="sidebar-link">REST framework之序列化器</a></li><li><a href="/python/django/REST framework版本图书管理系统.html" class="sidebar-link">REST framework版本图书管理系统</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flask 框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python爬虫</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python设计模式</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="缓存和信号"><a href="#缓存和信号" class="header-anchor">#</a> 缓存和信号</h2> <h3 id="_1-django-debug-toolbar"><a href="#_1-django-debug-toolbar" class="header-anchor">#</a> 1.django-debug-toolbar</h3> <ul><li><p>介绍</p></li> <li><p>django-debug-toolbar 是一组可配置的面板，可显示有关当前请求/响应的各种调试信息，并在单击时显示有关面板内容的更多详细信息。返回HttpResponse会失效</p></li> <li><p>安装：</p> <div class="language- extra-class"><pre class="language-text"><code>pip3 install django-debug-toolbar
</code></pre></div></li> <li><p>settings 配置</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#将 debug_toolbar 添加到 INSTALL_APPS 中</span>
INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token string">'debug_toolbar'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment">#如果是本机调试，还在将127.0.0.1加入 INTERNAL_IPS</span>
INTERNAL_IPS <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
<span class="token comment">#在中间件中加入DebugToolbarMiddleware</span>
MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token string">'debug_toolbar.middleware.DebugToolbarMiddleware'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment">#配置jQuery的URL</span>
	<span class="token comment">#django-debug-toolbar 默认使用的是Google的地址，默认配置如下：</span>
    JQUERY_URL <span class="token operator">=</span> <span class="token string">'//ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js'</span>
    <span class="token comment">#国内用不了的话可以在settings.py中配置一下，例如（我这里特意选用了和原作者相同版本的jQuery）：</span>
	DEBUG_TOOLBAR_CONFIG <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;JQUERY_URL&quot;</span><span class="token punctuation">:</span> <span class="token string">'//cdn.bootcss.com/jquery/2.2.4/jquery.min.js'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>urls.py中</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings

<span class="token keyword">if</span> settings<span class="token punctuation">.</span>DEBUG<span class="token punctuation">:</span><span class="token comment">#根据setting中的debug来判断，是否开启</span>
    <span class="token keyword">import</span> debug_toolbar

    urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
                      url<span class="token punctuation">(</span><span class="token string">r'^__debug__/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span>debug_toolbar<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token punctuation">]</span> <span class="token operator">+</span> urlpatterns
</code></pre></div><h2 id="缓存"><a href="#缓存" class="header-anchor">#</a> 缓存</h2> <ul><li><p>由于Django是动态网站，所有每次请求均会去数据进行相应的操作，当程序访问量大时，耗时必然会更加明显，最简单解决方式是使用：缓存，缓存将一个某个views的返回值保存至内存或者memcache中，5分钟内再有人来访问时，则不再去执行view中的操作，而是直接从内存或者memcache中之前缓存的内容拿到，并返回。</p></li> <li><p>开发调试---&gt;起到占位作用，本身不具备缓存。等上线之后更改配置即可使用</p> <div class="language- extra-class"><pre class="language-text"><code>不做任何缓存。咦？不做任何缓存？没听错吧，那干嘛要用它呢？

因为是开发调试模式，在本地进行调试，调试过程中，所有的相关缓存配置都需要加上，但是自己调试时候不需要加配置(效果半小时失效，不能干等半个小时看效果吧)，要实时看结果。先起到占位作用，等到上线，再改配置就可以使用了。
</code></pre></div></li> <li><p>内存</p></li> <li><p>文件</p></li> <li><p>数据库</p></li> <li><p>Memcache缓存(python-memcached模式)</p></li> <li><p>Memcache缓存(pylibmc模块)</p></li> <li><p>www.cnblogs.com/maple-shaw/articles/7563029.html</p></li></ul> <h4 id="_2-1-基于内存进行缓存的配置"><a href="#_2-1-基于内存进行缓存的配置" class="header-anchor">#</a> 2.1 基于内存进行缓存的配置</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token number">1.</span>settings<span class="token punctuation">.</span>py

<span class="token comment"># 此缓存将内容保存至内存的变量中</span>
<span class="token comment"># 配置：</span>
CACHES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'BACKEND'</span><span class="token punctuation">:</span> <span class="token string">'django.core.cache.backends.locmem.LocMemCache'</span><span class="token punctuation">,</span>
        <span class="token string">'LOCATION'</span><span class="token punctuation">:</span> <span class="token string">'unique-snowflake'</span><span class="token punctuation">,</span>
        <span class="token string">'TIMEOUT'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>         <span class="token comment"># 缓存超时时间（默认300，None表示永不过期，0表示立即过期）</span>
        <span class="token string">'OPTIONS'</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
            <span class="token string">'MAX_ENTRIES'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>  <span class="token comment"># 最大缓存个数（默认300）</span>
            <span class="token string">'CULL_FREQUENCY'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment"># 缓存到达最大个数之后，剔除缓存个数的比例，即：1/CULL_FREQUENCY（默认3）</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 注：其他配置同开发调试版本</span>

	
<span class="token number">2</span><span class="token punctuation">.</span>给视图加缓存
<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>decorators<span class="token punctuation">.</span>cache <span class="token keyword">import</span> cache_page
<span class="token decorator annotation punctuation">@cache_page</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token comment">#装饰器cache_timeout=5表示缓存超时时间5秒</span>
<span class="token keyword">def</span> <span class="token function">student_list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    students <span class="token operator">=</span> models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;打印代表没缓存&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span><span class="token string">'stu.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;students&quot;</span><span class="token punctuation">:</span>students<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">#5秒内除了第一次，多次访问是没有打印结果，代表不走缓存</span>
</code></pre></div><h4 id="_2-2-基于文件进行缓存的配置"><a href="#_2-2-基于文件进行缓存的配置" class="header-anchor">#</a> 2.2 基于文件进行缓存的配置</h4> <div class="language-python extra-class"><pre class="language-python"><code>CACHES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'BACKEND'</span><span class="token punctuation">:</span> <span class="token string">'django.core.cache.backends.filebased.FileBasedCache'</span><span class="token punctuation">,</span>
        <span class="token string">'LOCATION'</span><span class="token punctuation">:</span> <span class="token string">'G:\homework\day复习篇\day121Django\缓存\cache'</span><span class="token punctuation">,</span>
        <span class="token string">'TIMEOUT'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>         <span class="token comment"># 缓存超时时间（默认300，None表示永不过期，0表示立即过期）</span>
        <span class="token string">'OPTIONS'</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
            <span class="token string">'MAX_ENTRIES'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>  <span class="token comment"># 最大缓存个数（默认300）</span>
            <span class="token string">'CULL_FREQUENCY'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment"># 缓存到达最大个数之后，剔除缓存个数的比例，即：1/CULL_FREQUENCY（默认3）</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">#只是更改了'BACKEND' :'django.core.cache.backends.filebased.FileBasedCache'</span>
<span class="token comment">#'LOCATION' 文件存储位置。生成 .djcache后缀文件</span>
</code></pre></div><h4 id="_2-3基于数据库进行缓存的配置"><a href="#_2-3基于数据库进行缓存的配置" class="header-anchor">#</a> 2.3基于数据库进行缓存的配置</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token number">1</span><span class="token punctuation">.</span>
CACHES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'BACKEND'</span><span class="token punctuation">:</span> <span class="token string">'django.core.cache.backends.db.DatabaseCache'</span><span class="token punctuation">,</span>
        <span class="token string">'LOCATION'</span><span class="token punctuation">:</span> <span class="token string">'my_cache_table'</span><span class="token punctuation">,</span>
        <span class="token string">'TIMEOUT'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>         <span class="token comment"># 缓存超时时间（默认300，None表示永不过期，0表示立即过期）</span>
        <span class="token string">'OPTIONS'</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
            <span class="token string">'MAX_ENTRIES'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>  <span class="token comment"># 最大缓存个数（默认300）</span>
            <span class="token string">'CULL_FREQUENCY'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment"># 缓存到达最大个数之后，剔除缓存个数的比例，即：1/CULL_FREQUENCY（默认3）</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">2.</span>Terminal执行命令：
	python3 manage<span class="token punctuation">.</span>py createcachetable
   	生成表：表字段cache_key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>expires
</code></pre></div><h4 id="_2-4基于memcache进行缓存的配置"><a href="#_2-4基于memcache进行缓存的配置" class="header-anchor">#</a> 2.4基于Memcache进行缓存的配置</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#ip端口访问</span>
CACHES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'BACKEND'</span><span class="token punctuation">:</span> <span class="token string">'django.core.cache.backends.memcached.MemcachedCache'</span><span class="token punctuation">,</span>
        <span class="token string">'LOCATION'</span><span class="token punctuation">:</span> <span class="token string">'127.0.0.1:11211'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">#建立socket访问</span>
CACHES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'BACKEND'</span><span class="token punctuation">:</span> <span class="token string">'django.core.cache.backends.memcached.MemcachedCache'</span><span class="token punctuation">,</span>
        <span class="token string">'LOCATION'</span><span class="token punctuation">:</span> <span class="token string">'unix:/tmp/memcached.sock'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  

<span class="token comment">#多个缓存ip和端口，类似分布式</span>
CACHES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'BACKEND'</span><span class="token punctuation">:</span> <span class="token string">'django.core.cache.backends.memcached.MemcachedCache'</span><span class="token punctuation">,</span>
        <span class="token string">'LOCATION'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">'172.19.26.240:11211'</span><span class="token punctuation">,</span>
            <span class="token string">'172.19.26.242:11211'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-5全站使用缓存"><a href="#_2-5全站使用缓存" class="header-anchor">#</a> 2.5全站使用缓存</h4> <ul><li>使用中间件，经过一系列的认证等操作，如果内容在缓存中存在，则使用FetchFromCacheMiddleware获取内容并返回给用户，当返回给用户之前，判断缓存中是否已经存在，如果不存在则UpdateCacheMiddleware会将缓存保存至缓存，从而实现全站缓存</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
<span class="token string">'django.middleware.cache.UpdateCacheMiddleware'</span><span class="token punctuation">,</span><span class="token comment">#最上面</span>
<span class="token comment"># 其他中间件...</span>
<span class="token string">'django.middleware.cache.FetchFromCacheMiddleware'</span><span class="token punctuation">,</span><span class="token comment">#最下面</span>
<span class="token punctuation">]</span>
<span class="token comment">#只是添加2个中间件UpdateCacheMiddleware作用是更新缓存，FetchFromCacheMiddleware从缓存中获取数据</span>
</code></pre></div><h4 id="_2-6局部模板使用缓存"><a href="#_2-6局部模板使用缓存" class="header-anchor">#</a> 2.6局部模板使用缓存</h4> <ul><li>指的是页面返回数据，因为页面有些数据要实时看，有些不需要实时更新的。给不经常发生变化的加上缓存。</li> <li>views.py</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> time
<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render
<span class="token keyword">from</span> app01 <span class="token keyword">import</span> models
<span class="token keyword">def</span> <span class="token function">student_list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    students <span class="token operator">=</span> models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;打印代表没缓存&quot;</span><span class="token punctuation">)</span>
    now <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span><span class="token string">'stu.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;students&quot;</span><span class="token punctuation">:</span>students<span class="token punctuation">,</span><span class="token string">&quot;now&quot;</span><span class="token punctuation">:</span>now<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">#往模版传入时间</span>
</code></pre></div><ul><li>模版</li></ul> <div class="language-django extra-class"><pre class="language-django"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token django language-django"><span class="token delimiter punctuation">{%</span> <span class="token tag keyword">for</span> <span class="token variable">student</span> <span class="token keyword">in</span> <span class="token variable">students</span> <span class="token delimiter punctuation">%}</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token django language-django"><span class="token delimiter punctuation">{{</span> <span class="token variable">student</span><span class="token punctuation">.</span><span class="token variable">name</span> <span class="token delimiter punctuation">}}</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token django language-django"><span class="token delimiter punctuation">{%</span> <span class="token tag keyword">endfor</span> <span class="token delimiter punctuation">%}</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token django language-django"><span class="token comment">{# 实时更新 时间#}</span></span>
    <span class="token django language-django"><span class="token delimiter punctuation">{{</span> <span class="token variable">now</span> <span class="token delimiter punctuation">}}</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
<span class="token django language-django"><span class="token comment">{# 导入缓存#}</span></span>
<span class="token django language-django"><span class="token delimiter punctuation">{%</span> <span class="token tag keyword">load</span> <span class="token variable">cache</span> <span class="token delimiter punctuation">%}</span></span>
<span class="token django language-django"><span class="token comment">{# 设置缓存 5秒 更新一次，必须还有设置一个key #}</span></span>
<span class="token django language-django"><span class="token delimiter punctuation">{%</span> <span class="token tag keyword">cache</span> <span class="token number">5</span> <span class="token string">'keys'</span><span class="token delimiter punctuation">%}</span></span>
缓存<span class="token django language-django"><span class="token delimiter punctuation">{{</span> <span class="token variable">now</span> <span class="token delimiter punctuation">}}</span></span><span class="token django language-django"><span class="token comment">{# 内部代码5秒更新一次 #}</span></span>
<span class="token django language-django"><span class="token delimiter punctuation">{%</span> <span class="token tag keyword">endcache</span> <span class="token delimiter punctuation">%}</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="_2-7-django-redis配置"><a href="#_2-7-django-redis配置" class="header-anchor">#</a> 2.7 django-redis配置</h4> <ul><li><p><a href="https://django-redis-chs.readthedocs.io/zh_CN/latest/" target="_blank" rel="noopener noreferrer">https://django-redis-chs.readthedocs.io/zh_CN/latest/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p>本身不支持redis做缓存，通过django-redis</p></li> <li><p>下载</p> <div class="language- extra-class"><pre class="language-text"><code>pip install django-redis
</code></pre></div></li></ul> <div class="language-python extra-class"><pre class="language-python"><code>
CACHES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;default&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;BACKEND&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;django_redis.cache.RedisCache&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">#1为redis 的 1号库</span>
        <span class="token string">&quot;LOCATION&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;redis://127.0.0.1:6379/1&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;OPTIONS&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;CLIENT_CLASS&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;django_redis.client.DefaultClient&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><ul><li><h3 id="作为-session-backend-使用配置"><a href="#作为-session-backend-使用配置" class="header-anchor">#</a> 作为 session backend 使用配置</h3> <p>Django 默认可以使用任何 cache backend 作为 session backend, 将 django-redis 作为 session 储存后端不用安装任何额外的 backend</p> <div class="language- extra-class"><pre class="language-text"><code>SESSION_ENGINE = &quot;django.contrib.sessions.backends.cache&quot;
SESSION_CACHE_ALIAS = &quot;default&quot;
</code></pre></div></li></ul> <h2 id="信号"><a href="#信号" class="header-anchor">#</a> 信号</h2> <ul><li>Django中提供了“信号调度”，用于在框架执行操作时解耦。通俗来讲，就是一些动作发生的时候，信号允许特定的发送者去提醒一些接受者。</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>Model signals
    pre_init                    <span class="token comment"># django的model执行其构造方法前，自动触发</span>
    post_init                   <span class="token comment"># django的model执行其构造方法后，自动触发</span>
    pre_save                    <span class="token comment"># django的model对象保存前，自动触发</span>
    post_save                   <span class="token comment"># django的model对象保存后，自动触发</span>
    pre_delete                  <span class="token comment"># django的model对象删除前，自动触发</span>
    post_delete                 <span class="token comment"># django的model对象删除后，自动触发</span>
    m2m_changed                 <span class="token comment"># django的model中使用m2m字段操作第三张表（add,remove,clear）前后，自动触发</span>
    class_prepared              <span class="token comment"># 程序启动时，检测已注册的app中modal类，对于每一个类，自动触发</span>
Management signals
    pre_migrate                 <span class="token comment"># 执行migrate命令前，自动触发</span>
    post_migrate                <span class="token comment"># 执行migrate命令后，自动触发</span>
Request<span class="token operator">/</span>response signals
    request_started             <span class="token comment"># 请求到来前，自动触发</span>
    request_finished            <span class="token comment"># 请求结束后，自动触发</span>
    got_request_exception       <span class="token comment"># 请求异常后，自动触发</span>
Test signals
    setting_changed             <span class="token comment"># 使用test测试修改配置文件时，自动触发</span>
    template_rendered           <span class="token comment"># 使用test测试渲染模板时，自动触发</span>
Database Wrappers
    connection_created          <span class="token comment"># 创建数据库连接时，自动触发</span>
</code></pre></div><h4 id="_1-信号用法一"><a href="#_1-信号用法一" class="header-anchor">#</a> 1.信号用法一：</h4> <ul><li><p>对于Django内置的信号，仅需注册指定信号，当程序执行相应操作时，自动触发注册函数，<strong>注册信号，写入与project同名的文件夹下的<code>__init__.py</code>文件中</strong>，也是换数据库引擎的地方。这里拿post_save举例</p> <ul><li><code>__init__.py</code></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># post_save:django的model对象保存后，自动触发</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models<span class="token punctuation">.</span>signals <span class="token keyword">import</span> post_save
<span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;执行post_save信号&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span>kwargs<span class="token punctuation">)</span>

post_save<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token comment">#信号连接，并调用回调函数</span>
</code></pre></div><ul><li>views.py</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">student_list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    students <span class="token operator">=</span> models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>students<span class="token punctuation">)</span>
    models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'xxoo'</span><span class="token punctuation">)</span>  <span class="token comment">#创建一个对象，用于触发信号</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span><span class="token string">'stu.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;students&quot;</span><span class="token punctuation">:</span>students<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h4 id="_2-信号用法二"><a href="#_2-信号用法二" class="header-anchor">#</a> 2.信号用法二：</h4> <ul><li>通过装饰器receiver,也可以添加多个信号</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models<span class="token punctuation">.</span>signals <span class="token keyword">import</span> post_save
<span class="token keyword">from</span> django<span class="token punctuation">.</span>dispatch <span class="token keyword">import</span> receiver
<span class="token decorator annotation punctuation">@receiver</span><span class="token punctuation">(</span>post_save<span class="token punctuation">)</span><span class="token comment"># django的model对象保存后，自动触发</span>
<span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 这里的sender，是表示那个表的操作发起者，可以进行判断</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;执行post_save信号&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span>kwargs<span class="token punctuation">)</span>

post_save<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>callback<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@receiver</span><span class="token punctuation">(</span>pre_save<span class="token punctuation">)</span><span class="token comment"># django的model对象保存前，自动触发</span>
<span class="token keyword">def</span> <span class="token function">callback2</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;执行pre_save信号&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span>kwargs<span class="token punctuation">)</span>

pre_save<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>callback2<span class="token punctuation">)</span>

</code></pre></div><h4 id="_3-自定义信号"><a href="#_3-自定义信号" class="header-anchor">#</a> 3.自定义信号：</h4> <ul><li>在一个py文件定义信号！sig.py</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> django<span class="token punctuation">.</span>dispatch
pizza_done <span class="token operator">=</span> django<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span>Signal<span class="token punctuation">(</span>providing_args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;toppings&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;size&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#toppings,size自己定义字段</span>
</code></pre></div><ul><li>在<code>__init__.py</code>中注册信号</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sig <span class="token keyword">import</span> pizza_done
<span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;callback&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span>


pizza_done<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>callback<span class="token punctuation">)</span>

<span class="token comment">#触发后打印结果：</span>
callback
seven <span class="token punctuation">{</span><span class="token string">'signal'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>django<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span>Signal <span class="token builtin">object</span> at <span class="token number">0x000001BCD6D82B38</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token string">'toppings'</span><span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token string">'size'</span><span class="token punctuation">:</span> <span class="token number">456</span><span class="token punctuation">}</span>

</code></pre></div><ul><li><p>在视图函数触发信号<strong>由于内置信号的触发者已经集成到Django中，所以其会自动调用，而对于自定义信号则需要开发者在任意位置触发</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render
<span class="token keyword">from</span> app01 <span class="token keyword">import</span> models

<span class="token keyword">from</span> sig <span class="token keyword">import</span> pizza_done

<span class="token keyword">def</span> <span class="token function">student_list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	students <span class="token operator">=</span> models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	pizza_done<span class="token punctuation">.</span>send<span class="token punctuation">(</span>sender<span class="token operator">=</span><span class="token string">'seven'</span><span class="token punctuation">,</span> toppings<span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">456</span><span class="token punctuation">)</span><span class="token comment">#给sig中定义的字段传值，发起信号者赋值</span>
	<span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span><span class="token string">'stu.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;students&quot;</span><span class="token punctuation">:</span>students<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <div class="language- extra-class"><pre class="language-text"><code>触发信号：单独写文件，如果在视图函数写函数，当代码取消，不方便。如果单独写函数，虽然添加信号会繁琐，但功能不需要取消时候，就方便许多。
</code></pre></div><h4 id="案例二"><a href="#案例二" class="header-anchor">#</a> 案例二：</h4> <ul><li><p>在项目下的_<em>init</em>_.py文件中</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models<span class="token punctuation">.</span>signals <span class="token keyword">import</span> post_save
<span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;执行post_save信号&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span>kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'instance'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#&lt;class 'app.models.Student'&gt; sss</span>

post_save<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token comment">#信号连接，并调用回调函数</span>
</code></pre></div></li> <li><p>在models.py文中</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre></div></li> <li><p>在views.py文件中</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Student
<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>decorators<span class="token punctuation">.</span>csrf <span class="token keyword">import</span> csrf_exempt

<span class="token decorator annotation punctuation">@csrf_exempt</span>
<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>requset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    obj <span class="token operator">=</span> Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token operator">**</span>requset<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h2 id="orm性能相关"><a href="#orm性能相关" class="header-anchor">#</a> ORM性能相关</h2> <ul><li><p>尽量不用对象进行查询，多用values</p></li> <li><p>select_related('关联外键字段')   连表查询    用于多对一，一对一</p></li> <li><p>prefetch_related('关联外键字段')     子表查询    用于多对一，多对多</p></li> <li><p>只要返回某个字段。只是查某些字段   only('name')</p></li> <li><p>排除某些字段，defer(&quot;name&quot;)</p></li> <li><p>QuerySet特性</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token number">1</span><span class="token punctuation">.</span> 尽量不查对象，会跨表或多语句查询，用values直接取字段值，跨表一条语句，且结果为字典
 
    查询指定字段值时，尽量不用对象，而使用values直接取值
    <span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ret <span class="token operator">=</span> models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#获取所有对象</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> ret<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>name<span class="token punctuation">,</span>i<span class="token punctuation">.</span>classname<span class="token punctuation">)</span>   <span class="token comment">#这里要跨表查询对象的外键关联数据值时，orm会每一个对象都发一次sql查询，效率降低</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span><span class="token string">'index.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">'students'</span><span class="token punctuation">:</span>ret<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">#核心问题时我们通过对象点出来外键关联属性，我们可以不用all查询对象，而是用values直接获取到我们要的属性和值</span>
    <span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ret <span class="token operator">=</span> models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'classname'</span><span class="token punctuation">)</span>  <span class="token comment">#获取所有数据</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> ret<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">[</span>classname<span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment">#这里values得到的是字典，字典取值即可，此时orm会只发一次sql做了一次连表查询，效率高</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span><span class="token string">'index.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">'students'</span><span class="token punctuation">:</span>ret<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token number">2</span><span class="token punctuation">.</span> 对象查询时， 一对一、多对一获取关联对象时，使用select_related<span class="token punctuation">(</span>‘外键字段’<span class="token punctuation">)</span> 使多条语句sql合并为一条链表查询sql
   ret <span class="token operator">=</span> models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>select_related<span class="token punctuation">(</span><span class="token string">'classes'</span><span class="token punctuation">)</span>
   这条语句会在查询对象时，通过使用外键，仍能连表查询，效率提高

<span class="token number">3</span><span class="token punctuation">.</span> 对象查询时，多对一多对多时使用prefetch_related<span class="token punctuation">(</span>’外键‘<span class="token punctuation">)</span>，把多条sql合并使用子查询，减少查询次数
   ret <span class="token operator">=</span> models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>prefetch_related<span class="token punctuation">(</span><span class="token string">'classes'</span><span class="token punctuation">)</span>

<span class="token number">4</span><span class="token punctuation">.</span> 当对象查询指定字段值时，在orm后添加<span class="token punctuation">.</span>only<span class="token punctuation">(</span>‘指定字段’<span class="token punctuation">)</span>，得到的仍然是对象，与value不同的是value得到的是字典
   ret <span class="token operator">=</span> models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>only<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>

<span class="token number">5</span><span class="token punctuation">.</span> 当对象查询排除指定字段时，在orm后添加<span class="token punctuation">.</span>defer<span class="token punctuation">(</span>‘指定字段’<span class="token punctuation">)</span>，得到的仍然是对象，与value不同的是value得到的是字典
   ret <span class="token operator">=</span> models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>defer<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>
<span class="token number">6</span><span class="token punctuation">.</span> query_set特性
   只有在使用时才会查询数据库，而不是遇到查询语句就执行，比如html对象页面渲染
</code></pre></div><h3 id="_5-库的配置"><a href="#_5-库的配置" class="header-anchor">#</a> 5.库的配置</h3> <h4 id="_1-读写分离"><a href="#_1-读写分离" class="header-anchor">#</a> 1.读写分离</h4> <p>主要目的：单个数据库进行读写操作频繁，降低速度，增加服务器读写数据库压力，为了解决这一问题，对数据库进行读写分离，将大大提升项目的性能。其基本原理是：让主数据库处理事务性的增删改查，而从数据库处理查询操作，当主数据库因一些事务性操作导致数据变更后，同步更新到其他读库。写库一个，读库可以有多个。采用日志同步的方式实现主从同步。</p> <ul><li>settings配置</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#settings.py 配置库信息，生成2个库</span>

DATABASES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'ENGINE'</span><span class="token punctuation">:</span> <span class="token string">'django.db.backends.sqlite3'</span><span class="token punctuation">,</span>
        <span class="token string">'NAME'</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'db.sqlite3'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'db2'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'ENGINE'</span><span class="token punctuation">:</span> <span class="token string">'django.db.backends.sqlite3'</span><span class="token punctuation">,</span>
        <span class="token string">'NAME'</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'db2.sqlite3'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

python3 manage<span class="token punctuation">.</span>py makemigrations   <span class="token comment">#生成迁移文件</span>
python3 manage<span class="token punctuation">.</span>py migrate <span class="token operator">-</span><span class="token operator">-</span>database db2 <span class="token comment">#db2数据库迁移</span>

</code></pre></div><ul><li>手动操作</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>ret <span class="token operator">=</span> model<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>using<span class="token punctuation">(</span><span class="token string">'db2'</span><span class="token punctuation">)</span><span class="token comment">#查询db2库所有数据</span>

models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>using<span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'xxoo'</span><span class="token punctuation">)</span><span class="token comment">#往default库写入信息</span>

models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>using<span class="token punctuation">(</span><span class="token string">'db2'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#db2查询name='ss'，并更改name,并保存在default库中</span>
obj <span class="token operator">=</span> models<span class="token punctuation">.</span>Stundet<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>using<span class="token punctuation">(</span><span class="token string">'db2'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'ss'</span><span class="token punctuation">)</span>
obj<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;sha&quot;</span>
obj<span class="token punctuation">.</span>save<span class="token punctuation">(</span>using<span class="token operator">=</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 默认obj.save() 储存在db2中</span>
</code></pre></div><ul><li>自动操作</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#myrouter.py</span>

<span class="token keyword">class</span> <span class="token class-name">Router</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">db_for_write</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>model<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;db2&quot;</span>

	<span class="token keyword">def</span> <span class="token function">db_for_read</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>model<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;default&quot;</span>
<span class="token comment">#settings.py配置</span>
DATABASE_ROUTERS<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'myrouter.Router'</span><span class="token punctuation">,</span><span class="token punctuation">]</span>
</code></pre></div><h4 id="_2-一主多从"><a href="#_2-一主多从" class="header-anchor">#</a> 2.一主多从</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#myrouter.py</span>

<span class="token keyword">class</span> <span class="token class-name">Router</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">db_for_write</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>model<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;default&quot;</span>

	<span class="token keyword">def</span> <span class="token function">db_for_read</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>model<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'db2'</span><span class="token punctuation">,</span><span class="token string">'db3'</span><span class="token punctuation">,</span><span class="token string">&quot;db4&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">#settings.py配置</span>
DATABASE_ROUTERS<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'myrouter.Router'</span><span class="token punctuation">,</span><span class="token punctuation">]</span>

</code></pre></div><h4 id="_3-分库分表"><a href="#_3-分库分表" class="header-anchor">#</a> 3.分库分表</h4> <ul><li>分库：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#settings.py配置</span>
<span class="token comment">#myrouter.py</span>
<span class="token keyword">class</span> <span class="token class-name">Router</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    app01   model  db1
    app02   model  db2
    &quot;&quot;&quot;</span>
	<span class="token keyword">def</span> <span class="token function">db_for_write</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>model<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
         app_name <span class="token operator">=</span> model<span class="token punctuation">.</span>_meta<span class="token punctuation">.</span>app_label<span class="token comment">#此操作能获得app的名字</span>
         <span class="token keyword">if</span> app_name <span class="token operator">==</span> <span class="token string">&quot;app01&quot;</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">&quot;db1&quot;</span>
        <span class="token keyword">elif</span> app_name <span class="token operator">==</span> <span class="token string">&quot;app02&quot;</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string">&quot;app02&quot;</span>

	<span class="token keyword">def</span> <span class="token function">db_for_read</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>model<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
		app_name <span class="token operator">=</span> model<span class="token punctuation">.</span>_meta<span class="token punctuation">.</span>app_label<span class="token comment">#此操作能获得app的名字</span>
        <span class="token keyword">if</span> app_name <span class="token operator">==</span> <span class="token string">&quot;app01&quot;</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">&quot;db1&quot;</span>
        <span class="token keyword">elif</span> app_name <span class="token operator">==</span> <span class="token string">&quot;app02&quot;</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string">&quot;app02&quot;</span>
</code></pre></div><h4 id="_4-django执行原生sql"><a href="#_4-django执行原生sql" class="header-anchor">#</a> 4.Django执行原生SQL</h4> <ul><li>单起一个文件</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> os
<span class="token keyword">import</span> django
os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;temp.settings&quot;</span><span class="token punctuation">)</span>
djnago<span class="token punctuation">.</span>setup<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#以上配置django环境</span>

<span class="token comment">#extra方法：</span>
<span class="token keyword">from</span> app01 <span class="token keyword">import</span> models
<span class="token comment">#从Student，找id大于1的对象值</span>
ret <span class="token operator">=</span> models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extra<span class="token punctuation">(</span>where<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'id&gt;%s'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>params<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>

<span class="token comment">#raw方法：</span>
ret <span class="token operator">=</span> models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'select * from main.app01_classes'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> ret<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token comment">#拿到学生对象</span>
<span class="token comment">#connection方法：</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> connections
<span class="token comment">#cursor = connections.cursor()</span>
cursor <span class="token operator">=</span> connections<span class="token punctuation">[</span><span class="token string">'db2'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#指向db2库</span>
cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;select * from main.app_classes where id=%s&quot;&quot;&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
row <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span>
</code></pre></div><h3 id="_6-crm-rbac"><a href="#_6-crm-rbac" class="header-anchor">#</a> 6.CRM+RBAC</h3> <ul><li>客户关系管理系统</li></ul> <h4 id="_1-功能"><a href="#_1-功能" class="header-anchor">#</a> 1.功能</h4> <div class="language- extra-class"><pre class="language-text"><code>1.注册和登录
2.销售：
	- 客户信息展示
		公户/私户
	- 跟进记录的管理
	- 报名表的管理
	- 缴费记录的管理
3.班主任
	- 班级管理
	- 课程记录管理
	- 学生学习记录的管理
4.公户和私户
	避免抢单的情况
	有没有现成CRM系统？学邦
	http://www.xuebangsoft.com/case.html
	自己可开发可定制化程度高，当公司业务发生变化，可以根据自己公司业务需求改CRM

5.项目中用多少张表：
	CRM  10多张表：用户表，校区表，部门表，客户表，班级表，跟进记录表，报名表，缴费记录表，课程记录表，学习记录表。

权限：
1.如何实现权限控制？
	在web开发中，url地址当作权限
2.表结构设计：
	6张表(4个model)：
3.登录成功保存用户权限 + 中间件校验用户权限


4.表结构：
	

技术点：
	1.登录成功后保存权限信息：
		- 查询  跨表查询 去空 去重
		- 用户信息存储session
        	- session  list()  
	2.中间件：
		url  request.path_info
		*白名单：
			- settings 谁知白名单
			- re正则匹配
        *登录状态校验
        *免认证的校验
        *权限校验：
        	从session中获取权限信息
        	for循环 + re 校验
        *检验不通过最后返回HttpResponse('没有权限')

</code></pre></div><ul><li>数据结构</li></ul> <div class="language- extra-class"><pre class="language-text"><code>#简单权限控制
permission=[{&quot;permission&quot;:},{}]
</code></pre></div><ul><li><strong>需求发生变化（动态生成一级菜单）</strong></li></ul> <div class="language- extra-class"><pre class="language-text"><code>生成一级菜单：
Permission 
	增加字段 title  标题
			is_menu   是否是菜单
</code></pre></div><ul><li>数据结构变化</li></ul> <div class="language- extra-class"><pre class="language-text"><code>permission_list = [
	{
		url:xxx
	}
]
menu_list = [{'url':url,'title':title,'icon':icon}...]
</code></pre></div><ul><li>动态生成一级菜单</li></ul> <div class="language- extra-class"><pre class="language-text"><code>include_tag
</code></pre></div><ul><li><strong>需求发生变化（动态生成二级菜单）</strong></li></ul> <div class="language- extra-class"><pre class="language-text"><code>生成一个表
Menu   为一级菜单
 
原来 Permission表  为二级菜单
外键关联Menu  

#

</code></pre></div><ul><li>数据结构：</li></ul> <div class="language- extra-class"><pre class="language-text"><code>menu_dict = {
	一级菜单的id:{
		title:'xx',
		icon:'xxx'
		children:[
			{二级菜单url,二级菜单title},...
		]
	}
}
</code></pre></div><ul><li><strong>需求发生变化（排序）</strong></li></ul> <div class="language- extra-class"><pre class="language-text"><code>Menu表
	增加weight字段

排序：有序字典，sorted
</code></pre></div><ul><li>数据结构</li></ul> <div class="language- extra-class"><pre class="language-text"><code>menu_dict  增加weight字段

中间件CSS样式控制
</code></pre></div><ul><li><strong>需求发生变化：（非菜单权限归属）</strong></li></ul> <div class="language- extra-class"><pre class="language-text"><code>Permission表
	增加parent  字段    自关联
   	有parent_id  当前的权限就是子权限   一级菜单
   	有menu_id     当前是父权限    二级菜单

中间件：
	for循环有没有父ID
	判断有没有pid
		有pid当前是子权限   request。current_menu_id
		没有pid当前权限是父权限  二级菜单
	
</code></pre></div><ul><li>更改数据结构</li></ul> <h4 id="_7-1用户权限变更后"><a href="#_7-1用户权限变更后" class="header-anchor">#</a> 7.1用户权限变更后</h4> <ul><li>当用户的权限变更后,不重新登录,怎么应用最新的权限?</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token number">1</span><span class="token punctuation">.</span>用户表加字段 session_key
<span class="token number">2</span><span class="token punctuation">.</span>查询用户的session数据，把最新的权限保存进去

<span class="token comment">#解决思路：</span>
<span class="token number">1</span><span class="token punctuation">.</span>用户登录设置session   <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>requst<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">'keys'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;values&quot;</span>
<span class="token number">2</span><span class="token punctuation">.</span>登录状态访问其他网页，获取当前登录用户session_key
	keys <span class="token operator">=</span> request<span class="token punctuation">.</span>session<span class="token punctuation">.</span>session_key
<span class="token number">3</span><span class="token punctuation">.</span>查询Session表session_key等于keys
	<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>sessions<span class="token punctuation">.</span>models <span class="token keyword">import</span> Session
    ret <span class="token operator">=</span> Session<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>session_key<span class="token operator">=</span>keys<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    获取session_data<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>ret<span class="token punctuation">.</span>session_data
<span class="token number">4</span><span class="token punctuation">.</span>解密session_data 数据
	ses_data<span class="token operator">=</span>request<span class="token punctuation">.</span>session<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>ret<span class="token punctuation">.</span>session_data<span class="token punctuation">)</span>   此为<span class="token builtin">dict</span>类型
<span class="token number">5</span><span class="token punctuation">.</span>更改数据ses_data<span class="token punctuation">,</span>并且加密
	ses_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;xxx&quot;</span><span class="token punctuation">:</span><span class="token string">'ooo'</span><span class="token punctuation">}</span>
     new_ses_data <span class="token operator">=</span> request<span class="token punctuation">.</span>session<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>ses_data<span class="token punctuation">)</span>
<span class="token number">5</span><span class="token punctuation">.</span>将最新session保存至Session数据库中
	ret<span class="token punctuation">.</span>session_data <span class="token operator">=</span> new_ses_data
	ret<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="_7-2权限控制到按钮级别-怎么控制到行级别"><a href="#_7-2权限控制到按钮级别-怎么控制到行级别" class="header-anchor">#</a> 7.2权限控制到按钮级别,怎么控制到行级别?</h4> <ul><li>销售等级不同看到客户也不同，高级别销售能看到更优质客户</li></ul> <div class="language- extra-class"><pre class="language-text"><code>增加条件表，设置外键关联权限表
设置字段condition ---&gt;标识不同客户的条件 如是否是VIP

</code></pre></div><h4 id="_7-3你在开发中遇到什么印象深刻问题"><a href="#_7-3你在开发中遇到什么印象深刻问题" class="header-anchor">#</a> 7.3你在开发中遇到什么印象深刻问题？</h4> <div class="language- extra-class"><pre class="language-text"><code>1.json序列化   key是数字   序列化变成字符串
2.表结构变换
3.功能上的取舍   (用户需求变更后，不重新登录怎么应用最新权限)

</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/python/django/模型进阶.html" class="prev">
        模型进阶
      </a></span> <span class="next"><a href="/python/django/form组件.html">
        form组件
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.51f2f156.js" defer></script><script src="/assets/js/2.8911ec45.js" defer></script><script src="/assets/js/63.1e45ce59.js" defer></script>
  </body>
</html>
