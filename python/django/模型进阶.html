<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>模型进阶 | 独角兕大王</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.ccac5a78.css" as="style"><link rel="preload" href="/assets/js/app.51f2f156.js" as="script"><link rel="preload" href="/assets/js/2.8911ec45.js" as="script"><link rel="preload" href="/assets/js/61.d2b463ab.js" as="script"><link rel="prefetch" href="/assets/js/10.6948c28b.js"><link rel="prefetch" href="/assets/js/100.276864ee.js"><link rel="prefetch" href="/assets/js/101.447ab1c7.js"><link rel="prefetch" href="/assets/js/102.f5b3c71d.js"><link rel="prefetch" href="/assets/js/103.16474d4b.js"><link rel="prefetch" href="/assets/js/104.ed58aef3.js"><link rel="prefetch" href="/assets/js/105.045203cd.js"><link rel="prefetch" href="/assets/js/106.be359e0b.js"><link rel="prefetch" href="/assets/js/107.7331bbca.js"><link rel="prefetch" href="/assets/js/108.76e1c800.js"><link rel="prefetch" href="/assets/js/109.e82166f3.js"><link rel="prefetch" href="/assets/js/11.d4ec37c8.js"><link rel="prefetch" href="/assets/js/110.4144755a.js"><link rel="prefetch" href="/assets/js/111.5864ab53.js"><link rel="prefetch" href="/assets/js/112.ca2aee84.js"><link rel="prefetch" href="/assets/js/113.641e7765.js"><link rel="prefetch" href="/assets/js/114.d69f8545.js"><link rel="prefetch" href="/assets/js/115.1b6a9f89.js"><link rel="prefetch" href="/assets/js/116.dde2c44e.js"><link rel="prefetch" href="/assets/js/117.4e79498c.js"><link rel="prefetch" href="/assets/js/12.7aac9c8d.js"><link rel="prefetch" href="/assets/js/13.abf127cd.js"><link rel="prefetch" href="/assets/js/14.aa4413a7.js"><link rel="prefetch" href="/assets/js/15.11a64e5b.js"><link rel="prefetch" href="/assets/js/16.f2d9a882.js"><link rel="prefetch" href="/assets/js/17.11c5bb7f.js"><link rel="prefetch" href="/assets/js/18.a522877b.js"><link rel="prefetch" href="/assets/js/19.6f31a972.js"><link rel="prefetch" href="/assets/js/20.b546c54e.js"><link rel="prefetch" href="/assets/js/21.6d055b7f.js"><link rel="prefetch" href="/assets/js/22.c48feceb.js"><link rel="prefetch" href="/assets/js/23.69941f78.js"><link rel="prefetch" href="/assets/js/24.6126dfc2.js"><link rel="prefetch" href="/assets/js/25.3475449c.js"><link rel="prefetch" href="/assets/js/26.96bb4643.js"><link rel="prefetch" href="/assets/js/27.da610e5d.js"><link rel="prefetch" href="/assets/js/28.b24ec15c.js"><link rel="prefetch" href="/assets/js/29.ec8af553.js"><link rel="prefetch" href="/assets/js/3.bec5f768.js"><link rel="prefetch" href="/assets/js/30.2e780db1.js"><link rel="prefetch" href="/assets/js/31.464c36ed.js"><link rel="prefetch" href="/assets/js/32.ad7d37c2.js"><link rel="prefetch" href="/assets/js/33.722f1ec5.js"><link rel="prefetch" href="/assets/js/34.8448d0fd.js"><link rel="prefetch" href="/assets/js/35.e5168ac9.js"><link rel="prefetch" href="/assets/js/36.edc404f1.js"><link rel="prefetch" href="/assets/js/37.5807602e.js"><link rel="prefetch" href="/assets/js/38.a519c89a.js"><link rel="prefetch" href="/assets/js/39.89af1b9a.js"><link rel="prefetch" href="/assets/js/4.5ed19beb.js"><link rel="prefetch" href="/assets/js/40.6c653db9.js"><link rel="prefetch" href="/assets/js/41.bc3b8b69.js"><link rel="prefetch" href="/assets/js/42.a0a02d9b.js"><link rel="prefetch" href="/assets/js/43.62f344e3.js"><link rel="prefetch" href="/assets/js/44.a7fd9d68.js"><link rel="prefetch" href="/assets/js/45.729c1c39.js"><link rel="prefetch" href="/assets/js/46.5b924aea.js"><link rel="prefetch" href="/assets/js/47.f3990404.js"><link rel="prefetch" href="/assets/js/48.f591f360.js"><link rel="prefetch" href="/assets/js/49.f7f213ad.js"><link rel="prefetch" href="/assets/js/5.2c5d28b5.js"><link rel="prefetch" href="/assets/js/50.b9ca2762.js"><link rel="prefetch" href="/assets/js/51.93672ee6.js"><link rel="prefetch" href="/assets/js/52.fb21314a.js"><link rel="prefetch" href="/assets/js/53.65343ccc.js"><link rel="prefetch" href="/assets/js/54.8081227d.js"><link rel="prefetch" href="/assets/js/55.e207659e.js"><link rel="prefetch" href="/assets/js/56.bde381df.js"><link rel="prefetch" href="/assets/js/57.f8eceb45.js"><link rel="prefetch" href="/assets/js/58.bef70bfd.js"><link rel="prefetch" href="/assets/js/59.7ab7562d.js"><link rel="prefetch" href="/assets/js/6.fc65a1ac.js"><link rel="prefetch" href="/assets/js/60.f40ac3ca.js"><link rel="prefetch" href="/assets/js/62.cfdf1bcf.js"><link rel="prefetch" href="/assets/js/63.1e45ce59.js"><link rel="prefetch" href="/assets/js/64.a98fe86e.js"><link rel="prefetch" href="/assets/js/65.0234d7c5.js"><link rel="prefetch" href="/assets/js/66.724906f0.js"><link rel="prefetch" href="/assets/js/67.7806fda6.js"><link rel="prefetch" href="/assets/js/68.9f227dae.js"><link rel="prefetch" href="/assets/js/69.fdbc56ac.js"><link rel="prefetch" href="/assets/js/7.284de54e.js"><link rel="prefetch" href="/assets/js/70.04a9cc03.js"><link rel="prefetch" href="/assets/js/71.a6fa1dd9.js"><link rel="prefetch" href="/assets/js/72.2f8e3aa0.js"><link rel="prefetch" href="/assets/js/73.9bbb0cb6.js"><link rel="prefetch" href="/assets/js/74.9f122255.js"><link rel="prefetch" href="/assets/js/75.75e1fbd8.js"><link rel="prefetch" href="/assets/js/76.60ff3c3e.js"><link rel="prefetch" href="/assets/js/77.39a253ae.js"><link rel="prefetch" href="/assets/js/78.0e49712f.js"><link rel="prefetch" href="/assets/js/79.5f9c24a0.js"><link rel="prefetch" href="/assets/js/8.5c21a4cc.js"><link rel="prefetch" href="/assets/js/80.f826f188.js"><link rel="prefetch" href="/assets/js/81.b8995ea7.js"><link rel="prefetch" href="/assets/js/82.e9bf63e0.js"><link rel="prefetch" href="/assets/js/83.e3a00749.js"><link rel="prefetch" href="/assets/js/84.b940927c.js"><link rel="prefetch" href="/assets/js/85.ad46a9b2.js"><link rel="prefetch" href="/assets/js/86.190e0071.js"><link rel="prefetch" href="/assets/js/87.5f9eb9ef.js"><link rel="prefetch" href="/assets/js/88.cfaf7469.js"><link rel="prefetch" href="/assets/js/89.e64cc32c.js"><link rel="prefetch" href="/assets/js/9.0723805d.js"><link rel="prefetch" href="/assets/js/90.805edabe.js"><link rel="prefetch" href="/assets/js/91.6a1ab3f7.js"><link rel="prefetch" href="/assets/js/92.04ecd01e.js"><link rel="prefetch" href="/assets/js/93.e615470a.js"><link rel="prefetch" href="/assets/js/94.0ad7c41c.js"><link rel="prefetch" href="/assets/js/95.0e5ce618.js"><link rel="prefetch" href="/assets/js/96.b59cf9f4.js"><link rel="prefetch" href="/assets/js/97.2a327746.js"><link rel="prefetch" href="/assets/js/98.9c01ec88.js"><link rel="prefetch" href="/assets/js/99.952046bd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ccac5a78.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://github.com/fluidicon.png" alt="独角兕大王" class="logo"> <span class="site-name can-hide">独角兕大王</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/python/" class="nav-link router-link-active">
  Python
</a></div><div class="nav-item"><a href="/rust/" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/go/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/lua/" class="nav-link">
  Lua
</a></div><div class="nav-item"><a href="/C/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="https://github.com/wuyuz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/double-W/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cnblogs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/python/" class="nav-link router-link-active">
  Python
</a></div><div class="nav-item"><a href="/rust/" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/go/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/lua/" class="nav-link">
  Lua
</a></div><div class="nav-item"><a href="/C/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="https://github.com/wuyuz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/double-W/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cnblogs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python常用模块</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Django框架</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/python/django/Web框架本质.html" class="sidebar-link">Web框架本质</a></li><li><a href="/python/django/resquest、模块层.html" class="sidebar-link">resquest、模块层</a></li><li><a href="/python/django/静态文件和ORM.html" class="sidebar-link">静态文件和ORM</a></li><li><a href="/python/django/标签、自定义标签.html" class="sidebar-link">模块层之标签、自定义标签</a></li><li><a href="/python/django/模版语法.html" class="sidebar-link">模版语法</a></li><li><a href="/python/django/模型层.html" class="sidebar-link">模型层</a></li><li><a href="/python/django/反向解析和视图函数.html" class="sidebar-link">反向解析和视图函数</a></li><li><a href="/python/django/单表操作.html" class="sidebar-link">单表操作</a></li><li><a href="/python/django/多表操作.html" class="sidebar-link">多表操作</a></li><li><a href="/python/django/中间件.html" class="sidebar-link">中间件</a></li><li><a href="/python/django/模型进阶.html" class="active sidebar-link">模型进阶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/django/模型进阶.html#模型进阶" class="sidebar-link">模型进阶</a></li><li class="sidebar-sub-header"><a href="/python/django/模型进阶.html#queryset" class="sidebar-link">QuerySet</a></li><li class="sidebar-sub-header"><a href="/python/django/模型进阶.html#中介模型" class="sidebar-link">中介模型</a></li><li class="sidebar-sub-header"><a href="/python/django/模型进阶.html#查询优化" class="sidebar-link">查询优化</a></li><li class="sidebar-sub-header"><a href="/python/django/模型进阶.html#extra" class="sidebar-link">extra</a></li></ul></li><li><a href="/python/django/缓存和信号.html" class="sidebar-link">缓存和信号</a></li><li><a href="/python/django/form组件.html" class="sidebar-link">form组件</a></li><li><a href="/python/django/csrf和Ajax.html" class="sidebar-link">csrf和Ajax</a></li><li><a href="/python/django/APIView使用和源码分析.html" class="sidebar-link">APIView使用和源码分析</a></li><li><a href="/python/django/REST framework之版本和解析器.html" class="sidebar-link">REST framework之版本和解析器</a></li><li><a href="/python/django/REST framework之分页和视图组件.html" class="sidebar-link">REST framework之分页和视图组件</a></li><li><a href="/python/django/REST framework之路由和渲染器.html" class="sidebar-link">REST framework之路由和渲染器</a></li><li><a href="/python/django/REST framework之序列化器.html" class="sidebar-link">REST framework之序列化器</a></li><li><a href="/python/django/REST framework版本图书管理系统.html" class="sidebar-link">REST framework版本图书管理系统</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flask 框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python爬虫</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python设计模式</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="模型进阶"><a href="#模型进阶" class="header-anchor">#</a> 模型进阶</h2> <h4 id="官网知识点补充"><a href="#官网知识点补充" class="header-anchor">#</a> 官网知识点补充</h4> <p><strong>需要使用的数据</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models

<span class="token keyword">class</span> <span class="token class-name">Blog</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
    tagline <span class="token operator">=</span> models<span class="token punctuation">.</span>TextField<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>name

<span class="token keyword">class</span> <span class="token class-name">Author</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>
    email <span class="token operator">=</span> models<span class="token punctuation">.</span>EmailField<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>name

<span class="token keyword">class</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    blog <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>Blog<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span>
    headline <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span>
    body_text <span class="token operator">=</span> models<span class="token punctuation">.</span>TextField<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pub_date <span class="token operator">=</span> models<span class="token punctuation">.</span>DateField<span class="token punctuation">(</span><span class="token punctuation">)</span>
    mod_date <span class="token operator">=</span> models<span class="token punctuation">.</span>DateField<span class="token punctuation">(</span><span class="token punctuation">)</span>
    authors <span class="token operator">=</span> models<span class="token punctuation">.</span>ManyToManyField<span class="token punctuation">(</span>Author<span class="token punctuation">)</span>
    n_comments <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span><span class="token punctuation">)</span>
    n_pingbacks <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span><span class="token punctuation">)</span>
    rating <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>headline
</code></pre></div><ul><li><p><strong>创建对象</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> blog<span class="token punctuation">.</span>models <span class="token keyword">import</span> Blog
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> b <span class="token operator">=</span> Blog<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'Beatles Blog'</span><span class="token punctuation">,</span> tagline<span class="token operator">=</span><span class="token string">'All the latest Beatles news.'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> b<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p><strong>针对ForeignKey和ManyToManyField字段的保存：</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>ForeignKey添加记录
<span class="token comment">#法一：</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> blog<span class="token punctuation">.</span>models <span class="token keyword">import</span> Blog<span class="token punctuation">,</span> Entry 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> entry <span class="token operator">=</span> Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">#去拿到要被添加记录的对象</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> cheese_blog <span class="token operator">=</span> Blog<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;Cheddar Talk&quot;</span><span class="token punctuation">)</span> <span class="token comment"># 要添加的记录</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> entry<span class="token punctuation">.</span>blog <span class="token operator">=</span> cheese_blog  <span class="token comment">#使用关联管理对象绑定</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> entry<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#法二：</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> blog<span class="token punctuation">.</span>models <span class="token keyword">import</span> Author
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> joe <span class="token operator">=</span> Author<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;Joe&quot;</span><span class="token punctuation">)</span> <span class="token comment">#创建一个记录</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> entry<span class="token punctuation">.</span>authors<span class="token punctuation">.</span>add<span class="token punctuation">(</span>joe<span class="token punctuation">)</span>  <span class="token comment"># 使用关系管理对象添加</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
ManyToManyFeild添加数据
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> john <span class="token operator">=</span> Author<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;John&quot;</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> paul <span class="token operator">=</span> Author<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;Paul&quot;</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> george <span class="token operator">=</span> Author<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;George&quot;</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> ringo <span class="token operator">=</span> Author<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;Ringo&quot;</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> entry<span class="token punctuation">.</span>authors<span class="token punctuation">.</span>add<span class="token punctuation">(</span>john<span class="token punctuation">,</span> paul<span class="token punctuation">,</span> george<span class="token punctuation">,</span> ringo<span class="token punctuation">)</span>  <span class="token comment">#使用关系管理对象一次性添加多个记录</span>
</code></pre></div></li> <li><p><strong>跨越关系的查找</strong>：</p> <div class="language-python extra-class"><pre class="language-python"><code> <span class="token comment">#要跨越关系，只需使用跨模型的相关字段的字段名称，用双下划线分隔，直到到达所需的字段。</span>
    
 <span class="token comment">#练习：检索所有Entry与对象Blog，其name 为：'Beatles Blog'</span>
 <span class="token comment">#正向查询，使用关联管理对象__name</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>blog__name<span class="token operator">=</span><span class="token string">'Beatles Blog'</span><span class="token punctuation">)</span> 

 <span class="token comment">#练习：使用检索所有Blog具有至少一个对象Entry ，其headline包含'Lennon'</span>
 <span class="token comment">#反向查询，使用小写的表名__字段(甚至可以深度查询)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>Blog<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>entry__headline__contains<span class="token operator">=</span><span class="token string">'Lennon'</span><span class="token punctuation">)</span> 
</code></pre></div></li> <li><h5 id="跨越多值关系"><a href="#跨越多值关系" class="header-anchor">#</a> 跨越多值关系</h5> <div class="language-python extra-class"><pre class="language-python"><code> <span class="token comment">#练习：要选择所有包含标题中包含“Lennon”且2008年发布的条目（同一条目满足两个条件）的博客。</span>
Blog<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>entry__headline__contains<span class="token operator">=</span><span class="token string">'Lennon'</span><span class="token punctuation">,</span> entry__pub_date__year<span class="token operator">=</span><span class="token number">2008</span><span class="token punctuation">)</span>

 <span class="token comment">#练习：要选择标题 中包含“Lennon”条目的所有博客以及 2008年发布的条目。</span>
Blog<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>entry__headline__contains<span class="token operator">=</span><span class="token string">'Lennon'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>entry__pub_date__year<span class="token operator">=</span><span class="token number">2008</span><span class="token punctuation">)</span> 

<span class="token comment">#假设只有一个博客的两个条目都包含“Lennon”和2008年的条目，但是2008年的条目都没有包含“Lennon”。第一个查询不会返回任何博客，但第二个查询将返回该博客。</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
如上所述<span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>，跨越多值关系的查询的行为不是等效实现的exclude<span class="token punctuation">(</span><span class="token punctuation">)</span>。相反，单个exclude<span class="token punctuation">(</span><span class="token punctuation">)</span> 调用中的条件不一定是指同一个项目。

<span class="token comment">#练习:下面的查询将排除包含博客都 与条目“侬”的标题，并在2008年出版的条目</span>
Blog<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>exclude<span class="token punctuation">(</span>
    entry__headline__contains<span class="token operator">=</span><span class="token string">'Lennon'</span><span class="token punctuation">,</span>
    entry__pub_date__year<span class="token operator">=</span><span class="token number">2008</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token comment">#但是，与使用时的filter()的行为不同 ，这不会限制基于满足这两个条件的条目的博客。为了做到这一点，即选择所有不包含 2008年发布的“Lennon”条目的博客，您需要进行两次查询：</span>
Blog<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>exclude<span class="token punctuation">(</span>
    entry__in<span class="token operator">=</span>Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>
        headline__contains<span class="token operator">=</span><span class="token string">'Lennon'</span><span class="token punctuation">,</span>
        pub_date__year<span class="token operator">=</span><span class="token number">2008</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre></div></li> <li><p><strong>F查询用于同一模型中字段的比较</strong>：在到目前为止给出的例子中，我们构造了过滤器，用于比较模型字段的值和常量。但是，如果要将模型字段的值与同一模型上的另一个字段进行比较，该怎么办？</p> <div class="language-python extra-class"><pre class="language-python"><code> <span class="token comment">#练习1：要查找包含比pingback更多注释的所有博客条目的列表，我们构造一个F()对象来引用pingback计数，并F()在查询中使用该对象。</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> F
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>n_comments__gt<span class="token operator">=</span>F<span class="token punctuation">(</span><span class="token string">'n_pingbacks'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
 <span class="token comment">#可以使用加减乘除</span>
 <span class="token comment">#练习2：要查找所有博客条目的评论数量是pingback的两倍以上 ，我们会修改查询</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>n_comments__gt<span class="token operator">=</span>F<span class="token punctuation">(</span><span class="token string">'n_pingbacks'</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> 

 <span class="token comment">#练习3：要查找条目评级小于pingback计数和评论计数总和的所有条目，我们将发出查询 </span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>rating__lt<span class="token operator">=</span>F<span class="token punctuation">(</span><span class="token string">'n_comments'</span><span class="token punctuation">)</span> <span class="token operator">+</span> F<span class="token punctuation">(</span><span class="token string">'n_pingbacks'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
 <span class="token comment">#跨表F查询：F()具有双下划线的对象将引入访问相关对象所需的任何连接，正反都可以</span>
 <span class="token comment">#练习1：要检索作者姓名与博客名称相同的所有条目，我们可以发出查询</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>authors__name<span class="token operator">=</span>F<span class="token punctuation">(</span><span class="token string">'blog__name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token comment">#练习2：内容将返回在发布后超过3天内修改的所有条目</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> datetime <span class="token keyword">import</span> timedelta
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>mod_date__gt<span class="token operator">=</span>F<span class="token punctuation">(</span><span class="token string">'pub_date'</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
 <span class="token comment">#该F()对象通过支持位运算.bitand()，.bitor()， .bitrightshift()，和.bitleftshift()。例如：</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> F<span class="token punctuation">(</span><span class="token string">'somefield'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>bitand<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>       
</code></pre></div></li> <li><p><strong>PK查询快捷方式</strong>：Django提供了一个<code>pk</code>查找快捷方式，代表“主键”。</p> <div class="language-python extra-class"><pre class="language-python"><code> <span class="token comment">#以下三条在id为主键下是等效的</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Blog<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>id__exact<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span> <span class="token comment"># Explicit form</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Blog<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span> <span class="token comment"># __exact is implied</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Blog<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span> <span class="token comment"># pk implies id__exact</span>

 <span class="token comment">#使用pk不仅限于__exact查询 - 可以组合任何查询术语以pk对模型的主键执行查询：</span>
 <span class="token comment"># Get blogs entries with id 1, 4 and 7</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Blog<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>pk__in<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># Get all blog entries with id &gt; 14</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Blog<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>pk__gt<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment">#pk查找也适用于连接。例如，这三个陈述是等价的</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>blog__id__exact<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment"># Explicit form</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>blog__id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>        <span class="token comment"># __exact is implied</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>blog__pk<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>        <span class="token comment"># __pk implies __id__exact</span>
</code></pre></div></li> <li><p><strong>使用Q对象进行复杂查找</strong>：关键字参数查询 - 输入<a href="https://docs.djangoproject.com/zh-hans/2.1/ref/models/querysets/#django.db.models.query.QuerySet.filter" target="_blank" rel="noopener noreferrer"><code>filter()</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>等 - 是“AND”编辑在一起的。如果需要执行更复杂的查询（例如，带<code>OR</code>语句的查询），则可以使用。<a href="https://docs.djangoproject.com/zh-hans/2.1/ref/models/querysets/#django.db.models.Q" target="_blank" rel="noopener noreferrer"><code>Qobjects</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 也就是说在filter中的条件只能同时满足才能查询，不能进行满足其中一个即可。</p> <div class="language-python extra-class"><pre class="language-python"><code>用法<span class="token number">1</span>：封装查询对象， Q（）是用于封装关键字参数集合的对象。这些关键字参数在上面的“字段查找”中指定<span class="token punctuation">,</span>例如下面的Q，此Q对象封装了一个LIKE查询<span class="token punctuation">:</span>
    
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Q
Q<span class="token punctuation">(</span>question__startswith<span class="token operator">=</span><span class="token string">'What'</span><span class="token punctuation">)</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
用法<span class="token number">2</span>：合并Q对象，Q可以使用<span class="token operator">&amp;</span>和<span class="token operator">|</span>运算符组合对象。当在两个Q对象上使用运算符时，它会生成一个新Q对象。例如，此语句生成一个Q表示两个<span class="token string">&quot;question__startswith&quot;</span>查询的“OR”的对象：

Q<span class="token punctuation">(</span>question__startswith<span class="token operator">=</span><span class="token string">'Who'</span><span class="token punctuation">)</span> <span class="token operator">|</span> Q<span class="token punctuation">(</span>question__startswith<span class="token operator">=</span><span class="token string">'What'</span><span class="token punctuation">)</span>
<span class="token comment">#相当于：WHERE question LIKE 'Who%' OR question LIKE 'What%'</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
用法<span class="token number">3</span>：Q 可以使用<span class="token operator">~</span>运算符取消对象，允许组合查找结合常规查询和negated（NOT）查询。
Q<span class="token punctuation">(</span>question__startswith<span class="token operator">=</span><span class="token string">'Who'</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token operator">~</span>Q<span class="token punctuation">(</span>pub_date__year<span class="token operator">=</span><span class="token number">2005</span><span class="token punctuation">)</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
用法<span class="token number">4</span>：每个查找函数，采用关键字参数（例如<span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>， exclude<span class="token punctuation">(</span><span class="token punctuation">)</span>， get<span class="token punctuation">(</span><span class="token punctuation">)</span>）也可以通过一个或多个 Q对象作为位置（未命名的）参数。如果为Q查找函数提供多个 对象参数，则参数将“AND”编辑在一起。

Poll<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>
    Q<span class="token punctuation">(</span>question__startswith<span class="token operator">=</span><span class="token string">'Who'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Q<span class="token punctuation">(</span>pub_date<span class="token operator">=</span>date<span class="token punctuation">(</span><span class="token number">2005</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> Q<span class="token punctuation">(</span>pub_date<span class="token operator">=</span>date<span class="token punctuation">(</span><span class="token number">2005</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
用法<span class="token number">5</span>：Q提供了对象，则它必须位于任何关键字参数的定义之前。
Poll<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>
    Q<span class="token punctuation">(</span>pub_date<span class="token operator">=</span>date<span class="token punctuation">(</span><span class="token number">2005</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> Q<span class="token punctuation">(</span>pub_date<span class="token operator">=</span>date<span class="token punctuation">(</span><span class="token number">2005</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    question__startswith<span class="token operator">=</span><span class="token string">'Who'</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre></div></li> <li><p><strong>selected_related()</strong> ：返回一个跟随”外键关系的<code>QuerySet</code>“，在执行查询时选择其他相关对象数据。这是一个性能增强器，它会导致单个更复杂的查询，但意味着以后使用外键关系不需要数据库查询。</p> <div class="language-python extra-class"><pre class="language-python"><code>以下示例说明了普通查找和select_related<span class="token punctuation">(</span><span class="token punctuation">)</span>查找之间的区别 。这是标准查找：
<span class="token comment">#普通查找</span>
<span class="token comment"># Hits the database.</span>
e <span class="token operator">=</span> Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment"># Hits the database again to get the related Blog object.</span>
b <span class="token operator">=</span> e<span class="token punctuation">.</span>blog

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment">#select_related查找</span>
<span class="token comment"># Hits the database.</span>
e <span class="token operator">=</span> Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>select_related<span class="token punctuation">(</span><span class="token string">'blog'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment"># Doesn't hit the database, because e.blog has been prepopulated</span>
<span class="token comment"># in the previous query.</span>
b <span class="token operator">=</span> e<span class="token punctuation">.</span>blog

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment">#链式传递不考虑顺序：链接filter()和select_related()链接的顺序并不重要。这些查询集是等效的，如下：</span>
Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>pub_date__gt<span class="token operator">=</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>select_related<span class="token punctuation">(</span><span class="token string">'blog'</span><span class="token punctuation">)</span>
Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>select_related<span class="token punctuation">(</span><span class="token string">'blog'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>pub_date__gt<span class="token operator">=</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p>案例讲解：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models
<span class="token keyword">class</span> <span class="token class-name">City</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>
    <span class="token keyword">pass</span>

<span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>
    hometown <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>
        City<span class="token punctuation">,</span>
        on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>SET_NULL<span class="token punctuation">,</span>
        blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Book</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>
    author <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>Person<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span>
    
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment">#Book.objects.select_related('author__hometown').get(id=4) 将缓存相关Person 和相关的City</span>
<span class="token comment"># Hits the database with joins to the author and hometown tables.</span>
b <span class="token operator">=</span> Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>select_related<span class="token punctuation">(</span><span class="token string">'author__hometown'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
p <span class="token operator">=</span> b<span class="token punctuation">.</span>author         <span class="token comment"># Doesn't hit the database.</span>
c <span class="token operator">=</span> p<span class="token punctuation">.</span>hometown       <span class="token comment"># Doesn't hit the database.</span>

<span class="token comment"># Without select_related()...</span>
b <span class="token operator">=</span> Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># Hits the database.</span>
p <span class="token operator">=</span> b<span class="token punctuation">.</span>author         <span class="token comment"># Hits the database.</span>
c <span class="token operator">=</span> p<span class="token punctuation">.</span>hometown       <span class="token comment"># Hits the database.</span>
</code></pre></div></li></ul></li></ul> <h2 id="queryset"><a href="#queryset" class="header-anchor">#</a> QuerySet</h2> <ul><li><p>**可切片：**使用Python 的切片语法来限制<code>查询集</code>记录的数目 。它等同于SQL 的<code>LIMIT</code> 和<code>OFFSET</code> 子句。</p> <div class="language-python extra-class"><pre class="language-python"><code>Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>      <span class="token comment"># (LIMIT 5)</span>
Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>    <span class="token comment"># (OFFSET 5 LIMIT 5)</span>

<span class="token comment">#不支持负的索引（例如Entry.objects.all()[-1]）。通常，查询集 的切片返回一个新的查询集 —— 它不会执行查询。</span>
</code></pre></div></li> <li><p><strong>可迭代</strong>：本身就是一个列表集合</p> <div class="language-python extra-class"><pre class="language-python"><code>articleList<span class="token operator">=</span>models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> article <span class="token keyword">in</span> articleList<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span>title<span class="token punctuation">)</span>
</code></pre></div></li> <li><p><strong>惰性查询</strong>：<code>查询集</code> 是惰性执行的 —— 创建<code>查询集</code>不会带来任何数据库的访问。你可以将过滤器保持一整天，直到<code>查询集</code> 需要求值时，Django 才会真正运行这个查询。（关于惰性是不是在迭代器的地方听过呀）</p> <div class="language-python extra-class"><pre class="language-python"><code>queryResult<span class="token operator">=</span>models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># not hits database，通过看到的打印的翻译出来的sql语句记录，你会发现单纯的这句话并没有sql语句打印，也就是这里并没有进入数据库查询</span>
 
<span class="token keyword">print</span><span class="token punctuation">(</span>queryResult<span class="token punctuation">)</span> <span class="token comment"># hits database 进入 </span>
<span class="token keyword">for</span> article <span class="token keyword">in</span> queryResult<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span>title<span class="token punctuation">)</span>    <span class="token comment"># hits database</span>
 
<span class="token comment">#if判断的时候也会执行，if queryResult:pass、</span>
<span class="token comment">#一般来说，只有在“请求”查询集 的结果时才会到数据库中去获取它们。当你确实需要结果时，查询集 通过访问数据库来求值。 关于求值发生的准确时间</span>
</code></pre></div></li> <li><p><strong>缓存机制</strong>：每个<code>查询集</code>都包含一个缓存来最小化对数据库的访问。理解它是如何工作的将让你编写最高效的代码。叫做queryset缓存空间</p> <p>在一个新创建的<code>查询集</code>中，缓存为空。首次对<code>查询集</code>进行求值 —— 同时发生数据库查询 ——Django 将保存查询的结果到<code>查询集(非简单查询的查询结果，简单查询往下看。)</code>的缓存中并返回明确请求的结果（例如，如果正在迭代<code>查询集</code>，则返回下一个结果）。接下来对该<code>查询集</code> 的求值将重用缓存的结果。</p> <p>请牢记这个缓存行为，因为对<code>查询集</code>使用不当的话，它会坑你的。例如，下面的语句创建两个<code>查询集</code>，对它们求值，然后扔掉它们：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">.</span>title <span class="token keyword">for</span> a <span class="token keyword">in</span> models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">.</span>create_time <span class="token keyword">for</span> a <span class="token keyword">in</span> models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">#这意味着相同的数据库查询将执行两次，显然倍增了你的数据库负载。同时，还有可能两个结果列表并不包含相同的数据库记录，因为在两次请求期间有可能有Article被添加进来或删除掉。为了避免这个问题，只需保存查询集并重新使用它：</span>
queryResult<span class="token operator">=</span>models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">.</span>title <span class="token keyword">for</span> a <span class="token keyword">in</span> queryResult<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">.</span>create_time <span class="token keyword">for</span> a <span class="token keyword">in</span> queryResult<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p><strong>何时查询集不会被缓存?</strong>  查询集不会永远缓存它们的结果。当只对查询集的部分进行求值时会检查缓存， 如果这个部分不在缓存中，那么接下来查询返回的记录都将不会被缓存。所以，这意味着使用切片或索引来限制查询集将不会填充缓存。</p> <p>例如，重复获取查询集对象中一个特定的索引将每次都查询数据库：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> queryset <span class="token operator">=</span> Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span> queryset<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token comment"># Queries the database</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span> queryset<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token comment"># Queries the database again</span>

<span class="token comment">#然而，如果已经对全部查询集求值过，则将检查缓存：</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> queryset <span class="token operator">=</span> Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>entry <span class="token keyword">for</span> entry <span class="token keyword">in</span> queryset<span class="token punctuation">]</span> <span class="token comment"># Queries the database</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span> queryset<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token comment"># Uses cache</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span> queryset<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token comment"># Uses cache</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment">#下面是一些其它例子，它们会使得全部的查询集被求值并填充到缓存中：</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>entry <span class="token keyword">for</span> entry <span class="token keyword">in</span> queryset<span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>queryset<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> entry <span class="token keyword">in</span> queryset
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">(</span>queryset<span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment">#注意：简单地打印查询集不会填充缓存。</span>
queryResult<span class="token operator">=</span>models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>queryResult<span class="token punctuation">)</span> <span class="token comment">#  hits database</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>queryResult<span class="token punctuation">)</span> <span class="token comment">#  hits database</span>
</code></pre></div></li></ul></li> <li><h5 id="exists-与-iterater-方法"><a href="#exists-与-iterater-方法" class="header-anchor">#</a> exists() 与 iterater() 方法</h5> <ul><li><p><strong>exists</strong>：简单的使用if语句进行判断也会完全执行整个queryset并且把数据放入cache，虽然你并不需要这些 数据！为了避免这个，可以用exists()方法来检查是否有数据：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">if</span> queryResult<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token comment">#SELECT (1) AS &quot;a&quot; FROM &quot;blog_article&quot; LIMIT 1; args=()</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;exists...&quot;</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p><strong>iterator</strong>:当queryset非常巨大时，cache会成为问题。处理成千上万的记录时，将它们一次装入内存是很浪费的。更糟糕的是，巨大的queryset可能会锁住系统 进程，让你的程序濒临崩溃。要避免在遍历数据的同时产生queryset cache，可以使用iterator()方法 来获取数据，处理完数据就将其丢弃。</p> <div class="language-python extra-class"><pre class="language-python"><code>objs <span class="token operator">=</span> Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>iterator<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#objs变成了一个生成器，生成器也是迭代器，但是生成器有个特点，就是取完值就不能再取了</span>
<span class="token comment"># iterator()可以一次只从数据库获取少量数据，这样可以节省内存</span>
<span class="token keyword">for</span> obj <span class="token keyword">in</span> objs<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>title<span class="token punctuation">)</span>
<span class="token comment">#BUT,再次遍历没有打印,因为迭代器已经在上一次遍历(next)到最后一次了,没得遍历了</span>
<span class="token keyword">for</span> obj <span class="token keyword">in</span> objs<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>title<span class="token punctuation">)</span>
</code></pre></div></li></ul></li></ul> <h2 id="中介模型"><a href="#中介模型" class="header-anchor">#</a> 中介模型</h2> <p>​	处理类似搭配 pizza 和 topping 这样简单的多对多关系时，使用标准的<code>ManyToManyField</code>  就可以了。但是，有时你可能需要关联数据到两个模型之间的关系上。例如，有这样一个应用，它记录音乐家所属的音乐小组。我们可以用一个<code>ManyToManyField</code> 表示小组和成员之间的多对多关系。但是，有时你可能想知道更多成员关系的细节，比如成员是何时加入小组的。</p> <p>​	对于这些情况，Django 允许你指定一个中介模型来定义多对多关系。 你可以将其他字段放在中介模型里面。源模型的<code>ManyToManyField</code> 字段将使用<code>through</code> 参数指向中介模型。对于上面的音乐小组的例子，代码如下：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models
 
<span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span>
 
    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>              <span class="token comment"># __unicode__ on Python 2</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>name
 
<span class="token keyword">class</span> <span class="token class-name">Group</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span>
    members <span class="token operator">=</span> models<span class="token punctuation">.</span>ManyToManyField<span class="token punctuation">(</span>Person<span class="token punctuation">,</span> through<span class="token operator">=</span><span class="token string">'Membership'</span><span class="token punctuation">)</span>  <span class="token comment">#这里使用through表示将使用Membership来当第三张多表</span>
 
    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>              <span class="token comment"># __unicode__ on Python 2</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>name
 
<span class="token keyword">class</span> <span class="token class-name">Membership</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    person <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>Person<span class="token punctuation">)</span>
    group <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>Group<span class="token punctuation">)</span>
    date_joined <span class="token operator">=</span> models<span class="token punctuation">.</span>DateField<span class="token punctuation">(</span><span class="token punctuation">)</span>
    invite_reason <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span>
</code></pre></div><p>​	既然你已经设置好<code>ManyToManyField</code> 来使用中介模型（在这个例子中就是<code>Membership</code>），接下来你要开始创建多对多关系。你要做的就是创建中介模型的实例：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> ringo <span class="token operator">=</span> Person<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;Ringo Starr&quot;</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> paul <span class="token operator">=</span> Person<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;Paul McCartney&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#实例出一条Person记录</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> beatles <span class="token operator">=</span> Group<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;The Beatles&quot;</span><span class="token punctuation">)</span>   <span class="token comment">#实例出一个group记录</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m1 <span class="token operator">=</span> Membership<span class="token punctuation">(</span>person<span class="token operator">=</span>ringo<span class="token punctuation">,</span> group<span class="token operator">=</span>beatles<span class="token punctuation">,</span>  <span class="token comment">#两条关联管理对象，相互关联各自的一条记录</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     date_joined<span class="token operator">=</span>date<span class="token punctuation">(</span><span class="token number">1962</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     invite_reason<span class="token operator">=</span><span class="token string">&quot;Needed a new drummer.&quot;</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m1<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> beatles<span class="token punctuation">.</span>members<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#使用members关联管理对象也就是正向查询</span>
<span class="token punctuation">[</span><span class="token operator">&lt;</span>Person<span class="token punctuation">:</span> Ringo Starr<span class="token operator">&gt;</span><span class="token punctuation">]</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> ringo<span class="token punctuation">.</span>group_set<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">&lt;</span>Group<span class="token punctuation">:</span> The Beatles<span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m2 <span class="token operator">=</span> Membership<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>person<span class="token operator">=</span>paul<span class="token punctuation">,</span> group<span class="token operator">=</span>beatles<span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     date_joined<span class="token operator">=</span>date<span class="token punctuation">(</span><span class="token number">1960</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     invite_reason<span class="token operator">=</span><span class="token string">&quot;Wanted to form a band.&quot;</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> beatles<span class="token punctuation">.</span>members<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">&lt;</span>Person<span class="token punctuation">:</span> Ringo Starr<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Person<span class="token punctuation">:</span> Paul McCartney<span class="token operator">&gt;</span><span class="token punctuation">]</span>

<span class="token comment">#注意：与普通的多对多字段不同，你不能使用add、 create和赋值语句（比如，beatles.members = [...]）来创建关系</span>
<span class="token comment"># THIS WILL NOT WORK</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> beatles<span class="token punctuation">.</span>members<span class="token punctuation">.</span>add<span class="token punctuation">(</span>john<span class="token punctuation">)</span>  <span class="token comment">#单独的加入一条记录，显然没有beatles中的关联管理字段，所以不行</span>
<span class="token comment"># NEITHER WILL THIS</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> beatles<span class="token punctuation">.</span>members<span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;George Harrison&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#光创建一个姓名跟不行</span>
<span class="token comment"># AND NEITHER WILL THIS</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> beatles<span class="token punctuation">.</span>members <span class="token operator">=</span> <span class="token punctuation">[</span>john<span class="token punctuation">,</span> paul<span class="token punctuation">,</span> ringo<span class="token punctuation">,</span> george<span class="token punctuation">]</span>  <span class="token comment">#更不行</span>

<span class="token comment">#为什么不能这样做？ 这是因为你不能只创建 Person和 Group之间的关联关系，你还要指定 Membership模型中所需要的所有信息；而简单的add、create 和赋值语句是做不到这一点的。所以它们不能在使用中介模型的多对多关系中使用。此时，唯一的办法就是创建中介模型的实例。 remove()方法被禁用也是出于同样的原因。但是clear() 方法却是可用的。它可以清空某个实例所有的多对多关系：</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># Beatles have broken up</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> beatles<span class="token punctuation">.</span>members<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># Note that this deletes the intermediate model instances</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Membership<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre></div><h2 id="查询优化"><a href="#查询优化" class="header-anchor">#</a> 查询优化</h2> <h5 id="表数据及准备"><a href="#表数据及准备" class="header-anchor">#</a> 表数据及准备：</h5> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span>AbstractUser<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    用户信息
    &quot;&quot;&quot;</span>
    nid <span class="token operator">=</span> models<span class="token punctuation">.</span>BigAutoField<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    nickname <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'昵称'</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>
    telephone <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'手机号码'</span><span class="token punctuation">)</span>
    avatar <span class="token operator">=</span> models<span class="token punctuation">.</span>FileField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'头像'</span><span class="token punctuation">,</span>upload_to <span class="token operator">=</span> <span class="token string">'avatar/'</span><span class="token punctuation">,</span>default<span class="token operator">=</span><span class="token string">&quot;/avatar/default.png&quot;</span><span class="token punctuation">)</span>
    create_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'创建时间'</span><span class="token punctuation">,</span> auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
 
    fans <span class="token operator">=</span> models<span class="token punctuation">.</span>ManyToManyField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'粉丝们'</span><span class="token punctuation">,</span>
                                  to<span class="token operator">=</span><span class="token string">'UserInfo'</span><span class="token punctuation">,</span>
                                  through<span class="token operator">=</span><span class="token string">'UserFans'</span><span class="token punctuation">,</span>
                                  related_name<span class="token operator">=</span><span class="token string">'f'</span><span class="token punctuation">,</span>
                                  through_fields<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'follower'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 
    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>username
 
<span class="token keyword">class</span> <span class="token class-name">UserFans</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    互粉关系表
    &quot;&quot;&quot;</span>
    nid <span class="token operator">=</span> models<span class="token punctuation">.</span>AutoField<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'博主'</span><span class="token punctuation">,</span> to<span class="token operator">=</span><span class="token string">'UserInfo'</span><span class="token punctuation">,</span> to_field<span class="token operator">=</span><span class="token string">'nid'</span><span class="token punctuation">,</span> related_name<span class="token operator">=</span><span class="token string">'users'</span><span class="token punctuation">)</span>
    follower <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'粉丝'</span><span class="token punctuation">,</span> to<span class="token operator">=</span><span class="token string">'UserInfo'</span><span class="token punctuation">,</span> to_field<span class="token operator">=</span><span class="token string">'nid'</span><span class="token punctuation">,</span> related_name<span class="token operator">=</span><span class="token string">'followers'</span><span class="token punctuation">)</span>
 
<span class="token keyword">class</span> <span class="token class-name">Blog</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
 
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    博客信息
    &quot;&quot;&quot;</span>
    nid <span class="token operator">=</span> models<span class="token punctuation">.</span>BigAutoField<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'个人博客标题'</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span>
    site <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'个人博客后缀'</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    theme <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'博客主题'</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> models<span class="token punctuation">.</span>OneToOneField<span class="token punctuation">(</span>to<span class="token operator">=</span><span class="token string">'UserInfo'</span><span class="token punctuation">,</span> to_field<span class="token operator">=</span><span class="token string">'nid'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>title
 
<span class="token keyword">class</span> <span class="token class-name">Category</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    博主个人文章分类表
    &quot;&quot;&quot;</span>
    nid <span class="token operator">=</span> models<span class="token punctuation">.</span>AutoField<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'分类标题'</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>
 
    blog <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'所属博客'</span><span class="token punctuation">,</span> to<span class="token operator">=</span><span class="token string">'Blog'</span><span class="token punctuation">,</span> to_field<span class="token operator">=</span><span class="token string">'nid'</span><span class="token punctuation">)</span>
 
<span class="token keyword">class</span> <span class="token class-name">Article</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
 
    nid <span class="token operator">=</span> models<span class="token punctuation">.</span>BigAutoField<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'文章标题'</span><span class="token punctuation">)</span>
    desc <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'文章描述'</span><span class="token punctuation">)</span>
    read_count <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    comment_count<span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    up_count <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    down_count <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    category <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'文章类型'</span><span class="token punctuation">,</span> to<span class="token operator">=</span><span class="token string">'Category'</span><span class="token punctuation">,</span> to_field<span class="token operator">=</span><span class="token string">'nid'</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    create_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'创建时间'</span><span class="token punctuation">)</span>
    blog <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'所属博客'</span><span class="token punctuation">,</span> to<span class="token operator">=</span><span class="token string">'Blog'</span><span class="token punctuation">,</span> to_field<span class="token operator">=</span><span class="token string">'nid'</span><span class="token punctuation">)</span>
    tags <span class="token operator">=</span> models<span class="token punctuation">.</span>ManyToManyField<span class="token punctuation">(</span>
        to<span class="token operator">=</span><span class="token string">&quot;Tag&quot;</span><span class="token punctuation">,</span>
        through<span class="token operator">=</span><span class="token string">'Article2Tag'</span><span class="token punctuation">,</span>
        through_fields<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'article'</span><span class="token punctuation">,</span> <span class="token string">'tag'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
 
 
<span class="token keyword">class</span> <span class="token class-name">ArticleDetail</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    文章详细表
    &quot;&quot;&quot;</span>
    nid <span class="token operator">=</span> models<span class="token punctuation">.</span>AutoField<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    content <span class="token operator">=</span> models<span class="token punctuation">.</span>TextField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'文章内容'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
 
    article <span class="token operator">=</span> models<span class="token punctuation">.</span>OneToOneField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'所属文章'</span><span class="token punctuation">,</span> to<span class="token operator">=</span><span class="token string">'Article'</span><span class="token punctuation">,</span> to_field<span class="token operator">=</span><span class="token string">'nid'</span><span class="token punctuation">)</span>
 
 
<span class="token keyword">class</span> <span class="token class-name">Comment</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    评论表
    &quot;&quot;&quot;</span>
    nid <span class="token operator">=</span> models<span class="token punctuation">.</span>BigAutoField<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    article <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'评论文章'</span><span class="token punctuation">,</span> to<span class="token operator">=</span><span class="token string">'Article'</span><span class="token punctuation">,</span> to_field<span class="token operator">=</span><span class="token string">'nid'</span><span class="token punctuation">)</span>
    content <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'评论内容'</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span>
    create_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'创建时间'</span><span class="token punctuation">,</span> auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
 
    parent_comment <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'self'</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'父级评论'</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'评论者'</span><span class="token punctuation">,</span> to<span class="token operator">=</span><span class="token string">'UserInfo'</span><span class="token punctuation">,</span> to_field<span class="token operator">=</span><span class="token string">'nid'</span><span class="token punctuation">)</span>
 
    up_count <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
 
    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>content
 
<span class="token keyword">class</span> <span class="token class-name">ArticleUpDown</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    点赞表
    &quot;&quot;&quot;</span>
    nid <span class="token operator">=</span> models<span class="token punctuation">.</span>AutoField<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'UserInfo'</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    article <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">&quot;Article&quot;</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    models<span class="token punctuation">.</span>BooleanField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'是否赞'</span><span class="token punctuation">)</span>
 
<span class="token keyword">class</span> <span class="token class-name">CommentUp</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    点赞表
    &quot;&quot;&quot;</span>
    nid <span class="token operator">=</span> models<span class="token punctuation">.</span>AutoField<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'UserInfo'</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    comment <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">&quot;Comment&quot;</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
 
 
<span class="token keyword">class</span> <span class="token class-name">Tag</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    nid <span class="token operator">=</span> models<span class="token punctuation">.</span>AutoField<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'标签名称'</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>
    blog <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'所属博客'</span><span class="token punctuation">,</span> to<span class="token operator">=</span><span class="token string">'Blog'</span><span class="token punctuation">,</span> to_field<span class="token operator">=</span><span class="token string">'nid'</span><span class="token punctuation">)</span>
 
 
 
<span class="token keyword">class</span> <span class="token class-name">Article2Tag</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    nid <span class="token operator">=</span> models<span class="token punctuation">.</span>AutoField<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    article <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'文章'</span><span class="token punctuation">,</span> to<span class="token operator">=</span><span class="token string">&quot;Article&quot;</span><span class="token punctuation">,</span> to_field<span class="token operator">=</span><span class="token string">'nid'</span><span class="token punctuation">)</span>
    tag <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'标签'</span><span class="token punctuation">,</span> to<span class="token operator">=</span><span class="token string">&quot;Tag&quot;</span><span class="token punctuation">,</span> to_field<span class="token operator">=</span><span class="token string">'nid'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="select-related"><a href="#select-related" class="header-anchor">#</a> select_related</h4> <ul><li><p>**简单使用：**对于一对一字段（OneToOneField）和外键字段（ForeignKey），可以使用select_related 来对QuerySet进行优化。</p> <p>select_related 返回一个<code>QuerySet</code>，当执行它的查询时它沿着外键关系查询关联的对象的数据。它会生成一个复杂的查询并引起性能的损耗，但是在以后使用外键关系时将不需要数据库查询。简单说，在对QuerySet使用select_related()函数后，Django会获取相应外键对应的对象，从而在之后需要的时候不必再查询数据库了。</p> <p>下面的例子解释了普通查询和<code>select_related()</code> 查询的区别。查询id=2的文章的分类名称,下面是一个标准的查询：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># Hits the database.</span>
article<span class="token operator">=</span>models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>nid<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
 
<span class="token comment"># Hits the database again to get the related Blog object.</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span>category<span class="token punctuation">.</span>title<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">'''
SELECT
    &quot;blog_article&quot;.&quot;nid&quot;,
    &quot;blog_article&quot;.&quot;title&quot;,
    &quot;blog_article&quot;.&quot;desc&quot;,
    &quot;blog_article&quot;.&quot;read_count&quot;,
    &quot;blog_article&quot;.&quot;comment_count&quot;,
    &quot;blog_article&quot;.&quot;up_count&quot;,
    &quot;blog_article&quot;.&quot;down_count&quot;,
    &quot;blog_article&quot;.&quot;category_id&quot;,
    &quot;blog_article&quot;.&quot;create_time&quot;,
     &quot;blog_article&quot;.&quot;blog_id&quot;,
     &quot;blog_article&quot;.&quot;article_type_id&quot;
             FROM &quot;blog_article&quot;
             WHERE &quot;blog_article&quot;.&quot;nid&quot; = 2; args=(2,)
 
SELECT
     &quot;blog_category&quot;.&quot;nid&quot;,
     &quot;blog_category&quot;.&quot;title&quot;,
     &quot;blog_category&quot;.&quot;blog_id&quot;
              FROM &quot;blog_category&quot;
              WHERE &quot;blog_category&quot;.&quot;nid&quot; = 4; args=(4,)
'''</span>

<span class="token comment">#如果我们使用select_related()函数</span>
articleList<span class="token operator">=</span>models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>select_related<span class="token punctuation">(</span><span class="token string">&quot;category&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
    <span class="token keyword">for</span> article_obj <span class="token keyword">in</span> articleList<span class="token punctuation">:</span>
        <span class="token comment">#  Doesn't hit the database, because article_obj.category</span>
        <span class="token comment">#  has been prepopulated in the previous query.</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>article_obj<span class="token punctuation">.</span>category<span class="token punctuation">.</span>title<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">'''
SELECT
     &quot;blog_article&quot;.&quot;nid&quot;,
     &quot;blog_article&quot;.&quot;title&quot;,
     &quot;blog_article&quot;.&quot;desc&quot;,
     &quot;blog_article&quot;.&quot;read_count&quot;,
     &quot;blog_article&quot;.&quot;comment_count&quot;,
     &quot;blog_article&quot;.&quot;up_count&quot;,
     &quot;blog_article&quot;.&quot;down_count&quot;,
     &quot;blog_article&quot;.&quot;category_id&quot;,
     &quot;blog_article&quot;.&quot;create_time&quot;,
     &quot;blog_article&quot;.&quot;blog_id&quot;,
     &quot;blog_article&quot;.&quot;article_type_id&quot;,
 
     &quot;blog_category&quot;.&quot;nid&quot;,
     &quot;blog_category&quot;.&quot;title&quot;,
     &quot;blog_category&quot;.&quot;blog_id&quot;
 
FROM &quot;blog_article&quot;
LEFT OUTER JOIN &quot;blog_category&quot; ON (&quot;blog_article&quot;.&quot;category_id&quot; = &quot;blog_category&quot;.&quot;nid&quot;);
'''</span>            
</code></pre></div></li> <li><p><strong>多外键查询</strong>：这是针对category的外键查询，如果是另外一个外键呢？让我们一起看下：</p> <div class="language-python extra-class"><pre class="language-python"><code>article<span class="token operator">=</span>models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>select_related<span class="token punctuation">(</span><span class="token string">&quot;category&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>nid<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span>articledetail<span class="token punctuation">)</span>

<span class="token comment"># 观察logging结果，发现依然需要查询两次，所以需要改为：</span>
article<span class="token operator">=</span>models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>select_related<span class="token punctuation">(</span><span class="token string">&quot;category&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;articledetail&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>nid<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span>articledetail<span class="token punctuation">)</span>
<span class="token comment">#或则：</span>
article<span class="token operator">=</span>models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects
　　　　　　　　　　　　　<span class="token punctuation">.</span>select_related<span class="token punctuation">(</span><span class="token string">&quot;category&quot;</span><span class="token punctuation">)</span>
　　　　　　　　　　　　　<span class="token punctuation">.</span>select_related<span class="token punctuation">(</span><span class="token string">&quot;articledetail&quot;</span><span class="token punctuation">)</span>
　　　　　　　　　　　　　<span class="token punctuation">.</span>get<span class="token punctuation">(</span>nid<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># django 1.7 支持链式操作</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span>articledetail<span class="token punctuation">)</span>
</code></pre></div></li> <li><p><strong>深度查询</strong>：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 查询id=1的文章的用户姓名</span>
 
    article<span class="token operator">=</span>models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>select_related<span class="token punctuation">(</span><span class="token string">&quot;blog&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>nid<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span>blog<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username<span class="token punctuation">)</span>
    
<span class="token comment">#依然需要查询两次：</span>
SELECT
    <span class="token string">&quot;blog_article&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;nid&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;blog_article&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
     <span class="token string">&quot;blog_blog&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;nid&quot;</span><span class="token punctuation">,</span>
     <span class="token string">&quot;blog_blog&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span>
 
   FROM <span class="token string">&quot;blog_article&quot;</span> INNER JOIN <span class="token string">&quot;blog_blog&quot;</span> ON <span class="token punctuation">(</span><span class="token string">&quot;blog_article&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;blog_id&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;blog_blog&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;nid&quot;</span><span class="token punctuation">)</span>
   WHERE <span class="token string">&quot;blog_article&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;nid&quot;</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  
SELECT
    <span class="token string">&quot;blog_userinfo&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;blog_userinfo&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;last_login&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
FROM <span class="token string">&quot;blog_userinfo&quot;</span>
WHERE <span class="token string">&quot;blog_userinfo&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;nid&quot;</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>

<span class="token comment">#这是因为第一次查询没有query到userInfo表，所以，修改如下：</span>
article<span class="token operator">=</span>models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>select_related<span class="token punctuation">(</span><span class="token string">&quot;blog__user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>nid<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span>blog<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username<span class="token punctuation">)</span>

SELECT
 
<span class="token string">&quot;blog_article&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;nid&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;blog_article&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
 <span class="token string">&quot;blog_blog&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;nid&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;blog_blog&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
 <span class="token string">&quot;blog_userinfo&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;blog_userinfo&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;last_login&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
FROM <span class="token string">&quot;blog_article&quot;</span>
 
INNER JOIN <span class="token string">&quot;blog_blog&quot;</span> ON <span class="token punctuation">(</span><span class="token string">&quot;blog_article&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;blog_id&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;blog_blog&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;nid&quot;</span><span class="token punctuation">)</span>
 
INNER JOIN <span class="token string">&quot;blog_userinfo&quot;</span> ON <span class="token punctuation">(</span><span class="token string">&quot;blog_blog&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;user_id&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;blog_userinfo&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;nid&quot;</span><span class="token punctuation">)</span>
WHERE <span class="token string">&quot;blog_article&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;nid&quot;</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><strong>总结</strong>：</p> <div class="language- extra-class"><pre class="language-text"><code>1、select_related主要针一对一和多对一关系进行优化。
2、select_related使用SQL的JOIN语句进行优化，通过减少SQL查询的次数来进行优化、提高性能。
3、可以通过可变长参数指定需要select_related的字段名。也可以通过使用双下划线“__”连接字段名来实现指定的递归查询。
4、没有指定的字段不会缓存，没有指定的深度不会缓存，如果要访问的话Django会再次进行SQL查询。
5、也可以通过depth参数指定递归的深度，Django会自动缓存指定深度内所有的字段。如果要访问指定深度外的字段，Django会再次进行SQL查询。
6、也接受无参数的调用，Django会尽可能深的递归查询所有的字段。但注意有Django递归的限制和性能的浪费。
7、Django &gt;= 1.7，链式调用的select_related相当于使用可变长参数。Django &lt; 1.7，链式调用会导致前边的select_related失效，只保留最后一个。
</code></pre></div></li></ul> <h4 id="prefetch-related"><a href="#prefetch-related" class="header-anchor">#</a> prefetch_related()</h4> <p>​		对于多对多字段（ManyToManyField）和一对多字段，可以使用prefetch_related()来进行优化。prefetch_related()和select_related()的设计目的很相似，都是为了减少SQL查询的数量，但是实现的方式不一样。后者是通过JOIN语句，在SQL查询内解决问题。但是对于多对多关系，使用SQL语句解决就显得有些不太明智，因为JOIN得到的表将会很长，会导致SQL语句运行时间的增加和内存占用的增加。若有n个对象，每个对象的多对多字段对应Mi条，就会生成Σ(n)Mi 行的结果表。</p> <ul><li><p>prefetch_related()的解决方法是，分别查询每个表，然后用Python处理他们之间的关系。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 查询所有文章关联的所有标签</span>
    article_obj<span class="token operator">=</span>models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> article_obj<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>tags<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#4篇文章: hits database 5</span>
        
<span class="token comment"># 改为prefetch_related：查询所有文章关联的所有标签</span>
    article_obj<span class="token operator">=</span>models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>prefetch_related<span class="token punctuation">(</span><span class="token string">&quot;tags&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> article_obj<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>tags<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#4篇文章: hits database 2</span>
        
<span class="token triple-quoted-string string">'''
SELECT &quot;blog_article&quot;.&quot;nid&quot;,
               &quot;blog_article&quot;.&quot;title&quot;,
               ......
 
FROM &quot;blog_article&quot;;
 
SELECT
  (&quot;blog_article2tag&quot;.&quot;article_id&quot;) AS &quot;_prefetch_related_val_article_id&quot;,
  &quot;blog_tag&quot;.&quot;nid&quot;,
  &quot;blog_tag&quot;.&quot;title&quot;,
  &quot;blog_tag&quot;.&quot;blog_id&quot;
   FROM &quot;blog_tag&quot;
  INNER JOIN &quot;blog_article2tag&quot; ON (&quot;blog_tag&quot;.&quot;nid&quot; = &quot;blog_article2tag&quot;.&quot;tag_id&quot;)
  WHERE &quot;blog_article2tag&quot;.&quot;article_id&quot; IN (1, 2, 3, 4);'''</span>        
</code></pre></div></li></ul> <h2 id="extra"><a href="#extra" class="header-anchor">#</a> extra</h2> <ul><li><p><strong>语法</strong>：</p> <div class="language-python extra-class"><pre class="language-python"><code> extra<span class="token punctuation">(</span>select<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> where<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> tables<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> order_by<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> select_params<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
    
    <span class="token comment">#有些情况下，Django的查询语法难以简单的表达复杂的 WHERE 子句，对于这种情况, Django 提供了 extra() QuerySet修改机制 — 它能在 QuerySet生成的SQL从句中注入新子句。extra可以指定一个或多个 参数,例如 select, where or tables. 这些参数都不是必须的，但是你至少要使用一个!要注意这些额外的方式对不同的数据库引擎可能存在移植性问题.(因为你在显式的书写SQL语句),除非万不得已,尽量避免这样做</span>
</code></pre></div></li> <li><p><strong>参数之select</strong>：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#The select 参数可以让你在 SELECT 从句中添加其他字段信息，它应该是一个字典，存放着属性名到 SQL 从句的映射。</span>
queryResult<span class="token operator">=</span>models<span class="token punctuation">.</span>Article
　　　　　　　　　　　<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>extra<span class="token punctuation">(</span>select<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'is_recent'</span><span class="token punctuation">:</span> <span class="token string">&quot;create_time &gt; '2017-09-05'&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">#结果集中每个 Entry 对象都有一个额外的属性is_recent, 它是一个布尔值，表示 Article对象的create_time 是否晚于2017-09-05.　</span>

<span class="token comment">#练习：</span>
article_obj<span class="token operator">=</span>models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects
　　　　　　　　　　　　　　<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>nid<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
　　　　　　　　　　　　　　<span class="token punctuation">.</span>extra<span class="token punctuation">(</span>select<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;standard_time&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;strftime('%%Y-%%m-%%d',create_time)&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
　　　　　　　　　　　　　　<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">&quot;standard_time&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;nid&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>article_obj<span class="token punctuation">)</span>  <span class="token comment"># &lt;QuerySet [{'title': 'MongoDb 入门教程', 'standard_time': '2017-09-03', 'nid': 1}]&gt;</span>
</code></pre></div></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/python/django/中间件.html" class="prev">
        中间件
      </a></span> <span class="next"><a href="/python/django/缓存和信号.html">
        缓存和信号
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.51f2f156.js" defer></script><script src="/assets/js/2.8911ec45.js" defer></script><script src="/assets/js/61.d2b463ab.js" defer></script>
  </body>
</html>
