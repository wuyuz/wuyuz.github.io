<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>aiohttp使用详细 | 独角兕大王</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.ccac5a78.css" as="style"><link rel="preload" href="/assets/js/app.51f2f156.js" as="script"><link rel="preload" href="/assets/js/2.8911ec45.js" as="script"><link rel="preload" href="/assets/js/109.e82166f3.js" as="script"><link rel="prefetch" href="/assets/js/10.6948c28b.js"><link rel="prefetch" href="/assets/js/100.276864ee.js"><link rel="prefetch" href="/assets/js/101.447ab1c7.js"><link rel="prefetch" href="/assets/js/102.f5b3c71d.js"><link rel="prefetch" href="/assets/js/103.16474d4b.js"><link rel="prefetch" href="/assets/js/104.ed58aef3.js"><link rel="prefetch" href="/assets/js/105.045203cd.js"><link rel="prefetch" href="/assets/js/106.be359e0b.js"><link rel="prefetch" href="/assets/js/107.7331bbca.js"><link rel="prefetch" href="/assets/js/108.76e1c800.js"><link rel="prefetch" href="/assets/js/11.d4ec37c8.js"><link rel="prefetch" href="/assets/js/110.4144755a.js"><link rel="prefetch" href="/assets/js/111.5864ab53.js"><link rel="prefetch" href="/assets/js/112.ca2aee84.js"><link rel="prefetch" href="/assets/js/113.641e7765.js"><link rel="prefetch" href="/assets/js/114.d69f8545.js"><link rel="prefetch" href="/assets/js/115.1b6a9f89.js"><link rel="prefetch" href="/assets/js/116.dde2c44e.js"><link rel="prefetch" href="/assets/js/117.4e79498c.js"><link rel="prefetch" href="/assets/js/12.7aac9c8d.js"><link rel="prefetch" href="/assets/js/13.abf127cd.js"><link rel="prefetch" href="/assets/js/14.aa4413a7.js"><link rel="prefetch" href="/assets/js/15.11a64e5b.js"><link rel="prefetch" href="/assets/js/16.f2d9a882.js"><link rel="prefetch" href="/assets/js/17.11c5bb7f.js"><link rel="prefetch" href="/assets/js/18.a522877b.js"><link rel="prefetch" href="/assets/js/19.6f31a972.js"><link rel="prefetch" href="/assets/js/20.b546c54e.js"><link rel="prefetch" href="/assets/js/21.6d055b7f.js"><link rel="prefetch" href="/assets/js/22.c48feceb.js"><link rel="prefetch" href="/assets/js/23.69941f78.js"><link rel="prefetch" href="/assets/js/24.6126dfc2.js"><link rel="prefetch" href="/assets/js/25.3475449c.js"><link rel="prefetch" href="/assets/js/26.96bb4643.js"><link rel="prefetch" href="/assets/js/27.da610e5d.js"><link rel="prefetch" href="/assets/js/28.b24ec15c.js"><link rel="prefetch" href="/assets/js/29.ec8af553.js"><link rel="prefetch" href="/assets/js/3.bec5f768.js"><link rel="prefetch" href="/assets/js/30.2e780db1.js"><link rel="prefetch" href="/assets/js/31.464c36ed.js"><link rel="prefetch" href="/assets/js/32.ad7d37c2.js"><link rel="prefetch" href="/assets/js/33.722f1ec5.js"><link rel="prefetch" href="/assets/js/34.8448d0fd.js"><link rel="prefetch" href="/assets/js/35.e5168ac9.js"><link rel="prefetch" href="/assets/js/36.edc404f1.js"><link rel="prefetch" href="/assets/js/37.5807602e.js"><link rel="prefetch" href="/assets/js/38.a519c89a.js"><link rel="prefetch" href="/assets/js/39.89af1b9a.js"><link rel="prefetch" href="/assets/js/4.5ed19beb.js"><link rel="prefetch" href="/assets/js/40.6c653db9.js"><link rel="prefetch" href="/assets/js/41.bc3b8b69.js"><link rel="prefetch" href="/assets/js/42.a0a02d9b.js"><link rel="prefetch" href="/assets/js/43.62f344e3.js"><link rel="prefetch" href="/assets/js/44.a7fd9d68.js"><link rel="prefetch" href="/assets/js/45.729c1c39.js"><link rel="prefetch" href="/assets/js/46.5b924aea.js"><link rel="prefetch" href="/assets/js/47.f3990404.js"><link rel="prefetch" href="/assets/js/48.f591f360.js"><link rel="prefetch" href="/assets/js/49.f7f213ad.js"><link rel="prefetch" href="/assets/js/5.2c5d28b5.js"><link rel="prefetch" href="/assets/js/50.b9ca2762.js"><link rel="prefetch" href="/assets/js/51.93672ee6.js"><link rel="prefetch" href="/assets/js/52.fb21314a.js"><link rel="prefetch" href="/assets/js/53.65343ccc.js"><link rel="prefetch" href="/assets/js/54.8081227d.js"><link rel="prefetch" href="/assets/js/55.e207659e.js"><link rel="prefetch" href="/assets/js/56.bde381df.js"><link rel="prefetch" href="/assets/js/57.f8eceb45.js"><link rel="prefetch" href="/assets/js/58.bef70bfd.js"><link rel="prefetch" href="/assets/js/59.7ab7562d.js"><link rel="prefetch" href="/assets/js/6.fc65a1ac.js"><link rel="prefetch" href="/assets/js/60.f40ac3ca.js"><link rel="prefetch" href="/assets/js/61.d2b463ab.js"><link rel="prefetch" href="/assets/js/62.cfdf1bcf.js"><link rel="prefetch" href="/assets/js/63.1e45ce59.js"><link rel="prefetch" href="/assets/js/64.a98fe86e.js"><link rel="prefetch" href="/assets/js/65.0234d7c5.js"><link rel="prefetch" href="/assets/js/66.724906f0.js"><link rel="prefetch" href="/assets/js/67.7806fda6.js"><link rel="prefetch" href="/assets/js/68.9f227dae.js"><link rel="prefetch" href="/assets/js/69.fdbc56ac.js"><link rel="prefetch" href="/assets/js/7.284de54e.js"><link rel="prefetch" href="/assets/js/70.04a9cc03.js"><link rel="prefetch" href="/assets/js/71.a6fa1dd9.js"><link rel="prefetch" href="/assets/js/72.2f8e3aa0.js"><link rel="prefetch" href="/assets/js/73.9bbb0cb6.js"><link rel="prefetch" href="/assets/js/74.9f122255.js"><link rel="prefetch" href="/assets/js/75.75e1fbd8.js"><link rel="prefetch" href="/assets/js/76.60ff3c3e.js"><link rel="prefetch" href="/assets/js/77.39a253ae.js"><link rel="prefetch" href="/assets/js/78.0e49712f.js"><link rel="prefetch" href="/assets/js/79.5f9c24a0.js"><link rel="prefetch" href="/assets/js/8.5c21a4cc.js"><link rel="prefetch" href="/assets/js/80.f826f188.js"><link rel="prefetch" href="/assets/js/81.b8995ea7.js"><link rel="prefetch" href="/assets/js/82.e9bf63e0.js"><link rel="prefetch" href="/assets/js/83.e3a00749.js"><link rel="prefetch" href="/assets/js/84.b940927c.js"><link rel="prefetch" href="/assets/js/85.ad46a9b2.js"><link rel="prefetch" href="/assets/js/86.190e0071.js"><link rel="prefetch" href="/assets/js/87.5f9eb9ef.js"><link rel="prefetch" href="/assets/js/88.cfaf7469.js"><link rel="prefetch" href="/assets/js/89.e64cc32c.js"><link rel="prefetch" href="/assets/js/9.0723805d.js"><link rel="prefetch" href="/assets/js/90.805edabe.js"><link rel="prefetch" href="/assets/js/91.6a1ab3f7.js"><link rel="prefetch" href="/assets/js/92.04ecd01e.js"><link rel="prefetch" href="/assets/js/93.e615470a.js"><link rel="prefetch" href="/assets/js/94.0ad7c41c.js"><link rel="prefetch" href="/assets/js/95.0e5ce618.js"><link rel="prefetch" href="/assets/js/96.b59cf9f4.js"><link rel="prefetch" href="/assets/js/97.2a327746.js"><link rel="prefetch" href="/assets/js/98.9c01ec88.js"><link rel="prefetch" href="/assets/js/99.952046bd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ccac5a78.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://github.com/fluidicon.png" alt="独角兕大王" class="logo"> <span class="site-name can-hide">独角兕大王</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/python/" class="nav-link router-link-active">
  Python
</a></div><div class="nav-item"><a href="/rust/" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/go/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/lua/" class="nav-link">
  Lua
</a></div><div class="nav-item"><a href="/C/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="https://github.com/wuyuz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/double-W/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cnblogs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/python/" class="nav-link router-link-active">
  Python
</a></div><div class="nav-item"><a href="/rust/" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/go/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/lua/" class="nav-link">
  Lua
</a></div><div class="nav-item"><a href="/C/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="https://github.com/wuyuz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/double-W/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cnblogs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python常用模块</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Django框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flask 框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Python爬虫</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/python/spider/HTTP和HTTPS协议.html" class="sidebar-link">HTTP和HTTPS协议</a></li><li><a href="/python/spider/request模块高级.html" class="sidebar-link">request模块高级</a></li><li><a href="/python/spider/requests相关知识.html" class="sidebar-link">requests相关知识</a></li><li><a href="/python/spider/requests知识进阶.html" class="sidebar-link">requests知识进阶</a></li><li><a href="/python/spider/数据解析.html" class="sidebar-link">数据解析</a></li><li><a href="/python/spider/多任务协程.html" class="sidebar-link">多任务协程爬虫</a></li><li><a href="/python/spider/Scrapy运用与总结.html" class="sidebar-link">Scrapy运用与总结</a></li><li><a href="/python/spider/Selenium记录.html" class="sidebar-link">Selenium万能的自动化爬虫</a></li><li><a href="/python/spider/aiohttp使用详细.html" class="active sidebar-link">aiohttp使用详细</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/spider/aiohttp使用详细.html#aiohttp使用详细" class="sidebar-link">aiohttp使用详细</a></li><li class="sidebar-sub-header"><a href="/python/spider/aiohttp使用详细.html#快速开始" class="sidebar-link">快速开始:</a></li><li class="sidebar-sub-header"><a href="/python/spider/aiohttp使用详细.html#aiohttp客户端的使用" class="sidebar-link">aiohttp客户端的使用</a></li><li class="sidebar-sub-header"><a href="/python/spider/aiohttp使用详细.html#服务端指南" class="sidebar-link">服务端指南</a></li></ul></li><li><a href="/python/spider/爬虫面试案例.html" class="sidebar-link">爬虫面试案例</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python设计模式</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="aiohttp使用详细"><a href="#aiohttp使用详细" class="header-anchor">#</a> aiohttp使用详细</h2> <h4 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍：</h4> <p>​	<code>asyncio</code>可以实现单线程并发IO操作。如果仅用在客户端，发挥的威力不大。如果把<code>asyncio</code>用在服务器端，例如Web服务器，由于HTTP连接就是IO操作，因此可以用单线程+<code>coroutine</code>实现多用户的高并发支持。<code>asyncio</code>实现了TCP、UDP、SSL等协议，<code>aiohttp</code>则是基于<code>asyncio</code>实现的HTTP框架</p> <p><a href="https://www.cntofu.com/book/127/aiohttp%E6%96%87%E6%A1%A3/Introduce.md" target="_blank" rel="noopener noreferrer">学习网址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>aiohttp是一个为Python提供异步HTTP 客户端/服务端编程，基于<a href="https://aiohttp.readthedocs.io/en/stable/glossary.html#term-asyncio" target="_blank" rel="noopener noreferrer">asyncio(Python用于支持异步编程的标准库)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的异步库。</p> <h4 id="核心功能"><a href="#核心功能" class="header-anchor">#</a> 核心功能:</h4> <ul><li>同时支持<a href="https://aiohttp.readthedocs.io/en/stable/client.html#aiohttp-client" target="_blank" rel="noopener noreferrer">客户端使用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a href="https://aiohttp.readthedocs.io/en/stable/web.html#aiohttp-web" target="_blank" rel="noopener noreferrer">服务端使用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li>同时支持<a href="https://aiohttp.readthedocs.io/en/stable/web.html#aiohttp-web-websockets" target="_blank" rel="noopener noreferrer">服务端WebSockets组件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a href="https://aiohttp.readthedocs.io/en/stable/client.html#aiohttp-client-websockets" target="_blank" rel="noopener noreferrer">客户端WebSockets组件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，开箱即用呦。</li> <li>web服务器具有<a href="https://aiohttp.readthedocs.io/en/stable/web.html#aiohttp-web-middlewares" target="_blank" rel="noopener noreferrer">中间件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，<a href="https://aiohttp.readthedocs.io/en/stable/web.html#aiohttp-web-signals" target="_blank" rel="noopener noreferrer">信号组件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和可插拔路由的功能。</li></ul> <p>我们先安装<code>aiohttp</code>：</p> <div class="language- extra-class"><pre class="language-text"><code>pip install aiohttp
</code></pre></div><p>然后编写一个HTTP服务器，分别处理以下URL：</p> <ul><li><p><code>/</code> - 首页返回<code>b'&lt;h1&gt;Index&lt;/h1&gt;'</code>；</p></li> <li><p><code>/hello/{name}</code> - 根据URL参数返回文本<code>hello, %s!</code></p></li> <li><p>代码如下</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">from</span> aiohttp <span class="token keyword">import</span> web

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> web<span class="token punctuation">.</span>Response<span class="token punctuation">(</span>body<span class="token operator">=</span><span class="token string">b'&lt;h1&gt;Index&lt;/h1&gt;'</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    text <span class="token operator">=</span> <span class="token string">'&lt;h1&gt;hello, %s!&lt;/h1&gt;'</span> <span class="token operator">%</span> request<span class="token punctuation">.</span>match_info<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> web<span class="token punctuation">.</span>Response<span class="token punctuation">(</span>body<span class="token operator">=</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#创建一个服务端应用</span>
    app <span class="token operator">=</span> web<span class="token punctuation">.</span>Application<span class="token punctuation">(</span>loop<span class="token operator">=</span>loop<span class="token punctuation">)</span>
    <span class="token comment">#绑定视图函数</span>
    app<span class="token punctuation">.</span>router<span class="token punctuation">.</span>add_route<span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>router<span class="token punctuation">.</span>add_route<span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'/hello/{name}'</span><span class="token punctuation">,</span> hello<span class="token punctuation">)</span>
    <span class="token comment">#创建服务</span>
    srv <span class="token operator">=</span> <span class="token keyword">await</span> loop<span class="token punctuation">.</span>create_server<span class="token punctuation">(</span>app<span class="token punctuation">.</span>make_handler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Server started at http://127.0.0.1:8000...'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> srv

loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#其实init本身就是一个协程，注册到事件循环中</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>init<span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>注意<code>aiohttp</code>的初始化函数<code>init()</code>也是一个<code>coroutine</code>，<code>loop.create_server()</code>则利用<code>asyncio</code>创建TCP服务。</p></li></ul> <h2 id="快速开始"><a href="#快速开始" class="header-anchor">#</a> 快速开始:</h2> <ul><li><p>客户端例子:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> async_timeout

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> async_timeout<span class="token punctuation">.</span>timeout<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">as</span> response<span class="token punctuation">:</span>
            <span class="token comment">#返回 访问到的页面</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#使用ClientSession创建一个连接对象session</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token comment">#将连接对象和网址传入</span>
        <span class="token comment"># html = await fetch(session, 'http://python.org')  #访问python官网</span>
        html <span class="token operator">=</span> <span class="token keyword">await</span> fetch<span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token string">'http://127.0.0.1:8080/'</span><span class="token punctuation">)</span>  <span class="token comment">#访问python官网</span>
        <span class="token comment"># 答应拿到的html页面</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>

loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>服务端例子:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> aiohttp <span class="token keyword">import</span> web

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 这里的name，就是路径中传入的name，没有就使用Anonymous</span>
    name <span class="token operator">=</span> request<span class="token punctuation">.</span>match_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">&quot;Anonymous&quot;</span><span class="token punctuation">)</span>
    text <span class="token operator">=</span> <span class="token string">&quot;Hello, &quot;</span> <span class="token operator">+</span> name
    <span class="token keyword">return</span> web<span class="token punctuation">.</span>Response<span class="token punctuation">(</span>text<span class="token operator">=</span>text<span class="token punctuation">)</span>

app <span class="token operator">=</span> web<span class="token punctuation">.</span>Application<span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>router<span class="token punctuation">.</span>add_get<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
<span class="token comment"># 绑定路径和处理的视图函数</span>
app<span class="token punctuation">.</span>router<span class="token punctuation">.</span>add_get<span class="token punctuation">(</span><span class="token string">'/{name}'</span><span class="token punctuation">,</span> handle<span class="token punctuation">)</span>

web<span class="token punctuation">.</span>run_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
</code></pre></div></li> <li><p>注意：不同版本Python的支持</p> <div class="language-python extra-class"><pre class="language-python"><code>这篇文档的所有例子都是利用 <span class="token keyword">async</span><span class="token operator">/</span><span class="token keyword">await</span> 语法来完成的，此语法介绍请看PEP <span class="token number">492</span>，此语法仅Python <span class="token number">3.5</span><span class="token operator">+</span>有效。 如果你使用的是Python <span class="token number">3.4</span><span class="token punctuation">,</span> 请将<span class="token keyword">await</span>替换成<span class="token keyword">yield</span> <span class="token keyword">from</span>，将<span class="token keyword">async</span> 替换成带有 @corotine装饰器的<span class="token keyword">def</span><span class="token punctuation">.</span> 比如<span class="token punctuation">:</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">coro</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret <span class="token operator">=</span> <span class="token keyword">await</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>
应替换为<span class="token punctuation">:</span>

<span class="token decorator annotation punctuation">@asyncio<span class="token punctuation">.</span>coroutine</span>
<span class="token keyword">def</span> <span class="token function">coro</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
   ret <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h2 id="aiohttp客户端的使用"><a href="#aiohttp客户端的使用" class="header-anchor">#</a> aiohttp客户端的使用</h2> <p>**发起请求：**让我们从导入aiohttp模块开始:</p> <ul><li><p>代码示例：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> aiohttp
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> async_timeout

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> async_timeout<span class="token punctuation">.</span>timeout<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">as</span> resp<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> resp<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        html <span class="token operator">=</span> <span class="token keyword">await</span> fetch<span class="token punctuation">(</span>session<span class="token punctuation">,</span><span class="token string">'https://api.github.com/events'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>


loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">#需要注意的是：我们现在用的session不是我们后端框架的session，它表示一次会话，由ClientSession对象赋值而来，还有一个变量resp，它其实是ClientResponse对象。</span>
	<span class="token comment"># 我们可以从这个响应对象中获取我们任何想要的信息。协程方法ClientSession.get()的主要参数接受一个HTTP URL</span>
</code></pre></div></li> <li><h5 id="发起post请求以及其他请求"><a href="#发起post请求以及其他请求" class="header-anchor">#</a> 发起post请求以及其他请求：</h5> <div class="language-python extra-class"><pre class="language-python"><code>session<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/post'</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token string">b'data'</span><span class="token punctuation">)</span> <span class="token comment">#将代码修改为</span>

session<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/put'</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token string">b'data'</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/delete'</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/get'</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>options<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/get'</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>patch<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/patch'</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token string">b'data'</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h4 id="发起json请求"><a href="#发起json请求" class="header-anchor">#</a> 发起JSON请求</h4> <p>每个会话的请求方法都可接受json参数</p> <ul><li><p>代码如下：修改上面部分代码</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>json<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'test'</span><span class="token punctuation">:</span> <span class="token string">'object'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h4 id="url传参"><a href="#url传参" class="header-anchor">#</a> URL传参</h4> <p>​	你可能经常想在URL中发送一系列的查询信息。如果你手动构建他们，这些信息会以键值对的形式出现在?后面，比如: <code>httpbin.org/get?key=val</code>。请求对象允许你使用**dict（字典，python中的数据类型）**发送它们，使用<code>params</code>参数即可。例如: 如果你要把 <code>key1=value1，key2=value2</code>放到<code>httpbin.org/get</code>后面，你可以用下面的方式:</p> <div class="language-python extra-class"><pre class="language-python"><code>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'key1'</span><span class="token punctuation">:</span> <span class="token string">'value1'</span><span class="token punctuation">,</span> <span class="token string">'key2'</span><span class="token punctuation">:</span> <span class="token string">'value2'</span><span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/get'</span><span class="token punctuation">,</span>
                       params<span class="token operator">=</span>params<span class="token punctuation">)</span> <span class="token keyword">as</span> resp<span class="token punctuation">:</span>
    <span class="token keyword">assert</span> <span class="token builtin">str</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'http://httpbin.org/get?key2=value2&amp;key1=value1'</span>
</code></pre></div><p>看URL已经被正确的编码啦。 同键不同值的**并联字典（MultiDict） **也同样支持。 可使用带有两个tuples(元组，python中的数据类型)的list(列表，python中的数据类型)来构建:</p> <div class="language-python extra-class"><pre class="language-python"><code>params <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token string">'value1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token string">'value2'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/get'</span><span class="token punctuation">,</span>
                       params<span class="token operator">=</span>params<span class="token punctuation">)</span> <span class="token keyword">as</span> r<span class="token punctuation">:</span>
    <span class="token keyword">assert</span> <span class="token builtin">str</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'http://httpbin.org/get?key=value2&amp;key=value1'</span>
</code></pre></div><p>**警告:**传递<em>params</em>时不要用<code>encode=True</code>，这俩参数不能同时使用。</p> <h4 id="获取响应内容"><a href="#获取响应内容" class="header-anchor">#</a> 获取响应内容</h4> <p>我们可以读取服务器的响应内容。想想我们获取GitHub时间轴的例子:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> aiohttp
<span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://api.github.com/events'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> resp<span class="token punctuation">:</span>
           <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> resp<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>这样会打印出类似于下面的信息:</p> <div class="language- extra-class"><pre class="language-text"><code>'[{&quot;created_at&quot;:&quot;2015-06-12T14:06:22Z&quot;,&quot;public&quot;:true,&quot;actor&quot;:{...
</code></pre></div><p><code>aiohttp</code>将会自动解码内容。你可以为<strong>text</strong>()方法指定编码(使用encoding参数):</p> <div class="language- extra-class"><pre class="language-text"><code>await resp.text(encoding='windows-1251')
</code></pre></div><h4 id="获取二进制响应内容"><a href="#获取二进制响应内容" class="header-anchor">#</a> 获取二进制响应内容</h4> <p>你也可以以字节形式获取响应，这样得到的就不是文本了:可以获取字节流</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> resp<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
b'<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;created_at&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;2015-06-12T14:06:22Z&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;public&quot;</span><span class="token punctuation">:</span>true<span class="token punctuation">,</span><span class="token string">&quot;actor&quot;</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p><code>gzip</code>和<code>defalte</code>传输编码会自动解码。 你也可以使其支持<code>brotli</code>传输编码的解码，只需安装<a href="https://github.com/python-hyper/brotlipy" target="_blank" rel="noopener noreferrer">brotlipy<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>即可。</p> <h4 id="获取json响应内容"><a href="#获取json响应内容" class="header-anchor">#</a> 获取JSON响应内容</h4> <p>以防你需要处理JSON数据，内置了一个JSON解码器:</p> <div class="language- extra-class"><pre class="language-text"><code>async with session.get('https://api.github.com/events') as resp:
    print(await resp.json())  #直接给你反序列化
</code></pre></div><p>如果JSON解码失败，<strong>json</strong>()方法将会抛出一个异常。你还可以在调用<strong>json</strong>()时指定编码器和解码器函数。</p> <p>**注意:**这些方法会读出内存中所有响应的内容。如果你要读非常多的数据，考虑使用流式响应方法进行读取。请看之后的文档。</p> <h4 id="获取流式响应内容"><a href="#获取流式响应内容" class="header-anchor">#</a> 获取流式响应内容</h4> <p>​	<strong>read</strong>(), <strong>json</strong>(), <strong>text</strong>()等方法使用起来很方便，但也要注意谨慎地使用。上述方法会将所有的响应内容加载到内存。举个例子，如果你要下载几个G的文件，这些方法还是会将所有内容都加载到内存，内存会表示&quot;臣妾做不到啊~&quot;(如果内存不够的话)。作为代替你可以用<strong>content</strong>属性。content其实是 <strong>aiohttp.StreamReader</strong>类的实例。<code>gzip</code>和<code>deflate</code>传输编码同样会自动解码。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://api.github.com/events'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> resp<span class="token punctuation">:</span>
    <span class="token keyword">await</span> resp<span class="token punctuation">.</span>content<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre></div><p>一般情况下你可以使用下列模式将内容保存在一个文件中:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fd<span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        chunk <span class="token operator">=</span> <span class="token keyword">await</span> resp<span class="token punctuation">.</span>content<span class="token punctuation">.</span>read<span class="token punctuation">(</span>chunk_size<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> chunk<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        fd<span class="token punctuation">.</span>write<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
</code></pre></div><p>在使用<strong>content</strong>读了数据后，就不要在用<strong>read</strong>(), <strong>json</strong>(), <strong>text</strong>()了。</p> <h4 id="获取请求信息"><a href="#获取请求信息" class="header-anchor">#</a> 获取请求信息</h4> <p><em>ClientResponse（客户端响应）对象含有request_info(请求信息)，主要是url</em>和<em>headers</em>信息。 <em>raise_for_status</em>结构体上的信息会被复制给ClientResponseError实例。</p> <h4 id="自定义headers"><a href="#自定义headers" class="header-anchor">#</a> 自定义Headers</h4> <p>如果你需要给某个请求添加HTTP头,可以使用headers参数，传递一个<strong>dict</strong>对象即可。 比如，如果你想给之前的例子指定 content-type可以这样:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> json
url <span class="token operator">=</span> <span class="token string">'https://api.github.com/some/endpoint'</span>
payload <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'some'</span><span class="token punctuation">:</span> <span class="token string">'data'</span><span class="token punctuation">}</span>
headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'content-type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">}</span>

<span class="token keyword">await</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>
                   data<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
</code></pre></div><h4 id="自定义cookies"><a href="#自定义cookies" class="header-anchor">#</a> 自定义Cookies</h4> <p>发送你自己的cookies给服务器，你可以为<strong>ClientSession</strong>对象指定<em>cookies</em>参数:</p> <div class="language-python extra-class"><pre class="language-python"><code>url <span class="token operator">=</span> <span class="token string">'http://httpbin.org/cookies'</span>
cookies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'cookies_are'</span><span class="token punctuation">:</span> <span class="token string">'working'</span><span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">with</span> ClientSession<span class="token punctuation">(</span>cookies<span class="token operator">=</span>cookies<span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">as</span> resp<span class="token punctuation">:</span>
        <span class="token keyword">assert</span> <span class="token keyword">await</span> resp<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">{</span>
           <span class="token string">&quot;cookies&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;cookies_are&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;working&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p>**注意:**访问<code>httpbin.org/cookies</code> 会看到以JSON形式返回的cookies。查阅会话中的cookies请看<a href="https://aiohttp.readthedocs.io/en/stable/client_reference.html#aiohttp.ClientSession.cookie_jar" target="_blank" rel="noopener noreferrer">ClientSession.cookie_jar<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h4 id="发起更复杂的post请求"><a href="#发起更复杂的post请求" class="header-anchor">#</a> 发起更复杂的POST请求</h4> <p>一般来说，如果你想以表单形式发送一些数据 - 就像HTML表单。那么只需要简单的将一个dict通过<em>data</em>参数传递就可以。传递的dict数据会自动编码:</p> <div class="language-python extra-class"><pre class="language-python"><code>payload <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'key1'</span><span class="token punctuation">:</span> <span class="token string">'value1'</span><span class="token punctuation">,</span> <span class="token string">'key2'</span><span class="token punctuation">:</span> <span class="token string">'value2'</span><span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/post'</span><span class="token punctuation">,</span>
                        data<span class="token operator">=</span>payload<span class="token punctuation">)</span> <span class="token keyword">as</span> resp<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> resp<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token string">&quot;form&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;key2&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;value2&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;key1&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;value1&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果你想发送非表单形式的数据你可用<code>str(字符串)</code>代替<code>dict(字典)</code>。这些数据会直接发送出去。 例如，GitHub API v3 接受JSON编码POST/PATCH数据:</p> <div class="language- extra-class"><pre class="language-text"><code>import json
url = 'https://api.github.com/some/endpoint'
payload = {'some': 'data'}

async with session.post(url, data=json.dumps(payload)) as resp:
    ...
</code></pre></div><h4 id="发送多部分编码文件-multipart-encoded"><a href="#发送多部分编码文件-multipart-encoded" class="header-anchor">#</a> 发送多部分编码文件(Multipart-Encoded)</h4> <p>上传多部分编码文件:</p> <div class="language-python extra-class"><pre class="language-python"><code>url <span class="token operator">=</span> <span class="token string">'http://httpbin.org/post'</span>
files <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'file'</span><span class="token punctuation">:</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'report.xls'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

<span class="token keyword">await</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>files<span class="token punctuation">)</span>
</code></pre></div><p>你也可以显式地设置文件名，文件类型:</p> <div class="language-python extra-class"><pre class="language-python"><code>url <span class="token operator">=</span> <span class="token string">'http://httpbin.org/post'</span>
data <span class="token operator">=</span> FormData<span class="token punctuation">(</span><span class="token punctuation">)</span>
data<span class="token punctuation">.</span>add_field<span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span>
               <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'report.xls'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               filename<span class="token operator">=</span><span class="token string">'report.xls'</span><span class="token punctuation">,</span>
               content_type<span class="token operator">=</span><span class="token string">'application/vnd.ms-excel'</span><span class="token punctuation">)</span>

<span class="token keyword">await</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
</code></pre></div><p>如果你把一个文件对象传递给data参数，aiohttp会自动将其以流的形式上传。查看<strong>StreamReader</strong>以获取支持的格式信息。</p> <p>**参见:**使用Multipart.](https://aiohttp.readthedocs.io/en/stable/multipart.html#aiohttp-multipart)</p> <h4 id="流式上传"><a href="#流式上传" class="header-anchor">#</a> 流式上传</h4> <p><strong>aiohttp</strong> 支持多种形式的流式上传，允许你直接发送大文件而不必读到内存。</p> <p>下面是个简单的例子，提供类文件对象即可:</p> <div class="language- extra-class"><pre class="language-text"><code>with open('massive-body', 'rb') as f:
   await session.post('http://httpbin.org/post', data=f)
</code></pre></div><p>或者你也可以使用<em>aiohttp.streamer</em>对象：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@aiohttp<span class="token punctuation">.</span>streamer</span>
<span class="token keyword">def</span> <span class="token function">file_sender</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> file_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        chunk <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">16</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> chunk<span class="token punctuation">:</span>
            <span class="token keyword">yield</span> <span class="token keyword">from</span> writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
            chunk <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">16</span><span class="token punctuation">)</span>

<span class="token comment"># 之后你可以使用’file_sender‘传递给data:</span>

<span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/post'</span><span class="token punctuation">,</span>
                        data<span class="token operator">=</span>file_sender<span class="token punctuation">(</span>file_name<span class="token operator">=</span><span class="token string">'huge_file'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> resp<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> resp<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>同样可以使用<strong>StreamReader</strong>对象.</p> <p>我们来看下如何把来自于另一个请求的内容作为文件上传并计算其SHA1值:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">feed_stream</span><span class="token punctuation">(</span>resp<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">:</span>
    h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        chunk <span class="token operator">=</span> <span class="token keyword">await</span> resp<span class="token punctuation">.</span>content<span class="token punctuation">.</span>readany<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> chunk<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
        stream<span class="token punctuation">.</span>feed_data<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>

    <span class="token keyword">return</span> h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>

resp <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/post'</span><span class="token punctuation">)</span>
stream <span class="token operator">=</span> StreamReader<span class="token punctuation">(</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>session<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/post'</span><span class="token punctuation">,</span> data<span class="token operator">=</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span>

file_hash <span class="token operator">=</span> <span class="token keyword">await</span> feed_stream<span class="token punctuation">(</span>resp<span class="token punctuation">,</span> stream<span class="token punctuation">)</span>
</code></pre></div><p>因为响应对象的content属性是一个<code>StreamReader</code>实例，所以你可以将get和post请求连在一起用:</p> <div class="language- extra-class"><pre class="language-text"><code>r = await session.get('http://python.org')
await session.post('http://httpbin.org/post',
                   data=r.content)
</code></pre></div><h4 id="上传预压缩过的数据"><a href="#上传预压缩过的数据" class="header-anchor">#</a> 上传预压缩过的数据</h4> <p>上传一个已经压缩过的数据，需要为Headers中的<code>Content-Encoding</code>指定算法名(通常是deflate或者是zlib).</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">my_coroutine</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> my_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> zlib<span class="token punctuation">.</span>compress<span class="token punctuation">(</span>my_data<span class="token punctuation">)</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'Content-Encoding'</span><span class="token punctuation">:</span> <span class="token string">'deflate'</span><span class="token punctuation">}</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/post'</span><span class="token punctuation">,</span>
                            data<span class="token operator">=</span>data<span class="token punctuation">,</span>
                            headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
        <span class="token keyword">pass</span>
</code></pre></div><h4 id="持久连接-keep-alive-连接池和cookies共享"><a href="#持久连接-keep-alive-连接池和cookies共享" class="header-anchor">#</a> 持久连接(keep-alive), 连接池和cookies共享</h4> <p><strong>ClientSession</strong>可以在多个请求之间共享cookies:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
    <span class="token keyword">await</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>
        <span class="token string">'http://httpbin.org/cookies/set?my_cookie=my_value'</span><span class="token punctuation">)</span>
    filtered <span class="token operator">=</span> session<span class="token punctuation">.</span>cookie_jar<span class="token punctuation">.</span>filter_cookies<span class="token punctuation">(</span><span class="token string">'http://httpbin.org'</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> filtered<span class="token punctuation">[</span><span class="token string">'my_cookie'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token string">'my_value'</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/cookies'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> r<span class="token punctuation">:</span>
        json_body <span class="token operator">=</span> <span class="token keyword">await</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> json_body<span class="token punctuation">[</span><span class="token string">'cookies'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'my_cookie'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'my_value'</span>
</code></pre></div><p>你也可以为所有的会话请求设置headers:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span>
    headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Basic bG9naW46cGFzcw==&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;http://httpbin.org/headers&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> r<span class="token punctuation">:</span>
        json_body <span class="token operator">=</span> <span class="token keyword">await</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> json_body<span class="token punctuation">[</span><span class="token string">'headers'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'Authorization'</span><span class="token punctuation">]</span> <span class="token operator">==</span> \
            <span class="token string">'Basic bG9naW46cGFzcw=='</span>
</code></pre></div><p><strong>ClientSession</strong>支持持久连接和连接池，可直接使用，不需要额外操作。</p> <h4 id="安全cookies"><a href="#安全cookies" class="header-anchor">#</a> 安全cookies</h4> <p><strong>ClientSession</strong>中的默认的<strong>aiohttp.CookiesJar</strong>使用的是严苛模式，<a href="https://tools.ietf.org/html/rfc2109.html" target="_blank" rel="noopener noreferrer">RFC 2109<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>明确禁止使用ip地址形式的URL携带cookies信息。比如: <em>http://127.0.0.1:80/cookie</em> 这样很好，不过有些时候我们测试时需要允许携带cookies。在<strong>aiohttp.CookiesJar</strong>中传递<em>unsafe=True</em>来实现这一效果:</p> <div class="language- extra-class"><pre class="language-text"><code>jar = aiohttp.CookieJar(unsafe=True)
session = aiohttp.ClientSession(cookie_jar=jar)
</code></pre></div><h4 id="使用虚假cookie-jar"><a href="#使用虚假cookie-jar" class="header-anchor">#</a> 使用虚假Cookie Jar</h4> <p>有时不想处理cookie。这时可以在会话中使用<strong>aiohttp.DummyCookieJar</strong>来达到目的。</p> <div class="language- extra-class"><pre class="language-text"><code>jar = aiohttp.DummyCookieJar()
session = aiohttp.ClientSession(cookie_jar=jar)
</code></pre></div><h4 id="使用连接器"><a href="#使用连接器" class="header-anchor">#</a> 使用连接器</h4> <p>想要调整请求的传输层你可以为<strong>ClientSession</strong>及其同类组件传递自定义的连接器。例如:</p> <div class="language- extra-class"><pre class="language-text"><code>conn = aiohttp.TCPConnector()
session = aiohttp.ClientSession(connector=conn)
</code></pre></div><blockquote><h3 id="注解"><a href="#注解" class="header-anchor">#</a> 注解:</h3></blockquote> <p>不要给多个会话对象使用同一个连接器，某一会话对象拥有其所有权。</p> <blockquote><h3 id="参见"><a href="#参见" class="header-anchor">#</a> 参见:</h3></blockquote> <p>查看<a href="https://aiohttp.readthedocs.io/en/stable/client_reference.html#aiohttp-client-reference-connectors" target="_blank" rel="noopener noreferrer">连接器<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>部分了解更多不同的连接器类型和配置选项信息。</p> <h4 id="限制连接池的容量"><a href="#限制连接池的容量" class="header-anchor">#</a> 限制连接池的容量</h4> <p>限制同一时间打开的连接数可以传递limit参数:</p> <div class="language- extra-class"><pre class="language-text"><code>conn = aiohttp.TCPConnector(limit=30)
</code></pre></div><p>这样就将总数限制在30.</p> <p>默认情况下是100.</p> <p>如果你不想有限制，传递0即可:</p> <div class="language- extra-class"><pre class="language-text"><code>conn = aiohttp.TCPConnector(limit=0)
</code></pre></div><p>限制同一时间在同一个端点((<code>host</code>, <code>port</code>, <code>is_ssl</code>) 3者都一样的情况)打开的连接数可指定limit_per_host参数:</p> <div class="language- extra-class"><pre class="language-text"><code>conn = aiohttp.TCPConnector(limit_per_host=30)
</code></pre></div><p>这样会限制在30. 默认情况下是0(也就是不做限制)。</p> <h4 id="使用自定义域名服务器"><a href="#使用自定义域名服务器" class="header-anchor">#</a> 使用自定义域名服务器</h4> <p>底层需要<a href="https://aiohttp.readthedocs.io/en/stable/glossary.html#term-aiodns" target="_blank" rel="noopener noreferrer">aiodns<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>支持:</p> <div class="language- extra-class"><pre class="language-text"><code>from aiohttp.resolver import AsyncResolver

resolver = AsyncResolver(nameservers=[&quot;8.8.8.8&quot;, &quot;8.8.4.4&quot;])
conn = aiohttp.TCPConnector(resolver=resolver)
</code></pre></div><h4 id="为tcp-sockets添加ssl控制"><a href="#为tcp-sockets添加ssl控制" class="header-anchor">#</a> 为TCP sockets添加SSL控制:</h4> <p>默认情况下aiohttp总会对使用了HTTPS协议(的URL请求)查验其身份。但也可将<em>verify_ssl</em>设置为<code>False</code>让其不检查:</p> <div class="language- extra-class"><pre class="language-text"><code>r = await session.get('https://example.com', verify_ssl=False)
</code></pre></div><p>如果你需要设置自定义SSL信息(比如使用自己的证书文件)你可以创建一个<strong>ssl.SSLContext</strong>实例并传递到<strong>ClientSession</strong>中:</p> <div class="language- extra-class"><pre class="language-text"><code>sslcontext = ssl.create_default_context(
   cafile='/path/to/ca-bundle.crt')
r = await session.get('https://example.com', ssl_context=sslcontext)
</code></pre></div><p>如果你要验证<em>自签名</em>的证书，你也可以用之前的例子做同样的事，但是用的是load_cert_chain():</p> <div class="language- extra-class"><pre class="language-text"><code>sslcontext = ssl.create_default_context(
   cafile='/path/to/ca-bundle.crt')
sslcontext.load_cert_chain('/path/to/client/public/device.pem',
                           '/path/to/client/private/device.jey')
r = await session.get('https://example.com', ssl_context=sslcontext)
</code></pre></div><p>SSL验证失败时抛出的错误:</p> <p><strong>aiohttp.ClientConnectorSSLError</strong>:</p> <div class="language- extra-class"><pre class="language-text"><code>try:
    await session.get('https://expired.badssl.com/')
except aiohttp.ClientConnectorSSLError as e:
    assert isinstance(e, ssl.SSLError)
</code></pre></div><p><strong>aiohttp.ClientConnectorCertificateError</strong>:</p> <div class="language- extra-class"><pre class="language-text"><code>try:
    await session.get('https://wrong.host.badssl.com/')
except aiohttp.ClientConnectorCertificateError as e:
    assert isinstance(e, ssl.CertificateError)
</code></pre></div><p>如果你需要忽略所有SSL的错误:</p> <p><strong>aiohttp.ClientSSLError</strong>:</p> <div class="language- extra-class"><pre class="language-text"><code>try:
    await session.get('https://expired.badssl.com/')
except aiohttp.ClientSSLError as e:
    assert isinstance(e, ssl.SSLError)

try:
    await session.get('https://wrong.host.badssl.com/')
except aiohttp.ClientSSLError as e:
    assert isinstance(e, ssl.CertificateError)
</code></pre></div><p>你还可以通过<em>SHA256</em>指纹验证证书:</p> <div class="language- extra-class"><pre class="language-text"><code># Attempt to connect to https://www.python.org
# with a pin to a bogus certificate:
bad_fingerprint = b'0'*64
exc = None
try:
    r = await session.get('https://www.python.org',
                          fingerprint=bad_fingerprint)
except aiohttp.FingerprintMismatch as e:
    exc = e
assert exc is not None
assert exc.expected == bad_fingerprint

# www.python.org cert's actual fingerprint
assert exc.got == b'...'
</code></pre></div><p>注意这是以DER编码的证书的指纹。如果你的证书是PEM编码，你需要转换成DER格式:</p> <div class="language- extra-class"><pre class="language-text"><code>openssl x509 -in crt.pem -inform PEM -outform DER &gt; crt.der
</code></pre></div><blockquote><h3 id="注解-2"><a href="#注解-2" class="header-anchor">#</a> 注解:</h3></blockquote> <p>提示: 从16进制数字转换成二进制字节码，你可以用<strong>binascii.unhexlify</strong>().</p> <p><strong>TCPConnector</strong>中设置的<em>verify_ssl, fingerprint和ssl_context</em>都会被当做默认的verify_ssl, fingerprint和ssl_context，<strong>ClientSession</strong>或其他同类组件中的设置会覆盖默认值。</p> <blockquote><h3 id="警告"><a href="#警告" class="header-anchor">#</a> 警告:</h3></blockquote> <p><em>verify_ssl 和 ssl_context</em>是<em>互斥</em>的。 <em>MD5</em>和<em>SHA1</em>指纹虽不赞成使用但是是支持的 - 这俩是非常不安全的哈希函数。</p> <h4 id="unix-域套接字"><a href="#unix-域套接字" class="header-anchor">#</a> Unix 域套接字</h4> <p>如果你的服务器使用UNIX域套接字你可以用<strong>UnixConnector</strong>:</p> <div class="language- extra-class"><pre class="language-text"><code>conn = aiohttp.UnixConnector(path='/path/to/socket')
session = aiohttp.ClientSession(connector=conn)
</code></pre></div><h4 id="代理支持"><a href="#代理支持" class="header-anchor">#</a> 代理支持</h4> <p>aiohttp 支持 HTTP/HTTPS形式的代理。你需要使用<em>proxy</em>参数:</p> <div class="language- extra-class"><pre class="language-text"><code>async with aiohttp.ClientSession() as session:
    async with session.get(&quot;http://python.org&quot;,
                           proxy=&quot;http://some.proxy.com&quot;) as resp:
        print(resp.status)
</code></pre></div><p>同时支持认证代理:</p> <div class="language- extra-class"><pre class="language-text"><code>async with aiohttp.ClientSession() as session:
    proxy_auth = aiohttp.BasicAuth('user', 'pass')
    async with session.get(&quot;http://python.org&quot;,
                           proxy=&quot;http://some.proxy.com&quot;,
                           proxy_auth=proxy_auth) as resp:
        print(resp.status)
</code></pre></div><p>也可将代理的验证信息放在url中:</p> <div class="language- extra-class"><pre class="language-text"><code>session.get(&quot;http://python.org&quot;,
            proxy=&quot;http://user:pass@some.proxy.com&quot;)
</code></pre></div><p>与<code>requests(另一个广受欢迎的http包)</code>不同，aiohttp默认不会读取环境变量中的代理值。但你可以通过传递<code>trust_env=True</code>来让<strong>aiohttp.ClientSession</strong>读取<em>HTTP_PROXY</em>或<em>HTTPS_PROXY</em>环境变量中的代理信息(不区分大小写)。</p> <div class="language- extra-class"><pre class="language-text"><code>async with aiohttp.ClientSession() as session:
    async with session.get(&quot;http://python.org&quot;, trust_env=True) as resp:
        print(resp.status)
</code></pre></div><h4 id="查看响应状态码"><a href="#查看响应状态码" class="header-anchor">#</a> 查看响应状态码</h4> <p>我们可以查询响应状态码:</p> <div class="language- extra-class"><pre class="language-text"><code>async with session.get('http://httpbin.org/get') as resp:
    assert resp.status == 200
</code></pre></div><h4 id="获取响应头信息"><a href="#获取响应头信息" class="header-anchor">#</a> 获取响应头信息</h4> <p>我们可以查看服务器的响应信息, <strong>ClientResponse.headers</strong>使用的数据类型是<strong>CIMultiDcitProxy</strong>:</p> <div class="language- extra-class"><pre class="language-text"><code>&gt;&gt;&gt; resp.headers
{'ACCESS-CONTROL-ALLOW-ORIGIN': '*',
 'CONTENT-TYPE': 'application/json',
 'DATE': 'Tue, 15 Jul 2014 16:49:51 GMT',
 'SERVER': 'gunicorn/18.0',
 'CONTENT-LENGTH': '331',
 'CONNECTION': 'keep-alive'}
</code></pre></div><p>这是一个特别的字典，它只为HTTP头信息而生。根据<a href="http://tools.ietf.org/html/rfc7230#section-3.2" target="_blank" rel="noopener noreferrer"> RFC 7230<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，HTTP头信息中的名字是不分区大小写的。同时也支持多个不同的值对应同一个键。</p> <p>所以我们可以通过任意形式访问它:</p> <div class="language- extra-class"><pre class="language-text"><code>&gt;&gt;&gt; resp.headers['Content-Type']
'application/json'

&gt;&gt;&gt; resp.headers.get('content-type')
'application/json'
</code></pre></div><p>所有的header信息都是由二进制数据转换而来，使用带有<code>surrogateescape</code>选项的UTF-8编码方式(surrogateescape是一种错误处理方式，详情看&lt;a href=&quot;https://docs.python.org/3/library/codecs.html#error-handlers&quot; 这里))。大部分时候都可以很好的工作，但如果服务器使用的不是标准编码就不能正常解码了。从<a href="http://tools.ietf.org/html/rfc7230#section-3.2" target="_blank" rel="noopener noreferrer"> RFC 7230<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的角度来看这样的headers并不是合理的格式，你可以用<strong>ClientReponse.resp.raw_headers</strong>来查看原形:</p> <div class="language- extra-class"><pre class="language-text"><code>&gt;&gt;&gt; resp.raw_headers
((b'SERVER', b'nginx'),
 (b'DATE', b'Sat, 09 Jan 2016 20:28:40 GMT'),
 (b'CONTENT-TYPE', b'text/html; charset=utf-8'),
 (b'CONTENT-LENGTH', b'12150'),
 (b'CONNECTION', b'keep-alive'))
</code></pre></div><h4 id="获取响应cookies"><a href="#获取响应cookies" class="header-anchor">#</a> 获取响应cookies:</h4> <p>如果某响应包含一些Cookies，你可以很容易地访问他们:</p> <div class="language- extra-class"><pre class="language-text"><code>url = 'http://example.com/some/cookie/setting/url'
async with session.get(url) as resp:
    print(resp.cookies['example_cookie_name'])
</code></pre></div><blockquote><h3 id="注意"><a href="#注意" class="header-anchor">#</a> 注意:</h3></blockquote> <p>响应中的cookies只包含重定向链中最后一个请求中的<code>Set-Cookies</code>头信息设置的值。如果每一次重定向请求都收集一次cookies请使用<a href="https://aiohttp.readthedocs.io/en/stable/client.html#aiohttp-client-session" target="_blank" rel="noopener noreferrer"> aiohttp.ClientSession<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对象.</p> <h4 id="获取响应历史"><a href="#获取响应历史" class="header-anchor">#</a> 获取响应历史</h4> <p>如果一个请求被重定向了，你可以用<strong>history</strong>属性查看其之前的响应:</p> <div class="language- extra-class"><pre class="language-text"><code>&gt;&gt;&gt; resp = await session.get('http://example.com/some/redirect/')
&gt;&gt;&gt; resp
&lt;ClientResponse(http://example.com/some/other/url/) [200]&gt;
&gt;&gt;&gt; resp.history
(&lt;ClientResponse(http://example.com/some/redirect/) [301]&gt;,)
</code></pre></div><p>如果没有重定向或<code>allow_redirects</code>设置为<code>False</code>，history会被设置为空。</p> <h4 id="使用websockets"><a href="#使用websockets" class="header-anchor">#</a> 使用WebSockets</h4> <p><strong>aiohttp</strong>提供开箱即用的客户端websocket。 你需要使用<strong>aiohttp.ClientSession.ws_connect</strong>()协程对象。它的第一个参数接受URL，返回值是<strong>ClientWebSocketResponse</strong>，这样你就可以用响应的方法与websocket服务器进行通信。</p> <div class="language- extra-class"><pre class="language-text"><code>session = aiohttp.ClientSession()
async with session.ws_connect('http://example.org/websocket') as ws:

    async for msg in ws:
        if msg.type == aiohttp.WSMsgType.TEXT:
            if msg.data == 'close cmd':
                await ws.close()
                break
            else:
                await ws.send_str(msg.data + '/answer')
        elif msg.type == aiohttp.WSMsgType.CLOSED:
            break
        elif msg.type == aiohttp.WSMsgType.ERROR:
            break
</code></pre></div><p>你只能使用一种读取方式(例如<code>await ws.receive()</code> 或者 <code>async for msg in ws:</code>)和写入方法，但可以有多个写入任务，写入任务也是异步完成的(<code>ws.send_str('data')</code>)。</p> <h4 id="设置超时"><a href="#设置超时" class="header-anchor">#</a> 设置超时</h4> <p>默认情况下每个IO操作有5分钟超时时间。可以通过给<strong>ClientSession.get</strong>()及其同类组件传递<code>timeout</code>来覆盖原超时时间:</p> <div class="language- extra-class"><pre class="language-text"><code>async with session.get('https://github.com', timeout=60) as r:
    ...
</code></pre></div><p><code>None</code> 或者<code>0</code>则表示不检测超时。 还可通过调用<strong>async_timeout.timeout</strong>上下文管理器来为连接和解析响应内容添加一个总超时时间:</p> <div class="language- extra-class"><pre class="language-text"><code>import async_timeout

with async_timeout.timeout(0.001):
    async with session.get('https://github.com') as r:
        await r.text()
</code></pre></div><blockquote><h3 id="注意-2"><a href="#注意-2" class="header-anchor">#</a> 注意:</h3></blockquote> <p>超时时间是累计的，包含如发送情况，重定向，响应解析，处理响应等所有操作在内...</p> <h4 id="愉快地结束"><a href="#愉快地结束" class="header-anchor">#</a> 愉快地结束:</h4> <p>当一个包含<code>ClientSession</code>的<code>async with</code>代码块的末尾行结束时(或直接调用了<code>.close()</code>)，因为asyncio内部的一些原因底层的连接其实没有关闭。在实际使用中，底层连接需要有一个缓冲时间来关闭。然而，如果事件循环在底层连接关闭之前就结束了，那么会抛出一个 资源警告: 存在未关闭的传输(通道)(<code>ResourceWarning: unclosed transport</code>),如果警告可用的话。 为了避免这种情况，在关闭事件循环前加入一小段延迟让底层连接得到关闭的缓冲时间。 对于非SSL的<code>ClientSession</code>, 使用0即可(<code>await asyncio.sleep(0)</code>):</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_website</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://example.org/'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> response<span class="token punctuation">:</span>
            <span class="token keyword">await</span> response<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>read_website<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Zero-sleep to allow underlying connections to close</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>对于使用了SSL的<code>ClientSession</code>, 需要设置一小段合适的时间:</p> <div class="language- extra-class"><pre class="language-text"><code>...
# Wait 250 ms for the underlying SSL connections to close
loop.run_until_complete(asyncio.sleep(0.250))
loop.close()
</code></pre></div><p>合适的时间因应用程序而异。</p> <p>当asyncio内部的运行机制改变时就可以让aiohttp去等待底层连接关闭在退出啦，上面这种额外的方法总会废弃啦。你也可以跟进问题<a href="https://github.com/aio-libs/aiohttp/issues/1925" target="_blank" rel="noopener noreferrer">#1925<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来参与改进。</p> <hr> <h2 id="服务端指南"><a href="#服务端指南" class="header-anchor">#</a> 服务端指南</h2> <p>准备使用aiohttp但不知道如何开始？这里有一些小例子来快速熟悉下。接下来我们一起来试着开发一个小投票系统。如果你想改进或与之对比学习，可以查看demo source 来获取全部源码。</p> <p>准备好我们的开发环境 首先检查下python版本:</p> <div class="language- extra-class"><pre class="language-text"><code>$ python -V
Python 3.5.0
</code></pre></div><p>我们需要python 3.5.0及以上版本。</p> <p>假设你已经安装好aiohttp库了。你可以用以下命令来查询当前aiohttp库的版本。</p> <div class="language- extra-class"><pre class="language-text"><code>$ python3 -c 'import aiohttp; print(aiohttp.__version__)'
2.0.5
</code></pre></div><p>项目结构与其他以python为基础的web项目大同小异:</p> <div class="language- extra-class"><pre class="language-text"><code>.
├── README.rst
└── polls
    ├── Makefile
    ├── README.rst
    ├── aiohttpdemo_polls
    │   ├── __init__.py
    │   ├── __main__.py
    │   ├── db.py
    │   ├── main.py
    │   ├── routes.py
    │   ├── templates
    │   ├── utils.py
    │   └── views.py
    ├── config
    │   └── polls.yaml
    ├── images
    │   └── example.png
    ├── setup.py
    ├── sql
    │   ├── create_tables.sql
    │   ├── install.sh
    │   └── sample_data.sql
    └── static
        └── style.css
</code></pre></div><h4 id="开始用aiohttp构建我们的第一个应用程序"><a href="#开始用aiohttp构建我们的第一个应用程序" class="header-anchor">#</a> 开始用aiohttp构建我们的第一个应用程序</h4> <p>该指南借鉴了教科书Django投票系统指南。</p> <h4 id="创建应用程序"><a href="#创建应用程序" class="header-anchor">#</a> 创建应用程序</h4> <p>aiohttp的服务端程序都是 <code>aiohttp.web.Application</code>实例对象。用于创建信号，连接路由等。</p> <p>使用下列代码可以创建一个应用程序:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> aiohttp <span class="token keyword">import</span> web

app <span class="token operator">=</span> web<span class="token punctuation">.</span>Application<span class="token punctuation">(</span><span class="token punctuation">)</span>
web<span class="token punctuation">.</span>run_app<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">)</span>
</code></pre></div><p>将其保存在<code>aiohttpdemo_polls/main.py</code>然后开启服务器: <code>$ python3 main.py</code></p> <p>你会在命令行中看到如下输出:</p> <div class="language- extra-class"><pre class="language-text"><code>======== Running on http://127.0.0.1:8080 ========
(Press CTRL+C to quit)
</code></pre></div><p>在浏览器中打开 http://127.0.0.1:8080 或在命令行中使用<code>curl</code>: <code>$ curl -X GET localhost:8080</code></p> <p>啊咧，出现了404: Not Found. 呃...因为我们并没有创建路由和和展示页面。</p> <h4 id="创建视图"><a href="#创建视图" class="header-anchor">#</a> 创建视图</h4> <p>我们来一起创建第一个展示页面(视图)。我们先创建个文件<code>aiohttpdemo_polls/views.py</code>然后写入:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> aiohttp <span class="token keyword">import</span> web

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> web<span class="token punctuation">.</span>Response<span class="token punctuation">(</span>text<span class="token operator">=</span><span class="token string">'Hello Aiohttp!'</span><span class="token punctuation">)</span>
</code></pre></div><p><code>index</code>就是我们创建的展示页，然后我们创建个路由连接到这个展示页上。我们来把路由放在<code>aiohttpdemo_polls/routes.py</code>文件中（将路由表和模型分开写是很好的实践。创建实际项目时可能会有多个同类文件，这样分开放可以让自己很清楚。):</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> views <span class="token keyword">import</span> index

<span class="token keyword">def</span> <span class="token function">setup_routes</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#index是视图函数</span>
    app<span class="token punctuation">.</span>router<span class="token punctuation">.</span>add_get<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span>
</code></pre></div><p>我们还要在<code>main.py</code>中调用<code>setup_routes</code>。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> aiohttp <span class="token keyword">import</span> web
<span class="token keyword">from</span> routes <span class="token keyword">import</span> setup_routes

app <span class="token operator">=</span> web<span class="token punctuation">.</span>Application<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#传入app</span>
setup_routes<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
web<span class="token punctuation">.</span>run_app<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">)</span>
</code></pre></div><p>然后我们重新开启服务器，现在我们从浏览器中访问:</p> <div class="language- extra-class"><pre class="language-text"><code>$ curl -X GET localhost:8080
Hello Aiohttp!
</code></pre></div><p>啊哈！成功了！我们现在应该有了一个如下所示的目录结构:</p> <div class="language- extra-class"><pre class="language-text"><code>.
├── ..
└── polls
    ├── aiohttpdemo_polls
    │   ├── main.py
    │   ├── routes.py
    │   └── views.py
</code></pre></div><h4 id="使用配置文件"><a href="#使用配置文件" class="header-anchor">#</a> 使用配置文件</h4> <p>aiohttp不需要任何配置文件，也没有内置支持任何配置架构。 但考虑到这些事实:</p> <ol><li>99%的服务器都有配置文件。</li> <li>其他的同类程序(除了以Python为基础的像Django和Flask的)都不会将配置文件作为源码的一部分。 比如Nginx将配置文件保存在 /etc/nginx文件夹里。 mongo则保存在 /etc/mongodb.conf里。</li> <li>使用配置文件是公认的好方法，在部署产品时可以预防一些小错误。</li></ol> <p>所以我们建议用以下途径(进行配置文件):</p> <ol><li>将配置信息写在yaml文件中。(json或ini都可以，但yaml最好用。)</li> <li>在一个预先设定好的目录中加载yaml。</li> <li>拥有能通过命令行来设置配置文件的功能。如: ./run_app --config=/opt/config/app_cfg.yaml</li> <li>对要加载的字典执行严格检测，以确保其数据类型符合预期。可以使用: trafaret, colander 或 JSON schema等库。</li></ol> <p>以下代码会加载配置文件并设置到应用程序中:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># load config from yaml file in current dir</span>
conf <span class="token operator">=</span> load_config<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>pathlib<span class="token punctuation">.</span>Path<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token string">'config'</span> <span class="token operator">/</span> <span class="token string">'polls.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">[</span><span class="token string">'config'</span><span class="token punctuation">]</span> <span class="token operator">=</span> conf
</code></pre></div><h4 id="构建数据库"><a href="#构建数据库" class="header-anchor">#</a> 构建数据库</h4> <h4 id="准备工作"><a href="#准备工作" class="header-anchor">#</a> 准备工作</h4> <p>这份指南中我们使用最新版的<code>PostgreSQL</code>数据库。 你可访问以下链接下载: http://www.postgresql.org/download/</p> <h4 id="数据库架构"><a href="#数据库架构" class="header-anchor">#</a> 数据库架构</h4> <p>我们使用<code>SQLAlchemy</code>来写数据库架构。我们只要创建两个简单的模块——<code>question</code>和<code>choice</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> sqlalchemy <span class="token keyword">as</span> sa 

meta <span class="token operator">=</span> sa<span class="token punctuation">.</span>MetaData<span class="token punctuation">(</span><span class="token punctuation">)</span>

question <span class="token operator">=</span> sq<span class="token punctuation">.</span>Table<span class="token punctuation">(</span>
    <span class="token string">'question'</span><span class="token punctuation">,</span> meta<span class="token punctuation">,</span>
    sa<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> sa<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    sa<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token string">'question_text'</span><span class="token punctuation">,</span> sa<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    sa<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token string">'pub_date'</span><span class="token punctuation">,</span> sa<span class="token punctuation">.</span>Date<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># Indexes #</span>
    sa<span class="token punctuation">.</span>PrimaryKeyConstraint<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'question_id_pkey'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

choice <span class="token operator">=</span> sa<span class="token punctuation">.</span>Table<span class="token punctuation">(</span>
    <span class="token string">'choice'</span><span class="token punctuation">,</span> meta<span class="token punctuation">,</span>
    sa<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> sa<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    sa<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token string">'question_id'</span><span class="token punctuation">,</span> sa<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    sa<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token string">'choice_text'</span><span class="token punctuation">,</span> sa<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    sa<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token string">'votes'</span><span class="token punctuation">,</span> server_default<span class="token operator">=</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># Indexes #</span>
    sa<span class="token punctuation">.</span>PrimayKeyConstraint<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'choice_id_pkey'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    sa<span class="token punctuation">.</span>ForeignKeyContraint<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'question_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>question<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            name<span class="token operator">=</span><span class="token string">'choice_question_id_fkey'</span><span class="token punctuation">,</span>
                            ondelete<span class="token operator">=</span><span class="token string">'CASCADE'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre></div><p>你会看到如下数据库结构:</p> <p>第一张表 question: |question| |id| |question_text| |pub_date|</p> <p>第二张表 choice: |choice| |id| |choice_text| |votes| |question_id|</p> <h4 id="创建连接引擎"><a href="#创建连接引擎" class="header-anchor">#</a> 创建连接引擎</h4> <p>为了从数据库中查询数据我们需要一个引擎实例对象。假设<code>conf</code>变量是一个带有连接信息的配置字典，<code>Postgre</code>s会使用异步的方式完成该操作:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">init_pg</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conf <span class="token operator">=</span> app<span class="token punctuation">[</span><span class="token string">'config'</span><span class="token punctuation">]</span>
    engine <span class="token operator">=</span> <span class="token keyword">await</span> aiopg<span class="token punctuation">.</span>sa<span class="token punctuation">.</span>create_engine<span class="token punctuation">(</span>
        database<span class="token operator">=</span>conf<span class="token punctuation">[</span><span class="token string">'database'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        user<span class="token operator">=</span>conf<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        password<span class="token operator">=</span>conf<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        host<span class="token operator">=</span>conf<span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        port<span class="token operator">=</span>conf<span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        minsize<span class="token operator">=</span>conf<span class="token punctuation">[</span><span class="token string">'minsize'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        maxsize<span class="token operator">=</span>conf<span class="token punctuation">[</span><span class="token string">'maxsize'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    app<span class="token punctuation">[</span><span class="token string">'db'</span><span class="token punctuation">]</span> <span class="token operator">=</span> engine
</code></pre></div><p>最好将连接数据库的函数放在<code>on_startup</code>信号中:</p> <div class="language- extra-class"><pre class="language-text"><code>app.on_startup.append(init_pg)
</code></pre></div><h4 id="关闭数据库"><a href="#关闭数据库" class="header-anchor">#</a> 关闭数据库</h4> <p>程序退出时一块关闭所有的资源接口是一个很好的做法。 使用on_cleanup信号来关闭数据库接口:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">close_pg</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">:</span>
    app<span class="token punctuation">[</span><span class="token string">'db'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> app<span class="token punctuation">[</span><span class="token string">'db'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>wait_closed<span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span>on_cleanup<span class="token punctuation">.</span>append<span class="token punctuation">(</span>close_pg<span class="token punctuation">)</span>
</code></pre></div><h4 id="使用模板"><a href="#使用模板" class="header-anchor">#</a> 使用模板</h4> <p>我们来添加些更有用的页面:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@aiohttp_jinja2<span class="token punctuation">.</span>template</span><span class="token punctuation">(</span><span class="token string">'detail.html'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">poll</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> request<span class="token punctuation">[</span><span class="token string">'db'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
        question_id <span class="token operator">=</span> request<span class="token punctuation">.</span>match_info<span class="token punctuation">[</span><span class="token string">'question_id'</span><span class="token punctuation">]</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            question<span class="token punctuation">,</span> choices <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>get_question<span class="token punctuation">(</span>conn<span class="token punctuation">,</span>
                                                      question_id<span class="token punctuation">)</span>
        <span class="token keyword">except</span> db<span class="token punctuation">.</span>RecordNotFound <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> web<span class="token punctuation">.</span>HTTPNotFound<span class="token punctuation">(</span>text<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token string">'question'</span><span class="token punctuation">:</span> question<span class="token punctuation">,</span>
            <span class="token string">'choices'</span><span class="token punctuation">:</span> choices
        <span class="token punctuation">}</span>
</code></pre></div><p>编写页面时使用模板是很方便的。我们返回带有页面内容的字典，<code>aiohttp_jinja2.template</code>装饰器会用<code>jinja2</code>模板加载它。</p> <p>当然我们要先安装下<code>aiohttp_jinja2</code>:</p> <div class="language- extra-class"><pre class="language-text"><code>$ pip install aiohttp_jinja2
</code></pre></div><p>安装完成后我们使用时要适配下:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> aiohttp_jinja2
<span class="token keyword">import</span> jinja2

aiohttp_jinja2<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>
    app<span class="token punctuation">,</span> loader<span class="token operator">=</span>jinja2<span class="token punctuation">.</span>PackageLoader<span class="token punctuation">(</span><span class="token string">'aiohttpdemo_polls'</span><span class="token punctuation">,</span> <span class="token string">'templates'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>我们将其放在<code>polls/aiohttpdemo_polls/templates</code>文件夹中。</p> <h4 id="静态文件"><a href="#静态文件" class="header-anchor">#</a> 静态文件</h4> <p>每个web站点都有一些静态文件: 图片啦，JavaScript，CSS文件啦等等。 在生产环境中处理这些静态文件最好的方法是使用NGINX或CDN服务做反向代理。 但在开发环境中使用aiohttp服务器处理静态文件是很方便的。</p> <p>只需要简单的调用一个信号即可:</p> <div class="language- extra-class"><pre class="language-text"><code>app.router.add_static('/static/',
                      path=str(project_root / 'static'),
                      name='static')
</code></pre></div><p>project_root表示根目录。</p> <h4 id="使用中间件"><a href="#使用中间件" class="header-anchor">#</a> 使用中间件</h4> <p>中间件是每个web处理器必不可少的组件。它的作用是在处理器处理请求前预处理请求以及在得到响应后发送出去。</p> <p>我们下面来实现一个用于显示漂亮的404和500页面的简单中间件。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">setup_middlewares</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">:</span>
    error_middleware <span class="token operator">=</span> error_pages<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token number">404</span><span class="token punctuation">:</span> handle_404<span class="token punctuation">,</span>
                                    <span class="token number">500</span><span class="token punctuation">:</span> handle_500<span class="token punctuation">}</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>middlewares<span class="token punctuation">.</span>append<span class="token punctuation">(</span>error_middleware<span class="token punctuation">)</span>
</code></pre></div><p>中间件(middleware)本身是一个接受*应用程序（application）<em>和</em>后续处理器（next handler）*的加工厂。</p> <p>中间件工厂返回一个与web处理器一样接受请求并返回响应的中间件处理器。</p> <p>下面实现一个用于处理HTTP异常的中间件:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">error_pages</span><span class="token punctuation">(</span>overrides<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">middleware</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">middleware_handler</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                response <span class="token operator">=</span> <span class="token keyword">await</span> handler<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
                override <span class="token operator">=</span> overrides<span class="token punctuation">.</span>get<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
                <span class="token keyword">if</span> override <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span> response
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span> <span class="token keyword">await</span> override<span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
            <span class="token keyword">except</span> web<span class="token punctuation">.</span>HTTPException <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
                override <span class="token operator">=</span> overrides<span class="token punctuation">.</span>get<span class="token punctuation">(</span>ex<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
                <span class="token keyword">if</span> override <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span> <span class="token keyword">await</span> override<span class="token punctuation">(</span>request<span class="token punctuation">,</span> ex<span class="token punctuation">)</span>
        <span class="token keyword">return</span> middleware_handler
    <span class="token keyword">return</span> middleware
</code></pre></div><p>这些<code>overrides（handle_404和handle_500）</code>只是简单的用<code>Jinja2</code>模板渲染:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle_404</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> aiohttp_jinja2<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">'404.html'</span><span class="token punctuation">,</span>
                                              request<span class="token punctuation">,</span>
                                              <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> response


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle_500</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> aiohttp_jinja2<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">'500.html'</span><span class="token punctuation">,</span>
                                              request<span class="token punctuation">,</span>
                                              <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> response
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/python/spider/Selenium记录.html" class="prev">
        Selenium万能的自动化爬虫
      </a></span> <span class="next"><a href="/python/spider/爬虫面试案例.html">
        爬虫面试案例
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.51f2f156.js" defer></script><script src="/assets/js/2.8911ec45.js" defer></script><script src="/assets/js/109.e82166f3.js" defer></script>
  </body>
</html>
