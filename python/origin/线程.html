<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>线程 | 独角兕大王</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.ccac5a78.css" as="style"><link rel="preload" href="/assets/js/app.51f2f156.js" as="script"><link rel="preload" href="/assets/js/2.8911ec45.js" as="script"><link rel="preload" href="/assets/js/96.b59cf9f4.js" as="script"><link rel="prefetch" href="/assets/js/10.6948c28b.js"><link rel="prefetch" href="/assets/js/100.276864ee.js"><link rel="prefetch" href="/assets/js/101.447ab1c7.js"><link rel="prefetch" href="/assets/js/102.f5b3c71d.js"><link rel="prefetch" href="/assets/js/103.16474d4b.js"><link rel="prefetch" href="/assets/js/104.ed58aef3.js"><link rel="prefetch" href="/assets/js/105.045203cd.js"><link rel="prefetch" href="/assets/js/106.be359e0b.js"><link rel="prefetch" href="/assets/js/107.7331bbca.js"><link rel="prefetch" href="/assets/js/108.76e1c800.js"><link rel="prefetch" href="/assets/js/109.e82166f3.js"><link rel="prefetch" href="/assets/js/11.d4ec37c8.js"><link rel="prefetch" href="/assets/js/110.4144755a.js"><link rel="prefetch" href="/assets/js/111.5864ab53.js"><link rel="prefetch" href="/assets/js/112.ca2aee84.js"><link rel="prefetch" href="/assets/js/113.641e7765.js"><link rel="prefetch" href="/assets/js/114.d69f8545.js"><link rel="prefetch" href="/assets/js/115.1b6a9f89.js"><link rel="prefetch" href="/assets/js/116.dde2c44e.js"><link rel="prefetch" href="/assets/js/117.4e79498c.js"><link rel="prefetch" href="/assets/js/12.7aac9c8d.js"><link rel="prefetch" href="/assets/js/13.abf127cd.js"><link rel="prefetch" href="/assets/js/14.aa4413a7.js"><link rel="prefetch" href="/assets/js/15.11a64e5b.js"><link rel="prefetch" href="/assets/js/16.f2d9a882.js"><link rel="prefetch" href="/assets/js/17.11c5bb7f.js"><link rel="prefetch" href="/assets/js/18.a522877b.js"><link rel="prefetch" href="/assets/js/19.6f31a972.js"><link rel="prefetch" href="/assets/js/20.b546c54e.js"><link rel="prefetch" href="/assets/js/21.6d055b7f.js"><link rel="prefetch" href="/assets/js/22.c48feceb.js"><link rel="prefetch" href="/assets/js/23.69941f78.js"><link rel="prefetch" href="/assets/js/24.6126dfc2.js"><link rel="prefetch" href="/assets/js/25.3475449c.js"><link rel="prefetch" href="/assets/js/26.96bb4643.js"><link rel="prefetch" href="/assets/js/27.da610e5d.js"><link rel="prefetch" href="/assets/js/28.b24ec15c.js"><link rel="prefetch" href="/assets/js/29.ec8af553.js"><link rel="prefetch" href="/assets/js/3.bec5f768.js"><link rel="prefetch" href="/assets/js/30.2e780db1.js"><link rel="prefetch" href="/assets/js/31.464c36ed.js"><link rel="prefetch" href="/assets/js/32.ad7d37c2.js"><link rel="prefetch" href="/assets/js/33.722f1ec5.js"><link rel="prefetch" href="/assets/js/34.8448d0fd.js"><link rel="prefetch" href="/assets/js/35.e5168ac9.js"><link rel="prefetch" href="/assets/js/36.edc404f1.js"><link rel="prefetch" href="/assets/js/37.5807602e.js"><link rel="prefetch" href="/assets/js/38.a519c89a.js"><link rel="prefetch" href="/assets/js/39.89af1b9a.js"><link rel="prefetch" href="/assets/js/4.5ed19beb.js"><link rel="prefetch" href="/assets/js/40.6c653db9.js"><link rel="prefetch" href="/assets/js/41.bc3b8b69.js"><link rel="prefetch" href="/assets/js/42.a0a02d9b.js"><link rel="prefetch" href="/assets/js/43.62f344e3.js"><link rel="prefetch" href="/assets/js/44.a7fd9d68.js"><link rel="prefetch" href="/assets/js/45.729c1c39.js"><link rel="prefetch" href="/assets/js/46.5b924aea.js"><link rel="prefetch" href="/assets/js/47.f3990404.js"><link rel="prefetch" href="/assets/js/48.f591f360.js"><link rel="prefetch" href="/assets/js/49.f7f213ad.js"><link rel="prefetch" href="/assets/js/5.2c5d28b5.js"><link rel="prefetch" href="/assets/js/50.b9ca2762.js"><link rel="prefetch" href="/assets/js/51.93672ee6.js"><link rel="prefetch" href="/assets/js/52.fb21314a.js"><link rel="prefetch" href="/assets/js/53.65343ccc.js"><link rel="prefetch" href="/assets/js/54.8081227d.js"><link rel="prefetch" href="/assets/js/55.e207659e.js"><link rel="prefetch" href="/assets/js/56.bde381df.js"><link rel="prefetch" href="/assets/js/57.f8eceb45.js"><link rel="prefetch" href="/assets/js/58.bef70bfd.js"><link rel="prefetch" href="/assets/js/59.7ab7562d.js"><link rel="prefetch" href="/assets/js/6.fc65a1ac.js"><link rel="prefetch" href="/assets/js/60.f40ac3ca.js"><link rel="prefetch" href="/assets/js/61.d2b463ab.js"><link rel="prefetch" href="/assets/js/62.cfdf1bcf.js"><link rel="prefetch" href="/assets/js/63.1e45ce59.js"><link rel="prefetch" href="/assets/js/64.a98fe86e.js"><link rel="prefetch" href="/assets/js/65.0234d7c5.js"><link rel="prefetch" href="/assets/js/66.724906f0.js"><link rel="prefetch" href="/assets/js/67.7806fda6.js"><link rel="prefetch" href="/assets/js/68.9f227dae.js"><link rel="prefetch" href="/assets/js/69.fdbc56ac.js"><link rel="prefetch" href="/assets/js/7.284de54e.js"><link rel="prefetch" href="/assets/js/70.04a9cc03.js"><link rel="prefetch" href="/assets/js/71.a6fa1dd9.js"><link rel="prefetch" href="/assets/js/72.2f8e3aa0.js"><link rel="prefetch" href="/assets/js/73.9bbb0cb6.js"><link rel="prefetch" href="/assets/js/74.9f122255.js"><link rel="prefetch" href="/assets/js/75.75e1fbd8.js"><link rel="prefetch" href="/assets/js/76.60ff3c3e.js"><link rel="prefetch" href="/assets/js/77.39a253ae.js"><link rel="prefetch" href="/assets/js/78.0e49712f.js"><link rel="prefetch" href="/assets/js/79.5f9c24a0.js"><link rel="prefetch" href="/assets/js/8.5c21a4cc.js"><link rel="prefetch" href="/assets/js/80.f826f188.js"><link rel="prefetch" href="/assets/js/81.b8995ea7.js"><link rel="prefetch" href="/assets/js/82.e9bf63e0.js"><link rel="prefetch" href="/assets/js/83.e3a00749.js"><link rel="prefetch" href="/assets/js/84.b940927c.js"><link rel="prefetch" href="/assets/js/85.ad46a9b2.js"><link rel="prefetch" href="/assets/js/86.190e0071.js"><link rel="prefetch" href="/assets/js/87.5f9eb9ef.js"><link rel="prefetch" href="/assets/js/88.cfaf7469.js"><link rel="prefetch" href="/assets/js/89.e64cc32c.js"><link rel="prefetch" href="/assets/js/9.0723805d.js"><link rel="prefetch" href="/assets/js/90.805edabe.js"><link rel="prefetch" href="/assets/js/91.6a1ab3f7.js"><link rel="prefetch" href="/assets/js/92.04ecd01e.js"><link rel="prefetch" href="/assets/js/93.e615470a.js"><link rel="prefetch" href="/assets/js/94.0ad7c41c.js"><link rel="prefetch" href="/assets/js/95.0e5ce618.js"><link rel="prefetch" href="/assets/js/97.2a327746.js"><link rel="prefetch" href="/assets/js/98.9c01ec88.js"><link rel="prefetch" href="/assets/js/99.952046bd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ccac5a78.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://github.com/fluidicon.png" alt="独角兕大王" class="logo"> <span class="site-name can-hide">独角兕大王</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/python/" class="nav-link router-link-active">
  Python
</a></div><div class="nav-item"><a href="/rust/" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/go/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/lua/" class="nav-link">
  Lua
</a></div><div class="nav-item"><a href="/C/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="https://github.com/wuyuz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/double-W/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cnblogs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/python/" class="nav-link router-link-active">
  Python
</a></div><div class="nav-item"><a href="/rust/" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/go/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/lua/" class="nav-link">
  Lua
</a></div><div class="nav-item"><a href="/C/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="https://github.com/wuyuz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/double-W/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cnblogs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python常用模块</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Python基础</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/python/origin/Python内置方法.html" class="sidebar-link">Python内置方法</a></li><li><a href="/python/origin/元类.html" class="sidebar-link">元类的深度理解</a></li><li><a href="/python/origin/函数部分.html" class="sidebar-link">函数</a></li><li><a href="/python/origin/数据类型.html" class="sidebar-link">数据类型</a></li><li><a href="/python/origin/面向对象.html" class="sidebar-link">面向对象</a></li><li><a href="/python/origin/模块和包.html" class="sidebar-link">模块和包</a></li><li><a href="/python/origin/网络基础.html" class="sidebar-link">网络基础</a></li><li><a href="/python/origin/正则表达式.html" class="sidebar-link">正则表达式</a></li><li><a href="/python/origin/异常处理.html" class="sidebar-link">异常处理</a></li><li><a href="/python/origin/TCP和UDP.html" class="sidebar-link">TCP和UDP</a></li><li><a href="/python/origin/线程.html" class="active sidebar-link">线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/origin/线程.html#线程" class="sidebar-link">线程</a></li><li class="sidebar-sub-header"><a href="/python/origin/线程.html#线程的特点" class="sidebar-link">线程的特点</a></li><li class="sidebar-sub-header"><a href="/python/origin/线程.html#全局解释器锁gil" class="sidebar-link">全局解释器锁GIL</a></li><li class="sidebar-sub-header"><a href="/python/origin/线程.html#threading模块" class="sidebar-link">Threading模块</a></li><li class="sidebar-sub-header"><a href="/python/origin/线程.html#信号量" class="sidebar-link">信号量</a></li><li class="sidebar-sub-header"><a href="/python/origin/线程.html#守护线程" class="sidebar-link">守护线程</a></li><li class="sidebar-sub-header"><a href="/python/origin/线程.html#互斥锁-同步锁" class="sidebar-link">互斥锁（同步锁）</a></li><li class="sidebar-sub-header"><a href="/python/origin/线程.html#gil锁-global-interpreter-lock" class="sidebar-link">GIL锁（Global Interpreter Lock)</a></li><li class="sidebar-sub-header"><a href="/python/origin/线程.html#线程队列" class="sidebar-link">线程队列</a></li><li class="sidebar-sub-header"><a href="/python/origin/线程.html#线程池、进程池-concurrent-futures" class="sidebar-link">线程池、进程池(concurrent.futures)</a></li><li class="sidebar-sub-header"><a href="/python/origin/线程.html#线程事件-event" class="sidebar-link">线程事件（Event)</a></li><li class="sidebar-sub-header"><a href="/python/origin/线程.html#条件变量" class="sidebar-link">条件变量</a></li><li class="sidebar-sub-header"><a href="/python/origin/线程.html#定时器" class="sidebar-link">定时器</a></li></ul></li><li><a href="/python/origin/multiprocessing（上）.html" class="sidebar-link">multiprocessing（上）</a></li><li><a href="/python/origin/multiprocessing（中）.html" class="sidebar-link">multiprocessing（中）</a></li><li><a href="/python/origin/multiprocessing（下）.html" class="sidebar-link">multiprocessing（下）</a></li><li><a href="/python/origin/协程.html" class="sidebar-link">协程</a></li><li><a href="/python/origin/IO多路复用.html" class="sidebar-link">IO 多路复用</a></li><li><a href="/python/origin/C3算法.html" class="sidebar-link">C3算法</a></li><li><a href="/python/origin/yield  from语法与协程.html" class="sidebar-link">yield  from语法与协程</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Django框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flask 框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python爬虫</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python设计模式</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="线程"><a href="#线程" class="header-anchor">#</a> 线程</h2> <ul><li><p><strong>进程</strong>：在已经了解了操作系统中进程的概念后,我们对进程有了一定的了解:</p> <ul><li>程序是不能单独运行,只有将程序装载到内存中,系统为它分配资源才能运行,这种执行的程序就称之为进程.</li> <li>程序和进程的区别就在于: 程序是指令的集合, 它是进程运行的静态描述文本; 进程是程序的一次执行活动,属于动态概念. 在多道编程中,我们允许多个程序同时加载到内存中,在操作系统的调度下,可以实现并发地执行，进程是计算机中最小的资源分配单位，线程是最小的执行单位</li> <li>这样的设计,大大他搞了CPU的利用率. 进程的出现让每个用户感觉到自己独享CPU,因此,进程就是为了在CPU上实现多道编程而提出的.</li></ul></li> <li><p><strong>有了进程为何还要线程?</strong></p></li> <li><p>(1)什么是线程?</p> <div class="language- extra-class"><pre><code> 	  a.线程指的是流水线式的工作过程,一个进程内最少自带一个线程,其实进程根本不能执行,进程不是执行单位,而是资源单位,分配资源的单位.线程才是执行单位.
</code></pre></div><p>(2)进程与线程的对比:</p> <p>a.同一个进程内的多个线程是共享该进程的资源的,不同进程内的线程资源是隔离的.</p> <p>b.创建线程对资源的消耗远远小于创建进程的消耗</p> <p>(3)进程有很多优点,它提供了多道编程,提高了计算机的利用率,让每个人感觉自己独享着CPU和其他资源.然而,进程也是有缺点的,主要体现在两点上:</p> <p>a.进程只能在同一时间执行一个任务,如果想要同时执行两个或多个任务,进程就无能为力了.</p> <p>b.进程在执行的过程中如果阻塞,例如等待输入,整个进程就会挂起,即使进程中有些工作不依赖于输入的数据,也将无法执行.</p></li> <li><p>线程的出现：</p> <ul><li><p>60年代,在OS中能拥有资源和独立运行的基本单位是进程,然而随着计算机技术的发展,进程出现了很多弊端,一是由于进程是资源拥有者,创建,撤销与切换存在较大的时空开销,因此需要引入轻型进程;二是由于对称多处理机(SMP)出现,可以满足多个运行单位,而多个进程运行开销过大.</p></li> <li><p>因此,在80年代,出现了能独立运行的基本单位--线程(Threads).</p></li> <li><p>需要注意的是: 进程是资源分配的最小单位,线程是CPU调度的最小单位.每个进程中至少有一个线程.</p></li> <li><p>在传统操作系统中,每个进程有一个地址空间,而且默认就有一个控制线程.我们可以把一个车间的工作过程看作是一个进程,把一条流水线工作的过程看作是一个线程.车间不仅要负责把资源整合到一起,而且一个车间内至少要有一条流水线.</p> <p>所以总结来说: 进程只是用来把资源集中到一起(进程只是一个资源单位,或者说资源集合),而线程才是CPU上的执行单位.</p> <p>多线程的概念是: 在一个进程中存在多个控制线程,多个控制线程共享该进程的地址空间.</p></li></ul></li> <li><p><strong>线程和进程的关系</strong></p> <ul><li><p><strong>线程与进程的区别</strong>可归纳为以下4点:</p> <ol><li><p>地址空间和其他资源(如打开文件): 进程间相互独立,同一进程的各线程间共享. 某进程内的线程在其他进程不可见.</p></li> <li><p>通信: 进程间通信IPC,线程间可以直接读写进程数据段(如全局变量)来进行通信----需要进程同步和互斥手段的辅助,以保证数据的一致性(类似于进程中的锁的作用).</p></li> <li><p>调度和切换: 线程上下文切换比进程上下文切换要快得多.</p></li> <li><p>在多线程操作系统中,进程不是一个可执行的实体,真正去执行程序的不是进程,而是线程.可以理解为进程就是一个线程的容器.</p> <div class="language- extra-class"><pre class="language-text"><code>并发 :同一时刻能同时接收多个客户端的请求
线程
    轻型进程 轻量级的进程
    在同一个进程中的多个线程是可以共享一部分数据的
    线程的开启\销毁\切换都比进程要高效很多

1.多个进程可不可以利用多核(多个CPU) 可以
2.多个线程可不可以利用多核(多个CPU) 可以
多进程和多线程之间的区别
    进程 数据隔离 开销大
    线程 数据共享 开销小
    
python当中的多线程
    不能访问多个cpu
    是Cpython解释器导致的,GIL锁
    GIL锁 = 全局解释器锁,导致了同一时刻只能有一个线程访问CPU
    jpython pypy解释器中的多线程是可以访问多核的
</code></pre></div></li></ol></li></ul></li></ul> <h2 id="线程的特点"><a href="#线程的特点" class="header-anchor">#</a> 线程的特点</h2> <ul><li><p>在多线程的操作系统中,通常是在一个进程中包括多个线程,每个线程都是作为利用CPU的基本单位,是花费最小开销的实体. 线程具有以下属性:</p> <ul><li><p><strong>1. 轻型实体</strong>：线程中的实体基本上不拥有系统资源,只是有一些必不可少的,能保证独立运行的资源，线程的实体包括程序,数据和TCB.线程是动态概念,它的动态特性有线程控制块TCB(Thread Control Block)描述。</p> <div class="language- extra-class"><pre class="language-text"><code>#TCB包括以下信息:
(1)线程状态.
(2)当线程不运行时,被保存的现场资源.
(3)一组执行堆栈.
(4)存放每个线程的局部变量主存区.
(5)访问同一个进程中的主存和其它资源.
用于指示被执行指令序列的程序计数器、保留局部变量、少数状态参数和返回地址等的一组寄存器和堆栈.
</code></pre></div></li> <li><p><strong>2. 独立调度和分派的基本单位</strong>：在多线程OS中,线程是能独立运行的基本单位,因而也是独立调度和分派的基本单位.由于线程很“轻”,故线程的切换非常迅速且开销小(在同一进程中的线程).</p></li> <li><p><strong>3. 共享进程资源</strong>：线程在同一进程中的各个线程, 都可以共享该进程所拥有的资源, 这首先表现在: 所有线程都具有相同的进程id, 这意味着, 线程可以访问该进程的每一个内存资源; 此外, 还可以访问进程所拥有的已打开文件、定时器、信号量机构等. 由于同一个进程内的线程共享内存和文件, 所以线程之间互相通信不必调用内核</p></li> <li><p><strong>可并发执行</strong>：在一个进程中的多个线程之间, 可以并发执行, 甚至允许在一个进程中所有线程都能并发执行; 同样, 不同进程中的线程也能并发执行, 充分利用和发挥了处理机与外围设备并行工作的能力.</p></li></ul></li></ul> <h2 id="全局解释器锁gil"><a href="#全局解释器锁gil" class="header-anchor">#</a> 全局解释器锁GIL</h2> <ul><li><p>Python代码的执行由Python虚拟机(也叫解释器主循环)来控制. Pyhton在设计之初就考虑到: 在主循环中同时只有一个线程在执行. 虽然Python解释器中可以&quot;运行&quot;多个线程,但在任意时刻只有一个线程在解释器中运行. 对Python虚拟机的访问由全局解释器锁(GIL)来控制,正是这个锁能保证同一时刻只有一个线程在运行.在多线程环境中,Python虚拟机按以下方式执行:(Python虚拟机就像个容器，然后一个个的把线程给进程)</p> <p>a. 设置GIL</p> <p>b. 切换到一个线程去执行</p> <p>c. 运行指定数量的字节码指令或者线程主动让出控制(可以调用time.sleep(0))</p> <p>d. 把线程设置为睡眠状态</p> <p>e. 解锁GIL</p> <p>f. 再次重复以上所有步骤</p> <p>在调用外部代码(如C/C++扩展函数)的时候,GIL将会被锁定,直到这个函数结束为止(由于在这期间没有Python的字节码被运行,所以不会做线程切换)<code>编写扩展的程序员可以主动解锁GIL.</code></p></li> <li><p>Python线程模块的选择</p> <ul><li><p>Pyhton提供了几个用于多线程编程的模块,包括thread,threading和Queue等. thread和threading模块允许程序员创建和管理线程. thread模块提供了基本的线程和锁的支持,threading提供了更高级别,功能更强的线程管理的功能. Queue模块允许用户创建一个可以用于多个线程之间共享数据的队列数据结构.</p> <p>避免使用thread模块,因为更高级别的threading模块更为先进,对线程的支持更为完善,而且使用thread模块里的属性有可能会与threading出现冲突; 其次低级别的thread模块的同步原语很少(实际上只有一个),而threading模块则有很多;再者,thread模块中当主线程序结束时,所有的线程都会被强制结束掉,没有警告也没有正常的清除工作,至少threading模块能确保重要的子线程退出后程序才退出.</p> <p>就像我们熟悉的time模块,它比其他模块更接近底层,越是接近底层,用起来也越麻烦,就像时间日期转换之类的就比较麻烦,但是后面我们学到一个datetime模块,提供了更为简便的时间日期处理方法,它是建立在time模块的基础上来的. 又如socket和socketserver(底层还是用的socket)等等,这里的threading就是thread的高级模块.</p> <p>thread模块不支持守护进程,当主线程退出时,所有的子线程不论它们是否还在工作,都会被强行退出.而threading模块支持守护进程,守护进程一般是一个等待客户请求的服务器,如果没有客户提出请求它就会在那里等待,如果设定一个线程为守护线程,就表示这个线程是不重要的,在进程退出的时候,不用等待这个线程退出.</p></li></ul></li></ul> <h2 id="threading模块"><a href="#threading模块" class="header-anchor">#</a> Threading模块</h2> <ul><li><p>multiprocess模块完全模仿了threading模块的接口,二者在使用层面有很大的相似性.</p> <ul><li><p>线程创建的两种方式（类似于进程multiprocessing模块的使用）</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#方式一</span>
<span class="token keyword">import</span> time
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread    <span class="token comment"># 引入线程模块</span>
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 自定义一个函数</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;hello,world&quot;</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 创建线程对象</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 开启线程</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主线程结束&quot;</span><span class="token punctuation">)</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment">#方式二</span>
<span class="token keyword">import</span> time
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread    <span class="token comment"># 引入线程模块</span>
<span class="token keyword">class</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 自定义一个类</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 传参n</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 自己想要传参,必须先super()执行父类的init方法,再写自己的实例变量</span>
        self<span class="token punctuation">.</span>n <span class="token operator">=</span> n
        
    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 自定义一个run()方法,内容不定,但是run名称不能变，必须写</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>n<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> MyThread<span class="token punctuation">(</span><span class="token string">&quot;hello,world&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 创建线程对象</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 开启线程</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主线程结束&quot;</span><span class="token punctuation">)</span>
    
Thread实例对象的方法
  <span class="token comment"># isAlive(): 返回线程是否活动的。</span>
  <span class="token comment"># getName(): 返回线程名。</span>
  <span class="token comment"># setName(): 设置线程名。</span>

threading模块提供的一些方法：
  <span class="token comment"># threading.currentThread(): 返回当前的线程变量。</span>
  <span class="token comment"># threading.enumerate(): 返回一个包含正在运行的线程的list。正在运行指线程启动后、结束前，不包括启动前和终止后的线程。</span>
  <span class="token comment"># threading.activeCount(): 返回正在运行的线程数量，与len(threading.enumerate())有相同的结果。   </span>

 <span class="token comment"># 使用类的方式调用函数      </span>
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token keyword">import</span> time
<span class="token keyword">import</span> os

<span class="token keyword">def</span> <span class="token function">fun</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'oj'</span><span class="token punctuation">,</span>a<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>getppid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 打印是否进入子线程</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    
<span class="token keyword">class</span> <span class="token class-name">Mythread</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>func<span class="token punctuation">,</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment">#传递参数</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>func <span class="token operator">=</span> func
        self<span class="token punctuation">.</span>a <span class="token operator">=</span> a
        
    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>     <span class="token comment"># start必须执行的函数，把传进来的函数在此调用，要是没有run，什么都不会执行</span>
        self<span class="token punctuation">.</span>func<span class="token punctuation">(</span>self<span class="token punctuation">.</span>a<span class="token punctuation">)</span>
        
t <span class="token operator">=</span> Mythread<span class="token punctuation">(</span>fun<span class="token punctuation">,</span><span class="token string">'66'</span><span class="token punctuation">)</span>
t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 结果</span>
<span class="token comment"># oj 66</span>
<span class="token comment"># 7836 2504 </span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment">#判断线程的存活</span>
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
 
t <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">)</span>
t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
t<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 返回线程是否是活动的，</span>
    <span class="token comment">#结果</span>
    <span class="token comment">#123</span>
    <span class="token comment">#False</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>    
<span class="token keyword">import</span> time
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
 
t <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">)</span>
t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#结果</span>
    <span class="token comment">#True</span>
    <span class="token comment">#123</span>
    
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment">#设置修改线程名</span>
<span class="token keyword">import</span> time
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
t <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">)</span>
t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 返回线程是否活动的</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#返回线程名</span>
t<span class="token punctuation">.</span>setName<span class="token punctuation">(</span><span class="token string">'t1'</span><span class="token punctuation">)</span>  <span class="token comment"># 设置线程名</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#执行输出：</span>
    <span class="token comment">#True</span>
    <span class="token comment">#Thread-1</span>
    <span class="token comment">#t1</span>
    <span class="token comment">#123</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment">#输出现有存活线程</span>
<span class="token keyword">import</span> time
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread<span class="token punctuation">,</span>currentThread<span class="token punctuation">,</span><span class="token builtin">enumerate</span><span class="token punctuation">,</span>activeCount
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
    <span class="token comment">#print(123)</span>
 
t <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">)</span>
t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>currentThread<span class="token punctuation">)</span>  <span class="token comment"># 返回当前的线程变量，这个不需要调用</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#返回一个包含正在运行的线程的list</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>activeCount<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 返回正在运行的线程数量</span>

<span class="token comment">#结果</span>
<span class="token operator">&lt;</span>function current_thread at <span class="token number">0x000001C35EF6A268</span><span class="token operator">&gt;</span>
<span class="token punctuation">[</span><span class="token operator">&lt;</span>_MainThread<span class="token punctuation">(</span>MainThread<span class="token punctuation">,</span> started <span class="token number">20008</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Thread<span class="token punctuation">(</span>Thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> started <span class="token number">20232</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token number">2</span>
MainThread<span class="token punctuation">,</span> started <span class="token number">20008</span>表示主线程，Thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> started <span class="token number">20232</span>表示子线程。它会打印出<span class="token number">2</span>个。
所以activeCount的结果为<span class="token number">2</span>
</code></pre></div></li> <li><p><strong>进程与线程开启效率比较</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> time
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process

<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">sum</span> <span class="token operator">+=</span> i

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    t_start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#开始时间</span>
    t_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        t <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        t_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token punctuation">[</span>tt<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> tt <span class="token keyword">in</span> t_list<span class="token punctuation">]</span>  <span class="token comment">#等待所有的进程结束，阻塞</span>
    t_end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">#结束时间</span>
    t_dif_time <span class="token operator">=</span> t_end_time <span class="token operator">-</span> t_start_time  <span class="token comment">#时间差</span>

    p_start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#开始时间</span>
    p_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> ii <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        p_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token punctuation">[</span>pp<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p_list<span class="token punctuation">]</span>  <span class="token comment">#等待所线程结束</span>
    p_end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">#结束时间</span>
    p_dif_time <span class="token operator">=</span> p_end_time <span class="token operator">-</span> p_start_time  <span class="token comment">#时间差</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;线程的执行时间是&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> t_dif_time<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;进程的执行时间是&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> p_dif_time<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主线程结束&quot;</span><span class="token punctuation">)</span>

<span class="token comment"># 执行结果:</span>
<span class="token comment"># 线程的执行时间是&gt;&gt;&gt; 0.0010013580322265625</span>
<span class="token comment"># 进程的执行时间是&gt;&gt;&gt; 0.37227368354797363</span>
<span class="token comment"># 主线程结束，</span>
<span class="token comment">#从上面代码的结果中可以看出: 执行同一个任务,线程的执行时间远远小于进程的执行时间.因此,线程的效率是比较高的.</span>
</code></pre></div></li> <li><p><strong>同一进程下线程是资源共享的</strong></p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
tn <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> tn
    tn <span class="token operator">+=</span> <span class="token number">1</span>
t_l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t_l<span class="token punctuation">.</span>append<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
<span class="token keyword">for</span> t <span class="token keyword">in</span> t_l<span class="token punctuation">:</span>t<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>tn<span class="token punctuation">)</span>  <span class="token comment">#100</span>

<span class="token comment">#但是进程之间的数据是隔离的</span>
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
pn <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> pn
    pn <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    p_l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        p_l<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token keyword">for</span> p <span class="token keyword">in</span> p_l<span class="token punctuation">:</span>p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>pn<span class="token punctuation">)</span>    <span class="token comment">#0  因为所有的子进程并没有操作主进程的pn</span>
</code></pre></div><ul><li><p><strong>线程共享数据时,数据是不安全的</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#数据共享时数据不安全</span>
<span class="token keyword">import</span> time
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
num <span class="token operator">=</span> <span class="token number">100</span>   <span class="token comment">#全局变量</span>
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> num
    <span class="token comment"># 模拟num-=1的&quot;取值-&gt;计算-&gt;赋值&quot;过程</span>
    mid <span class="token operator">=</span> num       <span class="token comment">#取值</span>
    mid <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span>   <span class="token comment">#计算</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.0001</span><span class="token punctuation">)</span>
    num <span class="token operator">=</span> mid       <span class="token comment">#赋值</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    t_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#创建10个子线程</span>
        t <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span><span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        t_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token punctuation">[</span>tt<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> tt <span class="token keyword">in</span> t_list<span class="token punctuation">]</span>    <span class="token comment"># 主线程等待子线程执行结束</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'主线程结束,此时全局变量为&gt;&gt;&gt;'</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span>
<span class="token comment"># 执行结果:</span>
<span class="token comment"># 主线程结束,此时全局变量为&gt;&gt;&gt; 99</span>

<span class="token comment">#通过引入线程模块里的锁来解决不安全问题</span>
</code></pre></div></li></ul></li> <li><p>线程中的其他方法</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#currentTread 当前线程的属性，不要忘了，主进程也有个主线程</span>
<span class="token keyword">import</span> os
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread<span class="token punctuation">,</span>currentThread
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>name<span class="token punctuation">,</span>t<span class="token punctuation">.</span>ident<span class="token punctuation">,</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#Thread-1 2940 10716</span>

tobj <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">)</span>
tobj<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'tobj :'</span><span class="token punctuation">,</span>tobj<span class="token punctuation">)</span>   <span class="token comment">#tobj : &lt;Thread(Thread-1, started 2940)&gt;</span>
t2 <span class="token operator">=</span> currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span>name<span class="token punctuation">,</span>t2<span class="token punctuation">.</span>ident<span class="token punctuation">,</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">#MainThread 12360 10716</span>

<span class="token comment">#例，# lst = [1,2,3,4,5,6,7,8,9,10]按照顺序把列表中的每一个元素都计算一个平方，使用多线程的方式，并且将结果按照顺序返回</span>
<span class="token keyword">import</span> time
<span class="token keyword">import</span> random
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread<span class="token punctuation">,</span>currentThread
dic <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    dic<span class="token punctuation">[</span>t<span class="token punctuation">.</span>ident<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token operator">**</span><span class="token number">2</span>
t_lst <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t_lst<span class="token punctuation">.</span>append<span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token comment">#按照顺序加进去</span>
<span class="token keyword">for</span> t <span class="token keyword">in</span> t_lst<span class="token punctuation">:</span>
    t<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>dic<span class="token punctuation">[</span>t<span class="token punctuation">.</span>ident<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">#根据进程号来取</span>
    
<span class="token comment">#面试题   </span>
<span class="token keyword">from</span> threading <span class="token keyword">import</span> active_count   <span class="token comment"># 返回当前有多少个正在工作的线程</span>
<span class="token keyword">import</span> time
<span class="token keyword">import</span> random
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread<span class="token punctuation">,</span>currentThread
dic <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    dic<span class="token punctuation">[</span>t<span class="token punctuation">.</span>ident<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token operator">**</span><span class="token number">2</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 此时主线程已经下去了</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>active_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># ??? 结果1，因为主线程也算一个</span>

<span class="token comment">#线程有terminate么?</span>
   <span class="token comment">#没有terminate 不能强制结束</span>
   <span class="token comment">#所有的子线程都会在执行完所有的任务之后自动结束</span>
</code></pre></div></li> <li><p>线程（threading)的一些其他方法总结：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;子线程对象&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>               <span class="token comment"># 子线程对象</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;子线程名称&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment"># 子线程名称</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;子线程ID&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> threading<span class="token punctuation">.</span>get_ident<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                      <span class="token comment"># 子线程ID</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>work<span class="token punctuation">)</span>     <span class="token comment"># 创建子线程</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>                   <span class="token comment"># 开启子线程</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主线程对象&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>           <span class="token comment"># 主线程对象</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主线程名称&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 主线程名称</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主线程ID&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ident<span class="token punctuation">)</span>       <span class="token comment"># 主线程ID</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主线程ID&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> threading<span class="token punctuation">.</span>get_ident<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token comment"># 主线程ID</span>

    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                   <span class="token comment"># 阻塞住,此时主线程代码运行的同时子线程代码也在运行</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span><span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 拿到所有正在运行的线程对象(包括主线程)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>active_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 拿到所有正在运行的线程对象的数量</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主线程/主进程执行完毕&quot;</span><span class="token punctuation">)</span>

</code></pre></div></li> <li><h5 id="多线程的其他用法"><a href="#多线程的其他用法" class="header-anchor">#</a> 多线程的其他用法</h5> <div class="language-python extra-class"><pre class="language-python"><code> <span class="token comment">#threading.local()这个方法的特点用来保存一个全局变量，但是这个全局变量只有在当前线程才能访问，如果你在开发多线程应用的时候  需要每个线程保存一个单独的数据供当前线程操作，可以考虑使用这个方法，简单有效。举例：每个子线程使用全局对象a，但每个线程定义的属性a.xx是该线程独有的，Python提供了 threading.local 类，将这个类实例化得到一个全局对象，但是不同的线程使用这个对象存储的数据其它线程不可见(本质上就是不同的线程使用这个对象时为其创建一个独立的字典)。</span>

代码示例
<span class="token keyword">import</span> time
<span class="token keyword">import</span> threading
v <span class="token operator">=</span> threading<span class="token punctuation">.</span>local<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 内部会为当前线程创建一个空间用于存储：phone=自己的值</span>
    v<span class="token punctuation">.</span>phone <span class="token operator">=</span> arg<span class="token operator">**</span><span class="token number">2</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>phone<span class="token punctuation">,</span>arg<span class="token punctuation">)</span> <span class="token comment"># 去当前线程自己空间取值</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>   

<span class="token number">4</span> <span class="token number">2</span>
<span class="token number">0</span> <span class="token number">0</span>
<span class="token number">1</span> <span class="token number">1</span>
<span class="token number">49</span> <span class="token number">7</span>
<span class="token number">9</span> <span class="token number">3</span>  ……

<span class="token comment">#作用：内部自动为每个线程维护一个空间（字典），用于当前存取属于自己的值。保证线程之间的数据隔离。在Flask的上下文管理中就是依靠它实现</span>
<span class="token punctuation">{</span>
    线程ID<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    线程ID<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    线程ID<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    线程ID<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">#拓展</span>
<span class="token keyword">import</span> time
<span class="token keyword">import</span> threading
INFO <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Local</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ident <span class="token operator">=</span> threading<span class="token punctuation">.</span>get_ident<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> INFO<span class="token punctuation">[</span>ident<span class="token punctuation">]</span><span class="token punctuation">[</span>item<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">__setattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ident <span class="token operator">=</span> threading<span class="token punctuation">.</span>get_ident<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> ident <span class="token keyword">in</span> INFO<span class="token punctuation">:</span>
            INFO<span class="token punctuation">[</span>ident<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            INFO<span class="token punctuation">[</span>ident<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>key<span class="token punctuation">:</span> value<span class="token punctuation">}</span>

<span class="token comment">#实例化</span>
obj <span class="token operator">=</span> Local<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 调用对象的 __setattr__方法（“phone”,1）</span>
    obj<span class="token punctuation">.</span>phone <span class="token operator">=</span> arg
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>phone<span class="token punctuation">,</span> arg<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 效果类似</span>
</code></pre></div></li></ul> <h2 id="信号量"><a href="#信号量" class="header-anchor">#</a> 信号量</h2> <ul><li><p>同进程的一样, Semaphore管理一个内置的计数器:</p> <p>每当调用acquire()时内置计数器-1;</p> <p>调用release()时内置计数器+1;</p> <p>计数器不能小于0;当计数器为0时, acquire()将阻塞线程直到其他线程调用release().</p> <div class="language-python extra-class"><pre class="language-python"><code>互斥锁同时只允许一个线程更改数据，而信号量Semaphore是同时允许一定数量的线程更改数据 。
假设商场里有<span class="token number">4</span>个迷你唱吧，所以同时可以进去<span class="token number">4</span>个人，如果来了第五个人就要在外面等待，等到有人出来才能再进去玩。
实现：
信号量同步基于内部计数器，每调用一次acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>，计数器减<span class="token number">1</span>；每调用一次release<span class="token punctuation">(</span><span class="token punctuation">)</span>，计数器加<span class="token number">1</span><span class="token punctuation">.</span>当计数器为<span class="token number">0</span>时，acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>调用被阻塞。这是迪科斯彻（Dijkstra）信号量概念P<span class="token punctuation">(</span><span class="token punctuation">)</span>和V<span class="token punctuation">(</span><span class="token punctuation">)</span>的Python实现。信号量同步机制适用于访问像服务器这样的有限资源。信号量与进程池的概念很像，但是要区分开，信号量涉及到加锁的概念

<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread<span class="token punctuation">,</span>Semaphore
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> time
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> sm<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 加锁</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; get semaphore&quot;</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        sm<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 解锁</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    sm <span class="token operator">=</span> Semaphore<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>   <span class="token comment"># 创建信号量对象,限制锁内每次只能进入5个线程</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 创建25个线程</span>
        t <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span><span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
<span class="token comment">#与进程池是完全不同的概念，进程池Pool(4)，最大只能产生4个进程，而且从头到尾都只是这四个进程，不会产生新的，而信号量是产生一堆线程/进程，semaphore 允许同一时刻n个线程执行这段代码</span>
</code></pre></div></li></ul> <h2 id="守护线程"><a href="#守护线程" class="header-anchor">#</a> 守护线程</h2> <ul><li><p>无论是进程还是线程,都遵循: 守护进程(线程)会等待主进程(线程)运行完毕后被销毁. 需要强调的是: 运行完毕并非终止运行</p> <div class="language- extra-class"><pre class="language-text"><code>#1. 对于主进程来说,运行完毕指的是主进程代码运行完毕，很好理解守护进程其实是依赖于主进程的，那么子进程也可以理解为一堆线程的集合体，那么主进程的代码结束，必须同时对子进程的资源进行回收，所以守护进程必须在主进程代码结束时结束
#2. 对于主线程来说,运行完毕指的是主线程所在的进程内所有非守护线程全部执行完毕,主线程才算运行完毕.守护线程完全可以最后一个消失
解析：
	1. 主进程在其代码结束后就已经算运行完毕了(守护进程在此时就被回收),然后主进程会一直等非守护的子进程都运行完毕后回收子进程的资源(否则会产生僵尸进程),才会结束.
	2. 主线程在其他非守护线程运行完毕后才算运行完毕(守护线程在此时就被回收). 因为主线程的结束意味着进程的结束,进程整体的资源都将被回收,而进程必须保证非守护线程都运行完毕后才能结束,因为进程执行结束是要回收资源的.
</code></pre></div></li> <li><p>实力证明</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> time
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token keyword">def</span> <span class="token function">func1</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">func2</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    t1 <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func1<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;我是子线程1号&quot;</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    t1<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>    <span class="token comment">#设置守护线程，守护线程会随着其他所有非守护线程的结束而结束</span>
    t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t2 <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func2<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;我是子线程2号&quot;</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主线程结束&quot;</span><span class="token punctuation">)</span>

<span class="token comment"># 执行结果:  显然守护线程还没执行，全部线程结束，所以被动结束</span>
<span class="token comment"># 主线程结束</span>
<span class="token comment"># 我是子线程2号   </span>

<span class="token keyword">import</span> time
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token keyword">def</span> <span class="token function">func1</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">func2</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    t1 <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func1<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;我是子线程1号&quot;</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    t1<span class="token punctuation">.</span>deamon <span class="token operator">=</span> <span class="token boolean">True</span>    <span class="token comment"># 设置守护线程,必须放到start前面</span>
    t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t2 <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func2<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;我是子线程2号&quot;</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主线程结束&quot;</span><span class="token punctuation">)</span>

<span class="token comment"># 执行结果:</span>
<span class="token comment"># 主线程结束</span>
<span class="token comment"># 我是子线程1号</span>
<span class="token comment"># 我是子线程2号</span>
<span class="token comment">#对比两个例子的执行结果,可以看出,主线程等待所有非守护线程的结束才结束.当主线程的代码运行结束后,还要等待非守护线程执行完毕,在这个等待的过程中,守护线程并没有消亡,还在继续执行.</span>
</code></pre></div></li> <li><p><strong>对比守护进程和守护线程</strong>：</p> <ul><li><strong>守护进程</strong>: 主进程的代码执行完毕后,整个程序并没有结束,且主进程仍然存在着,因为主进程要等待其它子进程执行完毕,回收子进程的残余资源(为子进程收尸).总之,主**<u>进程的代码执行完毕后守护进程也跟着结束</u>**----守护进程随着主进程的消亡而消亡.</li> <li><strong>守护线程</strong>: 主线程的代码执行完毕后,整个程序并没有结束,且主线程仍然存在着,因为主线程要等待所有非守护线程执行完毕,随后,当所有线程全部执行完毕后,主线程结束,这也意味着主进程的结束,最后主进程回收所有资源.总之,<u><strong>主线程的代码执行完毕后要等待非守护线程执行完毕</strong></u>,在这个等待过程中,守护进程没有消亡,直到等待结束,随主线程的消亡而消亡.</li></ul></li></ul> <h2 id="互斥锁-同步锁"><a href="#互斥锁-同步锁" class="header-anchor">#</a> 互斥锁（同步锁）</h2> <ul><li><p>互斥锁: 在同一个线程中,不能连续acquire多次,并且可以做到多个线程中被锁的代码同时只有一个线程执行</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#1.线程抢的是GIL锁,GIL锁相当于执行权限,拿到执行权限后才能拿到互斥锁Lock,其他线程也可以抢到GIL,但如果发现Lock仍然没有被释放则阻塞,即便是拿到执行权限GIL也要立刻交出来</span>

<span class="token comment">#2.join是等待所有,即整体串行,而锁只是锁住修改共享数据的部分,即部分串行,要想保证数据安全的根本原理在于让并发变成串行,join与互斥锁都可以实现,毫无疑问,互斥锁的部分串行效率要更高</span>
<span class="token keyword">import</span> time
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> n
    temp <span class="token operator">=</span> n
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> temp <span class="token operator">-</span><span class="token number">1</span>
 
n <span class="token operator">=</span> <span class="token number">100</span>
t_lst <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t_lst<span class="token punctuation">.</span>append<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
<span class="token keyword">for</span> t <span class="token keyword">in</span> t_lst<span class="token punctuation">:</span>t<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>   <span class="token comment">#99，因为多个线程抢夺同一个资源，没有秩序</span>

<span class="token comment">#其实只要去掉赋值这个过程，直接每个进程在原有的数据上进行修改就不会出现问题，（不用枷锁）</span>
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> n
    n <span class="token operator">-=</span> <span class="token number">1</span>
 
n <span class="token operator">=</span> <span class="token number">100</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
</code></pre></div><p>原因很简单，因为异步执行所有线程，几乎同时对全局的n进行操作，换句话说100可线程都取到n=100，得到的结果也都是99，所以造成了数据不安全。</p></li> <li><h4 id="死锁现象-是指两个或两个以上的进程或线程在执行过程中-因争夺资源而造成的一种互相等待的现象-若无外力作用-它们都将无法推进下去。此时称系统处于死锁状态或系统产生了死锁-这些永远在互相等待的进程称为死锁进程-如下就是死锁。只要实例化多把锁-并交替使用-都有可能产生死锁现象"><a href="#死锁现象-是指两个或两个以上的进程或线程在执行过程中-因争夺资源而造成的一种互相等待的现象-若无外力作用-它们都将无法推进下去。此时称系统处于死锁状态或系统产生了死锁-这些永远在互相等待的进程称为死锁进程-如下就是死锁。只要实例化多把锁-并交替使用-都有可能产生死锁现象" class="header-anchor">#</a> 死锁现象： 是指两个或两个以上的进程或线程在执行过程中，因争夺资源而造成的一种互相等待的现象，若无外力作用，它们都将无法推进下去。此时称系统处于死锁状态或系统产生了死锁，这些永远在互相等待的进程称为死锁进程，如下就是死锁。<u>只要实例化多把锁,并交替使用,都有可能产生死锁现象</u></h4> <ul><li>只要是1把锁,递归锁永远不死锁</li> <li>只要是2以及以上,交替使用（递归锁也会）</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> threading <span class="token keyword">import</span> Lock
lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 在同一个线程中,能够被一个锁的多个acquire阻住,这种锁就叫做互斥锁</span>
lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 锁被拿走</span>
lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  
lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#科学家吃面问题：要完成一件事情 需要两个必要因素，要想吃到面，需要： 叉子，面。资源的互相抢占的问题 —— 死锁</span>
<span class="token keyword">import</span> time
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread<span class="token punctuation">,</span>Lock
noodle_lock<span class="token operator">=</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
fork_lock<span class="token operator">=</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">eat1</span><span class="token punctuation">(</span>noodle_lock<span class="token punctuation">,</span>fork_lock<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 吃面</span>
    noodle_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 面条加锁</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 抢到了面条'</span><span class="token operator">%</span>name<span class="token punctuation">)</span>
    fork_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 叉子加锁</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 抢到了叉子'</span><span class="token operator">%</span>name<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 正在吃面'</span><span class="token operator">%</span>name<span class="token punctuation">)</span>
    fork_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 叉子解锁</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s归还了叉子'</span><span class="token operator">%</span>name<span class="token punctuation">)</span>
    noodle_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 面条解锁</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s归还了面条'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
 
<span class="token keyword">def</span> <span class="token function">eat2</span><span class="token punctuation">(</span>noodle_lock<span class="token punctuation">,</span>fork_lock<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">#也是吃面，不同的是：先抢叉子，再抢面</span>
    fork_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s抢到了叉子'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    noodle_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s抢到了面'</span><span class="token operator">%</span>name<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s正在吃面'</span><span class="token operator">%</span>name<span class="token punctuation">)</span>
    noodle_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s归还了面'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
    fork_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s归还了叉子'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
 
noodle_lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 面条锁</span>
fork_lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 叉子锁</span>
t1 <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>eat1<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>noodle_lock<span class="token punctuation">,</span>fork_lock<span class="token punctuation">,</span><span class="token string">'nazha'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 最开始他有很大几率得到两把钥匙</span>
t2 <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>eat2<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>noodle_lock<span class="token punctuation">,</span>fork_lock<span class="token punctuation">,</span><span class="token string">'egon'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#他要叉，一有就拿走</span>
t3 <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>eat1<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>noodle_lock<span class="token punctuation">,</span>fork_lock<span class="token punctuation">,</span><span class="token string">'yuan'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#他要面，一有就拿走，两两卡死</span>
t4 <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>eat2<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>noodle_lock<span class="token punctuation">,</span>fork_lock<span class="token punctuation">,</span><span class="token string">'alex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h4 id="递归锁-互斥锁的解决办法"><a href="#递归锁-互斥锁的解决办法" class="header-anchor">#</a> 递归锁（互斥锁的解决办法）</h4> <ul><li><p>在Python中为了支持在同一线程中多次请求同一资源，python提供了可重入锁RLock。这个RLock内部维护着一个Lock和一个counter变量，counter记录了acquire的次数，从而使得资源可以被多次require。直到一个线程所有的acquire都被release，其他的线程才能获得资源。</p></li> <li><p>从一定程度上可以避免死锁现象，使用递归锁也会产生死锁现象，也就是说在交叉使用锁时也会出现死锁</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#简单例子</span>
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread<span class="token punctuation">,</span>RLock
rlock <span class="token operator">=</span> RLock<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 创建递归锁</span>
rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 加第一个锁</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'***'</span><span class="token punctuation">)</span>
rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 加第二个锁</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'***'</span><span class="token punctuation">)</span>
<span class="token comment">#结果：</span>
<span class="token operator">**</span><span class="token operator">*</span>
<span class="token operator">**</span><span class="token operator">*</span>
<span class="token comment">#结论：递归锁在同一个线程中对同一个锁多次acquire不会产生阻塞</span>

<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread<span class="token punctuation">,</span>RLock
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>rlock<span class="token punctuation">,</span>flag<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 第一道锁</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span>
    rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 第二道锁</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>flag <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 第三道锁</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>flag <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 第四道锁</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>flag <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
 
rlock <span class="token operator">=</span> RLock<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 创建递归锁</span>
Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>rlock<span class="token punctuation">,</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 传入递归锁和*</span>
Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>rlock<span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#结果</span>
<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span>
<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span>
<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span>
<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span>  <span class="token comment"># 这里没有输出---------，因为线程进去了没有出来</span>

<span class="token comment">#解决办法</span>
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread<span class="token punctuation">,</span>RLock
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>rlock<span class="token punctuation">,</span>flag<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 第一道锁</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span>
    rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 第二道锁</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>flag <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 第三道锁</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>flag <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 第四道锁</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>flag <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    rlock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 解锁</span>
    rlock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    rlock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    rlock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
rlock <span class="token operator">=</span> RLock<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 创建递归锁</span>
Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>rlock<span class="token punctuation">,</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>rlock<span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#使用递归锁解决科学家吃面问题</span>
<span class="token keyword">import</span> time
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread<span class="token punctuation">,</span>RLock 
<span class="token keyword">def</span> <span class="token function">eat1</span><span class="token punctuation">(</span>noodle_lock<span class="token punctuation">,</span>fork_lock<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 吃面</span>
    noodle_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 拿到面条的整串钥匙</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 抢到了面条'</span><span class="token operator">%</span>name<span class="token punctuation">)</span>
    fork_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 拿到叉子的整串钥匙</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 抢到了叉子'</span><span class="token operator">%</span>name<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 正在吃面'</span><span class="token operator">%</span>name<span class="token punctuation">)</span>
    fork_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 叉子解锁</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s归还了叉子'</span><span class="token operator">%</span>name<span class="token punctuation">)</span>
    noodle_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 面条解锁</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s归还了面条'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
 
<span class="token keyword">def</span> <span class="token function">eat2</span><span class="token punctuation">(</span>noodle_lock<span class="token punctuation">,</span>fork_lock<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">#也是吃面，不同的是：先抢叉子，再抢面</span>
    fork_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s抢到了叉子'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    noodle_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s抢到了面'</span><span class="token operator">%</span>name<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s正在吃面'</span><span class="token operator">%</span>name<span class="token punctuation">)</span>
    noodle_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s归还了面'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
    fork_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s归还了叉子'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
 
noodle_lock <span class="token operator">=</span> fork_lock <span class="token operator">=</span> RLock<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 面条锁和叉子锁，表示一串钥匙 </span>
t1 <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>eat1<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>noodle_lock<span class="token punctuation">,</span>fork_lock<span class="token punctuation">,</span><span class="token string">'nazha'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
t2 <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>eat2<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>noodle_lock<span class="token punctuation">,</span>fork_lock<span class="token punctuation">,</span><span class="token string">'egon'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
t3 <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>eat1<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>noodle_lock<span class="token punctuation">,</span>fork_lock<span class="token punctuation">,</span><span class="token string">'yuan'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
t4 <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>eat2<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>noodle_lock<span class="token punctuation">,</span>fork_lock<span class="token punctuation">,</span><span class="token string">'alex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <hr> <h2 id="gil锁-global-interpreter-lock"><a href="#gil锁-global-interpreter-lock" class="header-anchor">#</a> GIL锁（Global Interpreter Lock)</h2> <ul><li><p><strong>在Cpython解释器中，同一个进程下开启的多线程，同一时刻只能有一个线程执行，无法利用多核优势，但是其他python解释器能实现</strong></p></li> <li><p>首先需要明确的一点是<code>GIL</code>并不是Python的特性，它是在实现Python解析器(CPython)时所引入的一个概念。就好比C++是一套语言（语法）标准，但是可以用不同的编译器来编译成可执行代码。有名的编译器例如GCC，INTEL C++，Visual C++等。Python也一样，同样一段代码可以通过CPython，PyPy，Psyco等不同的Python执行环境来执行。像其中的JPython就没有GIL.</p></li> <li><p>如果多个线程的target=work，那么执行流程是:</p> <p>多个线程先访问到解释器的代码，即拿到执行权限，然后将target的代码交给解释器的代码去执行</p> <p>解释器的代码是所有线程共享的，所以垃圾回收线程也可能访问到解释器的代码而去执行，这就导致了一个问题:对于同一个数据100，可能线程1执行x=100的同时，而垃圾回收执行的是回收100的操作，解决这种问题没有什么高明的方法，就是加锁处理，如下图的GIL，保证python解释器同一时间只能执行一个任务的代码</p> <p><img src="https://img2018.cnblogs.com/blog/988061/201809/988061-20180926100512742-1573465285.png" alt="img"></p></li> <li><p><strong>GIL vs Lock</strong></p> <ul><li><p><strong>GIL保护的是解释器级的数据，保护用户自己的数据则需要自己加锁处理，如下图</strong></p> <p><img src="https://img2018.cnblogs.com/blog/988061/201809/988061-20180926100556096-1593917726.png" alt="img"></p></li> <li><p>既然Python已经有了一个GIL来保证同一时间只能有一个线程Laura执行,那么为什么还需要Lock呢?
首先我们需要达成共识: 锁的目的是为了保护共享的数据,同一时间只能有一个线程来修改共享的数据.
然后,我们可以得出结论: 保护不同的数据就应该加不同的锁.
于是,问题就比较明朗了,GIL与Lock是两把锁,保护的数据不一样:前者是解释器级别的(保护的是解释器级别的数据,比如垃圾回收的数据),后者是保护用户自己开发的应用程序的数据,很明显GIL不负责这件事,只能用户自定义加锁处理,即Lock.</p> <p><img src="C:%5CUsers%5Cwanglixing%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1555577025977.png" alt="1555577025977"></p></li></ul></li> <li><p><strong>GIL与多线程</strong></p> <ul><li><p>有了GIL的存在，同一时刻同一进程中只有一个线程被执行</p> <p>听到这里，有的同学立马质问：进程可以利用多核，但是开销大，而python的多线程开销小，但却无法利用多核优势，也就是说python没用了，php才是最牛逼的语言，别着急啊，老娘还没讲完呢，要解决这个问题，我们需要在几个点上达成一致：</p></li></ul></li></ul> <h2 id="线程队列"><a href="#线程队列" class="header-anchor">#</a> 线程队列</h2> <ul><li><p>Queue就是一个线程队列的类,自带lock锁,实现了线程安全的数据类型，队列是一个线程安全的数据类型</p> <ul><li><p>注意：</p> <ul><li>在多线程下都不准,因为多线程中随时可能会往里面添加值，或则删除值
q.empty() 判断是否为空
q.full()  判断是否为满
q.qsize() 队列的大小</li></ul></li> <li><p><strong>queue.Queue(maxsize=0) -- 先进先出</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>q<span class="token operator">=</span>queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'first'</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'second'</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'third'</span><span class="token punctuation">)</span>
<span class="token comment"># q.put_nowait() #没有数据就报错，可以通过try来搞</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># q.get_nowait() #没有数据就报错，可以通过try来搞</span>

<span class="token comment"># 执行结果: (先进先出)</span>
<span class="token comment"># first</span>
<span class="token comment"># second</span>
<span class="token comment"># third</span>
</code></pre></div></li> <li><p><strong>queue.LifoQueue(maxsize=0) -- last in first out 后进先出</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> queue
q<span class="token operator">=</span>queue<span class="token punctuation">.</span>LifoQueue<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#队列，类似于栈，后进先出的顺序</span>
q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'first'</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'second'</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'third'</span><span class="token punctuation">)</span>
<span class="token comment"># q.put_nowait()</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># q.get_nowait()</span>

<span class="token comment"># 执行结果:(后进先出)</span>
<span class="token comment"># third</span>
<span class="token comment"># second</span>
<span class="token comment"># first</span>
</code></pre></div></li> <li><p><strong>queue.PriorityQueue(maxsize=0) -- 存储数据时可以设置优先级队列</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> queue <span class="token keyword">import</span> PriorityQueue
q <span class="token operator">=</span> queue<span class="token punctuation">.</span>PriorityQueue<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 创建栈</span>

<span class="token comment"># put()方法放置一个元组进入栈,元组的第一个元素是优先级(通常是数字,也可以是非数字之间的比较),数字越小优先级越高</span>
q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 负数也可以</span>
<span class="token comment"># q.put((20,&quot;ws&quot;))  # 如果两个值的优先级一样,那么按照后面的值的acsii码顺序来排序,如果字符串第一个数元素相同,比较第二个元素的acsii码顺序</span>
<span class="token comment"># q.put((20,&quot;wd&quot;))</span>
<span class="token comment"># q.put((20,{&quot;a&quot;: 11})) # TypeError: unorderable types: dict() &lt; dict() 不能是字典</span>
<span class="token comment"># q.put((20,(&quot;w&quot;, 1)))  # 优先级相同的两个数据,他们后面的值必须是相同的数据类型才能比较,可以是元祖,也是通过元素的ascii码顺序来排序</span>

q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 数字越小优先级越高,优先级高的优先出队</span>
</code></pre></div></li></ul></li></ul> <h2 id="线程池、进程池-concurrent-futures"><a href="#线程池、进程池-concurrent-futures" class="header-anchor">#</a> 线程池、进程池(concurrent.futures)</h2> <ul><li><p>早期的时候并没有线程池,现在Python提供了一个新的标准或者说内置的模块,这个模块里面提供了新的线程池和进程池（Pool）.</p> <ul><li><p>concurrent.futures的用法（在multiprocessing模块中最初使用Pool，创建进程池，现在改用concurrent.futures)</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#1 介绍</span>
concurrent<span class="token punctuation">.</span>futures 模块提供了高度封装的异步调用接口
ThreadPoolExecutor：线程池，提供异步调用
ProcessPoolExecutor<span class="token punctuation">:</span> 进程池，提供异步调用
Both implement the same interface<span class="token punctuation">,</span> which <span class="token keyword">is</span> defined by the abstract Executor <span class="token keyword">class</span><span class="token punctuation">.</span>

<span class="token comment">#2 基本方法</span>
<span class="token comment">#submit(fn, *args, **kwargs)</span>
异步提交任务

<span class="token comment">#map(func, *iterables, timeout=None, chunksize=1) </span>
取代<span class="token keyword">for</span>循环submit的操作

<span class="token comment">#shutdown(wait=True) </span>
相当于进程池的pool<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>pool<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>操作
wait<span class="token operator">=</span><span class="token boolean">True</span>，等待池内所有任务执行完毕回收完资源后才继续
wait<span class="token operator">=</span><span class="token boolean">False</span>，立即返回，并不会等待池内的任务执行完毕
但不管wait参数为何值，整个程序都会等到所有任务执行完毕
submit和<span class="token builtin">map</span>必须在shutdown之前

<span class="token comment">#result(timeout=None)</span>
取得结果，这是个阻塞的，一直会等相应的返回值
<span class="token comment">#add_done_callback(fn)</span>
回调函数

<span class="token comment"># ProcessPoolExecutor的用法</span>
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor<span class="token punctuation">,</span>ProcessPoolExecutor
<span class="token keyword">import</span> os<span class="token punctuation">,</span>time<span class="token punctuation">,</span>random
<span class="token keyword">def</span> <span class="token function">task</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s is runing'</span> <span class="token operator">%</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> n<span class="token operator">**</span><span class="token number">2</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    executor<span class="token operator">=</span>ProcessPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment">#这是限制了使用进程，可以改为ThreadPoolEcecutor，效果一样</span>
    futures<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        future<span class="token operator">=</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>task<span class="token punctuation">,</span>i<span class="token punctuation">)</span>  <span class="token comment">#多线程执行函数，第二个参数必须是一个参数，可以封装成元组</span>
        futures<span class="token punctuation">.</span>append<span class="token punctuation">(</span>future<span class="token punctuation">)</span>
    executor<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment">#wait=True，等待池内所有任务执行完毕回收完资源后才继续</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'+++&gt;'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> futures<span class="token punctuation">:</span>  <span class="token comment">#最后输出结果</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
 <span class="token comment">#map的用法</span>
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor<span class="token punctuation">,</span>ProcessPoolExecutor
<span class="token keyword">import</span> os<span class="token punctuation">,</span>time<span class="token punctuation">,</span>random
<span class="token keyword">def</span> <span class="token function">task</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s is runing'</span> <span class="token operator">%</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> n<span class="token operator">**</span><span class="token number">2</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    executor<span class="token operator">=</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

    <span class="token comment"># for i in range(11):</span>
    <span class="token comment">#     future=executor.submit(task,i)</span>
   ret_l<span class="token operator">=</span>executor<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">#map取代了for+submit，效果一致</span>
   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'+++&gt;'</span><span class="token punctuation">)</span>
   <span class="token keyword">for</span> future <span class="token keyword">in</span> ret_l<span class="token punctuation">:</span>  <span class="token comment">#最后输出结果</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
 <span class="token comment">#池的误区</span>
<span class="token keyword">import</span> time
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token operator">*</span><span class="token string">'*'</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
thread_pool <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment">#创建一个最大可容纳2个任务的线程池</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    thread_pool<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>func<span class="token punctuation">,</span>i<span class="token punctuation">)</span>  <span class="token comment"># 异步提交任务,往线程池里面加入一个任务</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'wahaha'</span><span class="token punctuation">)</span>
<span class="token comment">#结果：</span>
<span class="token operator">*</span>
<span class="token operator">**</span>
<span class="token operator">**</span><span class="token operator">*</span>
<span class="token operator">**</span><span class="token operator">**</span>
wahaha
<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span>

<span class="token comment">#回调函数</span>
<span class="token keyword">import</span> time
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token operator">*</span><span class="token string">'*'</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> i<span class="token operator">**</span><span class="token number">2</span>
 
<span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">#回调函数</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token string">'-'</span><span class="token punctuation">)</span>  <span class="token comment"># 取得结果,并乘以-</span>
 
thread_pool <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment">#创建一个最大可容纳2个任务的线程池</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret <span class="token operator">=</span> thread_pool<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>func<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>callback<span class="token punctuation">)</span>  <span class="token comment"># 异步提交任务,执行回调函数</span>
    <span class="token comment">#print(ret) #打印i**2</span>
 
thread_pool<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 相当于进程池的pool.close()+pool.join()操作</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'wahaha'</span><span class="token punctuation">)</span>
<span class="token comment">#执行输出</span>
<span class="token operator">*</span>
<span class="token operator">**</span>
<span class="token operator">**</span><span class="token operator">*</span>
<span class="token operator">**</span><span class="token operator">**</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token operator">-</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
wahaha
</code></pre></div></li></ul></li> <li><h5 id="result-与-回调函数add-done-callback"><a href="#result-与-回调函数add-done-callback" class="header-anchor">#</a> result 与  回调函数add_done_callback</h5> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#add_done_callback(self, fn): </span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;Attaches a callable that will be called when the future finishes.

        Args:
            fn: A callable that will be called with this future as its only
                argument when the future completes or is cancelled. The callable
                will always be called by a thread in the same process in which
                it was added. If the future has already completed or been
                cancelled then the callable will be called immediately. These
                callables are called in the order that they were added.
        &quot;&quot;&quot;</span>
<span class="token comment">#也就是说，python在解析到add_done_callback后，会将fn这个函数提交成一个线程，这样整个流程都是异步的</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> time
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor
<span class="token keyword">def</span> <span class="token function">get_page</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'url'</span><span class="token punctuation">:</span>url<span class="token punctuation">,</span><span class="token string">'content'</span><span class="token punctuation">:</span>res<span class="token punctuation">.</span>text<span class="token punctuation">}</span>  <span class="token comment">#res.text拿到网页的文本格式</span>

<span class="token keyword">def</span> <span class="token function">parserpage</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dic <span class="token operator">=</span> ret<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>dic<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
tp <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
url_lst <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'http://www.baidu.com'</span><span class="token punctuation">,</span>   <span class="token comment"># 3</span>
    <span class="token string">'http://www.cnblogs.com'</span><span class="token punctuation">,</span> <span class="token comment"># 1</span>
    <span class="token string">'http://www.douban.com'</span><span class="token punctuation">,</span>  <span class="token comment"># 1</span>
    <span class="token string">'http://www.tencent.com'</span><span class="token punctuation">,</span>
    <span class="token string">'http://www.cnblogs.com/Eva-J/articles/8306047.html'</span><span class="token punctuation">,</span>
    <span class="token string">'http://www.cnblogs.com/Eva-J/articles/7206498.html'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
ret_l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> url <span class="token keyword">in</span> url_lst<span class="token punctuation">:</span>
    ret <span class="token operator">=</span> tp<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>get_page<span class="token punctuation">,</span>url<span class="token punctuation">)</span>
    ret_l<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    
<span class="token keyword">for</span> ret <span class="token keyword">in</span> ret_l<span class="token punctuation">:</span>
    ret<span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>parserpage<span class="token punctuation">)</span>  <span class="token comment">#结果依旧是异步的</span>
</code></pre></div></li></ul> <h2 id="线程事件-event"><a href="#线程事件-event" class="header-anchor">#</a> 线程事件（Event)</h2> <ul><li><p>同进程的一样,线程的一个关键特性是<code>每个线程都是独立运行且状态不可预测。如果程序中的其 他线程需要通过判断某个线程的状态来确定自己下一步的操作,这时线程同步问题就会变得非常棘手。为了解决这些问题,我们需要使用threading库中的Event对象</code>。 对象包含一个可由线程设置的信号标志,它允许线程等待某些事件的发生。在初始情况下,Event对象中的信号标志被设置为假。如果有线程等待一个Event对象, 而这个Event对象的标志为假,那么这个线程将会被一直阻塞直至该标志为真。一个线程如果将一个Event对象的信号标志设置为真,它将唤醒所有等待这个Event对象的线程。如果一个线程等待一个已经被设置为真的Event对象,那么它将忽略这个事件, 继续执行.</p></li> <li><p>event的用法</p> <div class="language-python extra-class"><pre class="language-python"><code>event<span class="token punctuation">.</span>isSet<span class="token punctuation">(</span><span class="token punctuation">)</span>：<span class="token comment">#返回event的状态值；</span>
event<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>： <span class="token comment">#如果 event.isSet()==False将阻塞线程；可设置时间</span>
event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>：  <span class="token comment">#设置event的状态值为True，所有阻塞池的线程激活进入就绪状态， 等待操作系统调度；</span>
event<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>：<span class="token comment">#恢复event的状态值为False。</span>
</code></pre></div></li> <li><p>例如，有多个工作线程尝试链接MySQL，我们想要在链接前确保MySQL服务正常才让那些工作线程去连接MySQL服务器，如果连接不成功，都会去尝试重新连接。那么我们就可以采用threading.Event机制来协调各个工作线程的连接操作。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> time
<span class="token keyword">import</span> random
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Event<span class="token punctuation">,</span>Thread
<span class="token comment"># 连接数据库</span>
<span class="token keyword">def</span> <span class="token function">connect_db</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">:</span>
    count <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># 初始计数器</span>
    <span class="token keyword">while</span> count <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'尝试第%s次检测连接'</span><span class="token operator">%</span>count<span class="token punctuation">)</span>
        e<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>  <span class="token comment"># 等待0.5,再去执行下面的代码,如果不写参数则会也一直在这等待</span>
        <span class="token comment"># 如果不传参数会一直等到事件为True为止</span>
        <span class="token comment"># 如果传参数 传一个时间参数,到时间后,</span>
        count <span class="token operator">+=</span> <span class="token number">1</span>  <span class="token comment"># 加1</span>
        <span class="token keyword">if</span> e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 判断状态是否为True</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'连接成功'</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'连接失败'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">check_conn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''检测数据库是否可以连接'''</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 等待1~2秒，显然这里时间太长</span>
    e<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 设置状态为True</span>

e <span class="token operator">=</span> Event<span class="token punctuation">(</span><span class="token punctuation">)</span>
Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>check_conn<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>connect_db<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token comment">#随机数，至少连接两次，如果等待2秒，e.wait(0.5)执行4次，才能达到2秒。但是whlie循环，不可能达到4。所以3次全部失败。第1种情况，等待1秒，e.wait(0.5)必然执行2次，才能达到1秒，状态变成True，输出连接成功。第2种情况，是偶然事件。因为CPU同一时刻只能执行一个线程。所以失败了3次，才输出连接成功。</span>
</code></pre></div></li> <li><p><strong>你要做一件事情 是有前提的</strong> <strong>你就先去处理前提的问题 —— 前提处理好了 把状态设置成True</strong>，来控制即将要做的事情可以开始</p> <p><img src="C:%5CUsers%5Cwanglixing%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1555745482833.png" alt="1555745482833"></p></li></ul> <h2 id="条件变量"><a href="#条件变量" class="header-anchor">#</a> 条件变量</h2> <p>使得线程等待，只有满足某条件时，才释放n个线程，Python提供的Condition对象提供了对复杂线程同步问题的支持。Condition被称为条件变量，除了提供与Lock类似的acquire和release方法外，还提供了wait和notify方法。线程首先acquire一个条件变量，然后判断一些条件。如果条件不满足则wait；如果条件满足，进行一些处理改变条件后，通过notify方法通知其他线程，其他处于wait状态的线程接到通知后会重新判断条件。不断的重复这一过程，从而解决复杂的同步问题。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> threading <span class="token keyword">import</span> Condition<span class="token punctuation">,</span>Thread
<span class="token comment"># acquire release</span>
<span class="token comment"># notify -- wait的行为</span>
<span class="token comment"># 10线程 wait</span>
<span class="token comment"># notify(1)</span>
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>con<span class="token punctuation">)</span><span class="token punctuation">:</span>
    con<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 进入锁定池</span>
    con<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 等待通知,前后必须要有acquire和release</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token operator">*</span><span class="token string">'*'</span><span class="token punctuation">)</span>
    con<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 解锁</span>
 
con <span class="token operator">=</span> Condition<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#条件变量</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>con<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    n <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'&gt;&gt;&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#n 表示激活几个线程</span>
    con<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 加锁</span>
    con<span class="token punctuation">.</span>notify<span class="token punctuation">(</span>n<span class="token punctuation">)</span>  <span class="token comment"># 通知其他线程,其他处于wait状态的线程接到通知后会重新判断条件,解除wait状态。前后必须要有acquire和release</span>
    con<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 解锁</span>
    
<span class="token comment">#从结果上来看，发生数据混乱</span>
<span class="token comment">#con.notify(n) 表示按照要求放开线程</span>
<span class="token comment">#con.notify_all() 表示一次性放开线程</span>

总结：
semaphore 允许同一时刻n个线程执行这段代码
event 有一个内部的事件来控制wait的行为<span class="token punctuation">,</span>控制的是所有的线程
condition 有一个内部的条件来控制wait的行为，它可以逐个或者分批次的控制线程的走向
</code></pre></div><h2 id="定时器"><a href="#定时器" class="header-anchor">#</a> 定时器</h2> <ul><li><p>定时器，指定n秒后执行某个操作,你可能说为什么不用sleep，因为那是同步阻塞的，虽然可以用time.sleep(5)完成5秒的过程，但是它会阻塞主线程，如果用timer，就不会，它是异步的。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> time
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Timer
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'子线程'</span><span class="token punctuation">,</span>time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 
t <span class="token operator">=</span>Timer<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>func<span class="token punctuation">)</span>  <span class="token comment"># 要开始一个线程,等到5秒之后才开启并执行</span>
t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'主进程'</span><span class="token punctuation">,</span>time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">#执行输出：</span>
<span class="token comment">#主进程 2018-05-17 19:41:08</span>
<span class="token comment">#**********</span>
<span class="token comment">#子线程 2018-05-17 19:41:13</span>
</code></pre></div></li></ul> <p>线程池的使用 https://blog.csdn.net/u013713010/article/details/53305151</p> <p>连接池的使用： https://blog.csdn.net/weixin_40976261/article/details/89057633</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/python/origin/TCP和UDP.html" class="prev">
        TCP和UDP
      </a></span> <span class="next"><a href="/python/origin/multiprocessing（上）.html">
        multiprocessing（上）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.51f2f156.js" defer></script><script src="/assets/js/2.8911ec45.js" defer></script><script src="/assets/js/96.b59cf9f4.js" defer></script>
  </body>
</html>
