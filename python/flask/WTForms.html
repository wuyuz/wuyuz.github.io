<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WTForms | 独角兕大王</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.ccac5a78.css" as="style"><link rel="preload" href="/assets/js/app.51f2f156.js" as="script"><link rel="preload" href="/assets/js/2.8911ec45.js" as="script"><link rel="preload" href="/assets/js/68.9f227dae.js" as="script"><link rel="prefetch" href="/assets/js/10.6948c28b.js"><link rel="prefetch" href="/assets/js/100.276864ee.js"><link rel="prefetch" href="/assets/js/101.447ab1c7.js"><link rel="prefetch" href="/assets/js/102.f5b3c71d.js"><link rel="prefetch" href="/assets/js/103.16474d4b.js"><link rel="prefetch" href="/assets/js/104.ed58aef3.js"><link rel="prefetch" href="/assets/js/105.045203cd.js"><link rel="prefetch" href="/assets/js/106.be359e0b.js"><link rel="prefetch" href="/assets/js/107.7331bbca.js"><link rel="prefetch" href="/assets/js/108.76e1c800.js"><link rel="prefetch" href="/assets/js/109.e82166f3.js"><link rel="prefetch" href="/assets/js/11.d4ec37c8.js"><link rel="prefetch" href="/assets/js/110.4144755a.js"><link rel="prefetch" href="/assets/js/111.5864ab53.js"><link rel="prefetch" href="/assets/js/112.ca2aee84.js"><link rel="prefetch" href="/assets/js/113.641e7765.js"><link rel="prefetch" href="/assets/js/114.d69f8545.js"><link rel="prefetch" href="/assets/js/115.1b6a9f89.js"><link rel="prefetch" href="/assets/js/116.dde2c44e.js"><link rel="prefetch" href="/assets/js/117.4e79498c.js"><link rel="prefetch" href="/assets/js/12.7aac9c8d.js"><link rel="prefetch" href="/assets/js/13.abf127cd.js"><link rel="prefetch" href="/assets/js/14.aa4413a7.js"><link rel="prefetch" href="/assets/js/15.11a64e5b.js"><link rel="prefetch" href="/assets/js/16.f2d9a882.js"><link rel="prefetch" href="/assets/js/17.11c5bb7f.js"><link rel="prefetch" href="/assets/js/18.a522877b.js"><link rel="prefetch" href="/assets/js/19.6f31a972.js"><link rel="prefetch" href="/assets/js/20.b546c54e.js"><link rel="prefetch" href="/assets/js/21.6d055b7f.js"><link rel="prefetch" href="/assets/js/22.c48feceb.js"><link rel="prefetch" href="/assets/js/23.69941f78.js"><link rel="prefetch" href="/assets/js/24.6126dfc2.js"><link rel="prefetch" href="/assets/js/25.3475449c.js"><link rel="prefetch" href="/assets/js/26.96bb4643.js"><link rel="prefetch" href="/assets/js/27.da610e5d.js"><link rel="prefetch" href="/assets/js/28.b24ec15c.js"><link rel="prefetch" href="/assets/js/29.ec8af553.js"><link rel="prefetch" href="/assets/js/3.bec5f768.js"><link rel="prefetch" href="/assets/js/30.2e780db1.js"><link rel="prefetch" href="/assets/js/31.464c36ed.js"><link rel="prefetch" href="/assets/js/32.ad7d37c2.js"><link rel="prefetch" href="/assets/js/33.722f1ec5.js"><link rel="prefetch" href="/assets/js/34.8448d0fd.js"><link rel="prefetch" href="/assets/js/35.e5168ac9.js"><link rel="prefetch" href="/assets/js/36.edc404f1.js"><link rel="prefetch" href="/assets/js/37.5807602e.js"><link rel="prefetch" href="/assets/js/38.a519c89a.js"><link rel="prefetch" href="/assets/js/39.89af1b9a.js"><link rel="prefetch" href="/assets/js/4.5ed19beb.js"><link rel="prefetch" href="/assets/js/40.6c653db9.js"><link rel="prefetch" href="/assets/js/41.bc3b8b69.js"><link rel="prefetch" href="/assets/js/42.a0a02d9b.js"><link rel="prefetch" href="/assets/js/43.62f344e3.js"><link rel="prefetch" href="/assets/js/44.a7fd9d68.js"><link rel="prefetch" href="/assets/js/45.729c1c39.js"><link rel="prefetch" href="/assets/js/46.5b924aea.js"><link rel="prefetch" href="/assets/js/47.f3990404.js"><link rel="prefetch" href="/assets/js/48.f591f360.js"><link rel="prefetch" href="/assets/js/49.f7f213ad.js"><link rel="prefetch" href="/assets/js/5.2c5d28b5.js"><link rel="prefetch" href="/assets/js/50.b9ca2762.js"><link rel="prefetch" href="/assets/js/51.93672ee6.js"><link rel="prefetch" href="/assets/js/52.fb21314a.js"><link rel="prefetch" href="/assets/js/53.65343ccc.js"><link rel="prefetch" href="/assets/js/54.8081227d.js"><link rel="prefetch" href="/assets/js/55.e207659e.js"><link rel="prefetch" href="/assets/js/56.bde381df.js"><link rel="prefetch" href="/assets/js/57.f8eceb45.js"><link rel="prefetch" href="/assets/js/58.bef70bfd.js"><link rel="prefetch" href="/assets/js/59.7ab7562d.js"><link rel="prefetch" href="/assets/js/6.fc65a1ac.js"><link rel="prefetch" href="/assets/js/60.f40ac3ca.js"><link rel="prefetch" href="/assets/js/61.d2b463ab.js"><link rel="prefetch" href="/assets/js/62.cfdf1bcf.js"><link rel="prefetch" href="/assets/js/63.1e45ce59.js"><link rel="prefetch" href="/assets/js/64.a98fe86e.js"><link rel="prefetch" href="/assets/js/65.0234d7c5.js"><link rel="prefetch" href="/assets/js/66.724906f0.js"><link rel="prefetch" href="/assets/js/67.7806fda6.js"><link rel="prefetch" href="/assets/js/69.fdbc56ac.js"><link rel="prefetch" href="/assets/js/7.284de54e.js"><link rel="prefetch" href="/assets/js/70.04a9cc03.js"><link rel="prefetch" href="/assets/js/71.a6fa1dd9.js"><link rel="prefetch" href="/assets/js/72.2f8e3aa0.js"><link rel="prefetch" href="/assets/js/73.9bbb0cb6.js"><link rel="prefetch" href="/assets/js/74.9f122255.js"><link rel="prefetch" href="/assets/js/75.75e1fbd8.js"><link rel="prefetch" href="/assets/js/76.60ff3c3e.js"><link rel="prefetch" href="/assets/js/77.39a253ae.js"><link rel="prefetch" href="/assets/js/78.0e49712f.js"><link rel="prefetch" href="/assets/js/79.5f9c24a0.js"><link rel="prefetch" href="/assets/js/8.5c21a4cc.js"><link rel="prefetch" href="/assets/js/80.f826f188.js"><link rel="prefetch" href="/assets/js/81.b8995ea7.js"><link rel="prefetch" href="/assets/js/82.e9bf63e0.js"><link rel="prefetch" href="/assets/js/83.e3a00749.js"><link rel="prefetch" href="/assets/js/84.b940927c.js"><link rel="prefetch" href="/assets/js/85.ad46a9b2.js"><link rel="prefetch" href="/assets/js/86.190e0071.js"><link rel="prefetch" href="/assets/js/87.5f9eb9ef.js"><link rel="prefetch" href="/assets/js/88.cfaf7469.js"><link rel="prefetch" href="/assets/js/89.e64cc32c.js"><link rel="prefetch" href="/assets/js/9.0723805d.js"><link rel="prefetch" href="/assets/js/90.805edabe.js"><link rel="prefetch" href="/assets/js/91.6a1ab3f7.js"><link rel="prefetch" href="/assets/js/92.04ecd01e.js"><link rel="prefetch" href="/assets/js/93.e615470a.js"><link rel="prefetch" href="/assets/js/94.0ad7c41c.js"><link rel="prefetch" href="/assets/js/95.0e5ce618.js"><link rel="prefetch" href="/assets/js/96.b59cf9f4.js"><link rel="prefetch" href="/assets/js/97.2a327746.js"><link rel="prefetch" href="/assets/js/98.9c01ec88.js"><link rel="prefetch" href="/assets/js/99.952046bd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ccac5a78.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://github.com/fluidicon.png" alt="独角兕大王" class="logo"> <span class="site-name can-hide">独角兕大王</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/python/" class="nav-link router-link-active">
  Python
</a></div><div class="nav-item"><a href="/rust/" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/go/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/lua/" class="nav-link">
  Lua
</a></div><div class="nav-item"><a href="/C/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="https://github.com/wuyuz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/double-W/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cnblogs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/python/" class="nav-link router-link-active">
  Python
</a></div><div class="nav-item"><a href="/rust/" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/go/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/lua/" class="nav-link">
  Lua
</a></div><div class="nav-item"><a href="/C/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="https://github.com/wuyuz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.cnblogs.com/double-W/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cnblogs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python常用模块</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Django框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Flask 框架</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/python/flask/Werkzeug讲解.html" class="sidebar-link">Werkzeug 讲解</a></li><li><a href="/python/flask/路由和配置.html" class="sidebar-link">路由和配置</a></li><li><a href="/python/flask/模板、请求与响应.html" class="sidebar-link">模板、请求与响应</a></li><li><a href="/python/flask/蓝图、请求扩展和中间件.html" class="sidebar-link">蓝图、请求扩展和中间件</a></li><li><a href="/python/flask/数据库连接池.html" class="sidebar-link">数据库连接池</a></li><li><a href="/python/flask/SQLAlchmey.html" class="sidebar-link">SQLAlchmey</a></li><li><a href="/python/flask/WTForms.html" aria-current="page" class="active sidebar-link">WTForms</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/flask/WTForms.html#wtforms" class="sidebar-link">WTForms</a></li><li class="sidebar-sub-header"><a href="/python/flask/WTForms.html#wtforms-组件" class="sidebar-link">WTForms 组件</a></li><li class="sidebar-sub-header"><a href="/python/flask/WTForms.html#wtforms的源码实现" class="sidebar-link">WTForms的源码实现</a></li></ul></li><li><a href="/python/flask/信号.html" class="sidebar-link">信号</a></li><li><a href="/python/flask/应用上下文.html" class="sidebar-link">应用上下文</a></li><li><a href="/python/flask/内置session理解.html" class="sidebar-link">内置session理解</a></li><li><a href="/python/flask/经典的编程思想.html" class="sidebar-link">经典的编程思想</a></li><li><a href="/python/flask/请求上下文源码分析.html" class="sidebar-link">请求上下文源码分析</a></li><li><a href="/python/flask/上下文管理准备工作.html" class="sidebar-link">上下文管理准备工作</a></li><li><a href="/python/flask/上下文管理源码分析.html" class="sidebar-link">上下文管理源码分析</a></li><li><a href="/python/flask/Flask回顾.html" class="sidebar-link">Flask开发规范和RESTful</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python爬虫</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python设计模式</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="wtforms"><a href="#wtforms" class="header-anchor">#</a> WTForms</h2> <p>WTForms是一个支持多个web框架的form组件，主要用于对用户请求数据进行验证</p> <h4 id="登陆注册实例"><a href="#登陆注册实例" class="header-anchor">#</a> 登陆注册实例</h4> <ul><li><p>与Django的表单验证的过程类似</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request<span class="token punctuation">,</span> redirect
<span class="token keyword">from</span> wtforms <span class="token keyword">import</span> Form
<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>fields <span class="token keyword">import</span> core
<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>fields <span class="token keyword">import</span> html5
<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>fields <span class="token keyword">import</span> simple
<span class="token keyword">from</span> wtforms <span class="token keyword">import</span> validators
<span class="token keyword">from</span> wtforms <span class="token keyword">import</span> widgets

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">,</span> template_folder<span class="token operator">=</span><span class="token string">'templates'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>debug <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment">#相当于django中的form组件，用于进行表单和数据验证</span>
<span class="token keyword">class</span> <span class="token class-name">LoginForm</span><span class="token punctuation">(</span>Form<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#字段（内部包含正则表达式）</span>
    name <span class="token operator">=</span> simple<span class="token punctuation">.</span>StringField<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">'用户名'</span><span class="token punctuation">,</span>
        validators<span class="token operator">=</span><span class="token punctuation">[</span>
            <span class="token comment">#内部校验器</span>
            validators<span class="token punctuation">.</span>DataRequired<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">'用户名不能为空.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            validators<span class="token punctuation">.</span>Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">'用户名长度必须大于%(min)d且小于%(max)d'</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">#页面的显示插件</span>
        widget<span class="token operator">=</span>widgets<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">#给插件添加的属性</span>
        render_kw<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'form-control'</span><span class="token punctuation">}</span>

    <span class="token punctuation">)</span>
    <span class="token comment"># pwd = html5.EmailField() # 可以使用html5的验证方式</span>
    pwd <span class="token operator">=</span> simple<span class="token punctuation">.</span>PasswordField<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">'密码'</span><span class="token punctuation">,</span>
        validators<span class="token operator">=</span><span class="token punctuation">[</span>
            validators<span class="token punctuation">.</span>DataRequired<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">'密码不能为空.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            validators<span class="token punctuation">.</span>Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">'用户名长度必须大于%(min)d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">#正则验证</span>
            validators<span class="token punctuation">.</span>Regexp<span class="token punctuation">(</span>regex<span class="token operator">=</span><span class="token string">&quot;^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[$@$!%*?&amp;])[A-Za-z\d$@$!%*?&amp;]{8,}&quot;</span><span class="token punctuation">,</span>
                              message<span class="token operator">=</span><span class="token string">'密码至少8个字符，至少1个大写字母，1个小写字母，1个数字和1个特殊字符'</span><span class="token punctuation">)</span>

        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        widget<span class="token operator">=</span>widgets<span class="token punctuation">.</span>PasswordInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        render_kw<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'form-control'</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        form <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        form <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span>formdata<span class="token operator">=</span>request<span class="token punctuation">.</span>form<span class="token punctuation">)</span>
        <span class="token keyword">if</span> form<span class="token punctuation">.</span>validate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'用户提交数据通过格式验证，提交的值为：'</span><span class="token punctuation">,</span> form<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>form<span class="token punctuation">.</span>errors<span class="token punctuation">)</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>对应的login.html文件</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;/html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;Title&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;登录&lt;/h1&gt;
&lt;form method=&quot;post&quot; novalidate&gt;
    &lt;p&gt;{{form.name.label}} {{form.name}} {{form.name.errors[0] }}&lt;/p&gt;

    &lt;p&gt;{{form.pwd.label}} {{form.pwd}} {{form.pwd.errors[0] }}&lt;/p&gt;
    &lt;input type=&quot;submit&quot; value=&quot;提交&quot;&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></li></ul> <h4 id="注册的简单使用"><a href="#注册的简单使用" class="header-anchor">#</a> 注册的简单使用</h4> <ul><li><p>在WTForms中也存在数据验证等操作</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request<span class="token punctuation">,</span> redirect
<span class="token keyword">from</span> wtforms <span class="token keyword">import</span> Form
<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>fields <span class="token keyword">import</span> core
<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>fields <span class="token keyword">import</span> html5
<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>fields <span class="token keyword">import</span> simple
<span class="token keyword">from</span> wtforms <span class="token keyword">import</span> validators
<span class="token keyword">from</span> wtforms <span class="token keyword">import</span> widgets

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">,</span> template_folder<span class="token operator">=</span><span class="token string">'templates'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>debug <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token keyword">class</span> <span class="token class-name">RegisterForm</span><span class="token punctuation">(</span>Form<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> simple<span class="token punctuation">.</span>StringField<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">'用户名'</span><span class="token punctuation">,</span>
        validators<span class="token operator">=</span><span class="token punctuation">[</span>
            validators<span class="token punctuation">.</span>DataRequired<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        widget<span class="token operator">=</span>widgets<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        render_kw<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'form-control'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment"># 输入框的默认值</span>
        default<span class="token operator">=</span><span class="token string">'alex'</span>
    <span class="token punctuation">)</span>

    pwd <span class="token operator">=</span> simple<span class="token punctuation">.</span>PasswordField<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">'密码'</span><span class="token punctuation">,</span>
        validators<span class="token operator">=</span><span class="token punctuation">[</span>
            validators<span class="token punctuation">.</span>DataRequired<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">'密码不能为空.'</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        widget<span class="token operator">=</span>widgets<span class="token punctuation">.</span>PasswordInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        render_kw<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'form-control'</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    pwd_confirm <span class="token operator">=</span> simple<span class="token punctuation">.</span>PasswordField<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">'重复密码'</span><span class="token punctuation">,</span>
        validators<span class="token operator">=</span><span class="token punctuation">[</span>
            validators<span class="token punctuation">.</span>DataRequired<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">'重复密码不能为空.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">#内部校验器:与哪一个字段要一直，比django自带的要简单一些，否则还要使用钩子</span>
            validators<span class="token punctuation">.</span>EqualTo<span class="token punctuation">(</span><span class="token string">'pwd'</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">&quot;两次密码输入不一致&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        widget<span class="token operator">=</span>widgets<span class="token punctuation">.</span>PasswordInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        render_kw<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'form-control'</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    <span class="token comment">#email在html5中</span>
    email <span class="token operator">=</span> html5<span class="token punctuation">.</span>EmailField<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">'邮箱'</span><span class="token punctuation">,</span>
        validators<span class="token operator">=</span><span class="token punctuation">[</span>
            validators<span class="token punctuation">.</span>DataRequired<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">'邮箱不能为空.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            validators<span class="token punctuation">.</span>Email<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">'邮箱格式错误'</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        widget<span class="token operator">=</span>widgets<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>input_type<span class="token operator">=</span><span class="token string">'email'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        render_kw<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'form-control'</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># 单选框在core中</span>
    gender <span class="token operator">=</span> core<span class="token punctuation">.</span>RadioField<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">'性别'</span><span class="token punctuation">,</span>
        choices<span class="token operator">=</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'男'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'女'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">#将用户提交过来的'1' 转换为 1</span>
        <span class="token builtin">coerce</span><span class="token operator">=</span><span class="token builtin">int</span>
    <span class="token punctuation">)</span>
    city <span class="token operator">=</span> core<span class="token punctuation">.</span>SelectField<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">'城市'</span><span class="token punctuation">,</span>
        choices<span class="token operator">=</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token string">'bj'</span><span class="token punctuation">,</span> <span class="token string">'北京'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'上海'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    hobby <span class="token operator">=</span> core<span class="token punctuation">.</span>SelectMultipleField<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">'爱好'</span><span class="token punctuation">,</span>
        choices<span class="token operator">=</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'篮球'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'足球'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token builtin">coerce</span><span class="token operator">=</span><span class="token builtin">int</span>
    <span class="token punctuation">)</span>

    favor <span class="token operator">=</span> core<span class="token punctuation">.</span>SelectMultipleField<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">'喜好'</span><span class="token punctuation">,</span>
        choices<span class="token operator">=</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'篮球'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'足球'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">#多选</span>
        widget<span class="token operator">=</span>widgets<span class="token punctuation">.</span>ListWidget<span class="token punctuation">(</span>prefix_label<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        option_widget<span class="token operator">=</span>widgets<span class="token punctuation">.</span>CheckboxInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token builtin">coerce</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span>
        default<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># 重写字段，因为如所写，所有的字段都是静态的，不能根据数据库同步，所以每次实例化类数据的时候都要初始化一下</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RegisterForm<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token comment"># 原来只有俩个现在页面显示3个，当然也可以去数据库中拿，使数据动态起来</span>
        self<span class="token punctuation">.</span>favor<span class="token punctuation">.</span>choices <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'篮球'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'足球'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'羽毛球'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">#定制钩子函数，使用validate_字段名</span>
    <span class="token keyword">def</span> <span class="token function">validate_pwd_confirm</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        自定义pwd_confirm字段规则，例：与pwd字段是否一致
        :param field:
        :return:
        &quot;&quot;&quot;</span>
        <span class="token comment"># 最开始初始化时，self.data中已经有所有的值</span>

        <span class="token keyword">if</span> field<span class="token punctuation">.</span>data <span class="token operator">!=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'pwd'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token comment"># raise validators.ValidationError(&quot;密码不一致&quot;) # 继续后续验证</span>
            <span class="token keyword">raise</span> validators<span class="token punctuation">.</span>StopValidation<span class="token punctuation">(</span><span class="token string">&quot;密码不一致&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 不再继续后续验证</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        <span class="token comment">#data是传入的默认值，表示gender字段默认选中1，来实例化form</span>
        form <span class="token operator">=</span> RegisterForm<span class="token punctuation">(</span>data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'gender'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'hobby'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'register.html'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 使用formdata接收数据</span>
        form <span class="token operator">=</span> RegisterForm<span class="token punctuation">(</span>formdata<span class="token operator">=</span>request<span class="token punctuation">.</span>form<span class="token punctuation">)</span>
        <span class="token keyword">if</span> form<span class="token punctuation">.</span>validate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'用户提交数据通过格式验证，提交的值为：'</span><span class="token punctuation">,</span> form<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>form<span class="token punctuation">.</span>errors<span class="token punctuation">)</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'register.html'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>register.html文件，可遵循for循环</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;Title&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;用户注册&lt;/h1&gt;
&lt;form method=&quot;post&quot; novalidate style=&quot;padding:0  50px&quot;&gt;
    {% for item in form %}
    &lt;p&gt;{{item.label}}: {{item}} {{item.errors[0] }}&lt;/p&gt;
    {% endfor %}
    &lt;input type=&quot;submit&quot; value=&quot;提交&quot;&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></li></ul> <h2 id="wtforms-组件"><a href="#wtforms-组件" class="header-anchor">#</a> WTForms 组件</h2> <h5 id="实现方式"><a href="#实现方式" class="header-anchor">#</a> 实现方式</h5> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">LoginForm</span><span class="token punctuation">(</span>Form<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#字段（内部包含正则表达式）</span>
    name <span class="token operator">=</span> simple<span class="token punctuation">.</span>StringField<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">'用户名'</span><span class="token punctuation">,</span>
        validators<span class="token operator">=</span><span class="token punctuation">[</span>
            <span class="token comment">#内部校验器</span>
            validators<span class="token punctuation">.</span>DataRequired<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">'用户名不能为空.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            validators<span class="token punctuation">.</span>Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">'用户名长度必须大于%(min)d且小于%(max)d'</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">#页面的显示插件</span>
        widget<span class="token operator">=</span>widgets<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">#给插件添加的属性</span>
        render_kw<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'form-control'</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment">#字段</span>
    pwd <span class="token operator">=</span> simple<span class="token punctuation">.</span>PasswordField<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">'密码'</span><span class="token punctuation">,</span>
        validators<span class="token operator">=</span><span class="token punctuation">[</span>
            validators<span class="token punctuation">.</span>DataRequired<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">'密码不能为空.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            validators<span class="token punctuation">.</span>Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">'用户名长度必须大于%(min)d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">#正则验证</span>
            validators<span class="token punctuation">.</span>Regexp<span class="token punctuation">(</span>regex<span class="token operator">=</span><span class="token string">&quot;^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[$@$!%*?&amp;])[A-Za-z\d$@$!%*?&amp;]{8,}&quot;</span><span class="token punctuation">,</span>message<span class="token operator">=</span><span class="token string">'密码至少8个字符，至少1个大写字母，1个小写字母，1个数字和1个特殊字符'</span><span class="token punctuation">)</span>

        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        widget<span class="token operator">=</span>widgets<span class="token punctuation">.</span>PasswordInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        render_kw<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'form-control'</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
</code></pre></div><p>​		这里我们以上面的继承Form类的类为例，LoginForm类是Form的子类，如果我们要实例化LoginForm成对象form，那么，LoginForm中的name、pwd又是字段类的对象，即实例化的form将也拥有name、pwd字段对象，在进行渲染时触发了form的for循环，按理说对象是没有for循环机制的，除非类中实现了 <code>__iter__</code>, 除了这个内置方法还有很多方法比如：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#情景一：</span>
	obj <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token comment">#也就是说触发了__str__方法，相应的会打印出 &lt;input /&gt;,相当于前端的form.name效果</span>
    <span class="token comment">#&lt;input class=&quot;form-control&quot; id=&quot;name&quot; name=&quot;name&quot; required type=&quot;text&quot; value=&quot;&quot;&gt;</span>
    
    <span class="token comment">#情景二：</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> obj<span class="token punctuation">:</span>  <span class="token comment">#相当于触发了__iter__</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>  <span class="token comment">#打印字段对象，触发__str__</span>
    <span class="token comment">#&lt;input class=&quot;form-control&quot; id=&quot;name&quot; name=&quot;name&quot; required type=&quot;text&quot; value=&quot;&quot;&gt;</span>
	<span class="token comment">#&lt;input class=&quot;form-control&quot; id=&quot;pwd&quot; name=&quot;pwd&quot; required type=&quot;password&quot; value=&quot;&quot;&gt;</span>
    
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        form <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>
</code></pre></div><ul><li><h5 id="演示类层层包裹"><a href="#演示类层层包裹" class="header-anchor">#</a> 演示类层层包裹</h5> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">InputText</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&lt;input type='type'/&gt;&quot;</span>

<span class="token keyword">class</span> <span class="token class-name">InputEmail</span><span class="token punctuation">:</span> <span class="token comment">#插件</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&lt;input type='email'/&gt;&quot;</span>

<span class="token keyword">class</span> <span class="token class-name">StringField</span><span class="token punctuation">:</span>  <span class="token comment">#字段类</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>wg<span class="token operator">=</span>InputText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>wg <span class="token operator">=</span> wg

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 此str可以触发自身的，还可以继承上一个</span>
        <span class="token comment"># return 'xxx'</span>

        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>wg<span class="token punctuation">)</span>  <span class="token comment"># 自动触发上一级的__str__</span>

<span class="token keyword">class</span> <span class="token class-name">LoginForm</span><span class="token punctuation">:</span>  <span class="token comment">#form类</span>
    a <span class="token operator">=</span> StringField<span class="token punctuation">(</span><span class="token punctuation">)</span>
    b <span class="token operator">=</span> StringField<span class="token punctuation">(</span>wg<span class="token operator">=</span>InputEmail<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

c <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>a<span class="token punctuation">)</span> <span class="token comment">#&lt;input type='type'/&gt;</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>b<span class="token punctuation">)</span> <span class="token comment">#&lt;input type='email'/&gt;</span>
</code></pre></div></li> <li><h5 id="wtforms中form类中字段源码部分"><a href="#wtforms中form类中字段源码部分" class="header-anchor">#</a> WTForms中Form类中字段源码部分</h5> <p>我们以StringFields为例，其他的也是类似的，点击看源码</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">StringField</span><span class="token punctuation">(</span>Field<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    This field is the base for most of the more complicated fields, and
    represents an ``&lt;input type=&quot;text&quot;&gt;``.
    &quot;&quot;&quot;</span>
    widget <span class="token operator">=</span> widgets<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_formdata</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> valuelist<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> valuelist<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>data <span class="token operator">=</span> valuelist<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>data <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token string">''</span>

    <span class="token keyword">def</span> <span class="token function">_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> text_type<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>data <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token string">''</span>
</code></pre></div><p>当模板中使用了form.name时（name假如时StringField的对象），那么就会触发StringField的 <code>__str__</code> 方法，找父类Field的 <code>__str__</code> 方法</p> <div class="language-python extra-class"><pre class="language-python"><code>    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Returns a HTML representation of the field. For more powerful rendering,
        see the `__call__` method.
        &quot;&quot;&quot;</span>
        <span class="token keyword">return</span> self<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#触发Field的__call__方法</span>
    
    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Render this field as HTML, using keyword args as additional attributes.

        This delegates rendering to
        :meth:`meta.render_field &lt;wtforms.meta.DefaultMeta.render_field&gt;`
        whose default behavior is to call the field's widget, passing any
        keyword arguments from this call along to the widget.

        In all of the WTForms HTML widgets, keyword arguments are turned to
        HTML attributes, though in theory a widget is free to do anything it
        wants with the supplied keyword arguments, and widgets don't have to
        even do anything related to HTML.
        &quot;&quot;&quot;</span>
        <span class="token comment">#这里的meta，也就是我们在执行FormMeta(type)的__call__方法时，通过查找继承类的Meta属性，在Form --&gt; Meta = DefaultMeta,找到的类，并将实例化的结果赋值给self.meta</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>render_field<span class="token punctuation">(</span>self<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span> <span class="token comment">#这里的self是StringField</span>
</code></pre></div></li></ul> <div class="language- extra-class"><pre class="language-text"><code>  
调用render_field(self, kwargs)，将触发各自字段插件的call方法
  
  ```python
      def render_field(self, field, render_kw): #field为传入的StringField对象，包含里面的插件
          &quot;&quot;&quot;
          render_field allows customization of how widget rendering is done.
  
          The default implementation calls ``field.widget(field, **render_kw)``
          &quot;&quot;&quot;
          other_kw = getattr(field, 'render_kw', None)
          if other_kw is not None:
              render_kw = dict(other_kw, **render_kw)
          return field.widget(field, **render_kw)   #触发插件的call方法，这里是TextInput，因为widget本身已经是对象了，加括号就要执行call方法
</code></pre></div><p>查看插件TextInput的<code>__call__</code>方法</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">TextInput</span><span class="token punctuation">(</span>Input<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Render a single-line text input.
    &quot;&quot;&quot;</span>
    input_type <span class="token operator">=</span> <span class="token string">'text'</span>
    
 <span class="token comment">#打开Input类的call方法：</span>
    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> field<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">#返回模板</span>
        kwargs<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
        kwargs<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>input_type<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'value'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> kwargs<span class="token punctuation">:</span>
            kwargs<span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span> <span class="token operator">=</span> field<span class="token punctuation">.</span>_value<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'required'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> kwargs <span class="token keyword">and</span> <span class="token string">'required'</span> <span class="token keyword">in</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> <span class="token string">'flags'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            kwargs<span class="token punctuation">[</span><span class="token string">'required'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span> HTMLString<span class="token punctuation">(</span><span class="token string">'&lt;input %s&gt;'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>html_params<span class="token punctuation">(</span>name<span class="token operator">=</span>field<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="wtforms中的校验"><a href="#wtforms中的校验" class="header-anchor">#</a> WTForms中的校验</h5> <ul><li><p>后台定义好正则规则，生成HTML   --&gt;    插件</p></li> <li><p>对数据进行校验   --&gt;  字段</p></li> <li><p>Form的继承类  --&gt; 用来统一管理全部字段格式</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">InputText</span><span class="token punctuation">:</span>  <span class="token comment">#生成HTML</span>
    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&lt;input type='type'/&gt;&quot;</span>

<span class="token keyword">class</span> <span class="token class-name">InputEmail</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&lt;input type='email'/&gt;&quot;</span>

<span class="token keyword">class</span> <span class="token class-name">StringField</span><span class="token punctuation">:</span>  <span class="token comment">#数据校验</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>reg<span class="token punctuation">,</span>wg<span class="token operator">=</span>InputText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>wg <span class="token operator">=</span> wg
        self<span class="token punctuation">.</span>reg <span class="token operator">=</span> reg

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>wg<span class="token punctuation">)</span>  <span class="token comment"># 自动触发上一级的__str__</span>

    <span class="token keyword">def</span> <span class="token function">valid</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">import</span> re
        <span class="token comment"># 自定义字段验证</span>
        <span class="token keyword">return</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>val<span class="token punctuation">,</span>self<span class="token punctuation">.</span>reg<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">LoginForm</span><span class="token punctuation">:</span>   <span class="token comment">#统一管理字段</span>
    a <span class="token operator">=</span> StringField<span class="token punctuation">(</span>reg<span class="token operator">=</span><span class="token string">&quot;\d+&quot;</span><span class="token punctuation">)</span>
    b <span class="token operator">=</span> StringField<span class="token punctuation">(</span>reg<span class="token operator">=</span><span class="token string">'\w+'</span><span class="token punctuation">,</span> wg<span class="token operator">=</span>InputEmail<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>formdata<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 前端传入的数据，&quot;用户发来的所有数据{user:'df',pwd:'sdf'}&quot;</span>
        self<span class="token punctuation">.</span>formdata <span class="token operator">=</span>formdata

    <span class="token keyword">def</span> <span class="token function">validate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        fields <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>a<span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>b<span class="token punctuation">}</span>
        <span class="token keyword">for</span> name<span class="token punctuation">,</span> field <span class="token keyword">in</span> fields<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">#调用每个字段的校验规则</span>
            <span class="token comment">#name 是字段，field 是字段对应的插件对象 a = StringField(reg=&quot;\d+&quot;)</span>

            <span class="token comment">#从前端获取的数据中取出对应字段的值，前提是要求用户提供的数据的key 要与 字段保持一致 a {'a':'xx'}</span>
            <span class="token comment">#self.formdata.get(name)</span>
            field<span class="token punctuation">.</span>valid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>formdata<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#可根据各字段的规则校验值，校验每个字段的值是否合乎规则</span>

c <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span>formdata<span class="token operator">=</span>request<span class="token punctuation">.</span>form<span class="token punctuation">)</span>
</code></pre></div><ul><li><p>我们可以使用 <code>___dict__</code> 来查看LoginForm类有那些属性</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">print</span><span class="token punctuation">(</span>LoginForm<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>

 <span class="token punctuation">{</span>
	<span class="token string">'__module__'</span><span class="token punctuation">:</span> <span class="token string">'__main__'</span><span class="token punctuation">,</span>
	<span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span> UnboundField<span class="token punctuation">(</span>StringField<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
		<span class="token string">'label'</span><span class="token punctuation">:</span> <span class="token string">'用户名'</span><span class="token punctuation">,</span>
		<span class="token string">'validators'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">&lt;</span> wtforms<span class="token punctuation">.</span>validators<span class="token punctuation">.</span>DataRequired <span class="token builtin">object</span> at <span class="token number">0x000001AE6CB1BF98</span> <span class="token operator">&gt;</span> <span class="token punctuation">,</span> <span class="token operator">&lt;</span> wtforms<span class="token punctuation">.</span>validators<span class="token punctuation">.</span>Length <span class="token builtin">object</span> at <span class="token number">0x000001AE6CB2E3C8</span> <span class="token operator">&gt;</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token string">'widget'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span> wtforms<span class="token punctuation">.</span>widgets<span class="token punctuation">.</span>core<span class="token punctuation">.</span>TextInput <span class="token builtin">object</span> at <span class="token number">0x000001AE6CB2E198</span> <span class="token operator">&gt;</span> <span class="token punctuation">,</span>
		<span class="token string">'render_kw'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
			<span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'form-control'</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">,</span>
	<span class="token string">'pwd'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span> UnboundField<span class="token punctuation">(</span>PasswordField<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
		<span class="token string">'label'</span><span class="token punctuation">:</span> <span class="token string">'密码'</span><span class="token punctuation">,</span>
		<span class="token string">'validators'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">&lt;</span> wtforms<span class="token punctuation">.</span>validators<span class="token punctuation">.</span>DataRequired <span class="token builtin">object</span> at <span class="token number">0x000001AE6CB2E2E8</span> <span class="token operator">&gt;</span> <span class="token punctuation">,</span> <span class="token operator">&lt;</span> wtforms<span class="token punctuation">.</span>validators<span class="token punctuation">.</span>Length <span class="token builtin">object</span> at <span class="token number">0x000001AE6CB2EE80</span> <span class="token operator">&gt;</span> <span class="token punctuation">,</span> <span class="token operator">&lt;</span> wtforms<span class="token punctuation">.</span>validators<span class="token punctuation">.</span>Regexp <span class="token builtin">object</span> at <span class="token number">0x000001AE6CB2EF98</span> <span class="token operator">&gt;</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token string">'widget'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span> wtforms<span class="token punctuation">.</span>widgets<span class="token punctuation">.</span>core<span class="token punctuation">.</span>PasswordInput <span class="token builtin">object</span> at <span class="token number">0x000001AE6CB2EFD0</span> <span class="token operator">&gt;</span> <span class="token punctuation">,</span>
		<span class="token string">'render_kw'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
			<span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'form-control'</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">,</span>
	<span class="token string">'__doc__'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
	<span class="token string">'_unbound_fields'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
	<span class="token string">'_wtforms_meta'</span><span class="token punctuation">:</span> <span class="token boolean">None</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ul> <h2 id="wtforms的源码实现"><a href="#wtforms的源码实现" class="header-anchor">#</a> WTForms的源码实现</h2> <p>还是以登陆例子开头</p> <div class="language-python extra-class"><pre class="language-python"><code>app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">,</span> template_folder<span class="token operator">=</span><span class="token string">'templates'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>debug <span class="token operator">=</span> <span class="token boolean">True</span>

 <span class="token comment">#由于 metaclass=FormMeta,所以LoginForm是由FormMeta创建，执行init方法</span>
 <span class="token comment">#1、在init方法中生成了 LoginForm._unbound_fields=None</span>
 <span class="token comment">#				     LoginForm._wtforms_meta = None</span>
    
 <span class="token comment">#2、解释字段：</span>
 <span class="token comment">#		name=simple.StringField()</span>
 <span class="token comment">#   	pwd =simple.StringField()</span>
 <span class="token comment">#  结果：name = UnboundField(cls,*args,**kwargs)</span>
 <span class="token comment">#   	 pwd = UnboundField(cls,*args,**kwargs)  相当于将cls=simple.StringField, StringFiel的参数传入</span>
<span class="token keyword">class</span> <span class="token class-name">LoginForm</span><span class="token punctuation">(</span>Form<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#3、执行StringField的new方法，本身没有就去找父类Field，在实例化之前先执行__new__、再执行__init__</span>
    name <span class="token operator">=</span> simple<span class="token punctuation">.</span>StringField<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">'用户名'</span><span class="token punctuation">,</span>
        validators<span class="token operator">=</span><span class="token punctuation">[</span>
            <span class="token comment">#内部校验器</span>
            validators<span class="token punctuation">.</span>DataRequired<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">'用户名不能为空.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            validators<span class="token punctuation">.</span>Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">'用户名长度必须大于%(min)d且小于%(max)d'</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">#页面的显示插件</span>
        widget<span class="token operator">=</span>widgets<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">#给插件添加的属性</span>
        render_kw<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'form-control'</span><span class="token punctuation">}</span>

    <span class="token punctuation">)</span>

    pwd <span class="token operator">=</span> simple<span class="token punctuation">.</span>PasswordField<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">'密码'</span><span class="token punctuation">,</span>
        validators<span class="token operator">=</span><span class="token punctuation">[</span>
            validators<span class="token punctuation">.</span>DataRequired<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">'密码不能为空.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            validators<span class="token punctuation">.</span>Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">'用户名长度必须大于%(min)d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">#正则验证</span>
            validators<span class="token punctuation">.</span>Regexp<span class="token punctuation">(</span>regex<span class="token operator">=</span><span class="token string">&quot;^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[$@$!%*?&amp;])[A-Za-z\d$@$!%*?&amp;]{8,}&quot;</span><span class="token punctuation">,</span>
                              message<span class="token operator">=</span><span class="token string">'密码至少8个字符，至少1个大写字母，1个小写字母，1个数字和1个特殊字符'</span><span class="token punctuation">)</span>

        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        widget<span class="token operator">=</span>widgets<span class="token punctuation">.</span>PasswordInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        render_kw<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'form-control'</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        <span class="token comment">#实列LoginForm</span>
        <span class="token comment">#执行LoginForm的__new__方法，显然没有</span>
        <span class="token comment">#1、执行FormMeta的__call__方法，因为LoginForm是Form的继承类，而FormMeta是元类，先会触发__call__默认</span>
        	<span class="token comment">#返回的数据类型：</span>
           <span class="token triple-quoted-string string">&quot;&quot;&quot;
               fields=[
                    (name,UnboundField对象), 
                    (pwd,UnboundField对象), 
               ]
           &quot;&quot;&quot;</span>    
        <span class="token comment">#2、执行LoginForm的__init__方法</span>
            <span class="token comment">#返回的数据类型:</span>
                <span class="token comment">#form = {</span>
                <span class="token comment">#    _fields:{</span>
                <span class="token comment">#        name:StringField对象(widget=widget.TextInput()),</span>
                <span class="token comment">#        pwd:Password对象,</span>
                <span class="token comment">#    },</span>
                <span class="token comment">#    name:StringField对象,</span>
                <span class="token comment">#    pwd:Password对象,</span>
                <span class="token comment">#}</span>
        form <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment">#提交数据后再次实例化</span>
        <span class="token comment">#依旧的执行FormMeta的__call__方法，再执行LoginForm的__init__方法，</span>
        <span class="token comment">#但是这里主要多了一步：process()</span>
        form <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span>formdata<span class="token operator">=</span>request<span class="token punctuation">.</span>form<span class="token punctuation">)</span>  <span class="token comment"># 请求传过来给formdata，值.getlist('name')</span>
        <span class="token comment">#form = LoginForm(obj='值')  #传数据库对象ORM，在LoginForm类中可以 值.name/值.pwd </span>
        <span class="token comment">#form = LoginForm(data={})  #可传递一个字典过来 值['name']</span>
        
        <span class="token comment">#1、循环所有的字段，为每一个字段执行验证流程</span>
        <span class="token comment">#2、获取每个字段的钩子函数，为每个字段执行他的验证流程，字段.validate(钩子函数)</span>
        <span class="token keyword">if</span> form<span class="token punctuation">.</span>validate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'用户提交数据通过格式验证，提交的值为：'</span><span class="token punctuation">,</span> form<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>form<span class="token punctuation">.</span>errors<span class="token punctuation">)</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>
 
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p>首先，我们知道LoginForm类是继承的Form，所以我们先打开Form的源码部分，在打开Form之前必须执行with_metaclass函数，所以我们先查看with_metaclass函数</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">with_metaclass</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> meta<span class="token punctuation">(</span><span class="token string">&quot;NewBase&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>base<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#meta也就是下面传入的FormMeta类，从而触发它的call方法</span>
</code></pre></div><p>查看FormMeta类的call方法，和init方法</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">FormMeta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    <span class="token comment"># 最先执行FormMeta的init方法</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">type</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span>
        cls<span class="token punctuation">.</span>_unbound_fields <span class="token operator">=</span> <span class="token boolean">None</span>
        cls<span class="token punctuation">.</span>_wtforms_meta <span class="token operator">=</span> <span class="token boolean">None</span>
        
    <span class="token comment">#触发了继承类的new方法后执行call,即实例化时第一步执行，本身</span>
    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> cls<span class="token punctuation">.</span>_unbound_fields <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> <span class="token comment">#第一次显然为空，初始化就为空</span>
            
            fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token comment">#取出LoginForm类中__dict__的所有key:'__moudlue__'，'name','pwd','_unbound_field'...</span>
            <span class="token keyword">for</span> name <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># 排除以_开头的</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    unbound_field <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">)</span>  <span class="token comment">#从类中获得字段，也就是__dict__中的每个字段值</span>
                    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>unbound_field<span class="token punctuation">,</span> <span class="token string">'_formfield'</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#UnboundField开头将其设置为True</span>
                        fields<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> unbound_field<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#添加为元组在fields中</span>
           <span class="token triple-quoted-string string">&quot;&quot;&quot;
           fields=[
           		(name,UnboundField对象), 
         ]
           &quot;&quot;&quot;</span>     
  		<span class="token comment"># 根据计数器排序，元组排序，如果数字相同，就以第二个数字排序，如x[1],x[0]</span>
            fields<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>creation_counter<span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            cls<span class="token punctuation">.</span>_unbound_fields <span class="token operator">=</span> fields  <span class="token comment"># 实例化之后，_unbound_fields不为空了</span>

        <span class="token comment"># Create a subclass of the 'class Meta' using all the ancestors.</span>
        <span class="token keyword">if</span> cls<span class="token punctuation">.</span>_wtforms_meta <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            bases <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token comment">#查找继承的类，钻石继承</span>
            <span class="token comment">#LoginForm</span>
            <span class="token comment">#Form --&gt; Meta = DefaultMeta, 存在Meta属性</span>
            <span class="token comment">#BaseForm</span>
            <span class="token keyword">for</span> mro_class <span class="token keyword">in</span> cls<span class="token punctuation">.</span>__mro__<span class="token punctuation">:</span>
                <span class="token comment">#查找每个继承的类中是否有 'Meta' 属性</span>
                <span class="token keyword">if</span> <span class="token string">'Meta'</span> <span class="token keyword">in</span> mro_class<span class="token punctuation">.</span>__dict__<span class="token punctuation">:</span>
                    <span class="token comment">#bases=[DefaultMeta,]</span>
                    bases<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mro_class<span class="token punctuation">.</span>Meta<span class="token punctuation">)</span>
                    
             <span class="token triple-quoted-string string">'''
             class Meta(DefalutMeta)：
             	pass
             '''</span>
            cls<span class="token punctuation">.</span>_wtforms_meta <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">'Meta'</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>bases<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">#cls.wtform_meta也有值了</span>
        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__call__<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token comment">#执行type.__call__触发本身的init方法</span>
</code></pre></div><p>Form的源码的部分</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Form</span><span class="token punctuation">(</span>with_metaclass<span class="token punctuation">(</span>FormMeta<span class="token punctuation">,</span> BaseForm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    Meta <span class="token operator">=</span> DefaultMeta
  
    <span class="token comment">#执行完FormMeta的__call__方法后，执行此初始化函数</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> formdata<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> obj<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> prefix<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> meta<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#self._wtforms_meta 为继承DefaultMeta类的Meta类，有CSRF生成input框的功能 </span>
        meta_obj <span class="token operator">=</span> self<span class="token punctuation">.</span>_wtforms_meta<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment">#添加meta信息：或者传入meta信息</span>
        <span class="token comment">#如，我们写了： class Meta:</span>
        <span class="token comment"># 				 csrf = True</span>
        <span class="token keyword">if</span> meta <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            meta_obj<span class="token punctuation">.</span>update_values<span class="token punctuation">(</span>meta<span class="token punctuation">)</span> <span class="token comment">#将信息添加进去</span>
        
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
           _unbound_fields=[
           		(name,UnboundField对象), 
          	 ]
           meta:Meta()
        &quot;&quot;&quot;</span>   
        <span class="token comment">#执行父类的构造方法,触发的时BaseForm的__init__函数，元类的init函数已经在初始化时用来生成类了，返回self.field</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Form<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_unbound_fields<span class="token punctuation">,</span> meta<span class="token operator">=</span>meta_obj<span class="token punctuation">,</span> prefix<span class="token operator">=</span>prefix<span class="token punctuation">)</span>

        <span class="token keyword">for</span> name<span class="token punctuation">,</span> field <span class="token keyword">in</span> iteritems<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_fields<span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment">#给对象赋值，因为目前要想取值只能：form._fields['name'],我们只想form.name就能取值</span>
            <span class="token comment">#循环：form.name = field</span>
            <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> field<span class="token punctuation">)</span>
         
        <span class="token comment"># 为每个字段设置默认值，以及提供验证的值</span>
        self<span class="token punctuation">.</span>process<span class="token punctuation">(</span>formdata<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
    <span class="token keyword">def</span> <span class="token function">validate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Validates the form by calling `validate` on each field, passing any
        extra `Form.validate_&lt;fieldname&gt;` validators to the field validator.
        &quot;&quot;&quot;</span>
        extra <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token comment">#循环每个字段</span>
        <span class="token keyword">for</span> name <span class="token keyword">in</span> self<span class="token punctuation">.</span>_fields<span class="token punctuation">:</span>
            inline <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">,</span> <span class="token string">'validate_%s'</span> <span class="token operator">%</span> name<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> inline <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                extra<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>inline<span class="token punctuation">]</span>
</code></pre></div></li> <li><p>触发的BaseForm的<code>__init__</code>函数</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token number">1</span>、查看BaseForm
<span class="token keyword">class</span> <span class="token class-name">BaseForm</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Base Form Class.  Provides core behaviour like field construction,
    validation, and data and error proxying.
    &quot;&quot;&quot;</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> fields<span class="token punctuation">,</span> prefix<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> meta<span class="token operator">=</span>DefaultMeta<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> prefix <span class="token keyword">and</span> prefix<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token string">'-_;:/.'</span><span class="token punctuation">:</span>
            prefix <span class="token operator">+=</span> <span class="token string">'-'</span>

        self<span class="token punctuation">.</span>meta <span class="token operator">=</span> meta
        self<span class="token punctuation">.</span>_prefix <span class="token operator">=</span> prefix
        self<span class="token punctuation">.</span>_errors <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token comment">#有序字典，用来存储所有的字段和对应的值</span>
        self<span class="token punctuation">.</span>_fields <span class="token operator">=</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>fields<span class="token punctuation">,</span> <span class="token string">'items'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            fields <span class="token operator">=</span> fields<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>

        translations <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_translations<span class="token punctuation">(</span><span class="token punctuation">)</span>
        extra_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> meta<span class="token punctuation">.</span>csrf<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_csrf <span class="token operator">=</span> meta<span class="token punctuation">.</span>build_csrf<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
            <span class="token comment">#添加一个隐藏的字段在fields中</span>
            extra_fields<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_csrf<span class="token punctuation">.</span>setup_form<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">)</span>
		
        <span class="token comment">#chain链条函数将fields字段和刚添加的字段进行拼接，然后进行for循环</span>
        <span class="token keyword">for</span> name<span class="token punctuation">,</span> unbound_field <span class="token keyword">in</span> itertools<span class="token punctuation">.</span>chain<span class="token punctuation">(</span>fields<span class="token punctuation">,</span> extra_fields<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#将字段名等用工厂化字典做成option参数</span>
            options <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">,</span> prefix<span class="token operator">=</span>prefix<span class="token punctuation">,</span> translations<span class="token operator">=</span>translations<span class="token punctuation">)</span>
            <span class="token comment"># 调用meta的bind_field方法，在这里猜得到真正的实例化</span>
            field <span class="token operator">=</span> meta<span class="token punctuation">.</span>bind_field<span class="token punctuation">(</span>self<span class="token punctuation">,</span> unbound_field<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
            <span class="token comment"># 放回到BaseForm的对象的self._fields中</span>
            self<span class="token punctuation">.</span>_fields<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> field
            
 <span class="token number">2</span>、点击bind_field<span class="token punctuation">(</span><span class="token punctuation">)</span> 函数
	<span class="token keyword">def</span> <span class="token function">bind_field</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> form<span class="token punctuation">,</span> unbound_field<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#这里的unbound_field为我们传入的字段对象，如StringField的bind函数执行</span>
        <span class="token keyword">return</span> unbound_field<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>form<span class="token operator">=</span>form<span class="token punctuation">,</span> <span class="token operator">**</span>options<span class="token punctuation">)</span>
    
<span class="token number">3</span>、在StringField中的父类的bind的函数
<span class="token keyword">class</span> <span class="token class-name">UnboundField</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    _formfield <span class="token operator">=</span> <span class="token boolean">True</span>
    creation_counter <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> field_class<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        UnboundField<span class="token punctuation">.</span>creation_counter <span class="token operator">+=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>field_class <span class="token operator">=</span> field_class
        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args
        self<span class="token punctuation">.</span>kwargs <span class="token operator">=</span> kwargs
        self<span class="token punctuation">.</span>creation_counter <span class="token operator">=</span> UnboundField<span class="token punctuation">.</span>creation_counter

    <span class="token keyword">def</span> <span class="token function">bind</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> form<span class="token punctuation">,</span> name<span class="token punctuation">,</span> prefix<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> translations<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        kw <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>kwargs<span class="token punctuation">,</span>
            _form<span class="token operator">=</span>form<span class="token punctuation">,</span>
            _prefix<span class="token operator">=</span>prefix<span class="token punctuation">,</span>
            _name<span class="token operator">=</span>name<span class="token punctuation">,</span>
            _translations<span class="token operator">=</span>translations<span class="token punctuation">,</span>
            <span class="token operator">**</span>kwargs
        <span class="token punctuation">)</span>
        <span class="token comment">#field_class这里可以是具体的字段，如StringField、等，在这里实例化，这时候下去执行具体的init函数</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>field_class<span class="token punctuation">(</span><span class="token operator">*</span>self<span class="token punctuation">.</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>

</code></pre></div></li> <li><p>以 StringField 字段为例，在我们实例化之前，先执行继承的Field的<code>__new__</code> 方法、再执行<code>__init__</code></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token string">'_form'</span> <span class="token keyword">in</span> kwargs <span class="token keyword">and</span> <span class="token string">'_name'</span> <span class="token keyword">in</span> kwargs<span class="token punctuation">:</span>
            <span class="token comment"># 如果有以上的这两个参数，才会返回Field的对象</span>
            <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span>Field<span class="token punctuation">,</span> cls<span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment">#一般情况下返回的是，UnboundField对象，将StringField传入UnboundField多封装了一层</span>
            <span class="token keyword">return</span> UnboundField<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> validators<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> filters<span class="token operator">=</span><span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 description<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> widget<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 render_kw<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> _form<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> _name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> _prefix<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span>
                 _translations<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> _meta<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> _translations <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_translations <span class="token operator">=</span> _translations

        <span class="token keyword">if</span> _meta <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>meta <span class="token operator">=</span> _meta
        <span class="token keyword">elif</span> _form <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>meta <span class="token operator">=</span> _form<span class="token punctuation">.</span>meta
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">&quot;Must provide one of _form or _meta&quot;</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>default <span class="token operator">=</span> default
        self<span class="token punctuation">.</span>description <span class="token operator">=</span> description
        self<span class="token punctuation">.</span>render_kw <span class="token operator">=</span> render_kw
        self<span class="token punctuation">.</span>filters <span class="token operator">=</span> filters
        self<span class="token punctuation">.</span>flags <span class="token operator">=</span> Flags<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> _prefix <span class="token operator">+</span> _name
        self<span class="token punctuation">.</span>short_name <span class="token operator">=</span> _name
        self<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__
        self<span class="token punctuation">.</span>validators <span class="token operator">=</span> validators <span class="token keyword">or</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>validators<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">=</span> <span class="token builtin">id</span> <span class="token keyword">or</span> self<span class="token punctuation">.</span>name
        self<span class="token punctuation">.</span>label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> label <span class="token keyword">if</span> label <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> self<span class="token punctuation">.</span>gettext<span class="token punctuation">(</span>_name<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> widget <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>widget <span class="token operator">=</span> widget

        <span class="token keyword">for</span> v <span class="token keyword">in</span> itertools<span class="token punctuation">.</span>chain<span class="token punctuation">(</span>self<span class="token punctuation">.</span>validators<span class="token punctuation">,</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>widget<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            flags <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token string">'field_flags'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> f <span class="token keyword">in</span> flags<span class="token punctuation">:</span>
                <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>flags<span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>

</code></pre></div><p><strong><code>UnboundField</code>的源码和作用</strong>：由于传入的字段如：name、pwd，在前端使用的时候，是有顺序的，否则每次form的的输出顺序就会出错，那么如何实现字段的有序性？<code>UnboundField</code>在源码中封装了一个计数器‘’，标记每个字段的顺序</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">UnboundField</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    _formfield <span class="token operator">=</span> <span class="token boolean">True</span>
    creation_counter <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> field_class<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        UnboundField<span class="token punctuation">.</span>creation_counter <span class="token operator">+=</span> <span class="token number">1</span>  <span class="token comment">#计数器</span>
        self<span class="token punctuation">.</span>field_class <span class="token operator">=</span> field_class
        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args
        self<span class="token punctuation">.</span>kwargs <span class="token operator">=</span> kwargs
        self<span class="token punctuation">.</span>creation_counter <span class="token operator">=</span> UnboundField<span class="token punctuation">.</span>creation_counter  <span class="token comment">#将计数的值给每个字段</span>
</code></pre></div></li></ul> <h4 id="form的提交数据校验"><a href="#form的提交数据校验" class="header-anchor">#</a> Form的提交数据校验</h4> <ul><li><p>和之前的LoginForm的实例化类似，主要是多出一步process函数，在<code>class Form(with_metaclass(FormMeta, BaseForm))</code>的init中，点击查看源码（继承的BaseForm）</p> <div class="language-python extra-class"><pre class="language-python"><code> <span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> formdata<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> obj<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Take form, object data, and keyword arg input and have the fields
        process them.

        :param formdata:
            Used to pass data coming from the enduser, usually `request.POST` or
            equivalent.
        :param obj:
            If `formdata` is empty or not provided, this object is checked for
            attributes matching form field names, which will be used for field
            values.
        :param data:
            If provided, must be a dictionary of data. This is only used if
            `formdata` is empty or not provided and `obj` does not contain
            an attribute named the same as the field.
        :param `**kwargs`:
            If `formdata` is empty or not provided and `obj` does not contain
            an attribute named the same as a field, form will assign the value
            of a matching keyword argument to the field, if one exists.
        &quot;&quot;&quot;</span>
        <span class="token comment">#获取request.POST数据，解包后：formdata={'name':'xxx','pwd':123}</span>
        formdata <span class="token operator">=</span> self<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>wrap_formdata<span class="token punctuation">(</span>self<span class="token punctuation">,</span> formdata<span class="token punctuation">)</span>

        <span class="token keyword">if</span> data <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token comment"># XXX we want to eventually process 'data' as a new entity.</span>
            <span class="token comment">#     Temporarily, this can simply be merged with kwargs.</span>
            kwargs <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
		
        <span class="token comment"># 循环所有的字段</span>
        <span class="token keyword">for</span> name<span class="token punctuation">,</span> field<span class="token punctuation">,</span> <span class="token keyword">in</span> iteritems<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_fields<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#obj 传值？</span>
            <span class="token keyword">if</span> obj <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
                field<span class="token punctuation">.</span>process<span class="token punctuation">(</span>formdata<span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> name <span class="token keyword">in</span> kwargs<span class="token punctuation">:</span>
                field<span class="token punctuation">.</span>process<span class="token punctuation">(</span>formdata<span class="token punctuation">,</span> kwargs<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment">#自行各自字段的process方法，把自己对应的值放到自己数据中，处理完后每个字段的对应的对象中，再添加一个数据</span>
                field<span class="token punctuation">.</span>process<span class="token punctuation">(</span>formdata<span class="token punctuation">)</span>
                
              <span class="token comment">#返回的数据类型:</span>
                <span class="token comment">#form = {</span>
                <span class="token comment">#    _fields:{</span>
                <span class="token comment">#        name:StringField对象(widget=widget.TextInput(name='你输入的用户名'),),</span>
                <span class="token comment">#        pwd:Password对象(widget=widget.TextInput(pwd ='密码'),),</span>
                <span class="token comment">#    },</span>
                <span class="token comment">#    name:StringField对象,</span>
                <span class="token comment">#    pwd:Password对象,</span>
                <span class="token comment">#}</span>
</code></pre></div></li> <li><h5 id="执行validate函数"><a href="#执行validate函数" class="header-anchor">#</a> 执行validate函数</h5> <div class="language-python extra-class"><pre class="language-python"><code>  	<span class="token keyword">def</span> <span class="token function">validate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Validates the form by calling `validate` on each field, passing any
        extra `Form.validate_&lt;fieldname&gt;` validators to the field validator.
        &quot;&quot;&quot;</span>
        extra <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
         <span class="token triple-quoted-string string">'''
           _fields:{
               name:StringField对象(widget=widget.TextInput(name='你输入的用户名'),),
               pwd:Password对象(widget=widget.TextInput(pwd ='密码'),),
             }
        '''</span>
        <span class="token keyword">for</span> name <span class="token keyword">in</span> self<span class="token punctuation">.</span>_fields<span class="token punctuation">:</span>
            <span class="token comment">#name --&gt; validate_name</span>
            <span class="token comment">#pwd --&gt; validate_pwd</span>
            <span class="token comment">#去每个字段拿钩子函数</span>
            inline <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">,</span> <span class="token string">'validate_%s'</span> <span class="token operator">%</span> name<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> inline <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token comment">#有钩子函数就放进extra中</span>
                extra<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>inline<span class="token punctuation">]</span>

        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span>Form<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>validate<span class="token punctuation">(</span>extra<span class="token punctuation">)</span> <span class="token comment">#传入extra字典，触发BaseForm的validate函数</span>
    
<span class="token number">2</span>、查看BaseForm的validate函数
    <span class="token keyword">def</span> <span class="token function">validate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> extra_validators<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Validates the form by calling `validate` on each field.

        :param extra_validators:
            If provided, is a dict mapping field names to a sequence of
            callables which will be passed as extra validators to the field's
            `validate` method.

        Returns `True` if no errors occur.
        &quot;&quot;&quot;</span>
        <span class="token comment">#extra_validators = {name:[钩子函数,],pwd:[钩子函数,]}</span>
        self<span class="token punctuation">.</span>_errors <span class="token operator">=</span> <span class="token boolean">None</span>
        success <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token comment">#取出每个字段</span>
        <span class="token comment">#name=name  field=StringField对象</span>
        <span class="token keyword">for</span> name<span class="token punctuation">,</span> field <span class="token keyword">in</span> iteritems<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_fields<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> extra_validators <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> name <span class="token keyword">in</span> extra_validators<span class="token punctuation">:</span>
                <span class="token comment">#赋值给extra将钩子函数</span>
                extra <span class="token operator">=</span> extra_validators<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment">#没有就是一个空元组</span>
                extra <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token comment">#将钩子函数传入每个字段的validate中，</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> field<span class="token punctuation">.</span>validate<span class="token punctuation">(</span>self<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">:</span>
                success <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">return</span> success

<span class="token number">3</span>、最后在每个字段的validate方法中执行所有的验证规则，以StringField为例，其实所有的字段类都是继承Feild类，在其中执行的validate校验

  <span class="token keyword">def</span> <span class="token function">validate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> form<span class="token punctuation">,</span> extra_validators<span class="token operator">=</span><span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#传入的钩子函数</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Validates the field and returns True or False. `self.errors` will
        contain any errors raised during validation. This is usually only
        called by `Form.validate`.

        Subfields shouldn't override this, but rather override either
        `pre_validate`, `post_validate` or both, depending on needs.

        :param form: The form the field belongs to.
        :param extra_validators: A sequence of extra validators to run.
        &quot;&quot;&quot;</span>
        <span class="token comment">#extra_validators=[钩子函数,]</span>
        self<span class="token punctuation">.</span>errors <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>process_errors<span class="token punctuation">)</span>
        stop_validation <span class="token operator">=</span> <span class="token boolean">False</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>pre_validate<span class="token punctuation">(</span>form<span class="token punctuation">)</span>
        <span class="token keyword">except</span> StopValidation <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">if</span> e<span class="token punctuation">.</span>args <span class="token keyword">and</span> e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            stop_validation <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># Run validators</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> stop_validation<span class="token punctuation">:</span>
            <span class="token comment">#self.validators是内置校验函数，存在自身中，extra_validators是自定义的钩子函数，链条函数</span>
            chain <span class="token operator">=</span> itertools<span class="token punctuation">.</span>chain<span class="token punctuation">(</span>self<span class="token punctuation">.</span>validators<span class="token punctuation">,</span> extra_validators<span class="token punctuation">)</span>
            stop_validation <span class="token operator">=</span> self<span class="token punctuation">.</span>_run_validation_chain<span class="token punctuation">(</span>form<span class="token punctuation">,</span> chain<span class="token punctuation">)</span>

        <span class="token comment"># Call post_validate</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>post_validate<span class="token punctuation">(</span>form<span class="token punctuation">,</span> stop_validation<span class="token punctuation">)</span>
        <span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>errors<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
    
   <span class="token comment"># 执行每个字段的校验器，如果报错，返回False，下个字段不会再进行验证</span>
  <span class="token keyword">def</span> <span class="token function">_run_validation_chain</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> form<span class="token punctuation">,</span> validators<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Run a validation chain, stopping if any validator raises StopValidation.
        &quot;&quot;&quot;</span>
        <span class="token comment">#validators = [</span>
            <span class="token comment">#validators.DataRequired(message='用户名不能为空'),  #执行DataRequired的call方法</span>
            <span class="token comment">#钩子函数,</span>
        <span class="token comment">#]</span>
        <span class="token keyword">for</span> validator <span class="token keyword">in</span> validators<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>            
                validator<span class="token punctuation">(</span>form<span class="token punctuation">,</span> self<span class="token punctuation">)</span>
            <span class="token keyword">except</span> StopValidation <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">if</span> e<span class="token punctuation">.</span>args <span class="token keyword">and</span> e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">True</span>
            <span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token boolean">False</span>    
</code></pre></div></li> <li><h5 id="wtforms-给每个字段进行验证-也给用户预留了扩展的函数-相当于信号"><a href="#wtforms-给每个字段进行验证-也给用户预留了扩展的函数-相当于信号" class="header-anchor">#</a> WTForms 给每个字段进行验证，也给用户预留了扩展的函数，相当于信号</h5> <div class="language- extra-class"><pre class="language-text"><code>字段的pre_validate 【预留的扩展】
字段的_run_validation_chain，对正则和字段的钩子函数进行校验
字段的post_validate【预留的扩展】
</code></pre></div></li></ul> <h4 id="meta的使用"><a href="#meta的使用" class="header-anchor">#</a> Meta的使用</h4> <ul><li><p>使用Meta类可以定制自己的Form类</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding:utf-8 -*-</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> session
<span class="token keyword">from</span> wtforms <span class="token keyword">import</span> Form
<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>csrf<span class="token punctuation">.</span>core <span class="token keyword">import</span> CSRF
<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>fields <span class="token keyword">import</span> core
<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>fields <span class="token keyword">import</span> html5
<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>fields <span class="token keyword">import</span> simple
<span class="token keyword">from</span> wtforms <span class="token keyword">import</span> validators
<span class="token keyword">from</span> wtforms <span class="token keyword">import</span> widgets
<span class="token keyword">from</span> hashlib <span class="token keyword">import</span> md5

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">,</span> template_folder<span class="token operator">=</span><span class="token string">'templates'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>debug <span class="token operator">=</span> <span class="token boolean">True</span>


<span class="token keyword">class</span> <span class="token class-name">MyCSRF</span><span class="token punctuation">(</span>CSRF<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Generate a CSRF token based on the user's IP. I am probably not very
    secure, so don't use me.
    &quot;&quot;&quot;</span>
    <span class="token keyword">def</span> <span class="token function">setup_form</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> form<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>csrf_context <span class="token operator">=</span> form<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>csrf_context<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>csrf_secret <span class="token operator">=</span> form<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>csrf_secret
        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span>MyCSRF<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>setup_form<span class="token punctuation">(</span>form<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">generate_csrf_token</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> csrf_token<span class="token punctuation">)</span><span class="token punctuation">:</span>
        gid <span class="token operator">=</span> self<span class="token punctuation">.</span>csrf_secret <span class="token operator">+</span> self<span class="token punctuation">.</span>csrf_context
        token <span class="token operator">=</span> md5<span class="token punctuation">(</span>gid<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> token

    <span class="token keyword">def</span> <span class="token function">validate_csrf_token</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> form<span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>data<span class="token punctuation">,</span> field<span class="token punctuation">.</span>current_token<span class="token punctuation">)</span>
        <span class="token keyword">if</span> field<span class="token punctuation">.</span>data <span class="token operator">!=</span> field<span class="token punctuation">.</span>current_token<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'Invalid CSRF'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">TestForm</span><span class="token punctuation">(</span>Form<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> html5<span class="token punctuation">.</span>EmailField<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">'用户名'</span><span class="token punctuation">)</span>
    pwd <span class="token operator">=</span> simple<span class="token punctuation">.</span>StringField<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">'密码'</span><span class="token punctuation">)</span>

    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        <span class="token comment"># -- CSRF</span>
        <span class="token comment"># 是否自动生成CSRF标签</span>
        csrf <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token comment"># 生成CSRF标签name</span>
        csrf_field_name <span class="token operator">=</span> <span class="token string">'csrf_token'</span>

        <span class="token comment"># 自动生成标签的值，加密用的csrf_secret</span>
        csrf_secret <span class="token operator">=</span> <span class="token string">'xxxxxx'</span>
        <span class="token comment"># 自动生成标签的值，加密用的csrf_context</span>
        csrf_context <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> request<span class="token punctuation">.</span>url
        <span class="token comment"># 生成和比较csrf标签</span>
        csrf_class <span class="token operator">=</span> MyCSRF

        <span class="token comment"># -- i18n</span>
        <span class="token comment"># 是否支持本地化</span>
        <span class="token comment"># locales = False</span>
        locales <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'zh'</span><span class="token punctuation">,</span> <span class="token string">'en'</span><span class="token punctuation">)</span>
        <span class="token comment"># 是否对本地化进行缓存</span>
        cache_translations <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token comment"># 保存本地化缓存信息的字段</span>
        translations_cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/index/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        form <span class="token operator">=</span> TestForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        form <span class="token operator">=</span> TestForm<span class="token punctuation">(</span>formdata<span class="token operator">=</span>request<span class="token punctuation">.</span>form<span class="token punctuation">)</span>
        <span class="token keyword">if</span> form<span class="token punctuation">.</span>validate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/python/flask/SQLAlchmey.html" class="prev">
        SQLAlchmey
      </a></span> <span class="next"><a href="/python/flask/信号.html">
        信号
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.51f2f156.js" defer></script><script src="/assets/js/2.8911ec45.js" defer></script><script src="/assets/js/68.9f227dae.js" defer></script>
  </body>
</html>
